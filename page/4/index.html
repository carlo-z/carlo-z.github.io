<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">




  
  
  
  

  
    
    
  

  

  

  
    
      
    

    
  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=consolas:300,300italic,400,400italic,700,700italic|Lobster Two:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT">










<meta name="keywords" content="Java Kafka Docker JVM NIO Netty">
<meta property="og:type" content="website">
<meta property="og:title" content="Focus-1">
<meta property="og:url" content="https://carlo-z.com/page/4/index.html">
<meta property="og:site_name" content="Focus-1">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Focus-1">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"left","display":"always","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://carlo-z.com/page/4/">





  <title>Focus-1</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Focus-1</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br>
            
            关于
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://carlo-z.com/mysql/mysql-tpc-tpcc-tpmc/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Focus-1">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Focus-1">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/mysql/mysql-tpc-tpcc-tpmc/" itemprop="url">TPC,TPCC,TPMC(数据库性能衡量指标)</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-11-20T00:00:00+08:00">
                2019-11-20
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/mysql/" itemprop="url" rel="index">
                    <span itemprop="name">mysql</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="第一章-什么是TPC和tpmC"><a href="#第一章-什么是TPC和tpmC" class="headerlink" title="第一章 什么是TPC和tpmC?"></a>第一章 什么是TPC和tpmC?</h1><h2 id="1-TPC"><a href="#1-TPC" class="headerlink" title="1 TPC"></a>1 TPC</h2><p>TPC(Transaction Processing Performance Council，事务处理性能委员会)是由数10家会员公司创建的非盈利组织，总部设在美国。该组织对全世界开放，但迄今为止，绝大多数会员都是美、日、西欧的大公司。TPC的成员主要是计算机软硬件厂家，而非计算机用户，它的功 能是制定商务应用基准程序(Benchmark)的标准规范、性能和价格度量，并管理测 试结果的发布。</p>
<p>TPC的出版物是开放的，可以通过网络获取(<a href="http://www.tpc.org/" target="_blank" rel="noopener">http://www.tpc.org</a>)。TPC不给出基准程序的代码，而只给出基准程序的标准规范(Standard Specification)。任何厂家或其它测试者都可以根据规范，最优地构造出自己的系统(测试平台和测试程序)。为保证测试结果的客观性，被测试者(通常是厂家)必须提交给TPC一套完整的报告(Full Disclosure Report)，包括被测系统的详细配置、分类价格和包含五年维护费用在内的总价 格。该报告必须由TPC授权的审核员核实(TPC本身并不做审计)。现在全球只有几个审核员，全部在美国。</p>
<p>TPC已经推出了四套基准程序，被称为TPC－A、TPC－B、TPC－C和TPC－D。其中A和B已经过时，不再使用了。TPC－C是在线事务处理(OLTP)的基准程序，TPC－D是决策支持(Decision Support) 的基准程序。TPC即将推TPC－E，作为大型企业(Enterprise)信息服务的基准程序。</p>
<h2 id="2-tpmC"><a href="#2-tpmC" class="headerlink" title="2 tpmC"></a>2 tpmC</h2><p>tpmC值在国内外被广 泛用于衡量计算机系统的事务处理能力。但究竟什么是tpmC值呢?作者曾向一些 用户、推销人员乃至某些国外大公司的技术人员问过这个问题，但回答的精确度 与tpmC值的流行程度远非相称。tpmC这一度量也常被误写为TPM或TPMC。</p>
<p>TPC-C模拟一个批发商的货物管理环境。该批发公司有N个仓库，每个仓库供应10个地区，其中每个地区为3000名顾客服务。在每个仓库中有10个终端，每一个终端用于一个地区。在运行时，10×N个终端操作员向公司的数据库发出5类请求。由于一个仓库中不可能存储公司所有的货物，有一些请求必须发往其它仓库，因此，数据库在逻辑上是 分布的。N是一个可变参数，测试者可以随意改变N，以获得最佳测试效果。</p>
<p>TPC-C使用三种性能和价格度量，其中性能由TPC-C吞吐率衡量，单位是tpmC。tpm是transactions per minute的简称；C指TPC中的C基准程序。它的定义是每分钟内系统处理的新订单个数。要注意的是，在处理新订单的同时，系统还要按表1的要求处理其它4类事务 请求。从表1可以看出，新订单请求不可能超出全部事务请求的45％，因此，当一个 系统的性能为1000tpmC时，它每分钟实际处理的请求数是2000多个。价格是指系 统的总价格，单位是美元，而价格性能比则定义为总价格÷性能，单位是＄/tpmC。</p>
<p>tpmC定义: TPC-C的吞吐量，按有效TPC-C配置期间每分钟处理的平均交易次数测量，至少要运行12分钟。</p>
<p>（吞吐量测试结果以比特/秒或字节/秒表示。）</p>
<h1 id="第二章-TPCC"><a href="#第二章-TPCC" class="headerlink" title="第二章 TPCC"></a>第二章 TPCC</h1><h2 id="1-基准测试"><a href="#1-基准测试" class="headerlink" title="1 基准测试"></a>1 基准测试</h2><p>TPCC值被广泛用于衡量C/S环境下,由服务器和客户端构筑的整体系统的性能,它由事物处理性能委员会（TPC，Transaction Processing Corp）制定,TPC为非赢利性国际组织。</p>
<p>TPCC值可以反映出系统的性能价格比。TPCC测试系统每分钟处理的任务数,单位为tpm,(transactions per minute)。系统的总体价格(单位为美元)除以TPCC值,就可以衡量出系统的性价比,系统的性价比值越大,系统的性价比越好。</p>
<p>需要注意的是,TPC-C值描述的是C/S整体系统的性能,它与系统的服务器和客户机的性能都有关系,也就是说,同样的服务器配置不同的客户端将会影响TPCC值,任何厂商和测试者都可以根据TPC提供的测试规范构造出自己最优的系统,当然测试的结果要经过TPC审核。</p>
<h2 id="2-性能测试指标介绍"><a href="#2-性能测试指标介绍" class="headerlink" title="2 性能测试指标介绍"></a>2 性能测试指标介绍</h2><p>TPC-C</p>
<p>作为一家非盈利性机构，事务处理性能委员会（TPC）负责定义诸如TPC-C、TPC-H和TPC-W基准测试之类的事务处理与数据库性能基准测试，并依据这些基准测试项目发布客观性能数据。TPC基准测试采用极为严格的运行环境，并且必须在独立审计机构监督下进行。委员会成员包括大多数主要数据库产品厂商以及服务器硬件系统供应商。</p>
<p>相关企业参与TPC基准测试以期在规定运行环境中获得客观性能验证，并通过应用测试过程中所使用的技术开发出更加强健且更具伸缩性的软件产品及硬件设备。</p>
<p>TPC-C是一种旨在衡量联机事务处理（OLTP）系统性能与可伸缩性的行业标准基准测试项目。这种基准测试项目将对包括查询、更新及队列式小批量事务在内的广泛数据库功能进行测试。许多IT专业人员将TPC-C视为衡量“真实”OLTP系统性能的有效指示器。</p>
<p>TPC-C基准测试针对一种模拟订单录入与销售环境测量每分钟商业事务（tpmC）吞吐量。特别值得一提的是，它将专门测量系统在同时执行其它四种事务类型（如支付、订单状态更新、交付及证券级变更）时每分钟所生成的新增订单事务数量。独立审计机构将负责对基准测试结果进行公证，同时，TPC将出据一份全面彻底的测试报告。这份测试报告可以从TPC Web站点(<a href="http://www.tpc.org)上获得。" target="_blank" rel="noopener">http://www.tpc.org)上获得。</a></p>
<h2 id="3-TPC-C规范概要"><a href="#3-TPC-C规范概要" class="headerlink" title="3 TPC-C规范概要"></a>3 TPC-C规范概要</h2><p>TPC-C是专门针对联机交易处理系统（OLTP系统）的，一般情况下我们也把这类系统称为业务处理系统。</p>
<p>TPC-C测试规范中模拟了一个比较复杂并具有代表意义的OLTP应用环境:假设有一个大型商品批发商，它拥有若干个分布在不同区域的商品库；每个仓库负责为10个销售点供货；每个销售点为3000个客户提供服务；每个客户平均一个订单有10项产品;所有订单中约1%的产品在其直接所属的仓库中没有存货，需要由其他区域的仓库来供货。同时，每个仓库都要维护公司销售的100000种商品的库存记录。</p>
<p>该系统需要处理的交易为以下几种：</p>
<p>New-Order：客户输入一笔新的订货交易；</p>
<p>Payment:更新客户账户余额以反映其支付状况;</p>
<p>Delivery:发货(模拟批处理交易);</p>
<p>Order-Status:查询客户最近交易的状态；</p>
<p>Stock-Level:查询仓库库存状况，以便能够及时补货。</p>
<p>对于前四种类型的交易，要求响应时间在5秒以内；对于库存状况查询交易，要求响应时间在20秒以内。</p>
<h2 id="4评测指标"><a href="#4评测指标" class="headerlink" title="4评测指标"></a>4评测指标</h2><p>TPC-C测试规范经过两年的研制，于1992年7月发布。几乎所有在OLTP市场提供软硬件平台的厂商都发布了相应的TPC-C测试结果，随着计算机技术的不断发展，这些测试结果也在不断刷新。</p>
<p>TPC-C的测试结果主要有两个指标：</p>
<h3 id="①流量指标-Throughput，简称tpmC"><a href="#①流量指标-Throughput，简称tpmC" class="headerlink" title="①流量指标(Throughput，简称tpmC)"></a>①流量指标(Throughput，简称tpmC)</h3><p>按照TPC的定义，流量指标描述了系统在执行Payment、Order-status、Delivery、Stock-Level这四种交易的同时，每分钟可以处理多少个New-Order交易。所有交易的响应时间必须满足TPC-C测试规范的要求。</p>
<p>流量指标值越大越好！</p>
<h3 id="②性价比-Price-Performance，简称Price-tpmC"><a href="#②性价比-Price-Performance，简称Price-tpmC" class="headerlink" title="②性价比(Price/Performance，简称Price/tpmC)"></a>②性价比(Price/Performance，简称Price/tpmC)</h3><p>即测试系统价格（指在美国的报价）与流量指标的比值。</p>
<p>性价比越大越好！</p>
<h1 id="第三章（TPCC）如何衡量计算机系统的性能和价格"><a href="#第三章（TPCC）如何衡量计算机系统的性能和价格" class="headerlink" title="第三章（TPCC）如何衡量计算机系统的性能和价格"></a>第三章（TPCC）如何衡量计算机系统的性能和价格</h1><p>在系统选型时，我们一定不要忘记我们是为特定用户环境中的特定应用选择系统。切忌为了“与国际接轨”而盲目套用“国际通用”的东西。在性能评价领域，越是通用的度量常常越是不准确的。据我所知，美国的一些大用户从不相信任何“国际通用”的度量，而是花相当精力，比如预算的5％，使用自己的应用来测试系统，决定选型。在使用任何一种性能和价格度量时，一定要弄明白该度量的定义，以及它是在什么系统配置和运行环境下得到的，如何解释它的意义等。下面我们由好到差讨论三种方式。</p>
<h2 id="1在真实环境中运行-实际应用"><a href="#1在真实环境中运行-实际应用" class="headerlink" title="1在真实环境中运行 实际应用"></a>1在真实环境中运行 实际应用</h2><p>最理想的方式是搞一个试点，要求制造商或系统集成商配合将系统(含平台、软件和操作流程)在一个 实际用户点真正试运行一段时间。这样，用户不仅能看到实际性能，也能观察到系统是否稳定可靠、使用是否方便、服务是否周到、配置是否足够、全部价格是否合理。如果一个部门需要购买一批同类的系统，这种方式应列为首选，因为它不仅最精确、稳妥，也常常最有效率，用户还可先租一套系统作为试点。用这种方式得到的度量值常常具有很明确和实际的含义。</p>
<h2 id="2使用用户定义的基准程序"><a href="#2使用用户定义的基准程序" class="headerlink" title="2使用用户定义的基准程序"></a>2使用用户定义的基准程序</h2><p>如果由于某种原因第一种方式不可行，用户可以定义一组含有自己实际应用环境特征的应用基准程序。 我举两个例子：近年来，由于R/3软件是应用层软件，SAP公司的基准程序获得了越来越多国外企业的认可；中国税务总局最近也开发了自己的基准程序，以帮助税务系统进行计算机选型。这种方式在中国尤其重要，因为中国的信息系统有其特殊性。</p>
<h2 id="3使用通用基准程序"><a href="#3使用通用基准程序" class="headerlink" title="3使用通用基准程序"></a>3使用通用基准程序</h2><p>如果第1种和第2种方式都不行，则使用如TPC-C之类的通用基准程序，这是不得已的一种近似方法。因 此，tpmC值只能用作参考。我们应当注意以下几点：</p>
<h3 id="①实际应用是否与基准程序相符"><a href="#①实际应用是否与基准程序相符" class="headerlink" title="①实际应用是否与基准程序相符"></a>①实际应用是否与基准程序相符</h3><p>绝大多数基准程序都是在美国制订的，而中国的企事业单位与美国的运作方式常常不一样(恐怕也不应该或不可能一样)。在使用TPC－C时，我们应该清楚地知道：我的应用是否符合批发商模式?事务请求是否与表1近似?对响应时间的要求是否满足表1?如果都不是，则tpmC值的参考价值就不太大了。</p>
<h3 id="②TPC度量的解释"><a href="#②TPC度量的解释" class="headerlink" title="②TPC度量的解释"></a>②TPC度量的解释</h3><p>TPC基准程序是用来测系统而不是测主机的，厂家肯定要充分优化他们的被测系统。此处的“系统”包括主机、外设(如硬盘或RAID)、主机端操作系统、数据库软件、客户端计算机及其 操作系统、数据库软件和网络连接等。在很多厂家的TPC测试系统中，主机的价格只是系统总价格的1/4或更小，而硬盘的价格有可能占到总价格的1/3以上，因为TPC－C要求被测系统必须保存180天的事务记录。如果同样的主机被用到用户的环境中，厂家报的tpmC值就意义不大，因为用户的实际系统与厂家原来用于TPC测试的系统大不一样。当同样的主机用在不同的系统中时，tpmC值可能有相当大的变化，现在很多用户还没有意识到这一点。</p>
<p>我举一个例子。假设用 户希望购买一批同类系统，每一系统至少需要1GB的内存和50GB的硬盘。厂家A、B、C 各报了三个价格相当的系统，tpmC值分别为3000、2800、2600。用户是否应该选厂家A的产品呢?答案是：不一定。厂家用于测试tpmC值的系统与实际提供给用户的系统配置大不一样。tpmC最低的厂家C提供给用户的系统反而有可能性能最好，不 论是以实际系统的tpmC值还是以用户的实际应用性能来衡量。</p>
<h3 id="③TPC测试的成本"><a href="#③TPC测试的成本" class="headerlink" title="③TPC测试的成本"></a>③TPC测试的成本</h3><p>TPC－C和TPC－D都是很复杂的基准程序，做一个严格的测试是很消耗资源的，厂家当然不会说出他们花费了多少钱和时间。但据国外知情人士透露，一个厂家做第一个TPC－C测试需 要几十万到上百万美元的资金和半年左右的时间投入。因此，很多TPC的度量值都 是估计的。由于计算机系统换代频繁，如果用户一定要用通过审核的度量值，就必 须多等待半年时间，因此而不能用最先进的系统。中国的厂家通过审核的时间则更长。</p>
<p>综上所述，我们对中国 用户(尤其是大用户)在计算机系统的选型方面有如下建议：</p>
<p>最好建立一个真实的试点，因为实际应用环境是检验计算机系统的最好标准。</p>
<p>中国的行业应该建立符合自己实际应用的基准程序和测试标准。中国税务总局的做法值得提倡。国家有关部门应该建立独立的测试中心，制定跨行业、符合中国企事业运作模式的性能测试标准。</p>
<p>“国际通用”的度量可以作为参考值，而不应作为必要条件。尤其是一定要弄清这些流行度量有什么含义，是在什么样的系统环境中测得的，以及基准程序是否符合企业真实的业务流程和运作模式。</p>
<p>作为一家非盈利性机构，事务处理性能委员会（TPC）负责定义诸如TPC-C、TPC-H和TPC-W基准测试之类的事务处理与数据库性能基准测试，并依据这些基准测试项目发布客观性能数据。TPC基准测试采用极为严格的运行环境，并且必须在独立审计机构监督下进行。委员会成员包括大多数主要数据库产品厂商以及服务器硬件系统供应商。</p>
<p>相关企业参与TPC基准测试以期在规定运行环境中获得客观性能验证，并通过应用测试过程中所使用的技术开发出更加强健且更具伸缩性的软件产品及硬件设备。</p>
<p>TPC-C是一种旨在衡量联机事务处理（OLTP）系统性能与可伸缩性的行业标准基准测试项目。这种基准测试项目将对包括查询、更新及队列式小批量事务在内的广泛数据库功能进行测试。许多IT专业人员将TPC-C视为衡量“真实”OLTP系统性能的有效指示器。</p>
<p>TPC-C基准测试针对一种模拟订单录入与销售环境测量每分钟商业事务（tpmC）吞吐量。特别值得一提的是，它将专门测量系统在同时执行其它四种事务类型（如支付、订单状态更新、交付及证券级变更）时每分钟所生成的新增订单事务数量。独立审计机构将负责对基准测试结果进行公证，同时，TPC将出据一份全面彻底的测试报告。这份测试报告可以从TPC Web站点(<a href="http://www.tpc.org/" target="_blank" rel="noopener">http://www.tpc.org</a>)上获得。</p>
<h1 id="第四章-TPCC计算原则"><a href="#第四章-TPCC计算原则" class="headerlink" title="第四章 TPCC计算原则"></a>第四章 TPCC计算原则</h1><h2 id="1建议"><a href="#1建议" class="headerlink" title="1建议"></a>1建议</h2><p>不管是TPC-C还是SPECjbb2000，计算结果都只能作为一个横向比较的参考。在实际应用中，决定系统性能的因素除了硬件、系统软件外，与应用软件的设计也是有很大关系的，此外，基于系统可扩展性的考虑，更多时候也倾向于一次性的采购。<br>从长远考虑，以政府信息化主管部门的角度考虑，建立一套评估机制是非常有用的，这其中包括：<br>1、 通过对各单位业务系统运行情况的调查，进行历史数据的收集分析，按分类建立基准指标库。收集的信息包括：服务器的配置、并发用户数（每天业务量）、CPU负荷等；<br>2、 由厂商定期提供基准值，更新基准指标库；<br>有了基准指标库的信息参照，不仅可以用于评估项目建设方案中服务器选型，也可以对各部门进行系统架构设计的优化提供指导。如以下是一些指导原则：<br>1、 数据库服务器选型：采购两台相同配置的小型机，进行虚拟分区和并行处理，以提高系统资源的利用率；日后扩容时采取垂直扩展的方式进行升级；<br>2、 应用服务器：采用负载均衡的方式提高并发处理能力，一般可配置2台以上，每台的硬件配置完全可以不同，应首先考虑使用旧的数据库服务器（利旧），如需采购新的服务器，应采用水平扩展的方式逐步升级；<br>3、 WEB服务器，可以考虑采用刀片服务器，提高扩展性和可管理性。</p>
<h2 id="2参考：某项目计算实例"><a href="#2参考：某项目计算实例" class="headerlink" title="2参考：某项目计算实例"></a>2参考：某项目计算实例</h2><h3 id="参考1"><a href="#参考1" class="headerlink" title="参考1"></a>参考1</h3><p>为了方便计算数据库服务器的造型，我们约定：<br>“ 系统同时在线用户数为1500人（U1）；<br>“ 平均每个用户每分钟发出2次业务请求（N1）；<br>“ 系统发出的业务请求中，更新、查询、统计各占1/3；<br>“ 平均每次更新业务产生3个事务（T1）；<br>“ 平均每次查询业务产生8个事务（T2）；<br>“ 平均每次统计业务产生13个事务（T3）；<br>“ 一天内忙时的处理量为平均值的5倍；<br>“ 经验系数为1.6；(实际工程经验)<br>“ 考虑服务器保留30％的冗余；<br>服务器需要的处理能力为：<br>TPC-C=U1<em>N1</em>（T1+T2+T3）/3<em>3</em>经验系数/冗余系数<br>则应用服务器的处理性能估算为：<br>TPC-C= 1500<em>2</em>（3+8+13）/3<em>5</em>1.6/0.7= 274,285 tpmC</p>
<p>数据库服务器关系到整个系统的稳定运行，考虑到高可靠性和高可用性，并注重设备的可扩展性和性价比，系统将配置两台TPC-C值不小于28万的高性能数据库服务器。</p>
<h3 id="参考2"><a href="#参考2" class="headerlink" title="参考2"></a>参考2</h3><p>以单台服务器性能进行计算，即确保单台服务器工作的时候可以满足系统正常运行的需要；</p>
<p>假设每天有1万人次来窗口办理业务，每人次办理一项业务。即以每日1万笔前台交易为例进行<strong><em>\</em>综合系数**</strong>的推导：</p>
<p>\1. 假设每月前台交易数（未来5年内的设计指标）为220,000 （有些业务在月初、月末的处理量比较高，按月统计可以平衡此项差异）;<br>\2. 每日前台交易数=220000/22=10,000 ，即每日 1万笔；<br>\3. 忙时处理能力：每日交易的80%在4个小时内完成，即10000<em>80%/4=2000（笔/小时）<br>\4. 峰值处理能力：2000</em>2=4000（笔/小时），即峰值处理能力为每小时4000笔，或 67笔/分，假设业务人员同时在线为100人，即每人每分钟处理0.7笔）<br>\5. 假设每笔交易对应数据库事务数=20<strong>（这个是不是有点夸张了，有这么复杂的交易，TPC的标准交易都不算简单了吧，这只能说明数据库设计的有问题，按这样，支付宝咋弄）</strong>，基准TPC指标值对应的比例=8，cpu保留30%的处理能力冗余，计算值与公布值（最优值）的偏差经验值为4 <strong>（这几个参数估算的依据不足，更多的是经验值）</strong></p>
<p>则 tpmC值为：<br>tpmC= 67<em>20<em>8</em>4/(1-30%)= 61257[颠峰处理能力时（笔/分）<em>每笔交易对应数据库事务数</em>基准TPC指标值对应的比例<em>计算值与公布值（最优值）的偏差经验值/（1- cpu保留30%的处理能力冗余）<br>倒算出 综合系数 = 61257/10000=6.1<br>即数据库服务器tpmC= **</em>*每日前台交易数 \</em> 6.1**** （实际计算值应不高于该值）<br>应用服务器的 tpmC = 数据库服务器 tpmC *50% （一般）</p>
<p>应用服务器的 tpmC = tpmC *70% </p>
<p>某单位要建立一个系统，设计容量是 2008 年要达到 1500 万客户的规模，在花费巨资（将近 100 M $）建设起此系统后，运行只有几个月，客户量也只达到几十万，厂商就说此系统容量不够，要花数 M $ 要扩容，并声称不是拍脑袋是，按 TPCC 计算的结果 …</p>
<p>以前只大致了解 TPCC 指标的一些情况，平常也就看看 By Performace 和　By Price/Performace 的 Top 10 列表，了解一下各厂商的实力和产品的情况，这次对 TPCC 进行了一下深入了解，发现了一些容易被厂商搞猫腻的地方。</p>
<p><a href="http://www.tpc.org/tpcc" target="_blank" rel="noopener">TPCC</a> 简单的来说，就是事务处理性能委员会 <a href="http://www.tpc.org/" target="_blank" rel="noopener">TPC</a> 组织针对联机数据库应用系统（OLTP）制定的一个综合性能考评指标，它模拟了一个批发 商的货物管理环境，有标准的数据库结构（Schema），可以很容易的扩展，在此系统中，主要有五类交易：</p>
<p>\1. 新订单（New-Order） </p>
<p>\2. 支付（Payment ） 43%（最小比例）</p>
<p>\3. 订单查询（Order-Status） 4%（最小比例）</p>
<p>\4. 交付（Delivery） 4%（最小比例）</p>
<p>\5. 库存查询（Stock-Level） 4%（最小比例）</p>
<p>因为 TPCC 指标值主要是衡量“新订单”交易的数量，所以厂商都会趋向于增加新订单交易的数量，这样并不满足实际的应用场景，所以 TPCC 的规范中指定了后四种交易数量的最小比例，这样意味着 “新订单” 的数量最多只能占到45%（这个 45% 不知出于什么原因，在很多 TPCC 的指标介绍中并没有提及）。</p>
<p>这就说明了：如果一台机器有 1000 tpm (Transactions per Minute)，那么它实际上处理的交易（请求）为 1000/45% = 2222 ，而实际上大多数厂商在面对用户估算应用系统需要多少个 TPCC 的服务器的时候，是计算所有交易量的，这样带来的评估结果是用户至少买比实际需要大一倍性能容量的机器，获得利益的谁呢？当然是服务器厂商，越高 TPCC 值的机器，价格越高，性价比也一般要偏小。</p>
<p>此外，服务器厂商还容易在以下方面愚弄客户：</p>
<p>１、交易复杂度（用户的一个交易约等于多少个 TPCC 的标准交易），某国际著名的服务器厂商建议此值取 10 - 20 ，这个值也忒大了点， 在 TPCC 的场景，交易也不是很简单的，和实际的应用交易差别并不是很大。</p>
<p>2、按一些峰值指标来计算性能，实际上，这些峰值只是在极少数情况下出现，所以在计算时，应乘以 80% 的系数。</p>
<p>​    3、预留容量，很多厂商建议预留容量，甚至达到一半，这有点过份，在实际容量要求增高的时候，可以通过服务器的横向扩展来纵向扩展来满足应用要求，何必为未来五年的要求，要在眼下一下子要做全部的硬件投资呢？ 何况硬件的价格在不断下降呢。</p>
<p><strong>具体情况具体分析，还得按中国国情来实测，国际标准有时不适合我们。<br>而且这个标准好多年了，现在很少在纵向扩展上花心思了，都注重横向扩展，按成本购置小机，尽量优化小机的数据库性能，得出TPCM值，然后对数据库进行横向扩展（虽然横向扩展有诸多问题，但是还是要扩展），利用集群提高整体的TPS</strong></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://carlo-z.com/mysql/2-mysql-benchmark-test/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Focus-1">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Focus-1">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/mysql/2-mysql-benchmark-test/" itemprop="url">centos7.5下对mysql5.6基准测试</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-11-18T00:00:00+08:00">
                2019-11-18
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/mysql/" itemprop="url" rel="index">
                    <span itemprop="name">mysql</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <hr>
<br>

<h1 id="一、测试环境准备"><a href="#一、测试环境准备" class="headerlink" title="一、测试环境准备"></a>一、测试环境准备</h1><ul>
<li><p>操作系统：centos7.5</p>
</li>
<li><p>处理器：Intel 8核  Current Speed: 2000 MHz， Max Speed: 2000 MHz，三级缓存</p>
</li>
<li><p>内存：16G</p>
</li>
<li><p>磁盘：100G SSD</p>
</li>
<li><p>数据库：mysql 5.6.28</p>
</li>
<li><p>sysbench：1.0.18</p>
</li>
</ul>
<br>

<h1 id="二、测试工具"><a href="#二、测试工具" class="headerlink" title="二、测试工具"></a>二、测试工具</h1><h3 id="1、sysbench"><a href="#1、sysbench" class="headerlink" title="1、sysbench"></a>1、sysbench</h3><p>安装文档： <a href="https://github.com/akopytov/sysbench#installing-from-binary-packages" target="_blank" rel="noopener">https://github.com/akopytov/sysbench#installing-from-binary-packages</a> </p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> centos7.5使用官方镜像安装</span><br><span class="line">curl -s https://packagecloud.io/install/repositories/akopytov/sysbench/script.rpm.sh | sudo bash</span><br><span class="line">sudo yum -y install sysbench</span><br></pre></td></tr></table></figure>

<p>帮助：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[root@10-10-135-172 benchmark]# sysbench --help</span><br><span class="line"></span><br><span class="line">[root@10-10-135-172 benchmark]# sysbench fileio help</span><br><span class="line">sysbench 1.0.18 (using bundled LuaJIT 2.1.0-beta2)</span><br><span class="line"></span><br><span class="line">fileio options:</span><br><span class="line">  --file-num=N                  number of files to create [128]</span><br><span class="line">  --file-block-size=N           block size to use in all IO operations [16384]</span><br><span class="line">  --file-total-size=SIZE        total size of files to create [2G]</span><br><span class="line">  --file-test-mode=STRING       test mode &#123;seqwr, seqrewr, seqrd, rndrd, rndwr, rndrw&#125;</span><br><span class="line">  --file-io-mode=STRING         file operations mode &#123;sync,async,mmap&#125; [sync]</span><br><span class="line">  --file-async-backlog=N        number of asynchronous operatons to queue per thread [128]</span><br><span class="line">  --file-extra-flags=[LIST,...] list of additional flags to use to open files &#123;sync,dsync,direct&#125; []</span><br><span class="line">  --file-fsync-freq=N           do fsync() after this number of requests (0 - don't use fsync()) [100]</span><br><span class="line">  --file-fsync-all[=on|off]     do fsync() after each write operation [off]</span><br><span class="line">  --file-fsync-end[=on|off]     do fsync() at the end of test [on]</span><br><span class="line">  --file-fsync-mode=STRING      which method to use for synchronization &#123;fsync, fdatasync&#125; [fsync]</span><br><span class="line">  --file-merged-requests=N      merge at most this number of IO requests if possible (0 - don't merge) [0]</span><br><span class="line">  --file-rw-ratio=N             reads/writes ratio for combined test [1.5]</span><br></pre></td></tr></table></figure>

<br>

<h3 id="2、tpcc-mysql"><a href="#2、tpcc-mysql" class="headerlink" title="2、tpcc-mysql"></a>2、tpcc-mysql</h3><p>github： <a href="https://github.com/Percona-Lab/tpcc-mysql" target="_blank" rel="noopener">https://github.com/Percona-Lab/tpcc-mysql</a> </p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /var/lib/mysql/benchmark</span><br><span class="line">cd /var/lib/mysql/benchmark</span><br><span class="line">wget https://github.com/Percona-Lab/tpcc-mysql/archive/master.zip -O tpcc-mysql.zip</span><br><span class="line">unzip -d ./ tpcc-mysql.zip</span><br><span class="line">cd /var/lib/mysql/benchmark/tpcc-mysql-master/src</span><br><span class="line">yum install mysql-devel</span><br><span class="line">make</span><br></pre></td></tr></table></figure>

<p>编译完成后，生成 tpcc_load  tpcc_start：</p>
<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20191118181430.png" alt></p>
<br>

<h1 id="三、测试目标"><a href="#三、测试目标" class="headerlink" title="三、测试目标"></a>三、测试目标</h1><ul>
<li><p>处理器性能</p>
</li>
<li><p>内存性能</p>
</li>
<li><p>磁盘顺序读写，随机读写性能</p>
</li>
<li><p>mysql 吞吐量，响应时间</p>
</li>
</ul>
<br>

<h1 id="四、测试步骤"><a href="#四、测试步骤" class="headerlink" title="四、测试步骤"></a>四、测试步骤</h1><h3 id="1、准备获取系统性能和状态的脚本"><a href="#1、准备获取系统性能和状态的脚本" class="headerlink" title="1、准备获取系统性能和状态的脚本"></a>1、准备获取系统性能和状态的脚本</h3><p>vi /root/benchmark/1-collect-system-status.sh</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span>!/bin/sh</span><br><span class="line"></span><br><span class="line">mkdir -p status_data</span><br><span class="line"></span><br><span class="line">INTERVAL=5</span><br><span class="line">PREFIX=./status_data/$INTERVAL-sec-status</span><br><span class="line">RUNFILE=/root/benchmark/running</span><br><span class="line"></span><br><span class="line">mysql -uroot -p123456 -e 'SHOW GLOBAL VARIABLES' &gt;&gt; mysql-variables</span><br><span class="line">while test -e $RUNFILE; do</span><br><span class="line">    tfile=$(date +%F_%I)</span><br><span class="line">    sleep=$(date +%s.%N | awk "&#123;print $INTERVAL - (\$1 % $INTERVAL)&#125;")</span><br><span class="line">    sleep $sleep</span><br><span class="line">    ts="$(date +"TS %s.%N %F %T")"</span><br><span class="line">    loadavg="$(uptime)"</span><br><span class="line">    echo "$ts $loadavg" &gt;&gt; $PREFIX-$&#123;tfile&#125;-status</span><br><span class="line">    mysql -uroot -p123456 -e 'SHOW GLOBAL STATUS' &gt;&gt; $PREFIX-$&#123;tfile&#125;-status &amp;</span><br><span class="line">    echo "$ts $loadavg" &gt;&gt; $PREFIX-$&#123;tfile&#125;-innodbstatus</span><br><span class="line">    mysql -uroot -p123456 -e 'SHOW GLOBAL STATUS\G' &gt;&gt; $PREFIX-$&#123;tfile&#125;-innodbstatus &amp;</span><br><span class="line">    echo "$ts $loadavg" &gt;&gt; $PREFIX-$&#123;tfile&#125;-processlist</span><br><span class="line">    mysql -uroot -p123456 -e 'SHOW FULL PROCESSLIST\G' &gt;&gt; $PREFIX-$&#123;tfile&#125;-processlist &amp;</span><br><span class="line">    echo $ts</span><br><span class="line">done</span><br><span class="line">echo Exiting because $RUNFILE does not exist.</span><br></pre></td></tr></table></figure>

<p>分析收集到的数据</p>
<p>vi /root/benchmark/2-system-status-analyzer.sh</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span>!/bin/bash</span><br><span class="line"></span><br><span class="line">awk '</span><br><span class="line">    BEGIN &#123;</span><br><span class="line">        printf "#ts date time load QPS";</span><br><span class="line">        fmt = " %.2f";</span><br><span class="line">    &#125;</span><br><span class="line">    /^TS/ &#123;</span><br><span class="line">        ts      = substr($2, 1, index($2, ".") - 1);</span><br><span class="line">        load    = NF -2;</span><br><span class="line">        diff    = ts - prev_ts;</span><br><span class="line">        prev_ts = ts;</span><br><span class="line">        printf "\n%s %s %s %s", ts, $3, $4, substr($load, 1, length($load) - 1);</span><br><span class="line">    &#125;</span><br><span class="line">    /Queries/ &#123;</span><br><span class="line">        printf fmt, ($2-Queries)/diff;</span><br><span class="line">        Queries=$2</span><br><span class="line">    &#125;</span><br><span class="line">' "$@"</span><br></pre></td></tr></table></figure>

<p>用法示例</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sh 2-system-status-analyzer.sh status_data/5-sec-status-2019-11-19_10-status</span><br></pre></td></tr></table></figure>

<br>

<h3 id="2、使用sysbench服务器性能测试"><a href="#2、使用sysbench服务器性能测试" class="headerlink" title="2、使用sysbench服务器性能测试"></a>2、使用sysbench服务器性能测试</h3><h4 id="1-、cpu测试"><a href="#1-、cpu测试" class="headerlink" title="1)、cpu测试"></a>1)、cpu测试</h4><p> 计算20000个素数。8核cpu，分别测试 1，4，8，12  线程时的 CPU表现</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sysbench --test=cpu --threads=1 --cpu-max-prime=20000 run</span><br></pre></td></tr></table></figure>

<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20191119112016.png" alt></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sysbench --test=cpu --threads=4 --cpu-max-prime=20000 run</span><br></pre></td></tr></table></figure>

<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20191119111943.png" alt></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sysbench --test=cpu --threads=8 --cpu-max-prime=20000 run</span><br></pre></td></tr></table></figure>

<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20191119112049.png" alt></p>
<blockquote>
<p> 结论：随着线程数增加，计算能力线性增加；</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sysbench --test=cpu --threads=12 --cpu-max-prime=20000 run</span><br></pre></td></tr></table></figure>

<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20191119112250.png" alt></p>
<blockquote>
<p> 结论：当线程数超过cpu核数之后，随着线程数增加，计算能力不再增加，甚至略微下降，这是因为线程上下文切换以后的时间损耗；</p>
</blockquote>
<br>

<h4 id="2-、文件I-O测试"><a href="#2-、文件I-O测试" class="headerlink" title="2)、文件I/O测试"></a>2)、文件I/O测试</h4><p><u><strong>① 准备30G的数据</strong></u></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sysbench --test=fileio --file-total-size=30G prepare</span><br></pre></td></tr></table></figure>

<p><u><strong>② 运行阶段</strong></u></p>
<ul>
<li>seqwr：顺序写入</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sysbench --test=fileio --file-test-mode=seqwr --file-total-size=30G --time=60 run</span><br></pre></td></tr></table></figure>

<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20191119143818.png" alt></p>
<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20191119143929.png" alt></p>
<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20191119144029.png" alt></p>
<blockquote>
<p>结论：可以看到，顺序写的过程中 CPU占用很低，但是 buff、cache、block out、in、cs(上下文切换)都很高，这是因为 linux 写磁盘用了 页缓存  和 DMA。</p>
</blockquote>
<ul>
<li>seqrewr：顺序重写</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sysbench --test=fileio --file-test-mode=seqrewr --file-total-size=30G --time=60 run</span><br></pre></td></tr></table></figure>

<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20191119144945.png" alt></p>
<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20191119145023.png" alt></p>
<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20191119145125.png" alt></p>
<ul>
<li>seqrd：顺序读取</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sysbench --test=fileio --file-test-mode=seqrd --file-total-size=30G --time=60 run</span><br></pre></td></tr></table></figure>

<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20191119143529.png" alt></p>
<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20191119143630.png" alt></p>
<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20191119143651.png" alt></p>
<ul>
<li>rndrd：随机读取</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sysbench --test=fileio --file-test-mode=rndrd --file-total-size=30G --time=60 run</span><br></pre></td></tr></table></figure>

<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20191119143319.png" alt></p>
<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20191119143406.png" alt></p>
<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20191119150157.png" alt></p>
<blockquote>
<p>结论： SSD是没有寻道时间的，但是 随机读（46.95MiB/s） 仍然比顺序读（184.46MiB/s）要慢很多</p>
</blockquote>
<ul>
<li>rndwr：随机写入</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sysbench --test=fileio --file-test-mode=rndwr --file-total-size=30G --time=60 run</span><br></pre></td></tr></table></figure>

<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20191119142856.png" alt></p>
<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20191119142944.png" alt></p>
<blockquote>
<p>随机写（26.25MiB/s）更慢了，顺序写的速度有138.38MiB/s</p>
</blockquote>
<ul>
<li>rndrw：混合随机读/写</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sysbench --test=fileio --file-test-mode=rndrw --file-total-size=30G --time=60 run</span><br></pre></td></tr></table></figure>

<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20191119140202.png" alt></p>
<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20191119141529.png" alt></p>
<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20191119141833.png" alt></p>
<blockquote>
<p>混合随机读写的速度更是龟速，然而我们平时业务场景中使用最多的就是这种情况，所以一定要注意，能顺序写的，一定不随机写</p>
</blockquote>
<p><u><strong>③ 清除数据</strong></u></p>
<p>sysbench –test=fileio –file-total-size=30G cleanup</p>
<br>

<h4 id="3-、内存测试"><a href="#3-、内存测试" class="headerlink" title="3)、内存测试"></a>3)、内存测试</h4><p>测试8K顺序分配</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sysbench --test=memory --memory-access-mode=seq --memory-block-size=8K --memory-total-size=100G --threads=12 --events=10000 run</span><br></pre></td></tr></table></figure>

<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20191119151942.png" alt></p>
<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20191119151311.png" alt></p>
<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20191119151447.png" alt></p>
<blockquote>
<p>结论：可以看到 CPU 占用极高，内存写入速度为 10138.32 MiB / sec</p>
</blockquote>
<p><u><strong>测试8K随机分配</strong></u></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sysbench --test=memory --memory-access-mode=rnd --memory-block-size=8K --memory-total-size=100G --threads=12 --events=10000 run</span><br></pre></td></tr></table></figure>

<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20191119151857.png" alt></p>
<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20191119151718.png" alt></p>
<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20191119151756.png" alt></p>
<blockquote>
<p>结论：cpu占用极高，随机分配速度为 1381.41 MiB / sec，只有顺序分配的 1/7 左右，内存都有顺序写都有差距。</p>
</blockquote>
<br>

<h3 id="3、sysbench对mysql进行OLTP测试"><a href="#3、sysbench对mysql进行OLTP测试" class="headerlink" title="3、sysbench对mysql进行OLTP测试"></a>3、sysbench对mysql进行OLTP测试</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sysbench /usr/share/sysbench/oltp_read_write.lua help</span><br></pre></td></tr></table></figure>

<h4 id="1-、新建数据库-sbtest"><a href="#1-、新建数据库-sbtest" class="headerlink" title="1) 、新建数据库 sbtest"></a>1) 、新建数据库 sbtest</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysqladmin create sbtest -uroot -p</span><br></pre></td></tr></table></figure>

<h4 id="2-、运行状态收集脚本"><a href="#2-、运行状态收集脚本" class="headerlink" title="2) 、运行状态收集脚本"></a>2) 、运行状态收集脚本</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sh /root/benchmark/1-collect-system-status.sh</span><br></pre></td></tr></table></figure>

<h4 id="3-、-准备1百万条数据"><a href="#3-、-准备1百万条数据" class="headerlink" title="3)、 准备1百万条数据"></a>3)、 准备1百万条数据</h4><p> 可以在/usr/share/sysbench/中找到需要使用的lua脚本：</p>
<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20191119171723.png" alt></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> 开始插入数据</span><br><span class="line">sysbench /usr/share/sysbench/oltp_read_write.lua --threads=64 --time=600 --histogram=on --mysql-host=10.10.135.172 --mysql-port=3306 --mysql-db=sbtest --mysql-user=root --mysql-password=123456 --table-size=10000000 prepare</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 关键参数说明：</span><br><span class="line">--threads=64           测试时使用的线程数</span><br><span class="line">--time=600             测试时间</span><br><span class="line">--histogram=on         在报告中是否输出关于延迟的直方图，建议开启</span><br><span class="line">--table_size=10000000  数据表的大小</span><br></pre></td></tr></table></figure>

<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20191119183230.png" alt></p>
<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20191119183337.png" alt></p>
<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20191119183835.png" alt></p>
<br>

<h4 id="4-、-运行压测程序"><a href="#4-、-运行压测程序" class="headerlink" title="4)、 运行压测程序"></a>4)、 运行压测程序</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sysbench /usr/share/sysbench/oltp_read_write.lua --threads=64 --time=600 --histogram=on --mysql-host=10.10.135.172 --mysql-port=3306 --mysql-db=sbtest --mysql-user=root --table-size=10000000 run</span><br></pre></td></tr></table></figure>

<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20191119184201.png" alt></p>
<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20191119185243.png" alt></p>
<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20191119185550.png" alt></p>
<ul>
<li><p>总事务数：820388</p>
</li>
<li><p>每秒事务数：1367.22 per sec</p>
</li>
<li><p>总查询数：16407760</p>
</li>
<li><p>每秒查询数：27344.47 per sec</p>
</li>
</ul>
<p>请求分布直方图</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br></pre></td><td class="code"><pre><span class="line">[root@10-10-135-172 benchmark]#  sysbench /usr/share/sysbench/oltp_read_write.lua --threads=64 --time=600 --histogram=on --mysql-host=10.10.135.172 --mysql-port=3306 --mysql-db=sbtest --mysql-user=root --table-size=10000000 run</span><br><span class="line">sysbench 1.0.18 (using bundled LuaJIT 2.1.0-beta2)</span><br><span class="line"></span><br><span class="line">Running the test with following options:</span><br><span class="line">Number of threads: 64</span><br><span class="line">Initializing random number generator from current time</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Initializing worker threads...</span><br><span class="line"></span><br><span class="line">Threads started!</span><br><span class="line"></span><br><span class="line"> Latency histogram (values are in milliseconds)</span><br><span class="line">       value  ------------- distribution ------------- count</span><br><span class="line">       4.329 |                                         64</span><br><span class="line">       4.407 |*****                                    1030</span><br><span class="line">       4.487 |****************                         3445</span><br><span class="line">       4.569 |**************************               5587</span><br><span class="line">       4.652 |****************************             5867</span><br><span class="line">       4.737 |*************************                5250</span><br><span class="line">       4.823 |********************                     4190</span><br><span class="line">       4.910 |****************                         3476</span><br><span class="line">       4.999 |**************                           2922</span><br><span class="line">       5.090 |************                             2605</span><br><span class="line">       5.183 |***********                              2329</span><br><span class="line">       5.277 |*********                                1991</span><br><span class="line">       5.373 |*********                                1813</span><br><span class="line">       5.470 |********                                 1600</span><br><span class="line">       5.570 |*******                                  1476</span><br><span class="line">       5.671 |******                                   1279</span><br><span class="line">       5.774 |******                                   1178</span><br><span class="line">       5.879 |*****                                    1043</span><br><span class="line">       5.986 |*****                                    974</span><br><span class="line">       6.095 |****                                     924</span><br><span class="line">       6.205 |****                                     843</span><br><span class="line">       6.318 |****                                     768</span><br><span class="line">       6.433 |****                                     786</span><br><span class="line">       6.550 |****                                     839</span><br><span class="line">       6.669 |****                                     943</span><br><span class="line">       6.790 |*****                                    1012</span><br><span class="line">       6.913 |*****                                    1126</span><br><span class="line">       7.039 |******                                   1171</span><br><span class="line">       7.167 |******                                   1310</span><br><span class="line">       7.297 |******                                   1305</span><br><span class="line">       7.430 |******                                   1291</span><br><span class="line">       7.565 |*****                                    1167</span><br><span class="line">       7.702 |*****                                    1072</span><br><span class="line">       7.842 |*****                                    1066</span><br><span class="line">       7.985 |*****                                    1051</span><br><span class="line">       8.130 |*****                                    1102</span><br><span class="line">       8.277 |*****                                    1081</span><br><span class="line">       8.428 |*****                                    1120</span><br><span class="line">       8.581 |*****                                    1129</span><br><span class="line">       8.737 |******                                   1244</span><br><span class="line">       8.895 |*******                                  1444</span><br><span class="line">       9.057 |********                                 1692</span><br><span class="line">       9.222 |*********                                1984</span><br><span class="line">       9.389 |**********                               2161</span><br><span class="line">       9.560 |**********                               2057</span><br><span class="line">       9.734 |*********                                1944</span><br><span class="line">       9.910 |*********                                1930</span><br><span class="line">      10.090 |********                                 1773</span><br><span class="line">      10.274 |********                                 1753</span><br><span class="line">      10.460 |********                                 1698</span><br><span class="line">      10.651 |********                                 1605</span><br><span class="line">      10.844 |*******                                  1553</span><br><span class="line">      11.041 |********                                 1601</span><br><span class="line">      11.242 |********                                 1636</span><br><span class="line">      11.446 |********                                 1649</span><br><span class="line">      11.654 |********                                 1667</span><br><span class="line">      11.866 |********                                 1673</span><br><span class="line">      12.081 |********                                 1733</span><br><span class="line">      12.301 |*********                                1821</span><br><span class="line">      12.524 |*********                                1838</span><br><span class="line">      12.752 |*********                                1844</span><br><span class="line">      12.984 |**********                               2031</span><br><span class="line">      13.219 |*********                                1978</span><br><span class="line">      13.460 |**********                               2206</span><br><span class="line">      13.704 |************                             2449</span><br><span class="line">      13.953 |*************                            2681</span><br><span class="line">      14.207 |*************                            2675</span><br><span class="line">      14.465 |*************                            2744</span><br><span class="line">      14.728 |*************                            2694</span><br><span class="line">      14.995 |*************                            2667</span><br><span class="line">      15.268 |************                             2652</span><br><span class="line">      15.545 |************                             2650</span><br><span class="line">      15.828 |*************                            2671</span><br><span class="line">      16.115 |************                             2644</span><br><span class="line">      16.408 |*************                            2757</span><br><span class="line">      16.706 |*************                            2760</span><br><span class="line">      17.010 |*************                            2845</span><br><span class="line">      17.319 |**************                           2933</span><br><span class="line">      17.633 |***************                          3217</span><br><span class="line">      17.954 |***************                          3105</span><br><span class="line">      18.280 |****************                         3294</span><br><span class="line">      18.612 |*****************                        3587</span><br><span class="line">      18.950 |*****************                        3704</span><br><span class="line">      19.295 |******************                       3845</span><br><span class="line">      19.645 |******************                       3763</span><br><span class="line">      20.002 |******************                       3743</span><br><span class="line">      20.366 |******************                       3852</span><br><span class="line">      20.736 |******************                       3763</span><br><span class="line">      21.112 |******************                       3891</span><br><span class="line">      21.496 |*******************                      4076</span><br><span class="line">      21.886 |*******************                      4108</span><br><span class="line">      22.284 |********************                     4191</span><br><span class="line">      22.689 |*********************                    4400</span><br><span class="line">      23.101 |**********************                   4702</span><br><span class="line">      23.521 |***********************                  4863</span><br><span class="line">      23.948 |************************                 5072</span><br><span class="line">      24.384 |************************                 5043</span><br><span class="line">      24.827 |*************************                5224</span><br><span class="line">      25.278 |************************                 5196</span><br><span class="line">      25.737 |*************************                5285</span><br><span class="line">      26.205 |**************************               5442</span><br><span class="line">      26.681 |**************************               5452</span><br><span class="line">      27.165 |***************************              5727</span><br><span class="line">      27.659 |****************************             5867</span><br><span class="line">      28.162 |*****************************            6097</span><br><span class="line">      28.673 |******************************           6367</span><br><span class="line">      29.194 |******************************           6414</span><br><span class="line">      29.725 |******************************           6441</span><br><span class="line">      30.265 |*******************************          6512</span><br><span class="line">      30.815 |*******************************          6479</span><br><span class="line">      31.375 |********************************         6828</span><br><span class="line">      31.945 |********************************         6876</span><br><span class="line">      32.525 |**********************************       7128</span><br><span class="line">      33.116 |**********************************       7241</span><br><span class="line">      33.718 |***********************************      7372</span><br><span class="line">      34.330 |************************************     7548</span><br><span class="line">      34.954 |************************************     7653</span><br><span class="line">      35.589 |*************************************    7788</span><br><span class="line">      36.236 |*************************************    7808</span><br><span class="line">      36.894 |*************************************    7910</span><br><span class="line">      37.565 |**************************************   8106</span><br><span class="line">      38.247 |***************************************  8177</span><br><span class="line">      38.942 |***************************************  8311</span><br><span class="line">      39.650 |**************************************** 8451</span><br><span class="line">      40.370 |**************************************   8058</span><br><span class="line">      41.104 |***************************************  8309</span><br><span class="line">      41.851 |***************************************  8260</span><br><span class="line">      42.611 |**************************************** 8481</span><br><span class="line">      43.385 |**************************************** 8493</span><br><span class="line">      44.173 |**************************************** 8478</span><br><span class="line">      44.976 |**************************************** 8394</span><br><span class="line">      45.793 |***************************************  8369</span><br><span class="line">      46.625 |**************************************** 8398</span><br><span class="line">      47.472 |**************************************** 8459</span><br><span class="line">      48.335 |**************************************** 8455</span><br><span class="line">      49.213 |**************************************** 8446</span><br><span class="line">      50.107 |***************************************  8245</span><br><span class="line">      51.018 |***************************************  8215</span><br><span class="line">      51.945 |***************************************  8215</span><br><span class="line">      52.889 |**************************************   8087</span><br><span class="line">      53.850 |**************************************   8119</span><br><span class="line">      54.828 |**************************************   8043</span><br><span class="line">      55.824 |*************************************    7959</span><br><span class="line">      56.839 |**************************************   8043</span><br><span class="line">      57.871 |************************************     7746</span><br><span class="line">      58.923 |************************************     7650</span><br><span class="line">      59.993 |***********************************      7522</span><br><span class="line">      61.083 |***********************************      7535</span><br><span class="line">      62.193 |**********************************       7250</span><br><span class="line">      63.323 |**********************************       7254</span><br><span class="line">      64.474 |**********************************       7118</span><br><span class="line">      65.645 |*********************************        6983</span><br><span class="line">      66.838 |********************************         6868</span><br><span class="line">      68.053 |********************************         6890</span><br><span class="line">      69.289 |*******************************          6688</span><br><span class="line">      70.548 |*******************************          6530</span><br><span class="line">      71.830 |******************************           6437</span><br><span class="line">      73.135 |*****************************            6127</span><br><span class="line">      74.464 |******************************           6278</span><br><span class="line">      75.817 |****************************             5952</span><br><span class="line">      77.194 |***************************              5767</span><br><span class="line">      78.597 |**************************               5581</span><br><span class="line">      80.025 |**************************               5522</span><br><span class="line">      81.479 |*************************                5374</span><br><span class="line">      82.959 |*************************                5217</span><br><span class="line">      84.467 |***********************                  4957</span><br><span class="line">      86.002 |***********************                  4947</span><br><span class="line">      87.564 |**********************                   4767</span><br><span class="line">      89.155 |**********************                   4673</span><br><span class="line">      90.775 |*********************                    4499</span><br><span class="line">      92.424 |*********************                    4358</span><br><span class="line">      94.104 |********************                     4230</span><br><span class="line">      95.814 |*******************                      4021</span><br><span class="line">      97.555 |******************                       3871</span><br><span class="line">      99.327 |******************                       3750</span><br><span class="line">     101.132 |*****************                        3665</span><br><span class="line">     102.969 |****************                         3465</span><br><span class="line">     104.840 |****************                         3322</span><br><span class="line">     106.745 |***************                          3286</span><br><span class="line">     108.685 |**************                           3019</span><br><span class="line">     110.659 |**************                           2963</span><br><span class="line">     112.670 |*************                            2707</span><br><span class="line">     114.717 |*************                            2712</span><br><span class="line">     116.802 |************                             2528</span><br><span class="line">     118.924 |***********                              2379</span><br><span class="line">     121.085 |***********                              2269</span><br><span class="line">     123.285 |**********                               2138</span><br><span class="line">     125.525 |**********                               2105</span><br><span class="line">     127.805 |*********                                1861</span><br><span class="line">     130.128 |*********                                1820</span><br><span class="line">     132.492 |********                                 1735</span><br><span class="line">     134.899 |*******                                  1575</span><br><span class="line">     137.350 |*******                                  1502</span><br><span class="line">     139.846 |*******                                  1412</span><br><span class="line">     142.387 |******                                   1302</span><br><span class="line">     144.974 |******                                   1231</span><br><span class="line">     147.608 |*****                                    1056</span><br><span class="line">     150.290 |*****                                    1015</span><br><span class="line">     153.021 |****                                     927</span><br><span class="line">     155.801 |****                                     879</span><br><span class="line">     158.632 |****                                     815</span><br><span class="line">     161.514 |***                                      685</span><br><span class="line">     164.449 |***                                      696</span><br><span class="line">     167.437 |***                                      613</span><br><span class="line">     170.479 |***                                      591</span><br><span class="line">     173.577 |**                                       499</span><br><span class="line">     176.731 |**                                       457</span><br><span class="line">     179.942 |**                                       447</span><br><span class="line">     183.211 |**                                       360</span><br><span class="line">     186.540 |**                                       352</span><br><span class="line">     189.929 |*                                        298</span><br><span class="line">     193.380 |*                                        304</span><br><span class="line">     196.894 |*                                        224</span><br><span class="line">     200.472 |*                                        208</span><br><span class="line">     204.114 |*                                        204</span><br><span class="line">     207.823 |*                                        173</span><br><span class="line">     211.599 |*                                        155</span><br><span class="line">     215.443 |*                                        113</span><br><span class="line">     219.358 |*                                        129</span><br><span class="line">     223.344 |                                         106</span><br><span class="line">     227.402 |                                         82</span><br><span class="line">     231.534 |                                         67</span><br><span class="line">     235.740 |                                         66</span><br><span class="line">     240.024 |                                         43</span><br><span class="line">     244.385 |                                         53</span><br><span class="line">     248.825 |                                         30</span><br><span class="line">     253.346 |                                         31</span><br><span class="line">     257.950 |                                         26</span><br><span class="line">     262.636 |                                         19</span><br><span class="line">     267.408 |                                         25</span><br><span class="line">     272.267 |                                         12</span><br><span class="line">     277.214 |                                         11</span><br><span class="line">     282.251 |                                         11</span><br><span class="line">     287.379 |                                         11</span><br><span class="line">     292.601 |                                         5</span><br><span class="line">     297.917 |                                         11</span><br><span class="line">     303.330 |                                         5</span><br><span class="line">     308.842 |                                         6</span><br><span class="line">     314.453 |                                         14</span><br><span class="line">     320.167 |                                         10</span><br><span class="line">     325.984 |                                         16</span><br><span class="line">     331.907 |                                         11</span><br><span class="line">     337.938 |                                         2</span><br><span class="line">     344.078 |                                         8</span><br><span class="line">     350.330 |                                         10</span><br><span class="line">     356.695 |                                         11</span><br><span class="line">     363.176 |                                         10</span><br><span class="line">     369.775 |                                         15</span><br><span class="line">     376.494 |                                         12</span><br><span class="line">     383.334 |                                         14</span><br><span class="line">     390.299 |                                         10</span><br><span class="line">     397.391 |                                         5</span><br><span class="line">     404.611 |                                         11</span><br><span class="line">     411.963 |                                         2</span><br><span class="line">     419.448 |                                         11</span><br><span class="line">     427.069 |                                         7</span><br><span class="line">     434.829 |                                         6</span><br><span class="line">     442.730 |                                         6</span><br><span class="line">     450.774 |                                         5</span><br><span class="line">     458.964 |                                         2</span><br><span class="line">     475.794 |                                         1</span><br><span class="line">     484.439 |                                         2</span><br><span class="line">     493.242 |                                         1</span><br><span class="line">     559.501 |                                         1</span><br><span class="line"> </span><br><span class="line">SQL statistics:</span><br><span class="line">    queries performed:</span><br><span class="line">        read:                            11485432</span><br><span class="line">        write:                           3281552</span><br><span class="line">        other:                           1640776</span><br><span class="line">        total:                           16407760</span><br><span class="line">    transactions:                        820388 (1367.22 per sec.)</span><br><span class="line">    queries:                             16407760 (27344.47 per sec.)</span><br><span class="line">    ignored errors:                      0      (0.00 per sec.)</span><br><span class="line">    reconnects:                          0      (0.00 per sec.)</span><br><span class="line"></span><br><span class="line">General statistics:</span><br><span class="line">    total time:                          600.0372s</span><br><span class="line">    total number of events:              820388</span><br><span class="line"></span><br><span class="line">Latency (ms):</span><br><span class="line">         min:                                    4.30</span><br><span class="line">         avg:                                   46.80</span><br><span class="line">         max:                                  556.16</span><br><span class="line">         95th percentile:                      112.67</span><br><span class="line">         sum:                             38398062.70</span><br><span class="line"></span><br><span class="line">Threads fairness:</span><br><span class="line">    events (avg/stddev):           12818.5625/107.50</span><br><span class="line">    execution time (avg/stddev):   599.9697/0.01</span><br><span class="line"></span><br><span class="line">[root@10-10-135-172 benchmark]#</span><br></pre></td></tr></table></figure>

<br>

<h4 id="5-、清理数据"><a href="#5-、清理数据" class="headerlink" title="5)、清理数据"></a>5)、清理数据</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sysbench /usr/share/sysbench/oltp_read_write.lua --threads=64 --time=600 --histogram=on --mysql-host=10.10.135.172 --mysql-port=3306 --mysql-db=sbtest --mysql-user=root --table-size=10000000 cleanup</span><br></pre></td></tr></table></figure>

<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20191119190316.png" alt></p>
<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20191119190336.png" alt></p>
<br>

<h4 id="6-、分析收集到的状态"><a href="#6-、分析收集到的状态" class="headerlink" title="6)、分析收集到的状态"></a>6)、分析收集到的状态</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span> sh 2-system-status-analyzer.sh status_data/5-sec-status-2019-11-19_06-status &gt; status.txt</span><br><span class="line"><span class="meta">$</span> vi status.txt</span><br><span class="line">unix时间戳    时间            系统负载 QPS(数据库)</span><br><span class="line">1574160560 18:49:20 18:49:20 51.53 28179.80</span><br><span class="line">1574160565 18:49:25 18:49:25 51.80 26713.20</span><br><span class="line">1574160570 18:49:30 18:49:30 50.86 27784.60</span><br><span class="line">1574160575 18:49:35 18:49:35 51.19 26912.40</span><br><span class="line">1574160580 18:49:40 18:49:40 52.30 27048.20</span><br><span class="line">1574160585 18:49:45 18:49:45 52.99 26843.00</span><br><span class="line">1574160590 18:49:50 18:49:50 53.87 27478.80</span><br><span class="line">1574160595 18:49:55 18:49:55 54.61 28724.60</span><br><span class="line">1574160600 18:50:00 18:50:00 55.68 27960.00</span><br><span class="line">1574160605 18:50:05 18:50:05 55.46 25874.40</span><br><span class="line">1574160610 18:50:10 18:50:10 56.07 25936.40</span><br><span class="line">1574160615 18:50:15 18:50:15 52.54 25914.20</span><br><span class="line">1574160620 18:50:20 18:50:20 52.66 27237.60</span><br><span class="line">1574160625 18:50:25 18:50:25 52.92 27507.20</span><br><span class="line">1574160630 18:50:30 18:50:30 53.89 26005.40</span><br><span class="line">1574160635 18:50:35 18:50:35 55.02 26745.00</span><br><span class="line">1574160640 18:50:40 18:50:40 54.86 25643.80</span><br><span class="line">1574160645 18:50:45 18:50:45 55.75 24751.20</span><br><span class="line">1574160650 18:50:50 18:50:50 53.69 27608.80</span><br><span class="line">1574160655 18:50:55 18:50:55 52.51 26590.20</span><br><span class="line">1574160660 18:51:00 18:51:00 51.83 27411.60</span><br><span class="line">1574160665 18:51:05 18:51:05 49.68 28504.20</span><br><span class="line">1574160670 18:51:10 18:51:10 50.27 20451.00</span><br><span class="line">1574160675 18:51:15 18:51:15 46.24 1.40</span><br><span class="line">1574160680 18:51:20 18:51:20 42.62 2.20</span><br><span class="line">1574160685 18:51:25 18:51:25 39.21 1.40</span><br><span class="line">1574160690 18:51:30 18:51:30 36.07 1.80</span><br><span class="line">1574160695 18:51:35 18:51:35 33.18 2.40</span><br><span class="line">1574160700 18:51:40 18:51:40 30.52 1.00</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span> cat status_data/5-sec-status-2019-11-19_06-status | grep 'TS ' &gt; load_status.txt</span><br><span class="line"><span class="meta">$</span> vi load_status.txt</span><br><span class="line"></span><br><span class="line">TS 1574160295.047916883 18:44:55  18:44:55 up 1 day,  2:22,  5 users,  load average: 52.13, 24.94, 9.96</span><br><span class="line">TS 1574160300.059352736 18:45:00  18:45:00 up 1 day,  2:22,  5 users,  load average: 53.08, 25.59, 10.25</span><br><span class="line">TS 1574160305.042101201 18:45:05  18:45:05 up 1 day,  2:22,  5 users,  load average: 50.91, 25.60, 10.33</span><br><span class="line">TS 1574160310.052530257 18:45:10  18:45:10 up 1 day,  2:22,  5 users,  load average: 51.72, 26.19, 10.60</span><br><span class="line">TS 1574160315.046490819 18:45:15  18:45:15 up 1 day,  2:22,  5 users,  load average: 52.78, 26.83, 10.89</span><br><span class="line">TS 1574160320.008893450 18:45:20  18:45:20 up 1 day,  2:22,  5 users,  load average: 53.68, 27.45, 11.18</span><br><span class="line">TS 1574160325.203247981 18:45:25  18:45:25 up 1 day,  2:22,  5 users,  load average: 54.67, 28.09, 11.47</span><br><span class="line">TS 1574160330.118228229 18:45:30  18:45:30 up 1 day,  2:22,  5 users,  load average: 55.57, 28.72, 11.77</span><br><span class="line">TS 1574160335.016869072 18:45:35  18:45:35 up 1 day,  2:22,  5 users,  load average: 55.61, 29.17, 12.00</span><br><span class="line">TS 1574160340.042057908 18:45:40  18:45:40 up 1 day,  2:22,  5 users,  load average: 54.84, 29.45, 12.19</span><br><span class="line">TS 1574160345.056853963 18:45:45  18:45:45 up 1 day,  2:23,  5 users,  load average: 55.65, 30.04, 12.47</span><br><span class="line">TS 1574160350.059495691 18:45:50  18:45:50 up 1 day,  2:23,  5 users,  load average: 55.84, 30.50, 12.72</span><br><span class="line">TS 1574160355.238934528 18:45:55  18:45:55 up 1 day,  2:23,  5 users,  load average: 56.65, 31.09, 13.00</span><br><span class="line">TS 1574160360.115909774 18:46:00  18:46:00 up 1 day,  2:23,  5 users,  load average: 56.76, 31.54, 13.24</span><br><span class="line">TS 1574160365.067470620 18:46:05  18:46:05 up 1 day,  2:23,  5 users,  load average: 57.34, 32.08, 13.52</span><br><span class="line">TS 1574160370.111400548 18:46:10  18:46:10 up 1 day,  2:23,  5 users,  load average: 55.39, 32.09, 13.62</span><br><span class="line">TS 1574160375.074730081 18:46:15  18:46:15 up 1 day,  2:23,  5 users,  load average: 53.76, 32.14, 13.74</span><br><span class="line">TS 1574160380.210612654 18:46:20  18:46:20 up 1 day,  2:23,  5 users,  load average: 54.34, 32.62, 13.99</span><br><span class="line">TS 1574160385.102457806 18:46:25  18:46:25 up 1 day,  2:23,  5 users,  load average: 50.87, 32.26, 13.97</span><br><span class="line">TS 1574160390.117591568 18:46:30  18:46:30 up 1 day,  2:23,  5 users,  load average: 50.48, 32.49, 14.14</span><br><span class="line">TS 1574160395.076076309 18:46:35  18:46:35 up 1 day,  2:23,  5 users,  load average: 51.40, 32.98, 14.40</span><br><span class="line">TS 1574160400.191211227 18:46:40  18:46:40 up 1 day,  2:23,  5 users,  load average: 52.09, 33.43, 14.65</span><br><span class="line">TS 1574160405.153420741 18:46:45  18:46:45 up 1 day,  2:24,  5 users,  load average: 49.20, 33.14, 14.65</span><br><span class="line">TS 1574160410.013108072 18:46:50  18:46:50 up 1 day,  2:24,  5 users,  load average: 49.58, 33.49, 14.87</span><br><span class="line">TS 1574160415.084485731 18:46:55  18:46:55 up 1 day,  2:24,  5 users,  load average: 48.82, 33.59, 15.00</span><br><span class="line">TS 1574160420.011562959 18:47:00  18:47:00 up 1 day,  2:24,  5 users,  load average: 47.55, 33.58, 15.10</span><br><span class="line">TS 1574160425.018923271 18:47:05  18:47:05 up 1 day,  2:24,  5 users,  load average: 48.95, 34.11, 15.37</span><br></pre></td></tr></table></figure>

<br>

<h3 id="4、tpcc-mysql对mysql进行测试"><a href="#4、tpcc-mysql对mysql进行测试" class="headerlink" title="4、tpcc-mysql对mysql进行测试"></a>4、tpcc-mysql对mysql进行测试</h3><blockquote>
<ol>
<li>Build binaries<ul>
<li><code>cd src ; make</code> ( you should have mysql_config available in $PATH)</li>
</ul>
</li>
<li>Load data<ul>
<li>create database <code>mysqladmin create tpcc1000</code></li>
<li>create tables <code>mysql tpcc1000 &lt; create_table.sql</code></li>
<li>create indexes and FK ( this step can be done after loading data) <code>mysql tpcc1000 &lt; add_fkey_idx.sql</code></li>
<li>populate data<ul>
<li>simple step <code>tpcc_load -h127.0.0.1 -d tpcc1000 -u root -p &quot;&quot; -w 1000</code> |hostname:port| |dbname| |user| |password| |WAREHOUSES| ref. tpcc_load –help for all options</li>
<li>load data in parallel check load.sh script</li>
</ul>
</li>
</ul>
</li>
<li>Start benchmark<ul>
<li><code>./tpcc_start -h127.0.0.1 -P3306 -dtpcc1000 -uroot -w1000 -c32 -r10 -l10800</code></li>
<li>|hostname| |port| |dbname| |user| |WAREHOUSES| |CONNECTIONS| |WARMUP TIME| |BENCHMARK TIME|</li>
<li>ref. tpcc_start –help for all options</li>
</ul>
</li>
</ol>
</blockquote>
<h4 id="1-、-创建数据库和表结构"><a href="#1-、-创建数据库和表结构" class="headerlink" title="1)、 创建数据库和表结构"></a>1)、 创建数据库和表结构</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cd tpcc-mysql-master</span><br><span class="line"></span><br><span class="line">mysqladmin create tpcc1000 -uroot -p123456</span><br><span class="line">mysql -uroot -p123456 tpcc1000 &lt; create_table.sql</span><br><span class="line">mysql -uroot -p123456 tpcc1000 &lt; add_fkey_idx.sql</span><br></pre></td></tr></table></figure>

<h4 id="2-、加载数据"><a href="#2-、加载数据" class="headerlink" title="2)、加载数据"></a>2)、加载数据</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">./tpcc_load -h10.10.135.172 -P3306 -d tpcc1000 -u root -p 123456 -w 10</span><br><span class="line"><span class="meta">#</span> 1 代表1个仓库大小，10代表 10个仓库大小</span><br><span class="line"><span class="meta">#</span> sh load.sh tpcc1000 1000</span><br></pre></td></tr></table></figure>

<p>加载完后查看数据量</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">count</span>(*) <span class="keyword">from</span> tpcc1000.customer;</span><br><span class="line"><span class="keyword">select</span> <span class="keyword">count</span>(*) <span class="keyword">from</span> tpcc1000.district;</span><br><span class="line"><span class="keyword">select</span> <span class="keyword">count</span>(*) <span class="keyword">from</span> tpcc1000.history;</span><br><span class="line"><span class="keyword">select</span> <span class="keyword">count</span>(*) <span class="keyword">from</span> tpcc1000.item;</span><br><span class="line"><span class="keyword">select</span> <span class="keyword">count</span>(*) <span class="keyword">from</span> tpcc1000.new_orders;</span><br><span class="line"><span class="keyword">select</span> <span class="keyword">count</span>(*) <span class="keyword">from</span> tpcc1000.order_line;</span><br><span class="line"><span class="keyword">select</span> <span class="keyword">count</span>(*) <span class="keyword">from</span> tpcc1000.orders;</span><br><span class="line"><span class="keyword">select</span> <span class="keyword">count</span>(*) <span class="keyword">from</span> tpcc1000.stock;</span><br><span class="line"><span class="keyword">select</span> <span class="keyword">count</span>(*) <span class="keyword">from</span> tpcc1000.warehouse;</span><br></pre></td></tr></table></figure>

<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20191119201805.png" alt></p>
<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20191119195506.png" alt></p>
<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20191119202942.png" alt></p>
<br>

<h4 id="3-、运行状态收集脚本"><a href="#3-、运行状态收集脚本" class="headerlink" title="3)、运行状态收集脚本"></a>3)、运行状态收集脚本</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sh /root/benchmark/1-collect-system-status.sh</span><br></pre></td></tr></table></figure>

<h4 id="4-、执行测试"><a href="#4-、执行测试" class="headerlink" title="4)、执行测试"></a>4)、执行测试</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> -w 指定仓库数量</span><br><span class="line"><span class="meta">#</span> -c 指定并发连接数</span><br><span class="line"><span class="meta">#</span> -r 指定开始测试前进行warmup的时间，进行预热后，测试效果更好</span><br><span class="line"><span class="meta">#</span> -l 指定测试持续时间</span><br><span class="line"><span class="meta">#</span> -i 指定生成报告间隔时长</span><br><span class="line"><span class="meta">#</span> -f 指定生成的报告文件名</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 真实测试场景中，建议预热时间不小于5分钟，持续压测时长不小于30分钟，否则测试数据可能不具参考意义</span><br><span class="line"><span class="meta">#</span> 耗时：1800, 即 30分钟</span><br><span class="line">./tpcc_start -h10.10.135.172 -P3306 -dtpcc1000 -uroot -p123456 -w10 -c32 -r300 -l1800 &gt; tpcc_output.txt</span><br></pre></td></tr></table></figure>

<p>top</p>
<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20191119203105.png" alt></p>
<p>vmstat 1</p>
<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20191119203144.png" alt></p>
<p>执行结果</p>
<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20191120101926.png" alt></p>
<br>

<h4 id="5-、分析收集到的状态数据"><a href="#5-、分析收集到的状态数据" class="headerlink" title="5)、分析收集到的状态数据"></a>5)、分析收集到的状态数据</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span> sh 2-system-status-analyzer.sh status_data/5-sec-status-2019-11-19_06-status &gt; status.txt</span><br><span class="line"><span class="meta">$</span> vi status.txt</span><br><span class="line">unix时间戳    时间              系统负载 QPS(数据库)</span><br><span class="line">1574177360 2019-11-19 23:29:20 22.00 37156.60</span><br><span class="line">1574177365 2019-11-19 23:29:25 20.24 36821.80</span><br><span class="line">1574177370 2019-11-19 23:29:30 21.26 36879.80</span><br><span class="line">1574177375 2019-11-19 23:29:35 19.56 37217.60</span><br><span class="line">1574177380 2019-11-19 23:29:40 20.63 37646.80</span><br><span class="line">1574177385 2019-11-19 23:29:45 21.62 35293.20</span><br><span class="line">1574177390 2019-11-19 23:29:50 19.89 36457.80</span><br><span class="line">1574177395 2019-11-19 23:29:55 18.30 37464.00</span><br><span class="line">1574177400 2019-11-19 23:30:00 19.72 36722.60</span><br><span class="line">1574177405 2019-11-19 23:30:05 20.78 37913.60</span><br><span class="line">1574177410 2019-11-19 23:30:10 19.12 36294.00</span><br><span class="line">1574177415 2019-11-19 23:30:15 17.58 35279.20</span><br><span class="line">1574177420 2019-11-19 23:30:20 18.98 39051.20</span><br><span class="line">1574177425 2019-11-19 23:30:25 20.10 37700.20</span><br><span class="line">1574177430 2019-11-19 23:30:30 18.49 37632.20</span><br><span class="line">1574177435 2019-11-19 23:30:35 17.01 38068.00</span><br><span class="line">1574177440 2019-11-19 23:30:40 15.65 38218.40</span><br><span class="line">1574177445 2019-11-19 23:30:45 14.48 34143.40</span><br><span class="line">1574177450 2019-11-19 23:30:50 13.40 7794.60</span><br><span class="line">1574177455 2019-11-19 23:30:55 12.40 7744.80</span><br><span class="line">1574177460 2019-11-19 23:31:00 11.41 613.40</span><br><span class="line">1574177465 2019-11-19 23:31:05 10.50 2.20</span><br><span class="line">1574177470 2019-11-19 23:31:10 9.66 1.40</span><br><span class="line">1574177475 2019-11-19 23:31:15 8.88 1.80</span><br><span class="line">1574177480 2019-11-19 23:31:20 8.17 1.80</span><br><span class="line">1574177485 2019-11-19 23:31:25 7.52 1.80</span><br><span class="line">1574177490 2019-11-19 23:31:30 6.92 2.00</span><br><span class="line">1574177495 2019-11-19 23:31:35 6.36 2.00</span><br><span class="line">1574177500 2019-11-19 23:31:40 5.85 1.60</span><br></pre></td></tr></table></figure>

<p>vi tpcc_output.txt</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line">***************************************</span><br><span class="line">*** ###easy### TPC-C Load Generator ***</span><br><span class="line">***************************************</span><br><span class="line">option h with value '10.10.135.172'</span><br><span class="line">option P with value '3306'</span><br><span class="line">option d with value 'tpcc1000'</span><br><span class="line">option u with value 'root'</span><br><span class="line">option p with value '123456'</span><br><span class="line">option w with value '10'</span><br><span class="line">option c with value '32'</span><br><span class="line">option r with value '300'</span><br><span class="line">option l with value '1800'</span><br><span class="line">&lt;Parameters&gt;</span><br><span class="line">     [server]: 10.10.135.172   -- 主机</span><br><span class="line">     [port]: 3306              -- 端口</span><br><span class="line">     [DBname]: tpcc1000        -- 压测的数据库</span><br><span class="line">       [user]: root            -- 账号</span><br><span class="line">       [pass]: 123456          -- 密码</span><br><span class="line">  [warehouse]: 10              -- 仓库数</span><br><span class="line"> [connection]: 32              -- 并发线程数 </span><br><span class="line">     [rampup]: 300 (sec.)      -- 数据预热时长 </span><br><span class="line">    [measure]: 1800 (sec.)     -- 压测时长</span><br><span class="line"></span><br><span class="line">RAMP-UP TIME.(300 sec.)       --预热结束</span><br><span class="line"></span><br><span class="line">MEASURING START.              --开始压测</span><br><span class="line"></span><br><span class="line">-- 每10秒输出一次压测数据</span><br><span class="line">-- 以逗号分隔，共9列</span><br><span class="line">-- 第1列，第N次10秒</span><br><span class="line">-- 第2列，New-Order在本轮取样时间内成功执行事务的次数(即吞吐量)</span><br><span class="line">-- 第3列，New-Order在本轮取样时间内，95%事务 在响应时间内（ms）完成</span><br><span class="line">-- 第4列，New-Order在本轮取样时间内，99%事务 在响应时间内完成</span><br><span class="line">-- 第5列，New-Order在本轮取样时间内，本轮测试最大响应时间（ms）</span><br><span class="line">-- 第6列，Payment 有效事务数（吞吐量） | 最大响应时间（ms）</span><br><span class="line">-- 第7列，Order-Status 有效事务数（吞吐量） | 最大响应时间（ms）</span><br><span class="line">-- 第8列，Delivery 有效事务数（吞吐量） | 最大响应时间（ms）</span><br><span class="line">-- 第9列，Stock-Level 有效事务数（吞吐量） | 最大响应时间（ms）</span><br><span class="line">  10, trx: 6322, 95%: 58.880, 99%: 80.384, max_rt: 465.298, 6319|311.356, 632|147.998, 633|518.363, 632|840.708</span><br><span class="line">  20, trx: 6402, 95%: 57.161, 99%: 74.165, max_rt: 108.881, 6399|102.155, 640|54.569, 640|187.683, 641|125.100</span><br><span class="line">  30, trx: 6215, 95%: 58.616, 99%: 83.674, max_rt: 240.631, 6224|149.658, 623|135.217, 622|332.418, 621|168.763</span><br><span class="line">  40, trx: 6365, 95%: 57.109, 99%: 76.190, max_rt: 136.020, 6362|140.110, 637|35.815, 637|142.510, 636|154.135</span><br><span class="line">  50, trx: 6426, 95%: 56.973, 99%: 76.281, max_rt: 131.508, 6427|171.652, 641|45.733, 640|145.872, 643|156.595</span><br><span class="line">  60, trx: 6198, 95%: 58.476, 99%: 80.384, max_rt: 229.300, 6197|238.621, 620|37.124, 621|269.572, 619|261.585</span><br><span class="line">  70, trx: 6418, 95%: 57.366, 99%: 76.648, max_rt: 116.301, 6421|115.735, 643|42.165, 643|172.855, 643|151.629</span><br><span class="line">  80, trx: 6406, 95%: 57.815, 99%: 76.877, max_rt: 115.657, 6396|99.119, 639|39.815, 640|152.090, 640|159.341</span><br><span class="line">  90, trx: 5841, 95%: 62.047, 99%: 87.229, max_rt: 290.416, 5836|291.379, 584|42.550, 585|301.866, 584|142.273</span><br><span class="line"> 100, trx: 6168, 95%: 56.362, 99%: 76.717, max_rt: 125.903, 6183|115.971, 618|47.143, 619|158.824, 618|162.145</span><br><span class="line"> 110, trx: 6249, 95%: 57.573, 99%: 78.200, max_rt: 138.199, 6232|126.211, 624|40.234, 623|155.532, 624|152.938</span><br><span class="line"> 120, trx: 6107, 95%: 58.511, 99%: 78.694, max_rt: 121.301, 6125|146.152, 611|37.128, 608|156.622, 609|126.521</span><br><span class="line"> 130, trx: 6076, 95%: 58.424, 99%: 84.227, max_rt: 346.854, 6074|266.228, 608|48.112, 608|361.008, 610|140.032</span><br><span class="line"> 140, trx: 6365, 95%: 55.992, 99%: 75.599, max_rt: 115.579, 6367|110.699, 637|47.943, 637|156.809, 634|126.359</span><br><span class="line">....</span><br><span class="line">1760, trx: 6386, 95%: 56.599, 99%: 74.588, max_rt: 115.095, 6386|103.424, 638|44.586, 640|143.890, 637|139.005</span><br><span class="line">1770, trx: 6148, 95%: 59.039, 99%: 76.510, max_rt: 124.202, 6149|99.945, 615|37.548, 612|152.861, 615|157.265</span><br><span class="line">1780, trx: 5831, 95%: 59.786, 99%: 82.061, max_rt: 291.887, 5826|335.447, 583|47.130, 585|365.992, 583|156.420</span><br><span class="line">1790, trx: 6161, 95%: 57.676, 99%: 78.294, max_rt: 130.952, 6162|132.039, 616|46.349, 616|149.911, 615|173.092</span><br><span class="line">1800, trx: 6164, 95%: 56.295, 99%: 74.098, max_rt: 117.632, 6169|131.690, 616|39.105, 616|202.839, 618|126.449</span><br><span class="line"></span><br><span class="line">STOPPING THREADS................................          -- 结束压测</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 成功(success,简写sc)次数，延迟(late,简写lt)次数，重试(retry,简写rt)次数，失败(failure,简写fl)次数</span><br><span class="line">&lt;Raw Results&gt;                                             -- 第一次统计结果</span><br><span class="line">  [0] sc:35421 lt:1093057  rt:0  fl:0 avg_rt: 30.0 (5)    -- New-Order，新订单业务</span><br><span class="line">  [1] sc:457714 lt:670742  rt:0  fl:0 avg_rt: 15.6 (5)    -- Payment，支付业务统计</span><br><span class="line">  [2] sc:96544 lt:16304  rt:0  fl:0 avg_rt: 3.6 (5)       -- Order-Status，订单状态业务统计</span><br><span class="line">  [3] sc:87922 lt:24927  rt:0  fl:0 avg_rt: 72.5 (80)     -- Delivery，发货业务统计</span><br><span class="line">  [4] sc:1565 lt:111282  rt:0  fl:0 avg_rt: 62.8 (20)     -- Stock-Level，库存业务统计</span><br><span class="line"> in 1800 sec.</span><br><span class="line"></span><br><span class="line">&lt;Raw Results2(sum ver.)&gt;                                  -- 第二次统计结果，其他同上</span><br><span class="line">  [0] sc:35421  lt:1093057  rt:0  fl:0</span><br><span class="line">  [1] sc:457717  lt:670764  rt:0  fl:0</span><br><span class="line">  [2] sc:96544  lt:16304  rt:0  fl:0</span><br><span class="line">  [3] sc:87922  lt:24927  rt:0  fl:0</span><br><span class="line">  [4] sc:1565  lt:111283  rt:0  fl:0</span><br><span class="line"></span><br><span class="line">&lt;Constraint Check&gt; (all must be [OK])     -- 下面所有业务逻辑结果都必须为 OK 才行</span><br><span class="line"> [transaction percentage]</span><br><span class="line">        Payment: 43.48% (&gt;=43.0%) [OK]    -- 支付成功次数(上述统计结果中sc + lt)必须大于43.0%，否则结果为NG，而不是OK</span><br><span class="line">   Order-Status: 4.35% (&gt;= 4.0%) [OK]     --订单状态，其他同上</span><br><span class="line">       Delivery: 4.35% (&gt;= 4.0%) [OK]     -- 发货，其他同上</span><br><span class="line">    Stock-Level: 4.35% (&gt;= 4.0%) [OK]     -- 库存，其他同上</span><br><span class="line"> [response time (at least 90% passed)]    -- 响应耗时指标必须超过90%通过才行</span><br><span class="line">      New-Order: 3.14%  [NG] *            -- 标准5ms，只有3.14% 响应时间合格</span><br><span class="line">        Payment: 40.56%  [NG] *           -- 标准5ms，</span><br><span class="line">   Order-Status: 85.55%  [NG] *           -- 标准5ms，</span><br><span class="line">       Delivery: 77.91%  [NG] *           -- 标准80ms，</span><br><span class="line">    Stock-Level: 1.39%  [NG] *            -- 标准20ms，</span><br><span class="line"></span><br><span class="line">&lt;TpmC&gt;</span><br><span class="line">                 37615.934 TpmC          -- TpmC结果值&#123;每分钟事务数，该值是第一次统计结果中的新订单事务数除以总耗时分钟数，例如本例中是：（35421+1093057）/30 ≈ 37615.93..&#125;；1000tpmC相当于2000个事务；</span><br></pre></td></tr></table></figure>

<blockquote>
<p>tpcc-mysql的业务逻辑及其相关的几个表作用如下：</p>
<ul>
<li>New-Order：新订单，一次完整的订单事务，几乎涉及到全部表</li>
<li>Payment：支付，主要对应 orders、history 表</li>
<li>Order-Status：订单状态，主要对应 orders、order_line 表</li>
<li>Delivery：发货，主要对应 order_line 表</li>
<li>Stock-Level：库存，主要对应 stock 表</li>
</ul>
<p>其它表说明:</p>
<ul>
<li>客户：主要对应 customer 表</li>
<li>地区：主要对应 district 表</li>
<li>商品：主要对应 item 表</li>
<li>仓库：主要对应 warehouse 表</li>
</ul>
</blockquote>
<br>

<h4 id="6-、清理数据"><a href="#6-、清理数据" class="headerlink" title="6)、清理数据"></a>6)、清理数据</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">drop database tpcc1000;</span><br></pre></td></tr></table></figure>

<h4 id="7-、使用gunplot绘图"><a href="#7-、使用gunplot绘图" class="headerlink" title="7)、使用gunplot绘图"></a>7)、使用gunplot绘图</h4><p>① 安装 gunplot</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">yum install -y gnuplot</span><br><span class="line"></span><br><span class="line">gnuplot -V</span><br><span class="line"><span class="meta">#</span> gnuplot 4.6 patchlevel 2</span><br></pre></td></tr></table></figure>

<p>帮助文档： <a href="http://gnuplot.info/docs_4.6/gnuplot.pdf" target="_blank" rel="noopener">http://gnuplot.info/docs_4.6/gnuplot.pdf</a> </p>
<p>② 准备分析脚本和绘图脚本</p>
<p>gunplot-analyze-tpcc.sh</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span>!/bin/bash</span><br><span class="line">TIMESLOT=1</span><br><span class="line"></span><br><span class="line">if [ -n "$2" ]</span><br><span class="line">then</span><br><span class="line">    TIMESLOT=$2</span><br><span class="line">    echo "Defined $2"</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">cat $1 | grep -v HY000 | grep -v payment | grep -v neword | \</span><br><span class="line">awk -v timeslot=$TIMESLOT '\</span><br><span class="line">BEGIN &#123; FS="[,():|]"; s=0; cntr=0; aggr=0 &#125; \</span><br><span class="line">/MEASURING START/ &#123;s=1&#125; \</span><br><span class="line">/STOPPING THREADS/ &#123;s=0&#125; \</span><br><span class="line">/0/ &#123; \</span><br><span class="line">    if (s==1) &#123; cntr++; aggr+=$2; &#125; \</span><br><span class="line">    if (cntr==timeslot ) &#123; printf ("%d %3f %d\n",$1,$5,$3) ; cntr=0; aggr=0  &#125; \</span><br><span class="line">&#125;'</span><br></pre></td></tr></table></figure>

<blockquote>
<p>解释： 把 <code>140, trx: 6365, 95%: 55.992, 99%: 75.599, max_rt: 115.579, 6367|110.699, 637|47.943, 637|156.809, 634|126.359</code>中的 “[,():|]” 字符去掉以后，就剩下了<code>140 trx 6365 95% 55.992 99% 75.599 max_rt 115.579 6367 110.699 637 47.943 637 156.809 634 126.359</code>。$1就是140， $5就是55.992，打印的语法就跟c语言一样</p>
<p>帮助文档：man awk</p>
</blockquote>
<p>③ 对 tpcc-mysql 测试生成的数据文件进行提取</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sh gunplot-analyze-tpcc.sh tpcc_output.txt &gt; tpcc_output_transfer.txt</span><br></pre></td></tr></table></figure>

<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20191120200034.png" alt></p>
<p>④  使用tpcc-graph-build.sh脚本生成图表 </p>
<ul>
<li>画95%的事务响应时间图：gunplot-graph-build-rt.sh</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span>!/bin/bash</span><br><span class="line"><span class="meta">#</span>## goto user homedir and remove previous file</span><br><span class="line">rm -f '$2'</span><br><span class="line">gnuplot &lt;&lt; EOP</span><br><span class="line"><span class="meta">#</span>## set data source file</span><br><span class="line">datafile = '$1'</span><br><span class="line"><span class="meta">#</span>## set graph type and size</span><br><span class="line">set terminal jpeg size 720,640</span><br><span class="line"><span class="meta">#</span>## set titles</span><br><span class="line">set grid x y</span><br><span class="line">set xlabel "Time (sec)"</span><br><span class="line">set ylabel "Response Times(sec)"</span><br><span class="line"><span class="meta">#</span>## set output filename</span><br><span class="line">set output '$2'</span><br><span class="line"><span class="meta">#</span>## build graph</span><br><span class="line"><span class="meta">#</span> plot datafile using 1:2 title "95%-rt" with lines,datafile using 1:3 title "max_rt" with lines axes x1y1</span><br><span class="line">plot datafile using 1:2 title "95%-rt" with lines axes x1y1</span><br><span class="line">EOP</span><br></pre></td></tr></table></figure>

<ul>
<li>画间隔时间内完成的事务数的图：gunplot-graph-build-trx.sh</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span>!/bin/bash</span><br><span class="line"><span class="meta">#</span>## goto user homedir and remove previous file</span><br><span class="line">rm -f '$2'</span><br><span class="line">gnuplot &lt;&lt; EOP</span><br><span class="line"><span class="meta">#</span>## set data source file</span><br><span class="line">datafile = '$1'</span><br><span class="line"><span class="meta">#</span>## set graph type and size</span><br><span class="line">set terminal jpeg size 720,640</span><br><span class="line"><span class="meta">#</span>## set titles</span><br><span class="line">set grid x y</span><br><span class="line">set xlabel "Time (sec)"</span><br><span class="line">set ylabel "Transaction Nums"</span><br><span class="line"><span class="meta">#</span>## set output filename</span><br><span class="line">set output '$2'</span><br><span class="line"><span class="meta">#</span>## build graph</span><br><span class="line"><span class="meta">#</span> plot datafile using 1:2 title "95%-rt" with lines,datafile using 1:3 title "max_rt" with lines axes x1y1</span><br><span class="line">plot datafile using 1:3 title "Transaction Nums" with lines axes x1y1</span><br><span class="line">EOP</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sh gunplot-graph-build-rt.sh tpcc_output_transfer.txt tpcc_output.jpg</span><br></pre></td></tr></table></figure>

<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20191120200505.png" alt></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sh gunplot-graph-build-trx.sh tpcc_output_transfer.txt tpcc_output.jpg</span><br></pre></td></tr></table></figure>

<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20191120200955.png" alt></p>
<br>

<h1 id="五、mysql性能调优"><a href="#五、mysql性能调优" class="headerlink" title="五、mysql性能调优"></a>五、mysql性能调优</h1><p>可以看到tpcc-mysql基准测试中 rt项全部不合格，所以需要对mysql进行性能调优</p>
<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20191120134255.png" alt></p>
<br>


          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://carlo-z.com/linux/linux-cache-and-buffer/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Focus-1">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Focus-1">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/linux/linux-cache-and-buffer/" itemprop="url">Centos7 管理 buff/cache 方法</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-11-17T00:00:00+08:00">
                2019-11-17
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/linux/" itemprop="url" rel="index">
                    <span itemprop="name">linux</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <hr>
<br>

<h1 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h1><p>　　Linux服务器运行一段时间后，由于其内存管理机制，会将暂时不用的内存转为buff/cache，这样在程序使用到这一部分数据时，能够很快的取出，从而提高系统的运行效率，所以这也正是linux内存管理中非常出色的一点，所以乍一看内存剩余的非常少，但是在程序真正需要内存空间时，linux会将缓存让出给程序使用，这样达到对内存的最充分利用，所以真正剩余的内存是free+buff/cache</p>
<p>　　但是有些时候大量的缓存占据空间，这时候应用程序回去使用swap交换空间，从而使系统变慢，这时候需要手动去释放内存，释放内存的时候，首先执行命令 <code>sync 将所有正在内存中的缓冲区写到磁盘中，其中包括已经修改的文件inode、已延迟的块I/O以及读写映射文件，从而确保文件系统的完整性</code></p>
<br>

<h1 id="linux机制"><a href="#linux机制" class="headerlink" title="linux机制"></a>linux机制</h1><p>　　说到清理内存，那么不得不提到/proc这一个虚拟文件系统，这里面的数据和文件都是内存中的实时数据，很多参数的获取都可以从下面相应的文件中得到，比如查看某一进程占用的内存大小和各项参数，cpu和主板的详细信息，显卡的参数等等；相应的关于内存的管理方式是在/proc/sys/vm/drop_chches文件中，一定要注意这个文件中存放的并不是具体的内存内容，而是0-3这几个数字，通过文件大小只有1B也可以知道，而这些代号分别告诉系统代表不同的含义如下：</p>
<ul>
<li>0：0是系统默认值，默认情况下表示不释放内存，由操作系统自动管理</li>
<li>1：释放页缓存</li>
<li>2：释放dentries和inodes</li>
<li>3：释放所有缓存</li>
</ul>
<p>　　所以根据上面的说明，分别将1,2,3这3个数字重定向到drop_caches中可以实现内存的释放，一般释放内存都是重定向3到文件中，释放所有的缓存</p>
<br>

<h1 id="使用方法"><a href="#使用方法" class="headerlink" title="使用方法"></a>使用方法</h1><p>那么下面举个例子，比如这里只释放页缓存，首先使用</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">free -m</span><br></pre></td></tr></table></figure>

<p>查看当前内存剩余</p>
<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20191117173637.png" alt></p>
<p>当前内存剩余570M左右，另外buff/cache是1.3G，根据上面说的现在真正的剩余内存应该是1.8G左右，首先写缓存到文件系统：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sync</span><br></pre></td></tr></table></figure>

<p>然后执行下面命令释放内存(页缓存buff/cache)：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo 1 &gt; /proc/sys/vm/drop_caches</span><br></pre></td></tr></table></figure>

<p>执行完之后，再次查看内存剩余：</p>
<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20191117173925.png" alt></p>
<p>会发现内存被释放了，可用内存确实变为1.5G左右</p>
<p>　　到这里内存就释放完了，现在drop_caches中的值为1，如果现在想让操作系统重新分配内存，那么设置drop_caches的值为0即可：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo 0 &gt; /proc/sys/vm/drop_caches</span><br></pre></td></tr></table></figure>

<p><strong>但是我走到这里报错，从0可以设置为1-3 ，但是不能设置为0了。一直没有找到原因，最后直接重启服务器了，然后开机之后自己恢复成0了。</strong></p>
<p><strong>所以命令慎用！！！</strong></p>
<p>另外需要注意的是，在生产环境中的服务器我们不要频繁的去释放内存，只在必要时候清理内存即可，更重要的是我们应该从应用程序层面去优化内存的利用和释放，经常清理内存可能只是暂时屏蔽的应用程序中的一些bug，所以更重要的是程序的调优，其他的交给操作系统来管理</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://carlo-z.com/computer-network/keepalived-vrrp/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Focus-1">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Focus-1">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/computer-network/keepalived-vrrp/" itemprop="url">keepalived+ip组播</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-11-14T00:00:00+08:00">
                2019-11-14
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/computer-network/" itemprop="url" rel="index">
                    <span itemprop="name">computer-network</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/computer-network/keepalived/" itemprop="url" rel="index">
                    <span itemprop="name">keepalived</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <hr>
<br>

<h1 id="开启ip组播"><a href="#开启ip组播" class="headerlink" title="开启ip组播"></a>开启ip组播</h1><h3 id="centos7"><a href="#centos7" class="headerlink" title="centos7"></a>centos7</h3><h3 id="centos6"><a href="#centos6" class="headerlink" title="centos6"></a>centos6</h3><h1 id="keepalived安装配置"><a href="#keepalived安装配置" class="headerlink" title="keepalived安装配置"></a>keepalived安装配置</h1><p>2台主机</p>
<table>
<thead>
<tr>
<th>server</th>
<th>hostname</th>
<th>ip</th>
</tr>
</thead>
<tbody><tr>
<td>keepalived</td>
<td>ka1</td>
<td>192.168.99.103</td>
</tr>
<tr>
<td>keepalived</td>
<td>ka2</td>
<td>192.168.99.104</td>
</tr>
</tbody></table>
<hr>
<h3 id="1、2台分别安装keepalived"><a href="#1、2台分别安装keepalived" class="headerlink" title="1、2台分别安装keepalived"></a>1、2台分别安装keepalived</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">[ka1]$</span> yum -y install keepalived</span><br><span class="line"><span class="meta">[ka2]$</span> yum -y install keepalived</span><br></pre></td></tr></table></figure>

<h3 id="2、修改ka1的配置"><a href="#2、修改ka1的配置" class="headerlink" title="2、修改ka1的配置"></a>2、修改ka1的配置</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">[ka1]#</span> vim /etc/keepalived/keepalived.conf</span><br><span class="line">! Configuration File for keepalived</span><br><span class="line"></span><br><span class="line">global_defs &#123;</span><br><span class="line">   notification_email &#123;</span><br><span class="line">       root@localhost</span><br><span class="line">   &#125;</span><br><span class="line">   notification_email_from root@localhost</span><br><span class="line">   smtp_server 127.0.0.1</span><br><span class="line">   smtp_connect_timeout 30</span><br><span class="line">   router_id ka1</span><br><span class="line">   vrrp_skip_check_adv_addr</span><br><span class="line">   vrrp_strict</span><br><span class="line">   vrrp_iptables</span><br><span class="line">   vrrp_mcast_group4 224.100.100.100   #不写默认是224.0.0.18</span><br><span class="line">   vrrp_garp_interval 0</span><br><span class="line">   vrrp_gna_interval 0</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state MASTER</span><br><span class="line">    interface eth0</span><br><span class="line">    virtual_router_id 11</span><br><span class="line">    priority 100</span><br><span class="line">    advert_int 1</span><br><span class="line">    #nopreempt   #非抢占模式，当优先级更高的主机上线时，不会抢占为主服务器</span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass 123</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        192.168.0.100 dev eth0 label eth0:1</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3、修改ka2的配置"><a href="#3、修改ka2的配置" class="headerlink" title="3、修改ka2的配置"></a>3、修改ka2的配置</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">! Configuration File for keepalived</span><br><span class="line"></span><br><span class="line">global_defs &#123;</span><br><span class="line">   notification_email &#123;</span><br><span class="line">       root@localhost</span><br><span class="line">   &#125;</span><br><span class="line">   notification_email_from root@localhost</span><br><span class="line">   smtp_server 127.0.0.1</span><br><span class="line">   smtp_connect_timeout 30</span><br><span class="line">   router_id ka2</span><br><span class="line">   vrrp_skip_check_adv_addr</span><br><span class="line">   vrrp_strict</span><br><span class="line">   vrrp_iptables</span><br><span class="line">   vrrp_mcast_group4 224.100.100.100   #不写默认是224.0.0.18</span><br><span class="line">   vrrp_garp_interval 0</span><br><span class="line">   vrrp_gna_interval 0</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state BACKUP</span><br><span class="line">    interface eth0</span><br><span class="line">    virtual_router_id 11</span><br><span class="line">    priority 80</span><br><span class="line">    advert_int 1</span><br><span class="line">    #nopreempt   #非抢占模式，当优先级更高的主机上线时，不会抢占为主服务器</span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass 123</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        192.168.0.100 dev eth0 label eth0:1</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="4、在ka1或ka2新开个终端准备抓包"><a href="#4、在ka1或ka2新开个终端准备抓包" class="headerlink" title="4、在ka1或ka2新开个终端准备抓包"></a>4、在ka1或ka2新开个终端准备抓包</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">[ka1]$</span> tcpdump -i eth0 -nn net 224.100.100.100</span><br><span class="line"></span><br><span class="line">tcpdump: verbose output suppressed, use -v or -vv for full protocol decode</span><br><span class="line">listening on eth0, link-type EN10MB (Ethernet), capture size 262144 bytes</span><br></pre></td></tr></table></figure>

<p>5、启动ka2的keepalived(先启动backup)</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">[ka2]$</span> systemctl restart keepalived</span><br></pre></td></tr></table></figure>

<p>抓到包了。</p>
<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20200114223152.png" alt></p>
<p>VIP绑定上了</p>
<h3 id="6、再启动ka1的keepalived-注意看抓包"><a href="#6、再启动ka1的keepalived-注意看抓包" class="headerlink" title="6、再启动ka1的keepalived(注意看抓包)"></a>6、再启动ka1的keepalived(注意看抓包)</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">[ka1]$</span> systemctl start keepalived</span><br></pre></td></tr></table></figure>

<p>可以看到，宣告的IP变成了ka1的了</p>
<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20200114223237.png" alt></p>
<p>VIP漂移到ka1了，因为ka1的优先级比ka2高</p>
<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20200114223253.png" alt></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://carlo-z.com/mysql/mysql-innodb-conf-optimize/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Focus-1">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Focus-1">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/mysql/mysql-innodb-conf-optimize/" itemprop="url">mysql配置优化</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-11-14T00:00:00+08:00">
                2019-11-14
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/mysql/" itemprop="url" rel="index">
                    <span itemprop="name">mysql</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <hr>
<p>要做优化工作首先要了解 mysql 的 架构设计，针对每个功能点做优化</p>
<br>

<h1 id="一、整体架构优化"><a href="#一、整体架构优化" class="headerlink" title="一、整体架构优化"></a>一、整体架构优化</h1><p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20191122160128.png" alt></p>
<h3 id="1、连接管理器"><a href="#1、连接管理器" class="headerlink" title="1、连接管理器"></a>1、连接管理器</h3><p><strong><em>参数概览</em></strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> show variables like <span class="string">'%conn%'</span>;</span></span><br><span class="line">+-----------------------------------------------+-----------------+</span><br><span class="line">| Variable_name                                 | Value           |</span><br><span class="line">+-----------------------------------------------+-----------------+</span><br><span class="line">| character_set_connection                      | utf8            |</span><br><span class="line">| collation_connection                          | utf8_general_ci |</span><br><span class="line">| connect_timeout                               | 10              |</span><br><span class="line">| disconnect_on_expired_password                | ON              |</span><br><span class="line">| init_connect                                  |                 |</span><br><span class="line">| max_connect_errors                            | 1000000         |</span><br><span class="line">| max_connections                               | 2000            |</span><br><span class="line">| max_user_connections                          | 0               |</span><br><span class="line">| performance_schema_session_connect_attrs_size | -1              |</span><br><span class="line">+-----------------------------------------------+-----------------+</span><br><span class="line">9 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure>

<ul>
<li>open_files_limit=1000000 # 文件描述符数量限制</li>
<li>character_set_connection=utf8mb4 # 连接使用的编码</li>
<li>collation_connection=utf8mb4_general_ci # 字符集</li>
<li>connect_timeout=10</li>
<li>init_connect=</li>
<li>max_connect_errors=100 # 连续失败的连接超过max_connect_errors会阻止这台主机后续的所有请求</li>
<li>max_connections=151 # MySql的最大连接数</li>
<li>max_user_connections=0 # 指每个数据库用户的最大连接, 默认值为：0不受限制</li>
<li>back_log=2000 # 当MySql的连接数据达到max_connections时，新来的请求将会被存在堆栈中，以等待某一连接释放资源，该堆栈的数量即back_log</li>
</ul>
<p><strong><em>open_files_limit=1000000</em></strong></p>
<blockquote>
<p>在/etc/my.cnf加入open_files_limit=8192后重启MySQL后查看不起作用(重点在于操作系统的文件打开数是否够) </p>
<p>如果my.cnf里配置了open_files_limit，open_files_limit最后取值为 /etc/my.cnf 中 open_files_limit，max_connections * 5， wanted_files=10+max_connections+table_cache_size*2 三者中的最大值。</p>
<p>如果my.cnf里如果没配置了open_files_limit，open_files_limit最后取值为max_connections * 5，10+max_connections+table_cache_size*2，ulimit -n中的最大者</p>
</blockquote>
<p><strong><em>max_connections=2000</em></strong></p>
<blockquote>
<p>max_connections是指MySql的最大连接数。</p>
<p>如果服务器的并发连接请求量比较大，建议调高此值，以增加并行连接数量。<br>当然这建立在机器能支撑的情况下，因为如果连接数越多，介于MySql会为每个连接提供连接缓冲区，就会开销越多的内存，所以要适当调整该值，不能盲目提高设值。</p>
<p>可以过’conn%’通配符查看当前状态的连接数量，以定夺该值的大小。</p>
<p>MySQL服务器允许的最大连接数16384；</p>
<p>查看系统当前最大连接数：</p>
<p>show variables like ‘max_connections’;</p>
</blockquote>
<p><strong><em>max_user_connections=0</em></strong></p>
<blockquote>
<p>max_user_connections是指每个数据库用户的最大连接</p>
<p>针对某一个账号的所有客户端并行连接到MYSQL服务的最大并行连接数。<br>简单说是指同一个账号能够同时连接到mysql服务的最大连接数。设置为0表示不限制。</p>
<p>目前默认值为：0不受限制。</p>
<p>查看max_user_connections值</p>
<p>show variables like ‘max_user_connections’;</p>
</blockquote>
<p><strong><em>max_connect_errors=100</em></strong></p>
<blockquote>
<p>如果MySQL服务器连续接收到了来自于同一个主机的请求，而且这些连续的请求全部都没有成功的建立连接就被中断了，当这些连续的请求的累计值大于max_connect_errors的设定值时，MySQL服务器就会阻止这台主机后续的所有请求。相信一开始你看到这些资料，也会被“many successive connection requests from a host are interrupted without a successful connection”给弄懵，其实这个就是因为由于网络异常而中止数据库连接</p>
</blockquote>
<p><strong><em>back_log=2000</em></strong></p>
<blockquote>
<p>back_log值指出在MySQL暂时停止回答新请求之前的短时间内多少个请求可以被存在堆栈中。</p>
<p>当MySql的连接数据达到max_connections时，新来的请求将会被存在堆栈中，以等待某一连接释放资源，该堆栈的数量即back_log。<br>如果等待连接的数量超过back_log，将不被授予连接资源。<br>将会报：unauthenticated user | xxx.xxx.xxx.xxx | NULL | Connect | NULL | login | NULL 的待连接进程时。</p>
<p>back_log值不能超过TCP/IP连接的侦听队列的大小。若超过则无效，查看当前系统的TCP/IP连接的侦听队列的大小命令：<br>cat /proc/sys/net/ipv4/tcp_max_syn_backlog目前系统为1024。</p>
<p>查看mysql 当前系统默认back_log值，命令：<br>show variables like ‘back_log’; 查看当前数量</p>
</blockquote>
<p><strong><em>thread_cache_size</em></strong></p>
<blockquote>
<p>默认的thread_cache_size=8</p>
<p>根据物理内存设置规则如下：<br>1G —&gt; 8<br>2G —&gt; 16<br>3G —&gt; 32     &gt;3G —&gt; 64</p>
<p>mysql&gt; show status like ‘thread%’;<br>+——————-+——-+<br>| Variable_name     | Value |<br>+——————-+——-+<br>| Threads_cached    | 0     |  &lt;—当前被缓存的空闲线程的数量<br>| Threads_connected | 1     |  &lt;—正在使用（处于连接状态）的线程<br>| Threads_created   | 1498  |  &lt;—服务启动以来，创建了多少个线程<br>| Threads_running   | 1     |  &lt;—正在忙的线程（正在查询数据，传输数据等等操作）<br>+——————-+——-+</p>
<p>查看开机起来数据库被连接了多少次？</p>
<p>mysql&gt; show status like ‘%connection%’;<br>+———————-+——-+<br>| Variable_name        | Value |<br>+———————-+——-+<br>| Connections          | 1504  |          –&gt;服务启动以来，历史连接数<br>| Max_used_connections | 2     |<br>+———————-+——-+</p>
<p>通过连接线程池的命中率来判断设置值是否合适？命中率超过90%以上,设定合理。</p>
<p>(Connections -  Threads_created) / Connections * 100 %</p>
</blockquote>
<br>

<h3 id="2、查询缓存"><a href="#2、查询缓存" class="headerlink" title="2、查询缓存"></a>2、查询缓存</h3><blockquote>
<p>查询缓存是 把 查询 sql 作为 key，查询结果作为 value 缓存；因为 sql 多变，而且 查询结果一般比较大；所以缓存的意义不大，一般关掉查询缓存</p>
<p>之所以查询缓存并没有能起到提升性能的做用，客观上有如下两点原因：<br>1、把SQL语句的hash值作为键，SQL语句的结果集作为值；这样就引起了一个问题如 <code>select user from mysql.user</code> 和c<code>SELECT user FROM mysql.user</code> 这两个将会被当成不同的SQL语句，这个时候就算结果集已经有了，但是一然用不到；</p>
<p>2、当查询所基于的低层表有改动时与这个表有关的查询缓存都会作废、如果对于并发度比较大的系统这个开销是可观的；对于作废结果集这个操作也是要用并发访问控制的，就是说也会有锁。并发大的时候就会有Waiting for query cache lock 产生；</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> show variables like <span class="string">'%query_cache%'</span>;</span></span><br><span class="line">+------------------------------+---------+</span><br><span class="line">| Variable_name                | Value   |</span><br><span class="line">+------------------------------+---------+</span><br><span class="line">| have_query_cache             | YES     |</span><br><span class="line">| query_cache_limit            | 1048576 |</span><br><span class="line">| query_cache_min_res_unit     | 4096    |</span><br><span class="line">| query_cache_size             | 1048576 |</span><br><span class="line">| query_cache_type             | OFF     |</span><br><span class="line">| query_cache_wlock_invalidate | OFF     |</span><br><span class="line">+------------------------------+---------+</span><br><span class="line">6 rows in set (0.01 sec)</span><br></pre></td></tr></table></figure>

<ul>
<li>have_query_cache    YES  # 表示这个mysql版本是否支持查询缓存</li>
<li>query_cache_limit    1048576  # 表示单个结果集所被允许缓存的最大值</li>
<li>query_cache_min_res_unit    4096  # 每个被缓存的结果集要占用的最小内存</li>
<li>query_cache_size    1048576  # 设置query缓冲区的大小</li>
<li>query_cache_type    OFF  # 是否开启查询缓存</li>
<li>query_cache_wlock_invalidate    OFF  # 如果某个数据表被其他的连接锁住，是否仍然从查询缓存中返回结果</li>
</ul>
<p><strong><em>query_cache_type</em></strong></p>
<blockquote>
<ul>
<li>query_cache_type=0（OFF）关闭</li>
<li>query_cache_type=1（ON）缓存所有结果，除非select语句使用SQL_NO_CACHE禁用查询缓存</li>
<li>query_cache_type=2(DEMAND)，只缓存select语句中通过SQL_CACHE指定需要缓存的查询</li>
</ul>
<p>修改方法：</p>
<p>vi /etc/my.cnf,加入如下行:</p>
<p>query_cache_type =2</p>
</blockquote>
<p><strong><em>query_cache_size</em></strong></p>
<blockquote>
<p>设置query缓冲区的大小，一般关掉</p>
<p>query_cache_size: 主要用来缓存MySQL中的ResultSet，也就是一条SQL语句执行的结果集。</p>
<p>Query Cache也有一个致命的缺陷，那就是当某个表的数据有任何任何变化，都会导致所有引用了该表的select语句在Query Cache中的缓存数据失效。所以，当我们的数据变化非常频繁的情况下，使用Query Cache可能会得不偿失</p>
<p>Query Cache的使用需要多个参数配合，其中最为关键的是query_cache_size和query_cache_type，<br>前者设置用于缓存 ResultSet的内存大小，后者设置在何场景下使用Query Cache</p>
<p>可以通过命令：<br>show status like ‘Qcache_%’;查看目前系统Query catch使用大小</p>
</blockquote>
<h4 id="计算缓存命中率"><a href="#计算缓存命中率" class="headerlink" title="计算缓存命中率"></a>计算缓存命中率</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> show status like <span class="string">'Qcache%'</span>;</span></span><br><span class="line">+-------------------------+----------+</span><br><span class="line">| Variable_name           | Value    |</span><br><span class="line">+-------------------------+----------+</span><br><span class="line">| Qcache_free_blocks      | 1        |</span><br><span class="line">| Qcache_free_memory      | 1031352  |</span><br><span class="line">| Qcache_hits             | 0        |</span><br><span class="line">| Qcache_inserts          | 0        |</span><br><span class="line">| Qcache_lowmem_prunes    | 0        |</span><br><span class="line">| Qcache_not_cached       | 94462672 |</span><br><span class="line">| Qcache_queries_in_cache | 0        |</span><br><span class="line">| Qcache_total_blocks     | 1        |</span><br><span class="line">+-------------------------+----------+</span><br></pre></td></tr></table></figure>

<ul>
<li>Qcache_free_blocks: 表示查询缓存中目前还有多少剩余的blocks，如果该值显示较大，则说明查询缓存中的内存碎片过多了，可能在一定的时间进行整理。</li>
<li>Qcache_free_memory: 查询缓存的内存大小，通过这个参数可以很清晰的知道当前系统的查询内存是否够用，是多了，还是不够用，DBA可以根据实际情况做出调整。</li>
<li>Qcache_hits: 表示有多少次命中缓存。我们主要可以通过该值来验证我们的查询缓存的效果。数字越大，缓存效果越理想。</li>
<li>Qcache_inserts: 表示多少次未命中然后插入，意思是新来的SQL请求在缓存中未找到，不得不执行查询处理，执行查询处理后把结果insert到查询缓存中。这样的情况的次数，次数越多，表示查询缓存应用到的比较少，效果也就不理想。当然系统刚启动后，查询缓存是空的，这很正常。</li>
<li>Qcache_lowmem_prunes: 该参数记录有多少条查询因为内存不足而被移除出查询缓存。通过这个值，用户可以适当的调整缓存大小。</li>
<li>Qcache_not_cached: 表示因为query_cache_type的设置而没有被缓存的查询数量。</li>
<li>Qcache_queries_in_cache: 当前缓存中缓存的查询数量。</li>
<li>Qcache_total_blocks: 当前缓存的block数量。</li>
</ul>
<p>内存碎片的产生。当一块分配的内存没有完全使用时，MySQL会把这块内存Trim掉，把没有使用的那部分归还以重 复利用。比如，第一次分配4KB,只用了3KB，剩1KB，第二次连续操作，分配4KB，用了2KB，剩2KB，这两次连续操作共剩下的 1KB+2KB=3KB，不足以做个一个内存单元分配， 这时候，内存碎片便产生了。使用flush query cache，可以消除碎片</p>
<p><strong><em>下面是命中率和内存使用率的一些算法</em></strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">query_cache_min_res_unit的估计值：(query_cache_size - Qcache_free_memory) / Qcache_queries_in_cache</span><br><span class="line"></span><br><span class="line">查询缓存命中率 ≈ (Qcache_hits – Qcache_inserts) / Qcache_hits * 100%</span><br><span class="line"></span><br><span class="line">查询缓存内存使用率 ≈ (query_cache_size – Qcache_free_memory) / query_cache_size * 100%</span><br></pre></td></tr></table></figure>

<br>

<br>

<h1 id="二、存储引擎-InnoDB-优化"><a href="#二、存储引擎-InnoDB-优化" class="headerlink" title="二、存储引擎 InnoDB 优化"></a>二、存储引擎 InnoDB 优化</h1><p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20191203113218.png" alt="Mysql5.6"></p>
<p>InnoDB 的存储引擎 总体 分为 内存结构 和 磁盘结构</p>
<br>

<h2 id="1、内存结构配置"><a href="#1、内存结构配置" class="headerlink" title="1、内存结构配置"></a>1、内存结构配置</h2><h3 id="1-1、Buffer-Pool"><a href="#1-1、Buffer-Pool" class="headerlink" title="1.1、Buffer Pool"></a>1.1、Buffer Pool</h3><h4 id="功能介绍"><a href="#功能介绍" class="headerlink" title="功能介绍"></a>功能介绍</h4><p>Buffer Pool是主内存中的一个区域，在<code>InnoDB</code>访问<code>表和索引数据</code>时会在其中进行 缓存。Buffer Pool允许直接从内存中直接处理经常使用的数据，从而加快了处理速度。在专用服务器上，通常将多达80％的物理内存分配给缓冲池。</p>
<p>为了提高大容量读取操作的效率，Buffer Pool被分为多个<a href="https://dev.mysql.com/doc/refman/5.6/en/glossary.html#glos_page" target="_blank" rel="noopener">页面</a>，这些<a href="https://dev.mysql.com/doc/refman/5.6/en/glossary.html#glos_page" target="_blank" rel="noopener">页面</a>可能包含多个行。为了提高缓存管理的效率，Buffer Pool被实现为页面的链接列表。使用<a href="https://dev.mysql.com/doc/refman/5.6/en/glossary.html#glos_lru" target="_blank" rel="noopener">LRU</a>算法的变体将很少使用的数据从缓存中老化掉 </p>
<p><strong>图14.2缓冲池列表</strong></p>
<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20191203141337.png" alt></p>
<p>该算法将大量页面保留在新的子列表中。旧的子列表包含较少使用的页面。这些页面是<a href="https://dev.mysql.com/doc/refman/5.6/en/glossary.html#glos_eviction" target="_blank" rel="noopener">驱逐的</a>候选对象 。</p>
<p>默认情况下，该算法的运行方式如下：</p>
<ul>
<li>3/8的缓冲池专用于旧的子列表。</li>
<li>列表的<code>中点</code>是新子列表的尾部与旧子列表的头相交的边界。</li>
<li>当<code>InnoDB</code>将<code>页面读入缓冲池时，它首先将其插入中点（旧子列表的头部）</code>。可以读取页面，因为它是用户启动的操作（例如SQL查询）所必需的，或作为的自动执行的<a href="https://dev.mysql.com/doc/refman/5.6/en/glossary.html#glos_read_ahead" target="_blank" rel="noopener">预读</a>操作的一部分 <code>InnoDB</code>。</li>
<li><code>访问旧子列表中的页面 使其变为“ 年轻 ”，将其移至新子列表的头部</code>。如果由于用户启动的操作而需要读取页面，则将立即进行首次访问，并使页面年轻。如果由于预读操作而读取了该页面，则第一次访问不会立即发生，并且在退出该页面之前可能根本不会发生。</li>
<li>随着数据库的运行，通过移至列表的尾部，缓冲池中<code>未被访问的页面将“ 老化 ”</code>。新的和旧的子列表中的页面都会随着其他页面的更新而老化。随着<code>将页面插入中点，旧子列表中的页面也会老化</code>。最终，未使用的页面到达旧子列表的尾部并被逐出。</li>
</ul>
<p>默认情况下，查询读取的页面会立即移入新的子列表，这意味着它们在缓冲池中的停留时间更长。例如，针对<a href="https://dev.mysql.com/doc/refman/5.6/en/mysqldump.html" target="_blank" rel="noopener"><strong>mysqldump</strong></a>操作或<code>SELECT</code>不带<code>WHERE</code>子句的 语句 执行的表扫描可以将大量数据带入缓冲池，并驱逐同等数量的旧数据，即使不再使用新数据也是如此。同样，由预读后台线程加载且仅访问一次的页面将移到新列表的开头。这些情况可能会将常用页面推送到旧的子列表，在此它们会被逐出。有关优化此行为的信息，请参见 <a href="https://dev.mysql.com/doc/refman/5.6/en/innodb-performance-midpoint_insertion.html" target="_blank" rel="noopener">第14.8.3.2节“使缓冲池扫描具有抵抗力”</a>和 <a href="https://dev.mysql.com/doc/refman/5.6/en/innodb-performance-read_ahead.html" target="_blank" rel="noopener">第14.8.3.3节“配置InnoDB缓冲池预取（预读）”</a>。</p>
<p><code>InnoDB</code>标准监视器输出在<code>BUFFER POOL AND MEMORY</code>有关缓冲池LRU算法操作的部分中包含几个字段。有关详细信息，请参阅<a href="https://dev.mysql.com/doc/refman/5.6/en/innodb-buffer-pool.html#innodb-buffer-pool-monitoring" target="_blank" rel="noopener">使用InnoDB Standard Monitor监视缓冲池</a>。</p>
<br>

<h4 id="参数配置"><a href="#参数配置" class="headerlink" title="参数配置"></a>参数配置</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> show variables like <span class="string">'%innodb_buffer%'</span>;</span></span><br><span class="line">+-------------------------------------+----------------+</span><br><span class="line">| Variable_name                       | Value          |</span><br><span class="line">+-------------------------------------+----------------+</span><br><span class="line">| innodb_buffer_pool_dump_at_shutdown | OFF            |</span><br><span class="line">| innodb_buffer_pool_dump_now         | OFF            |</span><br><span class="line">| innodb_buffer_pool_filename         | ib_buffer_pool |</span><br><span class="line">| innodb_buffer_pool_instances        | 8              |</span><br><span class="line">| innodb_buffer_pool_load_abort       | OFF            |</span><br><span class="line">| innodb_buffer_pool_load_at_startup  | OFF            |</span><br><span class="line">| innodb_buffer_pool_load_now         | OFF            |</span><br><span class="line">| innodb_buffer_pool_size             | 1688207360     |</span><br><span class="line">+-------------------------------------+----------------+</span><br><span class="line">8 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure>

<blockquote>
<p>参数说明：</p>
<ul>
<li>innodb_buffer_pool_dump_at_shutdown：在 mysqld 关闭时把热数据dump到本地磁盘；</li>
<li>innodb_buffer_pool_load_at_startup：在 mysqld 启动时把热数据加载到内存；</li>
<li>innodb_buffer_pool_dump_now：在 mysqld 关闭时把热数据dump到本地磁盘；</li>
<li>innodb_buffer_pool_load_now：采用手工方式把热数据加载到内存；</li>
<li>innodb_buffer_pool_filename：停止MySQL服务时，MySQL将InnoDB缓冲池中的热数据保存到数据库根目录中，默认文件名为ib_buffer_pool</li>
<li>innodb_buffer_pool_instances：表示InnoDB缓存池被划分到一个区域。适当地增加该参数（例如将该参数值设置为2），此时InnoDB被划分成为两个区域，可以提升InnoDB的并发性能。如果InnoDB缓存池被划分成多个区域，建议每个区域不小于1GB的空间；</li>
<li>innodb_buffer_pool_load_abort：终止Buffer Pool恢复，可以指定负载运行；</li>
<li>innodb_buffer_pool_size：缓存池大小</li>
</ul>
</blockquote>
<p><strong><em>innodb_buffer_pool_size</em></strong></p>
<ul>
<li>只使用InnoDB引擎的MySQL服务器中，根据经验，推荐设置 innodb_buffer_pool_size 为服务器总可用内存的80%；</li>
<li>通过<code>(innodb_buffer_pool_read_requests – innodb_buffer_pool_reads) / innodb_buffer_pool_read_requests * 100%</code> 计算缓存命中率。并根据命中率来调整 innodb_buffer_pool_size 参数大小进行优化， 命中率越高越好；</li>
</ul>
<p><strong><em>设置方法</em></strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">SET GLOBAL innodb_buffer_pool_size=size_in_bytes;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 并且</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> vi my.cnf</span></span><br><span class="line">innodb_buffer_pool_size=size_in_bytes</span><br><span class="line">innodb_buffer_pool_instances=8</span><br></pre></td></tr></table></figure>

<h4 id="效果监控"><a href="#效果监控" class="headerlink" title="效果监控"></a>效果监控</h4><p><u><strong><em>方法一</em></strong></u></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> show status like <span class="string">'innodb_%_read%'</span>;           </span></span><br><span class="line">+---------------------------------------+----------------+</span><br><span class="line">| Variable_name                         | Value          |</span><br><span class="line">+---------------------------------------+----------------+</span><br><span class="line">| Innodb_buffer_pool_read_ahead_rnd     | 0              |</span><br><span class="line">| Innodb_buffer_pool_read_ahead         | 1125395433     |</span><br><span class="line">| Innodb_buffer_pool_read_ahead_evicted | 4003043        |</span><br><span class="line">| Innodb_buffer_pool_read_requests      | 26830062706    |</span><br><span class="line">| Innodb_buffer_pool_reads              | 606103167      |</span><br><span class="line">| Innodb_data_pending_reads             | 0              |</span><br><span class="line">| Innodb_data_read                      | 28370717659136 |</span><br><span class="line">| Innodb_data_reads                     | 1731613719     |</span><br><span class="line">| Innodb_pages_read                     | 1731611205     |</span><br><span class="line">| Innodb_rows_read                      | 170090056704   |</span><br><span class="line">+---------------------------------------+----------------+</span><br><span class="line">10 rows in set (0.01 sec)</span><br></pre></td></tr></table></figure>

<blockquote>
<p>参数说明：</p>
<ul>
<li>Innodb_buffer_pool_reads: 表示从物理磁盘读取页的次数</li>
<li>Innodb_buffer_pool_read_ahead: 预读的次数</li>
<li>Innodb_buffer_pool_read_ahead_evicted: 预读的页，但是没有读取就从缓冲池中被替换的页的数量，一般用来判断预读的效率</li>
<li>Innodb_buffer_pool_read_requests: 从缓冲池中读取页的次数</li>
<li>Innodb_data_read: 总共读入的字节数</li>
<li>Innodb_data_reads: 发起读取请求的次数，每次读取可能需要读取多个页</li>
</ul>
</blockquote>
<p>​        通过<code>(innodb_buffer_pool_read_requests – innodb_buffer_pool_reads) / innodb_buffer_pool_read_requests * 100%</code> 计算缓存命中率。并根据命中率来调整 innodb_buffer_pool_size 参数大小进行优化， 命中率越高越好；</p>
<p><u><strong><em>方法二</em></strong></u></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> SHOW ENGINE INNODB STATUS\G</span></span><br></pre></td></tr></table></figure>

<p><code>InnoDB</code>可以使用访问的标准监视器输出， <a href="https://dev.mysql.com/doc/refman/5.6/en/innodb-standard-monitor.html" target="_blank" rel="noopener"><code>SHOW ENGINE INNODB STATUS</code></a>提供有关缓冲池操作的度量。缓冲池度量标准位于<code>BUFFER POOL AND MEMORY</code>“ <code>InnoDB</code>标准监视器”输出中的部分，其 外观类似于以下内容：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">----------------------</span><br><span class="line">BUFFER POOL AND MEMORY</span><br><span class="line">----------------------</span><br><span class="line">Total memory allocated 2197815296; in additional pool allocated 0</span><br><span class="line">Dictionary memory allocated 155455</span><br><span class="line">Buffer pool size   131071</span><br><span class="line">Free buffers       92158</span><br><span class="line">Database pages     38770</span><br><span class="line">Old database pages 14271</span><br><span class="line">Modified db pages  619</span><br><span class="line">Pending reads 0</span><br><span class="line">Pending writes: LRU 0, flush list 0, single page 0</span><br><span class="line">Pages made young 4, not young 0</span><br><span class="line">0.00 youngs/s, 0.00 non-youngs/s</span><br><span class="line">Pages read 322, created 38448, written 42083</span><br><span class="line">0.00 reads/s, 222.30 creates/s, 159.47 writes/s</span><br><span class="line">Buffer pool hit rate 1000 / 1000, young-making rate 0 / 1000 not 0 / 1000</span><br><span class="line">Pages read ahead 0.00/s, evicted without access 0.00/s, Random read ahead</span><br><span class="line">0.00/s</span><br><span class="line">LRU len: 38770, unzip_LRU len: 0</span><br><span class="line">I/O sum[0]:cur[0], unzip sum[0]:cur[0]</span><br></pre></td></tr></table></figure>

<br>

<h3 id="1-2、Change-Buffer"><a href="#1-2、Change-Buffer" class="headerlink" title="1.2、Change Buffer"></a>1.2、Change Buffer</h3><h4 id="功能介绍-1"><a href="#功能介绍-1" class="headerlink" title="功能介绍"></a>功能介绍</h4><p>Change Buffer是一种特殊的数据结构，当<a href="https://dev.mysql.com/doc/refman/5.6/en/glossary.html#glos_secondary_index" target="_blank" rel="noopener">二级索引</a>页不在<a href="https://dev.mysql.com/doc/refman/5.6/en/glossary.html#glos_buffer_pool" target="_blank" rel="noopener">缓冲池(Buffer Pool)中</a>时，它们 会缓存这些更改 。当页面通过其他读取操作加载到缓冲池中时，可能由<a href="https://dev.mysql.com/doc/refman/5.6/en/insert.html" target="_blank" rel="noopener"><code>INSERT</code></a>， <a href="https://dev.mysql.com/doc/refman/5.6/en/update.html" target="_blank" rel="noopener"><code>UPDATE</code></a>或 <a href="https://dev.mysql.com/doc/refman/5.6/en/delete.html" target="_blank" rel="noopener"><code>DELETE</code></a>操作（DML）导致的缓冲更改 将在以后合并。</p>
<p><strong>图14.3Change Buffer</strong></p>
<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20191212160328.png" alt></p>
<p>与<a href="https://dev.mysql.com/doc/refman/5.6/en/glossary.html#glos_clustered_index" target="_blank" rel="noopener">聚簇索引</a>不同，二级索引通常是非唯一的，并且二级索引中的插入以相对随机的顺序发生。同样，删除和更新可能会影响索引树中不相邻的二级索引页。当稍后通过其他操作将受影响的页读入缓冲池时，合并缓存的更改将避免从磁盘将辅助索引页读入缓冲池所需的大量随机访问I / O。</p>
<br>

<h4 id="参数配置-1"><a href="#参数配置-1" class="headerlink" title="参数配置"></a>参数配置</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> show variables like <span class="string">'%change_buffer%'</span>;      </span></span><br><span class="line">+-------------------------------+-------+</span><br><span class="line">| Variable_name                 | Value |</span><br><span class="line">+-------------------------------+-------+</span><br><span class="line">| innodb_change_buffer_max_size | 25    |</span><br><span class="line">| innodb_change_buffering       | all   |</span><br><span class="line">+-------------------------------+-------+</span><br><span class="line">2 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure>

<blockquote>
<p>参数说明：</p>
<ul>
<li>innodb_change_buffering：</li>
</ul>
<blockquote>
<ul>
<li><strong><code>all</code></strong>: 默认值：缓冲区插入，删除标记操作和清除。</li>
<li><strong><code>none</code></strong>: 不要缓冲任何操作。</li>
<li><strong><code>inserts</code></strong>: 缓冲区插入操作。</li>
<li><strong><code>deletes</code></strong>: 缓冲区删除标记操作。</li>
<li><strong><code>changes</code></strong>: 缓冲插入和删除标记操作。</li>
<li><strong><code>purges</code></strong>: 缓冲在后台发生的物理删除操作。</li>
</ul>
</blockquote>
<ul>
<li>innodb_change_buffer_max_size：<strong><u>Change Buffer的最大大小配置为Buffer Pool总大小的百分比</u></strong>。默认情况下， <a href="https://dev.mysql.com/doc/refman/5.6/en/innodb-parameters.html#sysvar_innodb_change_buffer_max_size" target="_blank" rel="noopener"><code>innodb_change_buffer_max_size</code></a>设置为25。最大设置为50</li>
</ul>
</blockquote>
<h4 id="效果监控-1"><a href="#效果监控-1" class="headerlink" title="效果监控"></a>效果监控</h4><p><strong><em>方法一</em></strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> SHOW ENGINE INNODB STATUS\G</span></span><br></pre></td></tr></table></figure>

<p>Change Buffer状态信息位于<code>INSERT BUFFER AND ADAPTIVE HASH INDEX</code> 标题下， 并显示类似以下内容：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">-------------------------------------</span><br><span class="line">INSERT BUFFER AND ADAPTIVE HASH INDEX</span><br><span class="line">-------------------------------------</span><br><span class="line">Ibuf: size 1, free list len 0, seg size 2, 0 merges</span><br><span class="line">merged operations:</span><br><span class="line"> insert 0, delete mark 0, delete 0</span><br><span class="line">discarded operations:</span><br><span class="line"> insert 0, delete mark 0, delete 0</span><br><span class="line">Hash table size 3340871, node heap has 2 buffer(s)</span><br><span class="line">0.00 hash searches/s, 0.00 non-hash searches/s</span><br></pre></td></tr></table></figure>

<p><strong><em>方法二</em></strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> SELECT (SELECT COUNT(*) FROM INFORMATION_SCHEMA.INNODB_BUFFER_PAGE</span></span><br><span class="line">       WHERE PAGE_TYPE LIKE 'IBUF%') AS change_buffer_pages, </span><br><span class="line">       (SELECT COUNT(*) FROM INFORMATION_SCHEMA.INNODB_BUFFER_PAGE) AS total_pages,</span><br><span class="line">       (SELECT ((change_buffer_pages/total_pages)*100)) </span><br><span class="line">       AS change_buffer_page_percentage;</span><br><span class="line">+---------------------+-------------+-------------------------------+</span><br><span class="line">| change_buffer_pages | total_pages | change_buffer_page_percentage |</span><br><span class="line">+---------------------+-------------+-------------------------------+</span><br><span class="line">|                  25 |        8192 |                        0.3052 |</span><br><span class="line">+---------------------+-------------+-------------------------------+</span><br></pre></td></tr></table></figure>

<br>

<h3 id="1-3、Log-Buffer-配置"><a href="#1-3、Log-Buffer-配置" class="headerlink" title="1.3、Log Buffer 配置"></a>1.3、Log Buffer 配置</h3><p>日志缓冲区是存储区域，用于保存要写入磁盘上的日志文件的数据。日志缓冲区大小由<a href="https://dev.mysql.com/doc/refman/5.6/en/innodb-parameters.html#sysvar_innodb_log_buffer_size" target="_blank" rel="noopener"><code>innodb_log_buffer_size</code></a>变量定义 。默认大小为16MB。日志缓冲区的内容会定期刷新到磁盘。<u><strong>大型的日志缓冲区使大型事务能够运行，而无需在事务提交之前将Redo Log数据写入磁盘</strong></u>。因此，如果您有更新，插入或删除许多行的事务，则增加日志缓冲区的大小可以节省磁盘I / O。</p>
<p>该 <a href="https://dev.mysql.com/doc/refman/5.6/en/innodb-parameters.html#sysvar_innodb_flush_log_at_trx_commit" target="_blank" rel="noopener"><code>innodb_flush_log_at_trx_commit</code></a> 变量控制如何将日志缓冲区的内容写入并刷新到磁盘。该 <a href="https://dev.mysql.com/doc/refman/5.6/en/innodb-parameters.html#sysvar_innodb_flush_log_at_timeout" target="_blank" rel="noopener"><code>innodb_flush_log_at_timeout</code></a> 变量控制日志刷新频率。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> show variables like <span class="string">'%log_buffer%'</span>;      </span></span><br><span class="line">+------------------------+---------+</span><br><span class="line">| Variable_name          | Value   |</span><br><span class="line">+------------------------+---------+</span><br><span class="line">| innodb_log_buffer_size | 8388608 |  此时为8M = 8 * 1024 * 1024</span><br><span class="line">+------------------------+---------+</span><br><span class="line">1 row in set (0.01 sec)</span><br><span class="line"></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> show variables like <span class="string">'%innodb_flush_log_at_trx_commit%'</span>;</span></span><br><span class="line">+--------------------------------+-------+</span><br><span class="line">| Variable_name                  | Value |</span><br><span class="line">+--------------------------------+-------+</span><br><span class="line">| innodb_flush_log_at_trx_commit | 2     |  </span><br><span class="line">+--------------------------------+-------+</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure>

<blockquote>
<p>innodb_flush_log_at_trx_commit 参数解释：</p>
<ul>
<li>0（延迟写）： log_buff  –每隔1秒–&gt; log_file  —实时—&gt; disk</li>
<li>1（实时写，实时刷）： log_buff  —实时—&gt;  log_file  —实时—&gt; disk</li>
<li>2（实时写，延迟刷）： log_buff  —实时—&gt; log_file –每隔1秒–&gt; disk</li>
</ul>
<p>0：最快减少mysql写的等待   1：最大安全性,不会丢失数据  2：折中，减少操作系统文件写入等待时间</p>
</blockquote>
<br>

<h3 id="1-4、Adaptive-Hash-Index"><a href="#1-4、Adaptive-Hash-Index" class="headerlink" title="1.4、Adaptive Hash Index"></a>1.4、Adaptive Hash Index</h3><h4 id="功能介绍-2"><a href="#功能介绍-2" class="headerlink" title="功能介绍"></a>功能介绍</h4><p>InnoDB存储引擎会监控对表上索引的查找，如果观察到建立哈希索引可以带来速度的提升，则建立哈希索引，所以称之为自适应（adaptive） 的。自适应哈希索引通过缓冲池的B+树构造而来，因此建立的速度很快。而且不需要将整个表都建哈希索引，InnoDB存储引擎会自动根据访问的频率和模式 来为某些页建立哈希索引。</p>
<p>根据InnoDB的官方文档显示，启用自适应哈希索引后，读取和写入速度可以提高2倍；对于辅助索引的连接操作，性能可以提高5倍。在我看来，自适应哈希索引是非常好的优化模式，其设计思想是数据库自优化（self-tuning），即无需DBA对数据库进行调整。</p>
<p>Adaptive Hash Index是针对B+树Search Path的优化，因此所有会涉及到Search Path的操作，均可使用此Hash索引进行优化，这些可优化的操作包括：Unique Scan/Range Scan(Locate First Key Page)/Insert/Delete/Purge等等，几乎涵盖InnoDB所有的操作类型。</p>
<p>通过参数innodb_adaptive_hash_index来禁用或启动此特性，默认为开启</p>
<h4 id="参数配置-2"><a href="#参数配置-2" class="headerlink" title="参数配置"></a>参数配置</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> show variables like <span class="string">'%adaptive_hash%'</span>;</span></span><br><span class="line">+----------------------------+-------+</span><br><span class="line">| Variable_name              | Value |</span><br><span class="line">+----------------------------+-------+</span><br><span class="line">| innodb_adaptive_hash_index | ON    |</span><br><span class="line">+----------------------------+-------+</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure>

<br>

<h2 id="2、操作系统缓存"><a href="#2、操作系统缓存" class="headerlink" title="2、操作系统缓存"></a>2、操作系统缓存</h2><br>

<p>##　3、磁盘结构配置</p>
<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20191203113218.png" alt="Mysql5.6"></p>
<h3 id="3-1、System-Tablespace"><a href="#3-1、System-Tablespace" class="headerlink" title="3.1、System Tablespace"></a>3.1、System Tablespace</h3><h4 id="功能介绍-3"><a href="#功能介绍-3" class="headerlink" title="功能介绍"></a>功能介绍</h4><p>​        系统表空间是 InnoDB数据字典，Doublewrite Buffer，Change Buffer和 Undo Log的存储区 。如果在系统表空间中创建表，而不是在每个表文件中创建表，则它也可能包含表和索引数据。</p>
<p>系统表空间可以具有一个或多个数据文件。默认情况下，<code>ibdata1</code>在数据目录中创建一个名为的系统表空间数据文件 。系统表空间数据文件的大小和数量由<a href="https://dev.mysql.com/doc/refman/5.6/en/innodb-parameters.html#sysvar_innodb_data_file_path" target="_blank" rel="noopener"><code>innodb_data_file_path</code></a>启动选项定义。有关配置信息，请参阅<a href="https://dev.mysql.com/doc/refman/5.6/en/innodb-init-startup-configuration.html#innodb-startup-data-file-configuration" target="_blank" rel="noopener">《 系统表空间数据文件配置》</a>。</p>
<h4 id="参数配置-3"><a href="#参数配置-3" class="headerlink" title="参数配置"></a>参数配置</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> show variables like <span class="string">'%innodb_data%'</span>;</span></span><br><span class="line">+-----------------------+------------------------+</span><br><span class="line">| Variable_name         | Value                  |</span><br><span class="line">+-----------------------+------------------------+</span><br><span class="line">| innodb_data_file_path | ibdata1:12M:autoextend |</span><br><span class="line">| innodb_data_home_dir  |                        |</span><br><span class="line">+-----------------------+------------------------+</span><br><span class="line">2 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> show variables like <span class="string">'%innodb_autoextend_increment%'</span>;</span></span><br><span class="line">+-----------------------------+-------+</span><br><span class="line">| Variable_name               | Value |</span><br><span class="line">+-----------------------------+-------+</span><br><span class="line">| innodb_autoextend_increment | 8    |</span><br><span class="line">+-----------------------------+-------+</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure>

<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20191214115733.png" alt></p>
<p><code>ibdata1:12M:autoextend</code> 含义：</p>
<p><code>innodb_data_home_dir</code> 为空，表示在默认目录 <code>/var/lib/mysql</code> 下创建一个文件 ibdata1，初始大小为12MB，如果快达到12MB时，以<code>innodb_autoextend_increment</code>设置的增量 8MB 根据需要增加空间。</p>
<p><u><strong>1、<em>增大系统表空间</em></strong></u></p>
<p>假设  <code>/var/lib/mysql</code> 所在的磁盘将满，需要扩展系统空间，方法如下：</p>
<ol>
<li>停止 mysql 服务；</li>
<li><code>vi /etc/my.cnf</code></li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[mysqld]</span><br><span class="line">innodb_data_file_path=/var/lib/mysql/ibdata1:76M;/disk2/ibdata2:50M:autoextend</span><br></pre></td></tr></table></figure>

<p><code>/disk2/</code> 为新磁盘；<code>autoextend</code> 只能跟在最后一个文件后面；</p>
<ol start="3">
<li>启动 mysql 服务；</li>
</ol>
<p><u><strong><em>2、减小系统表空间</em></strong></u></p>
<p>您不能从系统表空间中删除数据文件。要减小系统表空间大小，请使用以下过程：</p>
<ol>
<li><p>使用<a href="https://dev.mysql.com/doc/refman/5.6/en/mysqldump.html" target="_blank" rel="noopener"><strong>mysqldump</strong></a>转储所有 <code>InnoDB</code>表，包括 模式中的<code>InnoDB</code>表 <code>mysql</code>。使用以下查询标识 模式中的<code>InnoDB</code>表 <code>mysql</code>：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SELECT TABLE_NAME from INFORMATION_SCHEMA.TABLES WHERE TABLE_SCHEMA='mysql' and ENGINE='InnoDB';</span><br><span class="line">+<span class="comment">----------------------+</span></span><br><span class="line">| table_name           |</span><br><span class="line">+<span class="comment">----------------------+</span></span><br><span class="line">| innodb_index_stats   |</span><br><span class="line">| innodb_table_stats   |</span><br><span class="line">| slave_master_info    |</span><br><span class="line">| slave_relay_log_info |</span><br><span class="line">| slave_worker_info    |</span><br><span class="line">+<span class="comment">----------------------+</span></span><br><span class="line">5 rows in <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>
</li>
<li><p>停止服务器。</p>
</li>
<li><p>删除所有现有的表空间文件（<code>*.ibd</code>），包括 <code>ibdata</code>和<code>ib_log</code> 文件。不要忘记删除 架构<code>*.ibd</code> 中表的文件<code>mysql</code>。</p>
</li>
<li><p>删除表的所有<code>.frm</code>文件 <code>InnoDB</code>。</p>
</li>
<li><p>为新系统表空间配置数据文件。请参阅 <a href="https://dev.mysql.com/doc/refman/5.6/en/innodb-init-startup-configuration.html#innodb-startup-data-file-configuration" target="_blank" rel="noopener">系统表空间数据文件配置</a>。</p>
</li>
<li><p>重新启动服务器。</p>
</li>
<li><p>导入转储文件。</p>
</li>
</ol>
<p><u><strong><em>3、在l <code>Linux 和 Unix</code>上使用原始磁盘分区</em></strong></u></p>
<ol>
<li>修改 /etc/my.cnf ；</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[mysqld]</span><br><span class="line">innodb_data_home_dir=</span><br><span class="line">innodb_data_file_path=/dev/hdd1:3Gnewraw;/dev/hdd2:2Gnewraw</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>重启 mysql；</li>
</ol>
<blockquote>
<p><code>InnoDB</code> 的 <code>newraw</code>关键字将初始化新分区。重启以后，不要创建任何新表。否则下次重启将再次初始化分区，丢失所有数据；</p>
</blockquote>
<ol start="3">
<li>再次修改 /etc/my.cnf ；</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[mysqld]</span><br><span class="line">innodb_data_home_dir=</span><br><span class="line">innodb_data_file_path=/dev/hdd1:3Graw;/dev/hdd2:2Graw</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>重启 mysql 服务器。现在允许创建表。</li>
</ol>
<br>

<h3 id="3-2、File-Per-Table-Tablespaces"><a href="#3-2、File-Per-Table-Tablespaces" class="headerlink" title="3.2、File-Per-Table-Tablespaces"></a>3.2、File-Per-Table-Tablespaces</h3><h4 id="功能介绍-4"><a href="#功能介绍-4" class="headerlink" title="功能介绍"></a>功能介绍</h4><p>每表文件表空间包含单个<code>InnoDB</code>表的数据和索引 ，并存储在文件系统中自己的数据文件中。</p>
<ul>
<li><code>.frm 文件</code>：表结构信息、字典信息；</li>
<li><code>.idb 文件</code>：数据信息、索引信息；</li>
</ul>
<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20191214123531.png" alt></p>
<h4 id="参数配置-4"><a href="#参数配置-4" class="headerlink" title="参数配置"></a>参数配置</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> show variables like <span class="string">'%innodb_file%'</span>;</span></span><br><span class="line">+--------------------------+----------+</span><br><span class="line">| Variable_name            | Value    |</span><br><span class="line">+--------------------------+----------+</span><br><span class="line">| innodb_file_format       | Antelope |</span><br><span class="line">| innodb_file_format_check | ON       |</span><br><span class="line">| innodb_file_format_max   | Antelope |</span><br><span class="line">| innodb_file_per_table    | ON       |</span><br><span class="line">+--------------------------+----------+</span><br><span class="line">4 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure>

<p><code>innodb_file_per_table</code>： ON-启动独立表空间，OFF-启用共享表空间</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 临时表更</span></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> SET GLOBAL innodb_file_per_table=ON;</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 永久变更</span></span><br><span class="line">vi /etc/my.cnf</span><br><span class="line">innodb_file_per_table=1</span><br></pre></td></tr></table></figure>

<br>

<h3 id="3-3、Undo-Tablespaces"><a href="#3-3、Undo-Tablespaces" class="headerlink" title="3.3、Undo Tablespaces"></a>3.3、Undo Tablespaces</h3><h4 id="功能介绍-5"><a href="#功能介绍-5" class="headerlink" title="功能介绍"></a>功能介绍</h4><p><u><strong><em>回滚段</em></strong></u></p>
<p>InnoDB采用回滚段的方式来维护undo log的并发写入和持久化。回滚段实际上是一种 Undo 文件组织方式，每个回滚段又有多个undo log slot。</p>
<p>一共128个回滚段，每个回滚段维护了一个段头页，在该page中又划分了1024个slot (TRX_RSEG_N_SLOTS)，每个slot又对应到一个undo log对象，因此理论上InnoDB最多支持 96 * 1024个普通事务。</p>
<ol>
<li>rseg0预留在系统表空间ibdata中;</li>
<li>rseg 1~rseg 32这32个回滚段存放于临时表的系统表空间中;</li>
<li>rseg33~ 则根据配置存放到独立undo表空间中（如果没有打开独立Undo表空间，则存放于ibdata中）</li>
</ol>
<p><u><strong><em>Undo Log</em></strong></u></p>
<p>​        undo Log是与单个读写事务关联的 <code>undo Log</code> 记录的集合。undo Log 记录包含如何 撤消事务对 <a href="https://dev.mysql.com/doc/refman/5.6/en/glossary.html#glos_clustered_index" target="_blank" rel="noopener">聚簇索引</a> 记录的最新更改 的信息。如果另一个事务读取原始数据，就需要在 undo Log记录读取。</p>
<p>​        undo Log存在于 <code>undo log segment</code>。默认情况下，<code>undo log segment</code> 实际上是 <code>system tablespace</code> 的一部分 ，但它们也可以驻留在 <code>undo log tablespace</code> 中。有关更多信息，请参见<a href="https://dev.mysql.com/doc/refman/5.6/en/innodb-undo-tablespaces.html" target="_blank" rel="noopener">第14.6.3.3节“撤消表空间”</a>。</p>
<ol>
<li><p><code>InnoDB</code>支持128个回滚段，通过参数 <code>innodb_rollback_segments</code> 定义；</p>
</li>
<li><p>一个 <code>rollback segment</code> 支持的 事务数 取决（ <code>rollback segment</code> 中 <code>undo slots</code> 的数量） 和 （每个事务所需的 undo log 数）；</p>
</li>
<li><p>一个<code>rollback segment</code> 中 <code>undo slots</code> 的数量 又会因为 <code>innodb_page_size</code> 不同而不同；</p>
</li>
</ol>
<table>
<thead>
<tr>
<th>InnoDB Page Size</th>
<th>rollback segment 中的 undo slots 数（innodb_page_size/ 16）</th>
</tr>
</thead>
<tbody><tr>
<td><code>4096 (4KB)</code></td>
<td><code>256</code></td>
</tr>
<tr>
<td><code>8192 (8KB)</code></td>
<td><code>512</code></td>
</tr>
<tr>
<td><code>16384 (16KB)</code></td>
<td><code>1024</code></td>
</tr>
</tbody></table>
<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20191203205602.png" alt></p>
<p>以下每种操作类型，一个事务最多可以分配两个 undo Log：</p>
<ol>
<li><a href="https://dev.mysql.com/doc/refman/5.6/en/insert.html" target="_blank" rel="noopener"><code>INSERT</code></a> 操作 在事务提交前只对当前事务可见，因此产生的Undo日志可以在事务提交后直接删除；</li>
<li><a href="https://dev.mysql.com/doc/refman/5.6/en/update.html" target="_blank" rel="noopener"><code>UPDATE</code></a>和 <a href="https://dev.mysql.com/doc/refman/5.6/en/delete.html" target="_blank" rel="noopener"><code>DELETE</code></a> 操作 产生的Undo日志被归成一类，即update_undo；</li>
</ol>
<p>undo Log根据需要分配。例如，一个事务执行<code>INSERT</code>， <code>UPDATE</code> 和 <code>DELETE</code> 操作被分配了两个undo Log，仅执行<a href="https://dev.mysql.com/doc/refman/5.6/en/insert.html" target="_blank" rel="noopener"><code>INSERT</code></a>操作的事务被分配有一个 undo Log；</p>
<p>分配给事务的Undo Log在其持续时间内始终与事务相关；</p>
<p>给定上述因素，可以使用以下公式来估计<code>InnoDB</code>能够支持的并发读写事务数。</p>
<blockquote>
<p>注意：在达到 <code>InnoDB</code> 能够支持的并发读写事务数之前，事务可能会遇到并发事务限制错误。当分配给事务的 <code>rollback segment</code> 用完 <code>undo slots</code> 时，就会发生这种情况。在这种情况下，请尝试重新运行事务</p>
</blockquote>
<ul>
<li><p>如果每个事务执行任一个 insert 或 update 或 delete 操作，InnoDB支持的 并发读-写事务的数目： </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(innodb_page_size / 16) * innodb_rollback_segments</span><br></pre></td></tr></table></figure>
</li>
<li><p>如果每个事务执行任一个 insert 和（ update 或 delete） 操作，InnoDB支持的 并发读-写事务的数目</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(innodb_page_size / 16 / 2) * innodb_rollback_segments</span><br></pre></td></tr></table></figure>

</li>
</ul>
<br>

<p>在 <code>mysql 5.6</code> 中开始支持把 undo log 分离到独立的表空间，并放到单独的文件目录下；这给我们部署不同IO类型的文件位置带来便利，对于并发写入型负载，我们可以把undo文件部署到单独的高速存储设备上；</p>
<p>undo log 的 i/o 模式决定 最好使用 SSD 来存储； </p>
<blockquote>
<p>innodb事务日志包括redo log和undo log。redo log是重做日志，提供前滚操作，undo log是回滚日志，提供回滚操作。</p>
<p>undo log不是redo log的逆向过程，其实它们都算是用来恢复的日志：</p>
<ol>
<li><p>redo log通常是物理日志，记录的是 数据页 的物理修改，而不是某一行或某几行修改成怎样怎样，它用来恢复提交后的物理数据页(恢复数据页，且只能恢复到最后一次提交的位置)。</p>
</li>
<li><p>undo用来回滚行记录到某个版本。undo log一般是逻辑日志，根据 每行记录 进行记录。</p>
</li>
</ol>
</blockquote>
<h4 id="参数配置-5"><a href="#参数配置-5" class="headerlink" title="参数配置"></a>参数配置</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> show variables like <span class="string">'%undo%'</span>;</span></span><br><span class="line">+-------------------------+-------+</span><br><span class="line">| Variable_name           | Value |</span><br><span class="line">+-------------------------+-------+</span><br><span class="line">| innodb_undo_directory   | .     |</span><br><span class="line">| innodb_undo_logs        | 128   |</span><br><span class="line">| innodb_undo_tablespaces | 0     |</span><br><span class="line">+-------------------------+-------+</span><br><span class="line">3 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> show variables like <span class="string">'%innodb_rollback_segments%'</span>;</span></span><br><span class="line">+--------------------------+-------+</span><br><span class="line">| Variable_name            | Value |</span><br><span class="line">+--------------------------+-------+</span><br><span class="line">| innodb_rollback_segments | 128   |</span><br><span class="line">+--------------------------+-------+</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure>

<ul>
<li><code>innodb_undo_tablespaces</code></li>
</ul>
<blockquote>
<p>用于设定创建的undo表空间的个数，仅在初始化 mysql 实例时才能配置此选项，此后无法更改；</p>
<p>默认值为0，表示 <code>不独立设置undo的 tablespace，默认记录到 ibdata 中</code>；否则，则在undo目录下创建这么多个undo文件，例如假定设置该值为16，那么就会创建命名为 <code>undo001 ~ undo016</code>的 <code>undo tablespace</code> 文件，每个文件的默认大小为 10M</p>
<p>修改该值可能会导致Innodb无法完成初始化；</p>
</blockquote>
<ul>
<li><code>innodb_undo_logs</code></li>
</ul>
<blockquote>
<p>用于表示回滚段的个数（早期版本的命名为<code>innodb_rollback_segments</code> ），该变量可以动态调整，但是物理上的回滚段不会减少，只是会控制用到的回滚段的个数;</p>
<p>默认为128个回滚段</p>
</blockquote>
<ul>
<li><code>innodb_undo_directory</code></li>
</ul>
<blockquote>
<p>当开启独立undo表空间时，指定undo文件存放的目录</p>
<p>如果我们想转移undo文件的位置，只需要修改下该配置，并将undo文件拷贝过去就可以了。</p>
</blockquote>
<br>

<h3 id="3-4、Redo-Log"><a href="#3-4、Redo-Log" class="headerlink" title="3.4、Redo Log"></a>3.4、Redo Log</h3><p><a href="https://dev.mysql.com/doc/refman/5.6/en/innodb-redo-log.html" target="_blank" rel="noopener">https://dev.mysql.com/doc/refman/5.6/en/innodb-redo-log.html</a></p>
<h4 id="功能介绍-6"><a href="#功能介绍-6" class="headerlink" title="功能介绍"></a>功能介绍</h4><p>redo log 是一种基于磁盘的，在 mysql 崩溃恢复时 用来纠正未完成事务的数据结构。</p>
<p>默认情况下，redo log 在磁盘上表现为两个文件 <code>ib_logfile0</code> 和 <code>ib_logfile1</code>。mysql 把受影响的数据编码后以循环方式写这两文件。</p>
<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20191217111311.png" alt></p>
<p>优化建议：确保 redo log 日志足够大，甚至和 buffer pool 一样大。当 InnoDB 把 redo log 文件写满时，它必须把 buffer pool 中的 数据写入磁盘 checkpoint。如果 redo log 太小 会导致很多没必要的磁盘写入。尽管 redo log 太大会导致 mysql 在启动恢复时耗时更长，不过现在的优化以后它的速度还是挺快的，可以放心使用；</p>
<h4 id="参数配置-6"><a href="#参数配置-6" class="headerlink" title="参数配置"></a>参数配置</h4><p>1、确保 innodb_fast_shutdown 不是2</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> SET GLOBAL innodb_fast_shutdown=1;</span></span><br></pre></td></tr></table></figure>

<p>2、停止 mysql</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl stop mysqld</span><br></pre></td></tr></table></figure>

<p>3、将  <code>ib_logfile0</code> 和 <code>ib_logfile1</code> 复制到 其他安全的空间，防止被写入脏数据；</p>
<p>4、删除掉  <code>ib_logfile0</code> 和 <code>ib_logfile1</code>；</p>
<p>5、修改 /etc/my.cnf，改变 redo log 文件的数量 或者 大小；</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/my.cnf</span><br><span class="line"></span><br><span class="line">[mysqld]</span><br><span class="line"><span class="meta">#</span><span class="bash"> redo <span class="built_in">log</span> 文件大小</span></span><br><span class="line">innodb_log_file_size=536870912</span><br><span class="line"><span class="meta">#</span><span class="bash"> redo <span class="built_in">log</span> 文件个数</span></span><br><span class="line">innodb_log_files_in_group=2</span><br></pre></td></tr></table></figure>

<p>6、启动 mysql，mysqld 将会创建 新的<code>ib_logfile0</code> 和 <code>ib_logfile1</code>；</p>
<p>和其他AICD的数据库搜索引擎一样，InnoDB会在提交一个事务之前 flush redo log。InnoDB 使用 group commit 功能 将多个事务的提交请求一起flush，而避免每个提交只有一个flush，从而提高吞吐量。</p>
<h4 id="效果监控-2"><a href="#效果监控-2" class="headerlink" title="效果监控"></a>效果监控</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> show variables like <span class="string">'%innodb_log_file%'</span>;</span></span><br><span class="line">+---------------------------+-----------+</span><br><span class="line">| Variable_name             | Value     |</span><br><span class="line">+---------------------------+-----------+</span><br><span class="line">| innodb_log_file_size      | 536870912 |</span><br><span class="line">| innodb_log_files_in_group | 2         |</span><br><span class="line">+---------------------------+-----------+</span><br><span class="line">2 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure>

<br>

<h3 id="3-5、InnoDB-Data-Dictionary"><a href="#3-5、InnoDB-Data-Dictionary" class="headerlink" title="3.5、InnoDB Data Dictionary"></a>3.5、InnoDB Data Dictionary</h3><p>InnoDB的数据字典 有 内部系统表组成，这些表包含 tables，indexs，和 table columns。元数据在物理上位于 system tablespace。由于历史原因，数据字典元数据 在一定程度上 与 InnoDB 表的元数据文件（.frm 文件）中存储的信息重叠。</p>
<br>

<h3 id="3-6、Doublewrite-Buffer"><a href="#3-6、Doublewrite-Buffer" class="headerlink" title="3.6、Doublewrite Buffer"></a>3.6、Doublewrite Buffer</h3><h4 id="功能介绍-7"><a href="#功能介绍-7" class="headerlink" title="功能介绍"></a>功能介绍</h4><p>​        <code>doublewrite buffer</code> 是 InnoDB 的 <code>system tablespace</code> 中的一个区域。在 把 <code>buffer pool</code> 中的内容写入对应的 data file 之前，先要把数据写入 <code>doublewirte buffer</code> 中；</p>
<p>​        如果 storage 或者 mysqld 在写 page的过程中 进程崩溃，InnoDB 可以在 <code>doublewrite buffer</code> 中找到完成的 page 的拷贝 用来恢复；</p>
<p>​        尽管数据总是写两次，但 <code>doublewrite buffer</code> 不需要两倍的 I/O开销 或 两倍的 I/O 操作。数据作为一个大的连续块 写入 <code>doublwrite buffer</code>，只需对操作系统执行一次 <code>fsync()</code> 调用；</p>
<p>​        <code>doublewirte buffer</code> 默认启用，如果想关掉它，设置 <code>innodb_doublewrite=0</code></p>
<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20191217201952.png" alt></p>
<h4 id="效果监控-3"><a href="#效果监控-3" class="headerlink" title="效果监控"></a>效果监控</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> show global status like <span class="string">'%dblwr%'</span>;</span></span><br><span class="line">+----------------------------+-------+</span><br><span class="line">| Variable_name              | Value |</span><br><span class="line">+----------------------------+-------+</span><br><span class="line">| Innodb_dblwr_pages_written | 91756 |</span><br><span class="line">| Innodb_dblwr_writes        | 18741 |</span><br><span class="line">+----------------------------+-------+</span><br><span class="line">2 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure>

<p>关注点：<code>Innodb_dblwr_pages_written / Innodb_dblwr_writes</code></p>
<p>　　开启doublewrite后，每次脏页刷新必须要先写doublewrite，而doublewrite存在于磁盘上的是两个连续的区，每个区由连续的页组成，一般情况下一个区最多有64个页，所以一次IO写入应该可以最多写64个页。</p>
<p>　　而根据以上系统Innodb_dblwr_pages_written与Innodb_dblwr_writes的比例来看，大概在3左右，远远还没到64(如果约等于64，那么说明系统的写压力非常大，有大量的脏页要往磁盘上写)，所以从这个角度也可以看出，系统写入压力并不高。</p>
<br>



<h1 id="三、常见参数介绍"><a href="#三、常见参数介绍" class="headerlink" title="三、常见参数介绍"></a>三、常见参数介绍</h1><h4 id="back-log"><a href="#back-log" class="headerlink" title="back_log"></a>back_log</h4><p>含义：</p>
<blockquote>
<p>MySQL可以具有的未完成连接请求数。也受操作系统限制，默认值-1表示自动调整大小。默认值是这么计算的(50 + (max_connections / 5))，范围(1-65535) ;</p>
<p>back_log值指出在MySQL暂时停止回答新请求之前的短时间内多少个请求可以被存在堆栈中。也就是说，如果MySql的连接数达到max_connections时，新来的请求将会被存在堆栈中，以等待某一连接释放资源，该堆栈的数量即back_log，如果等待连接的数量超过back_log，将不被授予连接资源。将会报：unauthenticated user | xxx.xxx.xxx.xxx | NULL | Connect | NULL | login | NULL 的待连接进程时.</p>
<p>back_log值不能超过TCP/IP连接的侦听队列的大小。若超过则无效，查看当前系统的TCP/IP连接的侦听队列的大小命令：cat /proc/sys/net/ipv4/tcp_max_syn_backlog，目前系统为1024。对于Linux系统推荐设置为大于512的整数;</p>
</blockquote>
<p>修改方式：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 修改 TCP/IP连接的侦听队列的大小</span></span><br><span class="line">cat /proc/sys/net/ipv4/tcp_max_syn_backlog</span><br><span class="line">vi /etc/sysctl.conf</span><br><span class="line"><span class="meta">#</span><span class="bash"> 添加: </span></span><br><span class="line">net.ipv4.tcp_max_syn_backlog = 2048</span><br><span class="line"><span class="meta">#</span><span class="bash"> 使生效</span></span><br><span class="line">sysctl -p</span><br><span class="line">cat /proc/sys/net/ipv4/tcp_max_syn_backlog</span><br><span class="line"></span><br><span class="line">vi /etc/my.cnf</span><br><span class="line">[mysqld]</span><br><span class="line">back_log=2000</span><br><span class="line">在mysql中查看</span><br><span class="line">show variables like 'back_log';</span><br></pre></td></tr></table></figure>

<h4 id="open-files-limit"><a href="#open-files-limit" class="headerlink" title="open_files_limit"></a>open_files_limit</h4><p>含义</p>
<blockquote>
<p> 在/etc/my.cnf加入open_files_limit=8192后重启MySQL后查看不起作用(重点在于操作系统的文件打开数是否够) </p>
<p>my.cnf里如果配置了open_files_limit</p>
<p>open_files_limit最后取值为 配置文件 open_files_limit，max_connections<em>5， wanted_files= 10+max_connections+table_cache_size</em>2 三者中的最大值。</p>
<p>如果my.cnf里如果没配置了open_files_limit</p>
<p>open_files_limit最后取值为max_connections<em>5，10+max_connections+table_cache_size</em>2，ulimit -n中的最大者</p>
</blockquote>
<p>修改方案：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 永久更改最大打开文件描述符数</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 第一步</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> vi /etc/security/limits.conf</span></span><br><span class="line">*  soft nofile 1000000</span><br><span class="line">*  hard nofile 1000000       #星号表示对所有用户生效</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 第二步</span></span><br><span class="line">vi /etc/my.cnf</span><br><span class="line">[mysqld_safe]</span><br><span class="line">open_files_limit=1000000</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 第三步</span></span><br><span class="line">vi /etc/systemd/system/mysql.service</span><br><span class="line">[Service]</span><br><span class="line">LimitNOFILE=1000000</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 第四步</span></span><br><span class="line">systemctl daemon-reload</span><br><span class="line"><span class="meta">#</span><span class="bash"> service mysqld restart</span></span><br><span class="line">systemctl restart mysqld.service</span><br><span class="line">reboot       #重启系统</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 第五步（查看是否生效）</span></span><br><span class="line">ulimit -n</span><br><span class="line"><span class="meta">#</span><span class="bash"> sysctl fs.file-max</span></span><br><span class="line"><span class="meta">#</span><span class="bash">PID是应用的进程ID，在输出结果中查看<span class="string">"Max open files"</span>的显示值</span></span><br><span class="line">ps aux | grep mysql</span><br><span class="line">cat /proc/$&#123;mysql-pid&#125;/limits</span><br></pre></td></tr></table></figure>

<p>cat /proc/${mysql-pid}/limits</p>
<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20191114212402.png" alt></p>
<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20191114210150.png" alt></p>
<h4 id="直接设置生效"><a href="#直接设置生效" class="headerlink" title="直接设置生效"></a>直接设置生效</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">character_set_server=utf8</span><br><span class="line">collation_server=utf8_general_ci</span><br><span class="line">enforce_gtid_consistency=ON</span><br><span class="line">expire_logs_days=3</span><br><span class="line">innodb_open_files=2000</span><br><span class="line">open_files_limit=1000000</span><br><span class="line">performance_schema_digests_size=10000</span><br><span class="line">performance_schema_events_stages_history_long_size=10000</span><br><span class="line">performance_schema_events_statements_history_long_size=10000</span><br><span class="line">performance_schema_events_waits_history_long_size=10000</span><br><span class="line">performance_schema_max_cond_instances=3504</span><br><span class="line">performance_schema_max_file_instances=7693</span><br><span class="line">performance_schema_max_mutex_instances=15906</span><br><span class="line">performance_schema_max_rwlock_instances=9102</span><br><span class="line">performance_schema_max_socket_instances=322</span><br><span class="line">performance_schema_max_table_handles=4000</span><br><span class="line">performance_schema_max_table_instances=12500</span><br><span class="line">performance_schema_max_thread_instances=402</span><br><span class="line">system_time_zone=CST</span><br><span class="line">table_definition_cache=1400</span><br><span class="line">table_open_cache=2000</span><br></pre></td></tr></table></figure>

<h4 id="host-cache-size"><a href="#host-cache-size" class="headerlink" title="host_cache_size"></a>host_cache_size</h4><p>含义</p>
<blockquote>
<p>–skip-host-cache</p>
<p>为加快主机名到IP解析禁用使用内部主机缓存。在这种情况，每次客户连接，服务器执行DNS查找。见 Section 8.11.5.2, “DNS Lookup Optimization and the Host Cache”。使用 –skip-host-cache类似设置系统变量host_cache_size的值为0，但host_cache_size更加灵活，因为在运行时它也可以调整大小、启用或禁用主机缓存,不只是在服务器启动事。如果使用 –skip-host-cache启动服务，它不能阻止host_cache_size的改变，但这些改变不生效和缓存是不可用，尽管host_cache_size设置大于0。</p>
</blockquote>
<p>修改</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/my.cnf</span><br><span class="line">[mysqld]</span><br><span class="line">host_cache_size=703</span><br></pre></td></tr></table></figure>

<h4 id="innodb-buffer-pool-size"><a href="#innodb-buffer-pool-size" class="headerlink" title="innodb_buffer_pool_size"></a>innodb_buffer_pool_size</h4><p> <a href="https://www.cnblogs.com/wanbin/p/9530833.html" target="_blank" rel="noopener">https://www.cnblogs.com/wanbin/p/9530833.html</a> </p>
<blockquote>
<p> MyISAM使用操作系统缓存来缓存数据。InnoDB需要innodb buffer pool中处理缓存。所以非常需要有足够的InnoDB buffer pool空间 </p>
<h4 id="MySQL-InnoDB-buffer-pool-里包含什么？"><a href="#MySQL-InnoDB-buffer-pool-里包含什么？" class="headerlink" title="MySQL InnoDB buffer pool 里包含什么？"></a>MySQL InnoDB buffer pool 里包含什么？</h4><ul>
<li><p><strong>数据缓存</strong><br>InnoDB数据页面</p>
</li>
<li><p><strong>索引缓存</strong><br>索引数据</p>
</li>
<li><p><strong>缓冲数据</strong><br>脏页（在内存中修改尚未刷新(写入)到磁盘的数据）</p>
</li>
<li><p><strong>内部结构</strong><br>如自适应哈希索引，行锁等。</p>
<h2 id="配置的innodb-buffer-pool-size是否合适？"><a href="#配置的innodb-buffer-pool-size是否合适？" class="headerlink" title="配置的innodb_buffer_pool_size是否合适？"></a>配置的innodb_buffer_pool_size是否合适？</h2><p>当前配置的innodb_buffer_pool_size是否合适，可以通过分析InnoDB缓冲池的性能来验证。</p>
<p>可以使用以下公式计算InnoDB缓冲池性能：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt;  Performance = innodb_buffer_pool_reads / innodb_buffer_pool_read_requests * 100</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</li>
</ul>
</blockquote>
<blockquote>
<p> <strong><code>innodb_buffer_pool_reads</code></strong>：表示InnoDB缓冲池无法满足的请求数。需要从磁盘中读取。<br> <strong><code>innodb_buffer_pool_read_requests</code></strong>：表示从内存中读取逻辑的请求数。</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&gt;  root@localhost [(none)] 15:35:31&gt;show status like &apos;innodb_buffer_pool_read%&apos;;</span><br><span class="line">&gt;  +---------------------------------------+-------------+</span><br><span class="line">&gt;  | Variable_name                         | Value       |</span><br><span class="line">&gt;  +---------------------------------------+-------------+</span><br><span class="line">&gt;  | Innodb_buffer_pool_read_ahead_rnd     | 0           |</span><br><span class="line">&gt;  | Innodb_buffer_pool_read_ahead         | 0           |</span><br><span class="line">&gt;  | Innodb_buffer_pool_read_ahead_evicted | 0           |</span><br><span class="line">&gt;  | Innodb_buffer_pool_read_requests      | 4029033624  |</span><br><span class="line">&gt;  | Innodb_buffer_pool_reads              | 91661       |</span><br><span class="line">&gt;  +---------------------------------------+-------------+</span><br><span class="line">&gt;  5 rows in set (0.00 sec)</span><br><span class="line">&gt;  </span><br><span class="line">&gt;  </span><br><span class="line">&gt;  Performance = 91661 / 4029033624 * 100 = 0.0022750120389663</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<blockquote>
<p> 意味着InnoDB可以满足缓冲池本身的大部分请求。从磁盘完成读取的百分比非常小。因此无需增加innodb_buffer_pool_size值。</p>
</blockquote>
<p>修改</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/my.cnf</span><br><span class="line">[mysqld]</span><br><span class="line">innodb_buffer_pool_size=9688842240</span><br></pre></td></tr></table></figure>

<h4 id="innodb-data-file-path"><a href="#innodb-data-file-path" class="headerlink" title="innodb_data_file_path"></a>innodb_data_file_path</h4><blockquote>
<p>innodb_data_file_path用来指定innodb tablespace文件，如果我们不在My.cnf文件中指定innodb_data_home_dir和innodb_data_file_path那么默认会在datadir目录下创建ibdata1 作为innodb tablespace </p>
<p> show variables like ‘innodb_data%’; </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt; innodb_data_file_path	ibdata1:12M:autoextend</span><br><span class="line">&gt; innodb_data_home_dir	</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<blockquote>
</blockquote>
<p>修改</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/my.cnf</span><br><span class="line">[mysqld]</span><br><span class="line">innodb_data_file_path=ibdata1:100M:autoextend</span><br></pre></td></tr></table></figure>

<p>可能引起的问题</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">2019-11-15 10:58:33 18273 [ERROR] InnoDB: auto-extending data file ./ibdata1 is of a different size 768 pages (rounded down to MB) than specified in the .cnf file: initial 6400 pages, max 0 (relevant if non-zero) pages!</span><br><span class="line">2019<span class="selector-tag">-11-15</span> 10<span class="selector-pseudo">:58</span><span class="selector-pseudo">:33</span> 18273 <span class="selector-attr">[ERROR]</span> <span class="selector-tag">InnoDB</span>: <span class="selector-tag">Could</span> <span class="selector-tag">not</span> <span class="selector-tag">open</span> <span class="selector-tag">or</span> <span class="selector-tag">create</span> <span class="selector-tag">the</span> <span class="selector-tag">system</span> <span class="selector-tag">tablespace</span>. <span class="selector-tag">If</span> <span class="selector-tag">you</span> <span class="selector-tag">tried</span> <span class="selector-tag">to</span> <span class="selector-tag">add</span> <span class="selector-tag">new</span> <span class="selector-tag">data</span> <span class="selector-tag">files</span> <span class="selector-tag">to</span> <span class="selector-tag">the</span> <span class="selector-tag">system</span> <span class="selector-tag">tablespace</span>, <span class="selector-tag">and</span> <span class="selector-tag">it</span> <span class="selector-tag">failed</span> <span class="selector-tag">here</span>, <span class="selector-tag">you</span> <span class="selector-tag">should</span> <span class="selector-tag">now</span> <span class="selector-tag">edit</span> <span class="selector-tag">innodb_data_file_path</span> <span class="selector-tag">in</span> <span class="selector-tag">my</span><span class="selector-class">.cnf</span> <span class="selector-tag">back</span> <span class="selector-tag">to</span> <span class="selector-tag">what</span> <span class="selector-tag">it</span> <span class="selector-tag">was</span>, <span class="selector-tag">and</span> <span class="selector-tag">remove</span> <span class="selector-tag">the</span> <span class="selector-tag">new</span> <span class="selector-tag">ibdata</span> <span class="selector-tag">files</span> <span class="selector-tag">InnoDB</span> <span class="selector-tag">created</span> <span class="selector-tag">in</span> <span class="selector-tag">this</span> <span class="selector-tag">failed</span> <span class="selector-tag">attempt</span>. <span class="selector-tag">InnoDB</span> <span class="selector-tag">only</span> <span class="selector-tag">wrote</span> <span class="selector-tag">those</span> <span class="selector-tag">files</span> <span class="selector-tag">full</span> <span class="selector-tag">of</span> <span class="selector-tag">zeros</span>, <span class="selector-tag">but</span> <span class="selector-tag">did</span> <span class="selector-tag">not</span> <span class="selector-tag">yet</span> <span class="selector-tag">use</span> <span class="selector-tag">them</span> <span class="selector-tag">in</span> <span class="selector-tag">any</span> <span class="selector-tag">way</span>. <span class="selector-tag">But</span> <span class="selector-tag">be</span> <span class="selector-tag">careful</span>: <span class="selector-tag">do</span> <span class="selector-tag">not</span> <span class="selector-tag">remove</span> <span class="selector-tag">old</span> <span class="selector-tag">data</span> <span class="selector-tag">files</span> <span class="selector-tag">which</span> <span class="selector-tag">contain</span> <span class="selector-tag">your</span> <span class="selector-tag">precious</span> <span class="selector-tag">data</span>!</span><br><span class="line">2019-11-15 10:58:33 18273 [ERROR] Plugin 'InnoDB' init function returned error.</span><br><span class="line">2019-11-15 10:58:33 18273 [ERROR] Plugin 'InnoDB' registration as a STORAGE ENGINE failed.</span><br><span class="line">2019-11-15 10:58:33 18273 [ERROR] Unknown/unsupported storage engine: InnoDB</span><br><span class="line">2019<span class="selector-tag">-11-15</span> 10<span class="selector-pseudo">:58</span><span class="selector-pseudo">:33</span> 18273 <span class="selector-attr">[ERROR]</span> <span class="selector-tag">Aborting</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p><a href="https://blog.csdn.net/u010735147/article/details/82415868" target="_blank" rel="noopener">https://blog.csdn.net/u010735147/article/details/82415868</a><br>问题分析：从Error看,表空间ibdata1跑在旧的my.cnf下大小65536/64M(64个page=1M,1个page=16k)比现在my.cnf文件中配置的<br>ibdata1值要小,导致数据文件无法打开，同时InnoDB存储引擎加载失败<br>解决方式:<br>1.删除现在ibdata1数据文件,引起另外麻烦,mysqld启动了，但是所有InnoDB表报废，select时提示该表不存在—慎用；<br>2.注释该设置的参数(InnoDB_data_file_path),MySQLd启用默认设置ibdata1值大小;<br>3.ibdata1大小扩展方式,网上搜索一把,查询是ibdata1如何瘦身,涉及参数:InnoDB_data_file_path;</p>
</blockquote>
<h4 id="innodb-numa-interleave"><a href="#innodb-numa-interleave" class="headerlink" title="innodb_numa_interleave"></a>innodb_numa_interleave</h4><blockquote>
<p>大家都知道，在运行mysql服务的服务器上，linux系统的内存numa特性是强烈建议关闭的。因为这种特性很容易引起内存泄漏的情况：即发现物理内存还有剩余，但是系统已经开始使用swap内存。</p>
<p>​    numa内存特性：比如一台机器是有2个处理器，有4个内存块。我们将1个处理器和两个内存块合起来，称为一个NUMA node，这样这个机器就会有两个NUMA node。在物理分布上，NUMA node的处理器和内存块的物理距离更小，因此访问也更快。比如这台机器会分左右两个处理器（cpu1, cpu2），在每个处理器两边放两个内存块(memory1.1, memory1.2, memory2.1,memory2.2)，这样NUMA node1的cpu1访问memory1.1和memory1.2就比访问memory2.1和memory2.2更快。所以使用NUMA的模式如果能尽量保证本node内的CPU只访问本node内的内存块，那这样的效率就是最高的。</p>
<p>​    其实由于mysql数据库服务器一般只会部署mysql一种服务在运行，而不会部署若干应用在运行。所以一般是希望mysql是独占整个服务器的资源（剔除留给操作系统运行的资源）。所以根据这种业务特性，mysql服务器上是不建议开启numa内存特性。</p>
</blockquote>
<p>修改</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 建议关闭</span></span><br><span class="line">【关闭NUMA的方案】</span><br><span class="line">1、 在mysqld_safe脚本中加上“numactl –interleave all”来启动mysqld</span><br><span class="line">2、 Linux Kernel启动参数中加上numa=off，需要重启服务器</span><br><span class="line">3、 在BIOS层面关闭NUMA</span><br><span class="line">4、 MySQL 5.6.27/5.7.9开始引用innodb_numa_interleave选项</span><br></pre></td></tr></table></figure>

<h4 id="innodb-flush-log-at-trx-commit"><a href="#innodb-flush-log-at-trx-commit" class="headerlink" title="innodb_flush_log_at_trx_commit"></a>innodb_flush_log_at_trx_commit</h4><blockquote>
<p>一、参数解释<br>0：log buffer将每秒一次地写入log file中，并且log file的flush(刷到磁盘)操作同时进行。该模式下在事务提交的时候，不会主动触发写入磁盘的操作。<br>1：每次事务提交时MySQL都会把log buffer的数据写入log file，并且flush(刷到磁盘)中去，该模式为系统默认。<br>2：每次事务提交时MySQL都会把log buffer的数据写入log file，但是flush(刷到磁盘)操作并不会同时进行。该模式下，MySQL会每秒执行一次 flush(刷到磁盘)操作。</p>
<p>二、参数修改<br>找到mysql配置文件mysql.ini，修改成合适的值，然后重启mysql。</p>
<p>三、注意事项<br>当设置为0，该模式速度最快，但不太安全，mysqld进程的崩溃会导致上一秒钟所有事务数据的丢失。<br>当设置为1，该模式是最安全的，但也是最慢的一种方式。在mysqld 服务崩溃或者服务器主机crash的情况下，binary log 只有可能丢失最多一个语句或者一个事务。。<br>当设置为2，该模式速度较快，也比0安全，只有在操作系统崩溃或者系统断电的情况下，上一秒钟所有事务数据才可能丢失。</p>
<p>四、其他相关<br>查找资料时候看到其他文章说innodb_flush_log_at_trx_commit和sync_binlog 两个参数是控制MySQL 磁盘写入策略以及数据安全性的关键参数，当两个参数都设置为1的时候写入性能最差，推荐做法是innodb_flush_log_at_trx_commit=2，sync_binlog=500 或1000</p>
</blockquote>
<p>修改</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/my.cnf</span><br><span class="line">[mysqld]</span><br><span class="line">innodb_flush_log_at_trx_commit=2</span><br></pre></td></tr></table></figure>

<h4 id="innodb-flush-method"><a href="#innodb-flush-method" class="headerlink" title="innodb_flush_method"></a>innodb_flush_method</h4><p> <a href="https://blog.csdn.net/smooth00/article/details/72725941" target="_blank" rel="noopener">https://blog.csdn.net/smooth00/article/details/72725941</a> </p>
<blockquote>
<p>fdatasync模式：写数据时，write这一步并不需要真正写到磁盘才算完成（可能写入到操作系统buffer中就会返回完成），真正完成是flush操作，buffer交给操作系统去flush,并且文件的元数据信息也都需要更新到磁盘。<br>O_DSYNC模式：写日志操作是在write这步完成，而数据文件的写入是在flush这步通过fsync完成<br>O_DIRECT模式：数据文件的写入操作是直接从mysql innodb buffer到磁盘的，并不用通过操作系统的缓冲，而真正的完成也是在flush这步,日志还是要经过OS缓冲</p>
</blockquote>
<p>修改</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/my.cnf</span><br><span class="line">[mysqld]</span><br><span class="line">innodb_flush_method=O_DIRECT</span><br></pre></td></tr></table></figure>

<p>此模式，稳定性最高，直接读写磁盘，不经过buffer</p>
<h4 id="innodb-io-capacity"><a href="#innodb-io-capacity" class="headerlink" title="innodb_io_capacity"></a>innodb_io_capacity</h4><p>可以提高 数据库 tps</p>
<blockquote>
<ul>
<li>innodb_io_capacity 和 innodb_io_capacity_max</li>
</ul>
<p>​        这是一个更加高级的调优，只有当你在频繁写操作的时候才有意义（它不适用于读操作，例如 SELECTs）。若你真的需要对它进行调整，最好的方法是要了解系统可以支持多大的 IOPS。譬如，假设服务器有一块 SSD 硬盘，我们可以设置 <code>innodb_io_capacity_max=6000</code> 和 <code>innodb_io_capacity=3000</code>（最大值的一半）。运行 sysbench 或者任何其他基准工具来对磁盘吞吐量来进行基准测试是一个好方法。</p>
<p> 然而，我们需要去担心这个选项吗？看下面这张缓冲池的”<a href="http://dev.mysql.com/doc/refman/5.7/en/glossary.html#glos_dirty_page" target="_blank" rel="noopener">脏页</a>“ </p>
<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20191115104642.png" alt></p>
<p> 在这种情况下，脏页的总量很大，而且看起来 InnoDB 刷新脏页的速度跟不上脏页的速度。如果我们有一个高速的磁盘子系统（例如：SSD），可以增加 <code>innodb_io_capacity</code> 和 innodb_io_capacity_max 来得到更好的性能。 </p>
</blockquote>
<p>修改</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/my.cnf</span><br><span class="line">[mysqld]</span><br><span class="line">innodb_io_capacity=2000</span><br><span class="line">innodb_io_capacity_max=4000</span><br></pre></td></tr></table></figure>

<h4 id="innodb-log-file-size"><a href="#innodb-log-file-size" class="headerlink" title="innodb_log_file_size"></a>innodb_log_file_size</h4><p>延伸阅读： <a href="https://blog.csdn.net/kai404/article/details/80242262" target="_blank" rel="noopener">https://blog.csdn.net/kai404/article/details/80242262</a> </p>
<blockquote>
<p>跟其他数据库管理系统一样，MySQL通过日志来实现数据的持久性（在使用InnoDB存储引擎的前提下）。这确保了当一个事务提交后，其相关数据在崩溃或者服务器掉电的情况下不会丢失。</p>
<p>MySQL的InnoDB 存储引擎使用一个指定大小的Redo log空间（一个环形的数据结构）。Redo log的空间通过<code>innodb_log_file_size</code>和<code>innodb_log_files_in_group</code>（默认2）参数来调节。将这俩参数相乘即可得到总的可用Redo log 空间。尽管技术上并不关心你是通过<code>innodb_log_file_size</code>还是<code>innodb_log_files_in_group</code>来调整Redo log空间，不过多数情况下还是通过<code>innodb_log_file_size</code> 来调节。</p>
<p> 为InnoDB引擎设置合适的Redo log空间对于写敏感的工作负载来说是非常重要的。然而，这项工作是要做出权衡的。你配置的Redo空间越大，InnoDB就能更好的优化写操作；然而，增大Redo空间也意味着更长的恢复时间当出现崩溃或掉电等意外时。 </p>
<p> 恢复时间 : 每1GB的Redo log的恢复时间大约在5分钟左右来估算 ;</p>
<p> 关于Redo 空间的使用情况，如果没有安装PMM的话，也可以通过下面的命令来观察每小时的写入量（MB）： </p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;</span><span class="bash"> a=$(mysql -uuser -p<span class="string">'passwd'</span> -e <span class="string">"show engine innodb status\G"</span> | grep <span class="string">"Log sequence number"</span> | awk <span class="string">'&#123;print $4&#125;'</span>); sleep 60; b=$(mysql -uuser -p<span class="string">'passwd'</span> -e <span class="string">"show engine innodb status\G"</span> | grep <span class="string">"Log sequence number"</span> | awk <span class="string">'&#123;print $4&#125;'</span>); <span class="built_in">let</span> <span class="string">"res=(<span class="variable">$b</span>-<span class="variable">$a</span>)*60/1024/1024"</span>;<span class="built_in">echo</span> <span class="variable">$res</span></span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"></span></span><br></pre></td></tr></table></figure>
</blockquote>
<blockquote>
</blockquote>
<p>修改</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/my.cnf</span><br><span class="line">[mysqld]</span><br><span class="line">innodb_log_file_size=536870912</span><br></pre></td></tr></table></figure>

<h4 id="innodb-max-dirty-pages-pct"><a href="#innodb-max-dirty-pages-pct" class="headerlink" title="innodb_max_dirty_pages_pct"></a>innodb_max_dirty_pages_pct</h4><blockquote>
<p> mysql检查点事件受两个因素的制约：一个是amount,另外一个是age.amount主要由innodb_max_dirty_pages_pct参数控制;至于age,主要是由日志文件大小有关 ;</p>
<p>innodb_io_capacity, innodb_max_dirty_pages_pct, innodb_adaptive_flushing这三个参数是为了解决SSD等大容量存储设备的出现而导致innoDB不能很好利用这类设备性能的困境而出现的，本文会结合mysql-5.5.34的源代码进行这三个参数的介绍;</p>
<ul>
<li>innodb_max_dirty_pages_pct：参数会让InnoDB Buffer Pool刷新数据而不让脏数据的百分比超过这个值； </li>
<li>innodb_max_dirty_pages_pct_lwm：InnoDB会自动维护后台作业自动从Buffer Pool当中清除脏数据，当Buffer Pool中的脏页占用比 达到innodb_max_dirty_pages_pct_lwm的设定值的时候，就会自动将脏页清出Buffer Pool； </li>
</ul>
</blockquote>
<p>修改</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">innodb_max_dirty_pages_pct=50</span><br></pre></td></tr></table></figure>

<h4 id="innodb-open-files"><a href="#innodb-open-files" class="headerlink" title="innodb_open_files"></a>innodb_open_files</h4><blockquote>
<p> ​    限制Innodb能同时打开的表的数量，默认为300，数据库里的表特别多的情况，可以适当增大为1000。innodb_open_files的大小对InnoDB效率的影响比较小。但是在InnoDBcrash的情况下，innodb_open_files设置过小会影响recovery的效率。所以用InnoDB的时候还是把innodb_open_files放大一些比较合适。 </p>
</blockquote>
<p>修改</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">innodb_open_files=1024</span><br></pre></td></tr></table></figure>

<h4 id="key-buffer-size"><a href="#key-buffer-size" class="headerlink" title="key_buffer_size"></a>key_buffer_size</h4><blockquote>
<p> key_buffer_size这个参数是用来设置索引块（index blocks）缓存的大小，它被所有线程共享，严格说是它决定了数据库索引处理的速度，尤其是索引读的速度。那我们怎么才能知道key_buffer_size的设置是否合理呢，一般可以检查状态值Key_read_requests和Key_reads，比例key_reads / key_read_requests应该尽可能的低，比如1:100，1:1000 ，1:10000。其值可以用以i下命令查得： </p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;</span><span class="bash"> mysql&gt; show status like <span class="string">'key_read%'</span>;</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> +-------------------+------------+</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> | Variable_name     | Value      |</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> +-------------------+------------+</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> | Key_read_requests | 3916880184 | </span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> | Key_reads         | 1014261    | </span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> +-------------------+------------+</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> 2 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> 3916880184/1024/1024=?M    //单位为兆</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> 我的key_buffer_size值为：</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> key_buffer_size=536870912/1024/1024=512M,</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> key_reads / key_read_requests=1014261: 3916880184≈1:4000，照上面来看，健康状况还行。</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"></span></span><br></pre></td></tr></table></figure>
</blockquote>
<blockquote>
</blockquote>
<p>修改</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">key_buffer_size=33554432</span><br></pre></td></tr></table></figure>

<h4 id="long-query-time"><a href="#long-query-time" class="headerlink" title="long_query_time"></a>long_query_time</h4><p>慢查询阈值</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">long_query_time=3.000000</span><br></pre></td></tr></table></figure>

<h4 id="max-connections"><a href="#max-connections" class="headerlink" title="max_connections"></a>max_connections</h4><blockquote>
<p>数据库最大连接数，系统支持的最大连接</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"> mysql&gt;</span><span class="bash"> show status like <span class="string">'Threads%'</span>;</span></span><br><span class="line">+-------------------+-------+</span><br><span class="line">| Variable_name     | Value |</span><br><span class="line">+-------------------+-------+</span><br><span class="line">| Threads_cached    | 58    |</span><br><span class="line">| Threads_connected | 57    |   ###这个数值指的是打开的连接数</span><br><span class="line">| Threads_created   | 3676  |</span><br><span class="line">| Threads_running   | 4     |   ###这个数值指的是激活的连接数，这个数值一般远低于connected数值</span><br><span class="line">+-------------------+-------+</span><br><span class="line"> </span><br><span class="line">Threads_connected 跟show processlist结果相同，表示当前连接数。准确的来说，Threads_running是代表当前并发数</span><br><span class="line"> </span><br><span class="line">这是是查询数据库当前设置的最大连接数</span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> show variables like <span class="string">'%max_connections%'</span>;</span></span><br><span class="line">+-----------------+-------+</span><br><span class="line">| Variable_name   | Value |</span><br><span class="line">+-----------------+-------+</span><br><span class="line">| max_connections | 1000  |</span><br><span class="line">+-----------------+-------+</span><br><span class="line"> </span><br><span class="line">可以在/etc/my.cnf里面设置数据库的最大连接数</span><br><span class="line">[mysqld]</span><br><span class="line">max_connections = 1000</span><br></pre></td></tr></table></figure>

<p>设置</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">max_connections=2000</span><br></pre></td></tr></table></figure>

<h4 id="max-user-connections"><a href="#max-user-connections" class="headerlink" title="max_user_connections"></a>max_user_connections</h4><p>用户能最大连接进来的数量</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">max_user_connection=600</span><br></pre></td></tr></table></figure>

<h4 id="max-connect-errors"><a href="#max-connect-errors" class="headerlink" title="max_connect_errors"></a>max_connect_errors</h4><p>阅读延伸： <a href="https://www.cnblogs.com/kerrycode/p/8405862.html" target="_blank" rel="noopener">https://www.cnblogs.com/kerrycode/p/8405862.html</a> </p>
<blockquote>
<p>If more than this many successive connection requests from a host are interrupted without a successful connection, the server blocks that host from further connections. You can unblock blocked hosts by flushing the host cache. To do so, issue a FLUSH HOSTS statement or execute a mysqladmin flush-hosts command. If a connection is established successfully within fewer than max_connect_errors attempts after a previous connection was interrupted, the error count for the host is cleared to zero. However, once a host is blocked, flushing the host cache is the only way to unblock it. The default is 100.</p>
<p>如上所示，翻译出来的话，大致如下：如果MySQL服务器连续接收到了来自于同一个主机的请求，而且这些连续的请求全部都没有成功的建立连接就被中断了，当这些连续的请求的累计值大于max_connect_errors的设定值时，MySQL服务器就会阻止这台主机后续的所有请求。相信一开始你看到这些资料，也会被“many successive connection requests from a host are interrupted without a successful connection”给弄懵，其实这个就是因为由于网络异常而中止数据库连接</p>
</blockquote>
<p>设置</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">max_connect_errors=2000</span><br></pre></td></tr></table></figure>

<h4 id="max-allowed-packet"><a href="#max-allowed-packet" class="headerlink" title="max_allowed_packet"></a>max_allowed_packet</h4><blockquote>
<p>mysql根据配置文件会限制server接受的数据包大小。</p>
<p>有时候大的插入和更新会受max_allowed_packet 参数限制，导致写入或者更新失败。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;</span><span class="bash"> mysql&gt; show variables like <span class="string">'max_allowed_packet'</span>;</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> +--------------------+---------+</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> | Variable_name      | Value   |</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> +--------------------+---------+</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> | max_allowed_packet | 4194304 |</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> +--------------------+---------+</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> 1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"></span></span><br></pre></td></tr></table></figure>
</blockquote>
<blockquote>
</blockquote>
<p>设置</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">max_allowed_packet=16777216</span><br></pre></td></tr></table></figure>

<h4 id="max-digest-length-？？？"><a href="#max-digest-length-？？？" class="headerlink" title="max_digest_length ？？？"></a>max_digest_length ？？？</h4><h4 id="net-buffer-length"><a href="#net-buffer-length" class="headerlink" title="net_buffer_length"></a>net_buffer_length</h4><blockquote>
<p>net_buffer_length选项对数据备份及恢复影响<br>net-buffer-length 可能对mysqldump导出及恢复有影响，对此测试了一下，发现影响很小，基本可以忽略不计<br>每个客户端连接时。用于维持连接缓冲，初始分配预设值，在有需要时，则会自动扩大到max_allowed_packet大小，然后在回收预设的net_buffer_length大小 最小1k 最大1m默认16k</p>
</blockquote>
<p>设置</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">net_buffer_length=8192</span><br></pre></td></tr></table></figure>

<h4 id="query-cache-size"><a href="#query-cache-size" class="headerlink" title="query_cache_size"></a>query_cache_size</h4><p>延伸阅读：<a href="https://blog.csdn.net/u014044812/article/details/78924315" target="_blank" rel="noopener">https://blog.csdn.net/u014044812/article/details/78924315</a></p>
<blockquote>
<p>1、原理<br>MySQL查询缓存保存查询返回的完整结果。当查询命中该缓存，会立刻返回结果，跳过了解析，优化和执行阶段。<br>查询缓存会跟踪查询中涉及的每个表，如果这写表发生变化，那么和这个表相关的所有缓存都将失效。<br>但是随着服务器功能的强大，查询缓存也可能成为整个服务器的资源竞争单点。<br>2、初步设置<br>默认这个开关是关闭的，就是禁止使用query_cache，查询是否使用语句如下： </p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;</span><span class="bash"> mysql&gt; show variables like <span class="string">'have_query_cache'</span>; </span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> +------------------+-------+</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> | Variable_name    | Value |</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> +------------------+-------+</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> | have_query_cache | YES   |</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> +------------------+-------+</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> 1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> </span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> mysql&gt; show variables like <span class="string">'query_cache%'</span>;</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> +------------------------------+---------+</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> | Variable_name                | Value   |</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> +------------------------------+---------+</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> | query_cache_limit            | 1048576 |</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> | query_cache_min_res_unit     | 4096    |</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> | query_cache_size             | 1048576 |</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> | query_cache_type             | OFF     |</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> | query_cache_wlock_invalidate | OFF     |</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> +------------------------------+---------+</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> 5 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"></span></span><br></pre></td></tr></table></figure>
</blockquote>
<blockquote>
<p>注意这个只是显示，支持query_cache功能而已，默认是关闭的</p>
<p>3、MYSQL如何分配query_cache_size<br>MySQL用于查询的缓存的内存被分成一个个变长数据块，用来存储类型，大小，数据等信息。<br>当服务器启动的时候，会初始化缓存需要的内存，是一个完整的空闲块。当查询结果需要缓存的时候，先从空闲块中申请一个数据块大于参数query_cache_min_res_unit的配置，即使缓存数据很小，申请数据块也是这个，因为查询开始返回结果的时候就分配空间，此时无法预知结果多大。<br>分配内存块需要先锁住空间块，所以操作很慢，MySQL会尽量避免这个操作，选择尽可能小的内存块，如果不够，继续申请，如果存储完时有空余则释放多余的。<br>4、如何判断是否命中<br>缓存存放在一个引用表中，通过一个哈希值引用，这个哈希值包括查询本身，数据库，客户端协议的版本等，任何字符上的不同，例如空格，注释都会导致缓存不命中。<br>当查询中有一些不确定的数据时，是不会缓存的，比方说now(),current_date(),自定义函数，存储函数，用户变量，字查询等。所以这样的查询也就不会命中缓存，但是还会去检测缓存的，因为查询缓存在解析SQL之前，所以MySQL并不知道查询中是否包含该类函数，只是不缓存，自然不会命中。 </p>
<p>打开Qcache对读和写都会带来额外的消耗：<br>a、读查询开始之前必须检查是否命中缓存。<br>b、如果读查询可以缓存，那么执行完之后会写入缓存。<br>c、当向某个表写入数据的时候，必须将这个表所有的缓存设置为失效，如果缓存空间很大，则消耗也会很大，可能使系统僵死一段时间，因为这个操作是靠全局锁操作来保护的。<br>对InnoDB表，当修改一个表时，设置了缓存失效，但是多版本特性会暂时将这修改对其他事务屏蔽，在这个事务提交之前，所有查询都无法使用缓存，直到这个事务被提交，所以长时间的事务，会大大降低查询缓存的命中<br>  一个表可以被许多类型的语句更改，例如INSERT、UPDATE、DELETE、TRUNCATE、ALTER TABLE、DROP TABLE或DROP DATABASE。<br>对于InnoDB而言，事物的一些特性还会限制查询缓存的使用。当在事物A中修改了B表时，因为在事物提交之前，对B表的修改对其他的事物而言是不可见的。为了保证缓存结果的正确性，InnoDB采取的措施让所有涉及到该B表的查询在事物A提交之前是不可缓存的。如果A事物长时间运行，会严重影响查询缓存的命中率<br>查询缓存的空间不要设置的太大。<br>因为查询缓存是靠一个全局锁操作保护的，如果查询缓存配置的内存比较大且里面存放了大量的查询结果，当查询缓存失效的时候，会长时间的持有这个全局锁。因为查询缓存的命中检测操作以及缓存失效检测也都依赖这个全局锁，所以可能会导致系统僵死的情况 </p>
<p>5、</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;</span><span class="bash"> mysql&gt; show status like <span class="string">'Qcache%'</span>; </span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> +-------------------------+---------+</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> | Variable_name           | Value   |</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> +-------------------------+---------+</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> | Qcache_free_blocks      | 1       |</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> | Qcache_free_memory      | 1031352 |</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> | Qcache_hits             | 0       |</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> | Qcache_inserts          | 0       |</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> | Qcache_lowmem_prunes    | 0       |</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> | Qcache_not_cached       | 7       |</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> | Qcache_queries_in_cache | 0       |</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> | Qcache_total_blocks     | 1       |</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> +-------------------------+---------+</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> 8 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"></span></span><br></pre></td></tr></table></figure>
</blockquote>
<blockquote>
<p>解析：<br>Qcache_free_blocks:表示查询缓存中目前还有多少剩余的blocks，如果该值显示较大，则说明查询缓存中的内存碎片过多了，可能在一定的时间进行整理。<br>    减少碎片：<br>合适的query_cache_min_res_unit可以减少碎片，这个参数最合适的大小和应用程序查询结果的平均大小直接相关，可以通过内存实际消耗（query_cache_size - Qcache_free_memory）除以Qcache_queries_in_cache计算平均缓存大小。<br>可以通过Qcache_free_blocks来观察碎片，这个值反应了剩余的空闲块，如果这个值很多，但是<br>Qcache_lowmem_prunes却不断增加，则说明碎片太多了。可以使用flush query cache整理碎片，重新排序，但不会清空，清空命令是reset query cache。整理碎片期间，查询缓存无法被访问，可能导致服务器僵死一段时间，所以查询缓存不宜太大。<br>Qcache_free_memory:查询缓存的内存大小，通过这个参数可以很清晰的知道当前系统的查询内存是否够用，是多了，还是不够用，DBA可以根据实际情况做出调整。<br>Qcache_hits:表示有多少次命中缓存。我们主要可以通过该值来验证我们的查询缓存的效果。数字越大，缓存效果越理想。<br>Qcache_inserts: 表示多少次未命中然后插入，意思是新来的SQL请求在缓存中未找到，不得不执行查询处理，执行查询处理后把结果insert到查询缓存中。这样的情况的次 数，次数越多，表示查询缓存应用到的比较少，效果也就不理想。当然系统刚启动后，查询缓存是空的， 这很正常。<br>Qcache_lowmem_prunes:该参数记录有多少条查询因为内存不足而被移除出查询缓存。通过这个值，用户可以适当的调整缓存大小。<br>Qcache_not_cached: 表示因为query_cache_type的设置而没有被缓存的查询数量。<br>Qcache_queries_in_cache:当前缓存中缓存的查询数量。<br>Qcache_total_blocks:当前缓存的block数量。</p>
</blockquote>
<p>设置</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">query_cache_size=0</span><br><span class="line">query_cache_type=OFF</span><br></pre></td></tr></table></figure>

<p>提高查询缓存的使用率：<br>如果碎片不是问题，命中率却非常低，可能是内存不足，可以通过 Qcache_free_memory 参数来查看没有使用的内存。<br>如果2者都没有问题，命中率依然很低，那么说明缓存不适合你的当前系统。可以通过设置<br>query_cache_size = 0或者query_cache_type 来关闭查询缓存。</p>
<h4 id="read-buffer-size"><a href="#read-buffer-size" class="headerlink" title="read_buffer_size"></a>read_buffer_size</h4><blockquote>
<p>key_buffer_size + (read_buffer_size + sort_buffer_size)*max_connections = 458624 K</p>
<ul>
<li>read_buffer_size：是MySQL读入缓冲区大小。对表进行顺序扫描的请求将分配一个读入缓冲区，MySQL会为它分配一段内存缓冲区。</li>
<li>read_buffer_size变量控制这一缓冲区的大小。如果对表的顺序扫描请求非常频繁，并且你认为频繁扫描进行得太慢，可以通过增加该变量值以及内存缓冲区大小提高其性能。</li>
</ul>
</blockquote>
<h4 id="read-rnd-buffer-size"><a href="#read-rnd-buffer-size" class="headerlink" title="read_rnd_buffer_size"></a>read_rnd_buffer_size</h4><blockquote>
<p>MySQL手册里关于read_rnd_buffer_size的解释如下：   [ mrr  order by ]</p>
<p>   sort后，得到的是行数据指针，通过key-value的形式存在，对于MyISAM是数据的偏移量，对于innodb是主键或存储重新查询的全量数据（对于小片的数据是有益的）。</p>
<p>   假设sort后的数据使用的是行指针，并且行中的字段能够被转换成固定的大小（除了BLOB/TEXT字段外），MySQL能够使用read_rnd_buffer_size优化数据读取。</p>
<p>   因为sort后的数据是以key-value的形式存在的，使用这些行指针去读取数据，将是以指针数据物理的顺序去读取，很大程度上是随机的方式读取数据的。MySQL从　　　    sort_buffer中读取这些行指针数据，然后通过指针排序后存入read_rnd_buffer中，之后再通过指针读取数据时，基本上都是顺序读取了。</p>
<p>   read_rnd_buffer_size是很重要的参数，尤其工作在如下场景：</p>
<ul>
<li><p>sort_buffer中存的是行指针而不是要查询的数据。</p>
</li>
<li><p>查询的字段中包含Blob/Text字段。</p>
</li>
<li><p>sort后有大量的数据行（limit 10并不能帮助你，因为MySQL是通过指针获取行数据的）</p>
<p>如果你取出很少字段的数据（小于max_length_for_sort_data）,行数据将会全部存储在sort buffer里，因此将不需要read_rnd_buffer_size这个参数。</p>
<p>而如果你查询的字段数据很长（这些字段很可能含有Text/Blob字段），比max_length_for_sort_data还长，read_rnd_buffer_size这个参数将派上用场。</p>
</li>
</ul>
</blockquote>
<h4 id="table-open-cache"><a href="#table-open-cache" class="headerlink" title="table_open_cache"></a>table_open_cache</h4><blockquote>
<p> table_open_cache指定表高速缓存的大小。每当MySQL访问一个表时，如果在表缓冲区中还有空间，该表就被打开并放入其中，这样可以更快地访问表内容。<br> 通过检查峰值时间的状态值Open_tables和Opened_tables，可以决定是否需要增加table_open_cache的值。<br> 如果你发现<strong>open_tables</strong>等于<strong>table_open_cache</strong>，并且<strong>opened_tables</strong>在不断增长，那么你就需要增加table_open_cache的值了(上述状态值可通过SHOW GLOBAL STATUS LIKE ‘Open%tables’获得)。<br> 注意，不能盲目地把table_open_cache设置成很大的值，设置太大超过了shell的文件描述符(通过ulimit -n查看)，造成文件描述符不足，从而造成性能不稳定或者连接失败。 </p>
</blockquote>
<p>修改方式：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/my.cnf</span><br><span class="line">[mysqld]</span><br><span class="line">table_open_cache=2000</span><br></pre></td></tr></table></figure>

<h4 id="table-definition-cache"><a href="#table-definition-cache" class="headerlink" title="table_definition_cache"></a>table_definition_cache</h4><p>延伸阅读： <a href="http://ju.outofmemory.cn/entry/332959" target="_blank" rel="noopener">http://ju.outofmemory.cn/entry/332959</a> </p>
<blockquote>
<p>来理解一下 <code>table_open_cache</code>到底是来干嘛的，文档里或者网上的文章，通通解释是“用于控制MySQL Server能同时打开表的最大个数”。如果继续问这个个数怎么算呢？</p>
<p>我来尝试解答一下。MySQL是多线程的，多个会话上有可能会同时访问同一个表，mysql是允许这些会话各自独立的打开这个表，而表最终都是磁盘上的数据文件。(默认假设innodb_file_per_table=1)，打开文件需要获取文件描述符(File Descriptor)，为了加快这个open table的速度，MySQL在Server层设计了这个cache：</p>
<blockquote>
<p>The idea behind this cache is that most statements don’t need to go to a central table definition cache to get a TABLE object and therefore don’t need to lock LOCK_open mutex. Instead they only need to go to one Table_cache instance (the specific instance is determined by thread id) and only lock the mutex protecting this cache. DDL statements that need to remove all TABLE objects from all caches need to lock mutexes for all Table_cache instances, but they are rare.</p>
</blockquote>
<p>table_cache 减少了表级别 LOCK_open 这个互斥量的获取，改用获取 表对象缓存实例 列表的mutex。简化成如下过程：</p>
<ol>
<li>假设当前并发200个连接，table_open_cache=200，其中有50连接都在访问同一张表</li>
<li>mysql内部维护了一个 unused_table_list，在a表上的请求结束后，会把这个thread刚才用过的 table object 放入unused_table_list</li>
<li>每个表有个key，可以通过hash快速定位到表a的所有可用object，如果后面一下子100个连接上来访问表a，内部会先从 unused_table_list 去找这个表已经缓存过的对象(get_table)，比如前50个可以直接拿来用(unlink_unused_table)</li>
<li>后50个则需要调用系统内核，拿到文件描述符。</li>
<li>用完之后会，放回到unused_table_list，并将这个表的key放到hash表的前面。</li>
<li>如果缓存的对象个数超过了 table_open_cache，则会通过LRU算法，把认为不用的表对象逐出。</li>
</ol>
<p>从上面的过程应该很容易理解 table_open_cache 与 table_definition_cache 的区别。</p>
<ul>
<li><code>table_defintion_cache</code>也是一个key/value形式的hash表，但每个表只有一个值，值/对象的内容就是表的元数据信息(Data Dictionay，frm文件里面的信息)，如表结构、字段、索引，它是一个全局的结构，并且不占用文件描述符。</li>
<li>而 <code>table_open_cache</code>的key/value的值是一个列表，表示这个表的多个 Table_cache_element，他们共用这个表的 definition (代码层定义为TABLE_SHARE对象)。</li>
</ul>
<p>(注：我们在row格式的binlog里面看到的 table_map_id 就是在 TABLE_SHARE 里面定义的，表结构变更、缓存被逐出，都会导致 table_map_id 递增。)</p>
</blockquote>
<h4 id="thread-cache-size"><a href="#thread-cache-size" class="headerlink" title="thread_cache_size"></a>thread_cache_size</h4><blockquote>
<p>thread_cache_size：当客户端断开之后，服务器处理此客户的线程将会缓存起来以响应下一个客户而不是销毁(前提是缓存数未达上限)</p>
<p>即可以重新利用保存在缓存中线程的数量，当断开连接时如果缓存中还有空间，那么客户端的线程将被放到缓存中，如果线程重新被请求，那么请求将从缓存中读取，如果缓存中是空的或者是新的请求，那么这个线程将被重新创建，如果有很多新的线程，增加这个值可以改善系统性能。</p>
<p>thread_cache_size大小的设置：</p>
<p>如果是短连接，适当设置大一点，因为短连接往往需要不停创建，不停销毁，如果大一点，连接线程都处于取用状态，不需要重新创建和销毁，所以对性能肯定是比较大的提升。<br>对于长连接，不能保证连接的稳定性，所以设置这参数还是有一定必要，可能连接池的问题，会导致连接数据库的不稳定性，也会出现频繁的创建和销毁，但这个情况比较少，如果是长连接，可以设置成小一点，一般在50-100左右。</p>
</blockquote>
<p>设置</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">thread_cache_size=50</span><br></pre></td></tr></table></figure>

<p>show variables like ‘thread_cache_size’; </p>
<h4 id="performance-schema"><a href="#performance-schema" class="headerlink" title="performance_schema"></a>performance_schema</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> show variables like <span class="string">'performance_schema%'</span>; </span></span><br><span class="line">+--------------------------------------------------------+-------+</span><br><span class="line">| Variable_name                                          | Value |</span><br><span class="line">+--------------------------------------------------------+-------+</span><br><span class="line">| performance_schema                                     | ON    |</span><br><span class="line">| performance_schema_accounts_size                       | 100   |</span><br><span class="line">| performance_schema_digests_size                        | 10000 |</span><br><span class="line">| performance_schema_events_stages_history_long_size     | 10000 |</span><br><span class="line">| performance_schema_events_stages_history_size          | 10    |</span><br><span class="line">| performance_schema_events_statements_history_long_size | 10000 |</span><br><span class="line">| performance_schema_events_statements_history_size      | 10    |</span><br><span class="line">| performance_schema_events_waits_history_long_size      | 10000 |</span><br><span class="line">| performance_schema_events_waits_history_size           | 10    |</span><br><span class="line">| performance_schema_hosts_size                          | 100   |</span><br><span class="line">| performance_schema_max_cond_classes                    | 80    |</span><br><span class="line">| performance_schema_max_cond_instances                  | 3504  |</span><br><span class="line">| performance_schema_max_digest_length                   | 1024  |</span><br><span class="line">| performance_schema_max_file_classes                    | 50    |</span><br><span class="line">| performance_schema_max_file_handles                    | 32768 |</span><br><span class="line">| performance_schema_max_file_instances                  | 7693  |</span><br><span class="line">| performance_schema_max_mutex_classes                   | 200   |</span><br><span class="line">| performance_schema_max_mutex_instances                 | 15906 |</span><br><span class="line">| performance_schema_max_rwlock_classes                  | 40    |</span><br><span class="line">| performance_schema_max_rwlock_instances                | 9102  |</span><br><span class="line">| performance_schema_max_socket_classes                  | 10    |</span><br><span class="line">| performance_schema_max_socket_instances                | 322   |</span><br><span class="line">| performance_schema_max_stage_classes                   | 150   |</span><br><span class="line">| performance_schema_max_statement_classes               | 168   |</span><br><span class="line">| performance_schema_max_table_handles                   | 4000  |</span><br><span class="line">| performance_schema_max_table_instances                 | 12500 |</span><br><span class="line">| performance_schema_max_thread_classes                  | 50    |</span><br><span class="line">| performance_schema_max_thread_instances                | 402   |</span><br><span class="line">| performance_schema_session_connect_attrs_size          | 512   |</span><br><span class="line">| performance_schema_setup_actors_size                   | 100   |</span><br><span class="line">| performance_schema_setup_objects_size                  | 100   |</span><br><span class="line">| performance_schema_users_size                          | 100   |</span><br><span class="line">+--------------------------------------------------------+-------+</span><br><span class="line">32 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure>

<p>修改</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">performance_schema=OFF</span><br><span class="line">performance_schema_max_table_instances=200</span><br></pre></td></tr></table></figure>

<h1 id="按硬件优化"><a href="#按硬件优化" class="headerlink" title="按硬件优化"></a>按硬件优化</h1><h2 id="一、connection相关"><a href="#一、connection相关" class="headerlink" title="一、connection相关"></a>一、connection相关</h2><h2 id="二、timeout相关"><a href="#二、timeout相关" class="headerlink" title="二、timeout相关"></a>二、timeout相关</h2><h3 id="1、参数概览"><a href="#1、参数概览" class="headerlink" title="1、参数概览"></a>1、参数概览</h3><blockquote>
<p>show variables like ‘%timeout%’</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">connect_timeout=5  # 连接超时</span><br><span class="line">wait_timeout=28800  # 关闭闲置连接前等待的秒数</span><br><span class="line">interactive_timeout=28800 # 关闭交互式连接前等待的秒数</span><br><span class="line">net_read_timeout=30 # 读数据的时的等待超时</span><br><span class="line">net_write_timeout=60 # 等待将一个block发送给客户端的超时</span><br><span class="line"></span><br><span class="line">delayed_insert_timeout=300 # 这是为MyISAM INSERT DELAY设计的超时参数，在INSERT DELAY中止前等待INSERT语句的时间。</span><br><span class="line">innodb_flush_log_at_timeout=1 # 这个是5.6中才出现的，是InnoDB特有的参数，每次日志刷新时间。</span><br><span class="line">innodb_lock_wait_timeout=50 # 没有死锁的情况下一个事务持有另一个事务需要的锁资源，被回滚的肯定是请求锁的那个Query</span><br><span class="line">innodb_rollback_on_timeout=OFF # 这个参数关闭或不存在的话遇到超时只回滚事务最后一个Query，打开的话事务遇到超时就回滚整个事务</span><br><span class="line">lock_wait_timeout=31536000</span><br><span class="line">rpl_stop_slave_timeout=31536000 # 控制stop slave 的执行时间，在重放一个大的事务的时候,突然执行stop slave,命令 stop slave会执行很久,这个时候可能产生死锁或阻塞,严重影响性能，mysql 5.6可以通过rpl_stop_slave_timeout参数控制stop slave 的执行时间</span><br><span class="line">slave_net_timeout=3600 # 这是Slave判断主机是否挂掉的超时设置，在设定时间内依然没有获取到Master的回应就认为Master挂掉了</span><br></pre></td></tr></table></figure>

<p>参考：<a href="http://www.ttlsa.com/mysql/research-and-measurement-of-timeout-mysql/" target="_blank" rel="noopener">http://www.ttlsa.com/mysql/research-and-measurement-of-timeout-mysql/</a></p>
<h3 id="2、connect-timeout-5"><a href="#2、connect-timeout-5" class="headerlink" title="2、connect_timeout=5"></a>2、connect_timeout=5</h3><blockquote>
<p>这个比较好理解，字面上看意思是连接超时。”The number of seconds that the mysqld server waits for a connect packet before responding with Bad handshake”。</p>
<p>MySQL连接一次连接需求经过6次“握手”方可成功，任意一次“握手”失败都有可能导致连接失败，如下图所示。</p>
<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20191201222215.png" alt></p>
<p>前三次握手可以简单理解为TCP建立连接所必须的三次握手，MySQL无法控制，更多的受制于不TCP协议的不同实现，后面的三次握手过程超时与connect_timeout有关。简单的测试方法：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;</span><span class="bash"> e telnet mysql_ip_addr port</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> $ time telnet 127.0.0.1 5051</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> Trying 127.0.0.1...</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> Connected to 127.0.0.1.</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> Escape character is <span class="string">'^]'</span>.</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> ?</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> Connection closed by foreign</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> host.</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> real    0m5.005s <span class="comment">#这里的5秒即mysql默认的连接超时</span></span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> user    0m0.000s</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> sys 0m0.000s</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"></span></span><br></pre></td></tr></table></figure>
</blockquote>
<blockquote>
<p>Telnet未退出前通过show processlist查看各线程状态可见，当前该连接处于授权认证阶段，此时的用户为“unauthenticated user”。细心的你懂得，千万不要干坏事。</p>
<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20191201222505.png" alt></p>
</blockquote>
<h3 id="3、wait-timeout-1800"><a href="#3、wait-timeout-1800" class="headerlink" title="3、wait_timeout=1800"></a>3、wait_timeout=1800</h3><blockquote>
<p>MySQL客户端的数据库连接闲置最大时间值。当MySQL连接闲置超过一定时间后将会被强行关闭。</p>
<p>MySQL默认的wait-timeout  值为8个小时，可以通过命令show variables like ‘wait_timeout’查看结果值。</p>
<ul>
<li><p>interactive_timeout：服务器关闭交互式连接前等待活动的秒数。</p>
</li>
<li><p>wait_timeout:服务器关闭非交互连接之前等待活动的秒数。</p>
</li>
</ul>
<p>这两个参数必须配合使用。否则单独设置wait_timeout无效。</p>
<p>等待超时，那mysql等什么呢？确切的说是mysql在等用户的请求(query)，如果发现一个线程已经sleep的时间超过wait_timeout了那么这个线程将被清理掉，无论是交换模式或者是非交换模式都以此值为准。</p>
<p>注意：wait_timeout是session级别的变量哦，至于session和global变量的区别是什么我不说您也知道。手册上不是明明说wait_timeout为not interactive模式下的超时么？为什么你说无论是交换模式或者非交换模式都以此值为准呢？简单的测试例子如下</p>
<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20191201223108.png" alt></p>
<p>那为什么手册上说在交互模式下使用的是interactive_timeout呢，原因如下：</p>
<p>check_connection函数在建立连接初期，如果为交互模式则将interactive_timeout值赋给wait_timeout，骗您误以为交互模式下等待超时为interactive_timeout 代码如下:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="keyword">if</span> (thd-&gt;client_capabilities &amp; CLIENT_INTERACTIVE) &#123;</span><br><span class="line">&gt;      thd-&gt;variables.net_wait_timeout=thd-&gt;variables.net_interactive_timeout;</span><br><span class="line">&gt; &#125;</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<h3 id="4、interactive-timeout"><a href="#4、interactive-timeout" class="headerlink" title="4、interactive_timeout"></a>4、interactive_timeout</h3><p>上面说了那么多，这里就不再多做解释了。我理解mysql之所以多提供一个目的是提供给用户更灵活的设置空间。</p>
<h3 id="5、net-write-timeout-60"><a href="#5、net-write-timeout-60" class="headerlink" title="5、net_write_timeout=60"></a>5、net_write_timeout=60</h3><blockquote>
<p>看到这儿如果您看累了，那下面您得提提神了，接下来的两个参数才是我们遇到的最大的难题。 “The number of seconds to wait for a block to be written to a connection before aborting the write.” 等待将一个block发送给客户端的超时，一般在网络条件比较差的时，或者客户端处理每个block耗时比较长时，由于net_write_timeout导致的连接中断很容易发生。下面是一个模拟的例子：</p>
<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20191201223924.png" alt></p>
</blockquote>
<h3 id="6、net-read-timeout-30"><a href="#6、net-read-timeout-30" class="headerlink" title="6、net_read_timeout=30"></a>6、net_read_timeout=30</h3><blockquote>
<p>“The number of seconds to wait fprintfor more data from a connection before aborting the read.”。Mysql读数据的时的等待超时，可能的原因可能为网络异常或客户端or服务器端忙无法及时发送或接收处理包。这里我用的是iptables来模拟网络异常，生成一个较大的数据以便于给我充足的时间在load data的过程中去配置iptables规则。</p>
<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20191201224024.png" alt></p>
<p>执行完iptables命令后show processlist可以看到load data的连接已经被中断掉了</p>
</blockquote>
<h3 id="7、net-retry-count"><a href="#7、net-retry-count" class="headerlink" title="7、net_retry_count"></a>7、net_retry_count</h3><blockquote>
<p>“超时”的孪生兄弟“重试”，时间原因这个我没有进行实际的测试，手册如是说，估且先信它一回。</p>
<p>If a read or write on a communication port is interrupted, retry this many times before giving up. This value should be set quite high on FreeBSD because internal interrupts are sent to all threads.</p>
<p>On <a href="http://www.ttlsa.com/linux/" target="_blank" rel="noopener">Linux</a>, the “NO_ALARM” build flag (-DNO_ALARM) modifies how the binary treats both net_read_timeout and net_write_timeout. With this flag enabled, neither timer cancels the current statement until after the failing connection has been waited on an additional net_retry_count times. This means that the effective timeout value becomes” (timeout setting) × (net_retry_count+1)”.</p>
<p>FreeBSD中有效，Linux中只有在build的时候指定NO_ALARM参数时net_retry_count才会起作用。</p>
<p>说明：目前线上使用的版本都未指定NO_ALARM。</p>
</blockquote>
<h3 id="8、innodb-lock-wait-timeout"><a href="#8、innodb-lock-wait-timeout" class="headerlink" title="8、innodb_lock_wait_timeout"></a>8、innodb_lock_wait_timeout</h3><blockquote>
<p>The timeout in seconds an InnoDB transaction may wait for a row lock before giving up. The default value is 50 seconds. A transaction that tries to access a row that is locked by another InnoDB transaction will hang for at most this many seconds before issuing the following error:</p>
<p>ERROR 1205 (HY000): Lock wait timeout exceeded; try restarting transaction</p>
<p>When a lock wait timeout occurs, the current statement is not executed. The current transaction is not rolled back. (To have the entire transaction roll back, start the server with the –innodb_rollback_on_timeout option, available as of MySQL 5.1.15. See also Section 13.6.12, “InnoDB Error Handling”.)</p>
<p>innodb_lock_wait_timeout applies to InnoDB row locks only. A MySQL table lock does not happen inside InnoDB and this timeout does not apply to waits for table locks.</p>
<p>InnoDB does detect transaction deadlocks in its own lock table immediately and rolls back one transaction. The lock wait timeout value does not apply to such a wait.</p>
<p>For the built-in InnoDB, this variable can be set only at server startup. For InnoDB Plugin, it can be set at startup or changed at runtime, and has both global and session values.</p>
<p>解释：描述很长，简而言之，就是事务遇到锁等待时的Query超时时间。跟死锁不一样，InnoDB一旦检测到死锁立刻就会回滚代价小的那个事务，锁等待是没有死锁的情况下一个事务持有另一个事务需要的锁资源，被回滚的肯定是请求锁的那个Query。</p>
</blockquote>
<h3 id="9、innodb-rollback-on-timeout"><a href="#9、innodb-rollback-on-timeout" class="headerlink" title="9、innodb_rollback_on_timeout"></a>9、innodb_rollback_on_timeout</h3><blockquote>
<p>In MySQL 5.1, InnoDB rolls back only the last statement on a transaction timeout by default. If –innodb_rollback_on_timeout is specified, a transaction timeout causes InnoDB to abort and roll back the entire transaction (the same behavior as in MySQL 4.1). This variable was added in MySQL 5.1.15.</p>
<p>解释：这个参数关闭或不存在的话遇到超时只回滚事务最后一个Query，打开的话事务遇到超时就回滚整个事务。</p>
</blockquote>
<h3 id="10、innodb-flush-log-at-timeout"><a href="#10、innodb-flush-log-at-timeout" class="headerlink" title="10、innodb_flush_log_at_timeout"></a>10、innodb_flush_log_at_timeout</h3><blockquote>
<p>master线程刷写日志的频率。可以增大此参数设置来减少刷写次数，避免对binlog group commit带来影响。默认值是1</p>
</blockquote>
<br>



<h2 id="四、buffer相关"><a href="#四、buffer相关" class="headerlink" title="四、buffer相关"></a>四、buffer相关</h2><h3 id="参数概览"><a href="#参数概览" class="headerlink" title="参数概览"></a>参数概览</h3><blockquote>
<p>show variables like ‘%buffer%’</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">bulk_insert_buffer_size=8388608 # MyISAM，用来缓存批量插入数据的时候临时缓存写入数据</span><br><span class="line"></span><br><span class="line">innodb_buffer_pool_dump_at_shutdown=OFF</span><br><span class="line">innodb_buffer_pool_dump_now=OFF</span><br><span class="line">innodb_buffer_pool_filename=ib_buffer_pool</span><br><span class="line">innodb_buffer_pool_instances=8</span><br><span class="line">innodb_buffer_pool_load_abort=OFF</span><br><span class="line">innodb_buffer_pool_load_at_startup=OFF</span><br><span class="line">innodb_buffer_pool_load_now=OFF</span><br><span class="line">innodb_buffer_pool_size=134217728</span><br><span class="line"></span><br><span class="line">innodb_change_buffer_max_size=25</span><br><span class="line">innodb_change_buffering=all</span><br><span class="line">innodb_log_buffer_size=8388608</span><br><span class="line">innodb_sort_buffer_size=1048576</span><br><span class="line">join_buffer_size=262144 # 每个线程使用连接缓存区大小，最好是添加适当的索引而不是纯粹加大 join_buffer_size</span><br><span class="line">key_buffer_size=8388608 # MyISAM，索引块的缓冲区大小</span><br><span class="line">myisam_sort_buffer_size=8388608 # MyISAM，排序的缓冲区大小</span><br><span class="line">net_buffer_length=16384 # net-buffer-length 可能对mysqldump导出及恢复有影响</span><br><span class="line">preload_buffer_size=32768 # 预加载索引时分配的缓冲区大小</span><br><span class="line">read_buffer_size=131072 # 对表进行顺序扫描的请求将分配一个读入缓冲区</span><br><span class="line">read_rnd_buffer_size=262144 # 当按任意顺序读取行时(例如，按照排序顺序)，将分配一个随机读缓存区</span><br><span class="line">sort_buffer_size=262144 # 每个线程排序缓存区的大小</span><br><span class="line">sql_buffer_result=OFF # 通过SQL_BUFFER_RESULT.选项强制将结果集放到临时表, 释放表锁</span><br></pre></td></tr></table></figure>

<h3 id="key-buffer-size-1"><a href="#key-buffer-size-1" class="headerlink" title="key_buffer_size"></a>key_buffer_size</h3><blockquote>
<p>用于索引块的缓冲区大小，增加它可得到更好处理的索引(对所有读和多重写)，<u><strong>对MyISAM表性能影响最大</strong></u>的一个参数。</p>
<p>如果太大，系统将开始换页并且真的变慢了。</p>
<p>严格说是它决定了数据库索引处理的速度，尤其是索引读的速度。</p>
<p>对于内存在4GB左右的服务器该参数可设置为256M或384M。</p>
<p>如何判断key_buffer_size的设置是否合理？<br>检查状态值Key_read_requests和Key_reads，key_reads / key_read_requests应该尽可能的低，比如1:100，1:1000 ，1:10000。其值可以用以下命令查得：show status like ‘key_read%’;</p>
</blockquote>
<h3 id="read-buffer-size-1"><a href="#read-buffer-size-1" class="headerlink" title="read_buffer_size"></a>read_buffer_size</h3><blockquote>
<p>read_buffer_size 是 控制 MySql读入缓冲区大小。磁盘 -&gt; 内存 的缓冲区。</p>
<p>对表进行<u><strong>顺序扫描</strong></u>的请求将分配一个读入缓冲区，MySql会为它分配一段内存缓冲区。</p>
<p>如果对表的顺序扫描请求非常频繁，并且你认为频繁扫描进行得太慢，可以通过增加该变量值以及内存缓冲区大小提高其性能.</p>
</blockquote>
<h3 id="read-rnd-buffer-size-1"><a href="#read-rnd-buffer-size-1" class="headerlink" title="read_rnd_buffer_size"></a>read_rnd_buffer_size</h3><blockquote>
<p>read_rnd_buffer_size 是MySql的<u><strong>随机读缓冲区大小</strong></u>。</p>
<p>当按任意顺序读取行时(例如，按照排序顺序)，将分配一个随机读缓存区。</p>
<p>进行排序查询时，MySql会首先扫描一遍该缓冲，以避免磁盘搜索，提高查询速度，如果需要排序大量数据，可适当调高该值。</p>
<p>但MySql会为每个客户连接发放该缓冲空间，所以应尽量适当设置该值，以避免内存开销过大。</p>
</blockquote>
<h3 id="sort-buffer-size"><a href="#sort-buffer-size" class="headerlink" title="sort_buffer_size"></a>sort_buffer_size</h3><blockquote>
<p>sort_buffer_size是MySql执行<u><strong>排序使用的缓冲大小</strong></u>。</p>
<p>如果想要增加ORDER BY的速度，首先看是否可以让MySQL使用索引而不是额外的排序阶段。</p>
<p>如果不能，可以尝试增加sort_buffer_size变量的大小</p>
</blockquote>
<h3 id="tmp-table-size"><a href="#tmp-table-size" class="headerlink" title="tmp_table_size"></a>tmp_table_size</h3><blockquote>
<p>tmp_table_size是MySql的heap （堆积）表缓冲大小。所有联合在一个DML指令内完成，并且大多数联合甚至可以不用临时表即可以完成。大多数临时表是基于内存的(HEAP)表。具有大的记录长度的临时表 (所有列的长度的和)或包含BLOB列的表存储在硬盘上。<br>如果某个内部heap（堆积）表大小超过tmp_table_size，MySQL可以根据需要自动将内存中的heap表改为基于硬盘的MyISAM表。<br>还可以通过设置tmp_table_size选项来增加临时表的大小。<br>也就是说，如果调高该值，MySql同时将增加heap表的大小，可达到<u><strong>提高联接查询 join 速度的效果</strong></u>。</p>
</blockquote>
<h3 id="join-buffer-size"><a href="#join-buffer-size" class="headerlink" title="join_buffer_size"></a>join_buffer_size</h3><blockquote>
<p>应用经常会出现一些两表（或多表）<em>join<em>的操作需求，</em>MySQL<em>在完成某些</em>join<em>需求的时候（</em>all row join/all index /scan join<em>）为了减少参与</em>join<em>的“被驱动表”的读取次数以提高性能，需要使用到</em>join buffer<em>来协助完成</em>join<em>操作当</em>join buffer</em> 太小，<em>MySQL</em>不会将该<em>buffer</em>存入磁盘文件而是先将<em>join buffer</em>中的结果与需求<em>join</em>的表进行操作，然后清空<em>join buffer</em>中的数据，继续将剩余的结果集写入次<em>buffer</em>中，如此往复，这势必会造成被驱动表需要被多次读取，成倍增加<em>IO</em>访问，降低效率（执行计划中如果现实<em>using join buffer</em>）</p>
<p>两个表关联的时候 减少参与被驱动表的<em>join</em>操作（没办法有效利用索引的时候）</p>
<p>多表<em>join</em>时，就需要用到<em>join buffer</em>的三种情况</p>
<ul>
<li><p><em>All row join do not user indexes nad thus perform full table scans</em>（没有索引的全表扫描）</p>
</li>
<li><p><em>All index join plain index scans</em>（普通索引扫描）</p>
</li>
<li><p><em>Range index scan join=rangeindex scans</em>（范围索引扫描）</p>
</li>
</ul>
<p><u><strong>最好是添加适当的索引而不是纯粹加大 join_buffer_size</strong></u></p>
<p><strong>任何来个表间的全表join就会分配一次join_buffer，也就是说，如果3个表join就会分配2次joinbuffer（而不是一个session只分配一次）</strong></p>
</blockquote>
<h3 id="sql-buffer-result"><a href="#sql-buffer-result" class="headerlink" title="sql_buffer_result"></a>sql_buffer_result</h3><blockquote>
<p>SELECT SQL_BUFFER_RESULT * FROM TABLE1 WHERE …</p>
<p>当我们查询的结果集中的数据比较多时，可以通过SQL_BUFFER_RESULT.选项强制将结果集放到临时表中，这样就可以很快地释放MySQL的表锁(这样其它的SQL语句就可以对这些记录进行查询了)，并且可以长时间地为客户端提供大记录集。</p>
</blockquote>
<h3 id="innodb-buffer-pool"><a href="#innodb-buffer-pool" class="headerlink" title="innodb_buffer_pool_*"></a>innodb_buffer_pool_*</h3><blockquote>
<p>MySQL InnoDB buffer pool 里包含什么？</p>
<ul>
<li><strong>数据缓存</strong>：InnoDB数据页面</li>
<li><strong>索引缓存</strong>：索引数据</li>
<li><strong>缓冲数据</strong>：脏页（在内存中修改尚未刷新(写入)到磁盘的数据）</li>
<li><strong>内部结构</strong>：如自适应哈希索引，行锁等。</li>
</ul>
<p>1&gt;.mysqld重启之后，innodb_buffer_pool几乎是空的，没有任何的缓存数据。随着sql语句的执行，table中的数据以及index 逐渐被填充到buffer pool里面，之后的查询语句只需要在内存中操作（理想状态下），大幅度提升了mysql的性能。 这个逐渐填充的过程可能需要1-2个小时，甚至更久也说不准。在此过程中，mysql性能一般，因为需要大量的硬盘读操作</p>
<p>2&gt;.innodb在内存中维护一个缓冲池用来缓存数据和索引，缓存池管理一个数据块列表，该列表又分为2个字列，一个子列存放new blocks，另一个子列存放old blocks。old blocks默认占整个列大小的3/8（可通过innodb_old_blocks_pct改变默认值，该值范围在5-95之间，这是一个百分比），其余大小为new blocks占用</p>
<p>手工导出的话，可以用这个命令：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; mysql&gt; SET innodb_buffer_pool_dump_now=ON;</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<blockquote>
<p>然后mysql会在innodb的数据目录中生成一个文件：ib_buffer_pool</p>
<p>关闭mysql的时候，自动导出：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; mysql&gt; SET innodb_buffer_pool_dump_at_shutdown=ON;</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<blockquote>
<p>在my.cnf中加上 innodb_buffer_pool_load_at_startup=ON 就会在mysqld启动之后，重新加载buffer pool。</p>
<p>3&gt;.innodb_buffer_pool_instances：主要用于将innodb_buffer_pool进行划分，通过划分innodb_buffer_pool为多个实例，可以提高并发能力，并且减少了不同线程读写造成的缓冲页;但是不必设置过大，该值对mysql性能提升不大，有待测试；</p>
</blockquote>
<h5 id="innodb-buffer-pool-size-1"><a href="#innodb-buffer-pool-size-1" class="headerlink" title="innodb_buffer_pool_size"></a>innodb_buffer_pool_size</h5><blockquote>
<p>innodb_buffer_pool_size主要针对InnoDB表性能影响最大的一个参数。功能与Key_buffer_size一样。</p>
<p>​        另外InnoDB和 MyISAM 存储引擎不同。MyISAM 的 key_buffer_size 只能缓存索引键，而 <strong>innodb_buffer_pool_size 却可以缓存数据块和索引键</strong>。适当的增加这个参数的大小，可以有效的减少 InnoDB 类型的表的磁盘 I/O 。</p>
<p>show status like ‘Innodb_buffer_pool_read%’;</p>
<p>通过<code>(innodb_buffer_pool_read_requests – innodb_buffer_pool_reads) / innodb_buffer_pool_read_requests * 100%</code> 计算缓存命中率。并根据命中率来调整 innodb_buffer_pool_size 参数大小进行优化， 命中率越高越好。</p>
<ul>
<li>物理内存争用可能导致操作系统频繁的paging</li>
<li>InnoDB为缓冲区和control structures保留了额外的内存，因此总分配空间比指定的缓冲池大小大约大10％。</li>
<li>缓冲池的地址空间必须是连续的，这在带有在特定地址加载的DLL的Windows系统上可能是一个问题。</li>
<li>初始化缓冲池的时间大致与其大小成比例。在具有大缓冲池的实例上，初始化时间可能很长。要减少初始化时间，可以在服务器关闭时保存缓冲池状态，并在服务器启动时将其还原。<ul>
<li><strong><code>innodb_buffer_pool_dump_pct</code></strong>：指定每个缓冲池最近使用的页面读取和转储的百分比。 范围是1到100。默认值是25。例如，如果有4个缓冲池，每个缓冲池有100个page，并且innodb_buffer_pool_dump_pct设置为25，则dump每个缓冲池中最近使用的25个page。</li>
<li><strong><code>innodb_buffer_pool_dump_at_shutdown</code></strong>：默认启用。指定在MySQL服务器关闭时是否记录在InnoDB缓冲池中缓存的页面，以便在下次重新启动时缩短预热过程。</li>
<li><strong><code>innodb_buffer_pool_load_at_startup</code></strong>：默认启用。指定在MySQL服务器启动时，InnoDB缓冲池通过加载之前保存的相同页面自动预热。 通常与innodb_buffer_pool_dump_at_shutdown结合使用。</li>
</ul>
</li>
</ul>
<p>增大或减小缓冲池大小时，将以chunk的形式执行操作。chunk大小由<code>innodb_buffer_pool_chunk_size</code>配置选项定义，默认值为128 MB。</p>
<p>缓冲池大小必须始终等于或者是<code>innodb_buffer_pool_chunk_size * innodb_buffer_pool_instances</code>的倍数。<br>如果将缓冲池大小更改为不等于或等于<code>innodb_buffer_pool_chunk_size * innodb_buffer_pool_instances</code>的倍数的值，<br>则缓冲池大小将自动调整为等于或者是<code>innodb_buffer_pool_chunk_size * innodb_buffer_pool_instances</code>的倍数的值。</p>
<p>innodb_buffer_pool_size可以动态设置，允许在不重新启动服务器的情况下调整缓冲池的大小。 可以通过状态变量<code>Innodb_buffer_pool_resize_status</code>报告在线调整缓冲池大小操作的状态。</p>
</blockquote>
<br>

<h2 id="五、cache相关"><a href="#五、cache相关" class="headerlink" title="五、cache相关"></a>五、cache相关</h2><blockquote>
<p>show variables like ‘%cache%’</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">binlog_cache_size=32768</span><br><span class="line">binlog_stmt_cache_size=32768</span><br><span class="line">have_query_cache=YES</span><br><span class="line">host_cache_size=279</span><br><span class="line">innodb_disable_sort_file_cache=OFF</span><br><span class="line">innodb_ft_cache_size=8000000</span><br><span class="line">innodb_ft_result_cache_limit=2000000000</span><br><span class="line">innodb_ft_total_cache_size=640000000</span><br><span class="line">key_cache_age_threshold=300</span><br><span class="line">key_cache_block_size=1024</span><br><span class="line">key_cache_division_limit=100</span><br><span class="line">max_binlog_cache_size=18446744073709547520</span><br><span class="line">max_binlog_stmt_cache_size=18446744073709547520</span><br><span class="line">metadata_locks_cache_size=1024</span><br><span class="line"></span><br><span class="line">stored_program_cache=256</span><br><span class="line">table_definition_cache=1400</span><br><span class="line">table_open_cache=2000</span><br><span class="line">table_open_cache_instances=1</span><br><span class="line">thread_cache_size=9</span><br></pre></td></tr></table></figure>

<h2 id="六、thread相关"><a href="#六、thread相关" class="headerlink" title="六、thread相关"></a>六、thread相关</h2><blockquote>
<p>show variables like ‘%thread%’</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">innodb_purge_threads=1</span><br><span class="line">innodb_read_io_threads=4</span><br><span class="line">innodb_thread_concurrency=0</span><br><span class="line">innodb_thread_sleep_delay=10000</span><br><span class="line">innodb_write_io_threads=4</span><br><span class="line">max_delayed_threads=20</span><br><span class="line">max_insert_delayed_threads=20</span><br><span class="line">myisam_repair_threads=1</span><br><span class="line">performance_schema_max_thread_classes=50</span><br><span class="line">performance_schema_max_thread_instances=402</span><br><span class="line">pseudo_thread_id=5</span><br><span class="line">thread_cache_size=9</span><br><span class="line">thread_concurrency=10 # CPU核数的2倍,对性能影响很大</span><br><span class="line">thread_handling=one-thread-per-connection</span><br><span class="line">thread_stack=262144</span><br></pre></td></tr></table></figure>

<h3 id="thread-concurrency"><a href="#thread-concurrency" class="headerlink" title="thread_concurrency"></a>thread_concurrency</h3><blockquote>
<p>thread_concurrency的值的正确与否, 对mysql的性能影响很大。<br>在多个cpu(或多核)的情况下，错误设置了thread_concurrency的值, 会导致mysql不能充分利用多cpu(或多核), 出现同一时刻只能一个cpu(或核)在工作的情况。</p>
<p>thread_concurrency应设为CPU核数的2倍. 比如有一个双核的CPU, 那thread_concurrency  的应该为4; 2个双核的cpu, thread_concurrency的值应为8.</p>
<p>查看系统当前thread_concurrency默认配置命令：</p>
<p>show variables like ‘thread_concurrency’;</p>
</blockquote>
<br>

<h2 id="七、table相关"><a href="#七、table相关" class="headerlink" title="七、table相关"></a>七、table相关</h2><blockquote>
<p>show variables like ‘%table%’</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">big_tables=OFF</span><br><span class="line">innodb_file_per_table=ON</span><br><span class="line">innodb_ft_aux_table=</span><br><span class="line">innodb_ft_server_stopword_table=</span><br><span class="line">innodb_ft_user_stopword_table=</span><br><span class="line">innodb_table_locks=ON</span><br><span class="line">innodb_undo_tablespaces=0</span><br><span class="line">lower_case_table_names=0</span><br><span class="line">max_heap_table_size=16777216</span><br><span class="line">max_tmp_tables=32</span><br><span class="line">old_alter_table=OFF</span><br><span class="line">performance_schema_max_table_handles=4000</span><br><span class="line">performance_schema_max_table_instances=12500</span><br><span class="line">table_definition_cache=1400</span><br><span class="line">table_open_cache=2000</span><br><span class="line">table_open_cache_instances=1</span><br><span class="line">tmp_table_size=16777216</span><br><span class="line">updatable_views_with_limit=YES</span><br></pre></td></tr></table></figure>

<p>a</p>
<br>





<h2 id="十、InnoDB相关"><a href="#十、InnoDB相关" class="headerlink" title="十、InnoDB相关"></a>十、InnoDB相关</h2><h3 id="1、参数概览-1"><a href="#1、参数概览-1" class="headerlink" title="1、参数概览"></a>1、参数概览</h3><blockquote>
<p>show variables like ‘%innodb%’</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br></pre></td><td class="code"><pre><span class="line">ignore_builtin_innodb=OFF</span><br><span class="line">innodb_adaptive_flushing=ON</span><br><span class="line">innodb_adaptive_flushing_lwm=10</span><br><span class="line">innodb_adaptive_hash_index=ON</span><br><span class="line">innodb_adaptive_max_sleep_delay=150000</span><br><span class="line">innodb_additional_mem_pool_size=8388608</span><br><span class="line">innodb_api_bk_commit_interval=5</span><br><span class="line">innodb_api_disable_rowlock=OFF</span><br><span class="line">innodb_api_enable_binlog=OFF</span><br><span class="line">innodb_api_enable_mdl=OFF</span><br><span class="line">innodb_api_trx_level=0</span><br><span class="line">innodb_autoextend_increment=64</span><br><span class="line">innodb_autoinc_lock_mode=1</span><br><span class="line">innodb_buffer_pool_dump_at_shutdown=OFF</span><br><span class="line">innodb_buffer_pool_dump_now=OFF</span><br><span class="line">innodb_buffer_pool_filename=ib_buffer_pool</span><br><span class="line">innodb_buffer_pool_instances=8</span><br><span class="line">innodb_buffer_pool_load_abort=OFF</span><br><span class="line">innodb_buffer_pool_load_at_startup=OFF</span><br><span class="line">innodb_buffer_pool_load_now=OFF</span><br><span class="line">innodb_buffer_pool_size=134217728</span><br><span class="line">innodb_change_buffer_max_size=25</span><br><span class="line">innodb_change_buffering=all</span><br><span class="line">innodb_checksum_algorithm=innodb</span><br><span class="line">innodb_checksums=ON</span><br><span class="line">innodb_cmp_per_index_enabled=OFF</span><br><span class="line">innodb_commit_concurrency=0</span><br><span class="line">innodb_compression_failure_threshold_pct=5</span><br><span class="line">innodb_compression_level=6</span><br><span class="line">innodb_compression_pad_pct_max=50</span><br><span class="line">innodb_concurrency_tickets=5000</span><br><span class="line">innodb_data_file_path=ibdata1:12M:autoextend # 要注释掉，否则会创建一个新的把原来的替换的 </span><br><span class="line">innodb_data_home_dir=</span><br><span class="line">innodb_disable_sort_file_cache=OFF</span><br><span class="line">innodb_doublewrite=ON</span><br><span class="line">innodb_fast_shutdown=1</span><br><span class="line">innodb_file_format=Antelope</span><br><span class="line">innodb_file_format_check=ON</span><br><span class="line">innodb_file_format_max=Antelope</span><br><span class="line">innodb_file_per_table=ON</span><br><span class="line">innodb_flush_log_at_timeout=1</span><br><span class="line">innodb_flush_log_at_trx_commit=1</span><br><span class="line">innodb_flush_method=</span><br><span class="line">innodb_flush_neighbors=1</span><br><span class="line">innodb_flushing_avg_loops=30</span><br><span class="line">innodb_force_load_corrupted=OFF</span><br><span class="line">innodb_force_recovery=0</span><br><span class="line">innodb_ft_aux_table=</span><br><span class="line">innodb_ft_cache_size=8000000</span><br><span class="line">innodb_ft_enable_diag_print=OFF</span><br><span class="line">innodb_ft_enable_stopword=ON</span><br><span class="line">innodb_ft_max_token_size=84</span><br><span class="line">innodb_ft_min_token_size=3</span><br><span class="line">innodb_ft_num_word_optimize=2000</span><br><span class="line">innodb_ft_result_cache_limit=2000000000</span><br><span class="line">innodb_ft_server_stopword_table=</span><br><span class="line">innodb_ft_sort_pll_degree=2</span><br><span class="line">innodb_ft_total_cache_size=640000000</span><br><span class="line">innodb_ft_user_stopword_table=</span><br><span class="line">innodb_io_capacity=200</span><br><span class="line">innodb_io_capacity_max=2000</span><br><span class="line">innodb_large_prefix=OFF</span><br><span class="line">innodb_lock_wait_timeout=50</span><br><span class="line">innodb_locks_unsafe_for_binlog=OFF</span><br><span class="line">innodb_log_buffer_size=8388608</span><br><span class="line">innodb_log_compressed_pages=ON</span><br><span class="line">innodb_log_file_size=50331648</span><br><span class="line">innodb_log_files_in_group=2</span><br><span class="line">innodb_log_group_home_dir=./</span><br><span class="line">innodb_lru_scan_depth=1024</span><br><span class="line">innodb_max_dirty_pages_pct=75</span><br><span class="line">innodb_max_dirty_pages_pct_lwm=0</span><br><span class="line">innodb_max_purge_lag=0</span><br><span class="line">innodb_max_purge_lag_delay=0</span><br><span class="line">innodb_mirrored_log_groups=1</span><br><span class="line">innodb_monitor_disable=</span><br><span class="line">innodb_monitor_enable=</span><br><span class="line">innodb_monitor_reset=</span><br><span class="line">innodb_monitor_reset_all=</span><br><span class="line">innodb_numa_interleave=OFF</span><br><span class="line">innodb_old_blocks_pct=37</span><br><span class="line">innodb_old_blocks_time=1000</span><br><span class="line">innodb_online_alter_log_max_size=134217728</span><br><span class="line">innodb_open_files=2000</span><br><span class="line">innodb_optimize_fulltext_only=OFF</span><br><span class="line">innodb_page_size=16384</span><br><span class="line">innodb_print_all_deadlocks=OFF</span><br><span class="line">innodb_purge_batch_size=300</span><br><span class="line">innodb_purge_threads=1</span><br><span class="line">innodb_random_read_ahead=OFF</span><br><span class="line">innodb_read_ahead_threshold=56</span><br><span class="line">innodb_read_io_threads=4</span><br><span class="line">innodb_read_only=OFF</span><br><span class="line">innodb_replication_delay=0</span><br><span class="line">innodb_rollback_on_timeout=OFF</span><br><span class="line">innodb_rollback_segments=128</span><br><span class="line">innodb_sort_buffer_size=1048576</span><br><span class="line">innodb_spin_wait_delay=6</span><br><span class="line">innodb_stats_auto_recalc=ON</span><br><span class="line">innodb_stats_include_delete_marked=OFF</span><br><span class="line">innodb_stats_method=nulls_equal</span><br><span class="line">innodb_stats_on_metadata=OFF</span><br><span class="line">innodb_stats_persistent=ON</span><br><span class="line">innodb_stats_persistent_sample_pages=20</span><br><span class="line">innodb_stats_sample_pages=8</span><br><span class="line">innodb_stats_transient_sample_pages=8</span><br><span class="line">innodb_status_output=OFF</span><br><span class="line">innodb_status_output_locks=OFF</span><br><span class="line">innodb_strict_mode=OFF</span><br><span class="line">innodb_support_xa=ON</span><br><span class="line">innodb_sync_array_size=1</span><br><span class="line">innodb_sync_spin_loops=30</span><br><span class="line">innodb_table_locks=ON</span><br><span class="line">innodb_thread_concurrency=0</span><br><span class="line">innodb_thread_sleep_delay=10000</span><br><span class="line">innodb_tmpdir=</span><br><span class="line">innodb_undo_directory=.</span><br><span class="line">innodb_undo_logs=128</span><br><span class="line">innodb_undo_tablespaces=0</span><br><span class="line">innodb_use_native_aio=ON</span><br><span class="line">innodb_use_sys_malloc=ON</span><br><span class="line">innodb_version=5.6.45</span><br><span class="line">innodb_write_io_threads=4</span><br></pre></td></tr></table></figure>

<h3 id="2、default-storage-engine-InnoDB"><a href="#2、default-storage-engine-InnoDB" class="headerlink" title="2、default-storage-engine=InnoDB"></a>2、default-storage-engine=InnoDB</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">备注：设置完后把以下几个开启：</span><br><span class="line"><span class="meta">#</span><span class="bash"> Uncomment the following <span class="keyword">if</span> you are using InnoDB tables</span></span><br><span class="line">innodb_data_home_dir =/usr/local/mysql</span><br><span class="line"><span class="meta">#</span><span class="bash">innodb_data_file_path = ibdata1:1024M;ibdata2:10M:autoextend（要注释掉，否则会创建一个新的把原来的替换的。）</span></span><br><span class="line">innodb_log_group_home_dir = /usr/local/mysql</span><br><span class="line"><span class="meta">#</span><span class="bash"> You can <span class="built_in">set</span> .._buffer_pool_size up to 50 - 80 %</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> of RAM but beware of setting memory usage too high</span></span><br><span class="line">innodb_buffer_pool_size = 1000M</span><br><span class="line">innodb_additional_mem_pool_size = 20M</span><br><span class="line"><span class="meta">#</span><span class="bash"> Set .._log_file_size to 25 % of buffer pool size</span></span><br><span class="line">innodb_log_file_size = 500M</span><br><span class="line">innodb_log_buffer_size = 20M</span><br><span class="line">innodb_flush_log_at_trx_commit = 0</span><br><span class="line">innodb_lock_wait_timeout = 50</span><br></pre></td></tr></table></figure>

<h3 id="3、innodb-additional-mem-pool-size"><a href="#3、innodb-additional-mem-pool-size" class="headerlink" title="3、innodb_additional_mem_pool_size"></a>3、innodb_additional_mem_pool_size</h3><blockquote>
<p>innodb_additional_mem_pool_size 设置了InnoDB存储引擎用来<u><strong>存放数据字典信息以及一些内部数据结构</strong></u>的内存空间大小，所以当MySQL Instance中的数据库对象非常多的时候，是需要适当调整该参数的大小以确保所有数据都能存放在内存中提高访问效率的。</p>
<p>这个参数大小是否足够还是比较容易知道的，因为<u><strong>当过小的时候，MySQL会记录Warning信息到数据库的error log</strong></u>中，这时候就该调整这个参数大小了。</p>
<p>查看当前系统mysql的error日志  cat  /var/lib/mysql/机器名.error 发现有很多waring警告。所以要调大为20M。根据MySQL手册，对于2G内存的机器，推荐值是20M。 32G内存的 100M</p>
</blockquote>
<h3 id="4、innodb-log-buffer-size"><a href="#4、innodb-log-buffer-size" class="headerlink" title="4、innodb_log_buffer_size"></a>4、innodb_log_buffer_size</h3><blockquote>
<p>innodb_log_buffer_size  这是InnoDB存储引擎的<u><strong>事务日志所使用的缓冲区</strong></u>。类似于Binlog Buffer，InnoDB在写事务日志的时候，为了提高性能，也是先将信息写入Innofb Log Buffer中，当满足innodb_flush_log_trx_commit 参数所设置的相应条件(或者日志缓冲区写满)之后，才会将日志写到文件 (或者同步到磁盘)中。可以通过innodb_log_buffer_size 参数设置其可以使用的最大内存空间。</p>
<p>InnoDB 将日志写入日志磁盘文件前的缓冲大小。<br>理想值为 1M 至 8M。<u><strong>大的日志缓冲允许事务运行时不需要将日志保存入磁盘而只到事务被提交</strong></u>(commit)。<br>因此，如果有大的事务处理，设置大的日志缓冲可以减少磁盘I/O。 在 my.cnf中以数字格式设置。</p>
<p>默认是8MB，系的如频繁的系统可适当增大至4MB～8MB。当然如上面介绍所说，这个参数实际上还和另外的flush参数相关。一般来说不建议超过32MB</p>
</blockquote>
<blockquote>
<p>Creating index ‘GEN_CLUST_INDEX’ required more than ‘innodb_online_alter_log_max_size’ bytes of modification log. Please try again.</p>
<p>虽然optimize对innodb表没什么用，但是仍然会抛出该错误</p>
<p>那么查看一下手册，可以得知：</p>
<ul>
<li>innodb_online_alter_log_max_size控制在用于在Online DDL操作时的一个临时的日志文件的上限值大小。</li>
<li>该临时的日志文件存储了在DDL时间内，dml操作的记录。这个临时的日志文件依照innodb_sort_buffer_size的值做扩展。</li>
<li>如果该日志超过了innodb_online_alter_log_max_size的最大上限，DDL操作则会抛出失败，并且回滚所有未提交的DML操作。</li>
<li>反过来说，该值如果设置更高，则可以允许在做Online DDL时，有更多的DML操作发生。</li>
<li>但因此带来的问题就是，在DDL做完之后，需要更多时间来锁表和应用这些日志。</li>
</ul>
<p>另外对于某些DDL操作，比如<br>ADD INDEX/COLUMN，则可以通过调整innodb_sort_buffer_size的大小来加快操作速度。<br>但是实际上分配的内存为3倍的innodb_sort_buffer_size值。</p>
<p>innodb_online_alter_log_max_size和innodb_sort_buffer_size均为5.6 Online DDL的新参数。</p>
<p>【解决方案】：</p>
<p>知道这个参数控制的是什么东西，就好解决了。<br>临时调大该值，此处改成了256MB：</p>
<p>mysql&gt; SET GLOBAL innodb_online_alter_log_max_size=256<em>1024</em>1024;<br>Query OK, 0 rows affected (0.03 sec)</p>
<p>该值默认为128MB，还是建议在做完DDL之后再将其改为默认值，也就是134217728。</p>
</blockquote>
<br>

<h2 id="十一、Master-Slave相关"><a href="#十一、Master-Slave相关" class="headerlink" title="十一、Master-Slave相关"></a>十一、Master-Slave相关</h2><h3 id="1、参数概览-2"><a href="#1、参数概览-2" class="headerlink" title="1、参数概览"></a>1、参数概览</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">gtid_mode=on</span><br><span class="line">enforce_gtid_consistency=on</span><br><span class="line">log_slave_updates=1</span><br><span class="line">slave_parallel_type=logical_clock</span><br><span class="line">slave_parallel_workers=8</span><br><span class="line">innodb_flush_log_at_trx_commit=1</span><br><span class="line">sync_binlog=1  #每一个transaction commit都会调用一次fsync()，此时能保证数据最安全但是性能影响较大。</span><br></pre></td></tr></table></figure>

<h2 id="十二、net相关"><a href="#十二、net相关" class="headerlink" title="十二、net相关"></a>十二、net相关</h2><blockquote>
<p>show variables like ‘%net%’</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">net_buffer_length=16384</span><br><span class="line">net_read_timeout=30</span><br><span class="line">net_retry_count=10</span><br><span class="line">net_write_timeout=60</span><br><span class="line">skip_networking=OFF # 开启该选项可以彻底关闭MySQL的TCP/IP连接方式。</span><br><span class="line">slave_net_timeout=3600</span><br></pre></td></tr></table></figure>

<h3 id="skip-name-resolve"><a href="#skip-name-resolve" class="headerlink" title="skip-name-resolve"></a>skip-name-resolve</h3><blockquote>
<p>skip-name-resolve：禁止MySQL对外部连接进行DNS解析。</p>
<p>使用这一选项可以消除MySQL进行DNS解析的时间。</p>
<p>但需要注意，如果开启该选项，则所有远程主机连接授权都要使用IP地址方式，否则MySQL将无法正常处理连接请求！</p>
</blockquote>
<h3 id="skip-networking"><a href="#skip-networking" class="headerlink" title="skip-networking"></a>skip-networking</h3><blockquote>
<p>建议被注释掉，不要开启</p>
<p>开启该选项可以彻底关闭MySQL的TCP/IP连接方式。</p>
<p>如果WEB服务器是以远程连接的方式访问MySQL数据库服务器则不要开启该选项，否则将无法正常连接。</p>
</blockquote>
<br>

<h2 id="十三、lock相关"><a href="#十三、lock相关" class="headerlink" title="十三、lock相关"></a>十三、lock相关</h2><blockquote>
<p>show variables like ‘%lock%’</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">block_encryption_mode=aes-128-ecb</span><br><span class="line">innodb_api_disable_rowlock=OFF</span><br><span class="line">innodb_autoinc_lock_mode=1</span><br><span class="line">innodb_lock_wait_timeout=50</span><br><span class="line">innodb_locks_unsafe_for_binlog=OFF</span><br><span class="line">innodb_old_blocks_pct=37</span><br><span class="line">innodb_old_blocks_time=1000</span><br><span class="line">innodb_print_all_deadlocks=OFF</span><br><span class="line">innodb_status_output_locks=OFF</span><br><span class="line">innodb_table_locks=ON</span><br><span class="line">key_cache_block_size=1024</span><br><span class="line">lock_wait_timeout=31536000</span><br><span class="line">locked_in_memory=OFF</span><br><span class="line">max_write_lock_count=18446744073709551615</span><br><span class="line">metadata_locks_cache_size=1024</span><br><span class="line">metadata_locks_hash_instances=8</span><br><span class="line">performance_schema_max_rwlock_classes=40</span><br><span class="line">performance_schema_max_rwlock_instances=9102</span><br><span class="line">query_alloc_block_size=8192</span><br><span class="line">query_cache_wlock_invalidate=OFF</span><br><span class="line">range_alloc_block_size=4096</span><br><span class="line">skip_external_locking=ON</span><br><span class="line">transaction_alloc_block_size=8192</span><br></pre></td></tr></table></figure>

<br>

<h2 id="十四、transaction-相关"><a href="#十四、transaction-相关" class="headerlink" title="十四、transaction 相关"></a>十四、transaction 相关</h2><blockquote>
<p>show variables like ‘%transaction%’</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">binlog_direct_non_transactional_updates=OFF</span><br><span class="line">slave_transaction_retries=10</span><br><span class="line">transaction_alloc_block_size=8192</span><br><span class="line">transaction_allow_batching=OFF</span><br><span class="line">transaction_prealloc_size=4096</span><br></pre></td></tr></table></figure>

<blockquote>
<p>show variables like ‘%trx%’</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">innodb_api_trx_level=0</span><br><span class="line">innodb_flush_log_at_trx_commit=1</span><br></pre></td></tr></table></figure>

<h1 id="按功能优化"><a href="#按功能优化" class="headerlink" title="按功能优化"></a>按功能优化</h1><h2 id="查询优化"><a href="#查询优化" class="headerlink" title="查询优化"></a>查询优化</h2><p>sql_cache意思是说，查询的时候使用缓存。</p>
<p>sql_no_cache意思是查询的时候不适用缓存。</p>
<p>sql_buffer_result意思是说，在查询语句中，将查询结果缓存到临时表中。</p>
<p>这三者正好配套使用。sql_buffer_result将尽快释放表锁，这样其他sql就能够尽快执行。</p>
<p>使用 FLUSH QUERY CACHE 命令，你可以整理查询缓存，以更好的利用它的内存。这个命令不会从缓存中移除任何查询。FLUSH TABLES 会转储清除查询缓存。<br>RESET QUERY CACHE 使命从查询缓存中移除所有的查询结果。</p>
<p>-————————————————-</p>
<p>那么mysql到底是怎么决定到底要不要把查询结果放到查询缓存中呢？</p>
<p>是根据query_cache_type这个变量来决定的。</p>
<p>这个变量有三个取值：0,1,2，分别代表了off、on、demand。</p>
<p>意思是说，如果是0，那么query cache 是关闭的。如果是1，那么查询总是先到查询缓存中查找，除非使用了sql_no_cache。如果是2，那么，只有使用 sql_cache的查询，才会去查询缓存中查找。</p>
<h2 id="三、index索引相关"><a href="#三、index索引相关" class="headerlink" title="三、index索引相关"></a>三、index索引相关</h2><h3 id="1、参数概览-3"><a href="#1、参数概览-3" class="headerlink" title="1、参数概览"></a>1、参数概览</h3><blockquote>
<p>show variables like ‘%key%’</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">delay_key_write=ON</span><br><span class="line">foreign_key_checks=ON</span><br><span class="line">have_rtree_keys=YES</span><br><span class="line">key_buffer_size=8388608</span><br><span class="line">key_cache_age_threshold=300</span><br><span class="line">key_cache_block_size=1024</span><br><span class="line">key_cache_division_limit=100</span><br><span class="line">max_seeks_for_key=18446744073709551615</span><br><span class="line">ssl_key=</span><br></pre></td></tr></table></figure>

<br>

<br>

<h2 id="八、sort相关"><a href="#八、sort相关" class="headerlink" title="八、sort相关"></a>八、sort相关</h2><h3 id="1、参数概览-4"><a href="#1、参数概览-4" class="headerlink" title="1、参数概览"></a>1、参数概览</h3><blockquote>
<p>show variables like ‘%sort%’</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">innodb_disable_sort_file_cache=OFF</span><br><span class="line">innodb_ft_sort_pll_degree=2</span><br><span class="line">innodb_sort_buffer_size=1048576</span><br><span class="line">max_length_for_sort_data=1024</span><br><span class="line">max_sort_length=1024</span><br><span class="line">myisam_max_sort_file_size=9223372036853727232</span><br><span class="line">myisam_sort_buffer_size=8388608</span><br><span class="line">sort_buffer_size=262144</span><br></pre></td></tr></table></figure>

<br>

<h2 id="九、log-相关"><a href="#九、log-相关" class="headerlink" title="九、log 相关"></a>九、log 相关</h2><h3 id="1、参数概览-5"><a href="#1、参数概览-5" class="headerlink" title="1、参数概览"></a>1、参数概览</h3><blockquote>
<p>show variables like ‘%log%’</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">back_log=80</span><br><span class="line">binlog_cache_size=32768</span><br><span class="line">binlog_checksum=CRC32</span><br><span class="line">binlog_direct_non_transactional_updates=OFF</span><br><span class="line">binlog_error_action=IGNORE_ERROR</span><br><span class="line">binlog_format=STATEMENT</span><br><span class="line">binlog_gtid_simple_recovery=OFF</span><br><span class="line">binlog_max_flush_queue_time=0</span><br><span class="line">binlog_order_commits=ON</span><br><span class="line">binlog_row_image=FULL</span><br><span class="line">binlog_rows_query_log_events=OFF</span><br><span class="line">binlog_stmt_cache_size=32768</span><br><span class="line">binlogging_impossible_mode=IGNORE_ERROR</span><br><span class="line">expire_logs_days=0</span><br><span class="line">general_log=OFF</span><br><span class="line">general_log_file=/var/lib/mysql/d27fc289bc0c.log</span><br><span class="line">innodb_api_enable_binlog=OFF</span><br><span class="line">innodb_flush_log_at_timeout=1</span><br><span class="line">innodb_flush_log_at_trx_commit=1</span><br><span class="line">innodb_locks_unsafe_for_binlog=OFF</span><br><span class="line">innodb_log_buffer_size=8388608</span><br><span class="line">innodb_log_compressed_pages=ON</span><br><span class="line">innodb_log_file_size=50331648</span><br><span class="line">innodb_log_files_in_group=2</span><br><span class="line">innodb_log_group_home_dir=./</span><br><span class="line">innodb_mirrored_log_groups=1</span><br><span class="line">innodb_online_alter_log_max_size=134217728</span><br><span class="line">innodb_undo_logs=128</span><br><span class="line">log_bin=OFF</span><br><span class="line">log_bin_basename=</span><br><span class="line">log_bin_index=</span><br><span class="line">log_bin_trust_function_creators=OFF</span><br><span class="line">log_bin_use_v1_row_events=OFF</span><br><span class="line">log_error=</span><br><span class="line">log_output=FILE</span><br><span class="line">log_queries_not_using_indexes=OFF</span><br><span class="line">log_slave_updates=OFF</span><br><span class="line">log_slow_admin_statements=OFF</span><br><span class="line">log_slow_slave_statements=OFF</span><br><span class="line">log_throttle_queries_not_using_indexes=0</span><br><span class="line">log_warnings=1</span><br><span class="line">max_binlog_cache_size=18446744073709547520</span><br><span class="line">max_binlog_size=1073741824</span><br><span class="line">max_binlog_stmt_cache_size=18446744073709547520</span><br><span class="line">max_relay_log_size=0</span><br><span class="line">relay_log=</span><br><span class="line">relay_log_basename=</span><br><span class="line">relay_log_index=</span><br><span class="line">relay_log_info_file=relay-log.info</span><br><span class="line">relay_log_info_repository=FILE</span><br><span class="line">relay_log_purge=ON</span><br><span class="line">relay_log_recovery=OFF</span><br><span class="line">relay_log_space_limit=0</span><br><span class="line">simplified_binlog_gtid_recovery=OFF</span><br><span class="line">slow_query_log=OFF</span><br><span class="line">slow_query_log_file=/var/lib/mysql/d27fc289bc0c-slow.log</span><br><span class="line">sql_log_bin=ON</span><br><span class="line">sql_log_off=OFF</span><br><span class="line">sync_binlog=0</span><br><span class="line">sync_relay_log=10000</span><br><span class="line">sync_relay_log_info=10000</span><br></pre></td></tr></table></figure>

<h3 id="undo-log"><a href="#undo-log" class="headerlink" title="undo_log"></a>undo_log</h3><h3 id="redo-log"><a href="#redo-log" class="headerlink" title="redo_log"></a>redo_log</h3><h3 id="bin-log"><a href="#bin-log" class="headerlink" title="bin_log"></a>bin_log</h3>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://carlo-z.com/java/cpu/java-cpu-affinity/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Focus-1">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Focus-1">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/java/cpu/java-cpu-affinity/" itemprop="url">Java 实现CPU亲和性_未完</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-11-13T00:00:00+08:00">
                2019-11-13
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/java/" itemprop="url" rel="index">
                    <span itemprop="name">java</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <hr>
<br>



<br>



<p><br><br><br><br><br></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://carlo-z.com/java/log4j2/log4j2-srcode/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Focus-1">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Focus-1">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/java/log4j2/log4j2-srcode/" itemprop="url">log4j2源码——架构设计</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-11-12T00:00:00+08:00">
                2019-11-12
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <hr>
<br>

<h1 id="从github导入idea"><a href="#从github导入idea" class="headerlink" title="从github导入idea"></a>从github导入idea</h1><p>下载地址： <a href="https://github.com/apache/logging-log4j2.git" target="_blank" rel="noopener">https://github.com/apache/logging-log4j2.git</a></p>
<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20191112165651.png" alt></p>
<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20191112172046.png" alt></p>
<br>

<br>

<br>

<br>

<br>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://carlo-z.com/message-queue/kafka/kafka-qa/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Focus-1">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Focus-1">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/message-queue/kafka/kafka-qa/" itemprop="url">kafka Q&A</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-11-11T20:56:12+08:00">
                2019-11-11
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h4 id="kafka多个partition-之间怎么保证-消息全局顺序性"><a href="#kafka多个partition-之间怎么保证-消息全局顺序性" class="headerlink" title="kafka多个partition 之间怎么保证 消息全局顺序性"></a>kafka多个partition 之间怎么保证 消息全局顺序性</h4>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://carlo-z.com/flink/flink-checkpoint/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Focus-1">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Focus-1">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/flink/flink-checkpoint/" itemprop="url">flink checkpoint 分类</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-10-29T00:00:00+08:00">
                2019-10-29
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/flink/" itemprop="url" rel="index">
                    <span itemprop="name">flink</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Keyed-State"><a href="#Keyed-State" class="headerlink" title="Keyed State"></a>Keyed State</h1><h1 id="Operator-State"><a href="#Operator-State" class="headerlink" title="Operator State"></a>Operator State</h1><h1 id="增量-checkpoint"><a href="#增量-checkpoint" class="headerlink" title="增量 checkpoint"></a>增量 checkpoint</h1><h1 id="持久化方式"><a href="#持久化方式" class="headerlink" title="持久化方式"></a>持久化方式</h1>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://carlo-z.com/flink/flink-mysql-to-kafka/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Focus-1">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Focus-1">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/flink/flink-mysql-to-kafka/" itemprop="url">flink 从mysql抽取写入kafka和文本文件</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-10-29T00:00:00+08:00">
                2019-10-29
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/flink/" itemprop="url" rel="index">
                    <span itemprop="name">flink</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <hr>
<br>

<h1 id="一、需求说明"><a href="#一、需求说明" class="headerlink" title="一、需求说明"></a>一、需求说明</h1><p>登录日志放在mysql里 ==&gt; 现在需要将 mysql中的数据 转换格式以后写入kafka ==&gt; 数据中心 从 kafka里取数据进行 日志分析和监管审查；</p>
<p>首先考虑有flume读取数据，但是在做格式转换时，需要重写 source 和 interceptor，得不偿失，还不如用flink。正好 阿里发布了全新的 flink 1.9，尝鲜使用；</p>
<br>

<h1 id="二、环境配置"><a href="#二、环境配置" class="headerlink" title="二、环境配置"></a>二、环境配置</h1><ul>
<li>flink-1.9.0（The only requirements are working <strong>Maven 3.0.4</strong> (or higher) and <strong>Java 8.x</strong> installations.）</li>
<li>mysql-5.6</li>
<li>kafka_2.11-0.11 </li>
</ul>
<p>1、安装 jdk 1.8+</p>
<p>2、下载启动flink-1.9</p>
<p>下载地址： <a href="https://flink.apache.org/zh/downloads.html" target="_blank" rel="noopener">https://flink.apache.org/zh/downloads.html</a> </p>
<p>说明文档： <a href="https://ci.apache.org/projects/flink/flink-docs-release-1.9/getting-started/tutorials/local_setup.html" target="_blank" rel="noopener">https://ci.apache.org/projects/flink/flink-docs-release-1.9/getting-started/tutorials/local_setup.html</a>  </p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">wget http://mirrors.tuna.tsinghua.edu.cn/apache/flink/flink-1.9.1/flink-1.9.1-bin-scala_2.11.tgz</span><br><span class="line">tar zxf flink-1.9.1-bin-scala_2.11.tgz</span><br><span class="line">cd flink-1.9.1</span><br><span class="line"><span class="meta">#</span> 启动flink(Standalone形式)</span><br><span class="line">/data/flink/flink-1.9.1/bin/start-cluster.sh</span><br><span class="line"><span class="meta">#</span> 停止flink</span><br><span class="line">/data/flink/flink-1.9.1/bin/stop-cluster.sh</span><br><span class="line">开启端口</span><br><span class="line">firewall-cmd --permanent --add-port=8081/tcp</span><br><span class="line">firewall-cmd --reload</span><br><span class="line">firewall-cmd --query-port 8081/tcp</span><br></pre></td></tr></table></figure>

<p>验证启动成功：</p>
<blockquote>
<p>jps -l</p>
</blockquote>
<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20191030094801.png" alt></p>
<blockquote>
<p>netstat -nltp | grep 8081</p>
</blockquote>
<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20191030094905.png" alt></p>
<p>访问管理页面： <a href="http://172.18.1.51:8081/" target="_blank" rel="noopener">http://172.18.1.51:8081</a> </p>
<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20191030094627.png" alt></p>
<br>

<h1 id="三、创建-Flink工程"><a href="#三、创建-Flink工程" class="headerlink" title="三、创建 Flink工程"></a>三、创建 Flink工程</h1><p>官网文档：<br><a href="https://ci.apache.org/projects/flink/flink-docs-release-1.9/dev/projectsetup/java_api_quickstart.html#requirements" target="_blank" rel="noopener">https://ci.apache.org/projects/flink/flink-docs-release-1.9/dev/projectsetup/java_api_quickstart.html#requirements</a> </p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">curl https://flink.apache.org/q/quickstart.sh | bash -s 1.9.0</span><br><span class="line">mv quickstart/ flink-log-process</span><br></pre></td></tr></table></figure>

<p>改造后工程结构如下：</p>
<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20191029184141.png" alt></p>
<h3 id="1、定义-Mysql-Datasource"><a href="#1、定义-Mysql-Datasource" class="headerlink" title="1、定义 Mysql Datasource"></a>1、定义 Mysql Datasource</h3><p>1.1、在上述工程的 pom.xml 中添加  mysql 依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">version</span>&gt;</span>5.1.34<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>1.2、定义 CCustLoginHisSource 读取 mysql</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.jzsec.tzdslog;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.IteratorUtils;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.api.common.state.ListState;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.api.common.state.ListStateDescriptor;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.api.common.typeinfo.TypeInformation;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.configuration.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.runtime.state.FunctionInitializationContext;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.runtime.state.FunctionSnapshotContext;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.checkpoint.CheckpointedFunction;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.functions.source.RichSourceFunction;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.sql.Connection;</span><br><span class="line"><span class="keyword">import</span> java.sql.DriverManager;</span><br><span class="line"><span class="keyword">import</span> java.sql.PreparedStatement;</span><br><span class="line"><span class="keyword">import</span> java.sql.ResultSet;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CCustLoginHisSource</span> <span class="keyword">extends</span> <span class="title">RichSourceFunction</span>&lt;<span class="title">CCustLoginHisEntity</span>&gt; <span class="keyword">implements</span> <span class="title">CheckpointedFunction</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> PreparedStatement ps;</span><br><span class="line">    <span class="keyword">private</span> Connection connection;</span><br><span class="line">    <span class="keyword">private</span> String url, username, password;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> year;</span><br><span class="line">    <span class="keyword">private</span> Date beginDate, endDate;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">CCustLoginHisSource</span><span class="params">(String url, String username, String password, LocalDate localDate)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.url = url;</span><br><span class="line">        <span class="keyword">this</span>.username = username;</span><br><span class="line">        <span class="keyword">this</span>.password = password;</span><br><span class="line"></span><br><span class="line">        year = localDate.getYear();</span><br><span class="line">        beginDate = <span class="keyword">new</span> java.sql.Date(localDate.atStartOfDay().atZone(ZoneId.systemDefault()).toInstant().toEpochMilli());</span><br><span class="line">        endDate = <span class="keyword">new</span> java.sql.Date(localDate.plusDays(<span class="number">1</span>).atStartOfDay().atZone(ZoneId.systemDefault()).toInstant().toEpochMilli());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Connection <span class="title">getConnection</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Connection conn = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Class.forName(<span class="string">"com.mysql.jdbc.Driver"</span>);</span><br><span class="line">            conn = DriverManager.getConnection(url, username, password);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            System.out.println(<span class="string">"-----------mysql getConnection() has exception , msg = "</span> + e.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> conn;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">open</span><span class="params">(Configuration parameters)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">// 增量抽取数据</span></span><br><span class="line">        <span class="keyword">super</span>.open(parameters);</span><br><span class="line">        connection = getConnection();</span><br><span class="line">        String sql = <span class="string">"select * from db.tablename_"</span> + year + <span class="string">" where create_time between ? and ?;"</span>;</span><br><span class="line">        ps = <span class="keyword">this</span>.connection.prepareStatement(sql);</span><br><span class="line">        ps.setDate(<span class="number">1</span>, beginDate);</span><br><span class="line">        ps.setDate(<span class="number">2</span>, endDate);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.close();</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> != connection) &#123;</span><br><span class="line">            connection.close();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> != ps) &#123;</span><br><span class="line">            ps.close();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">cancel</span><span class="params">()</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">(SourceContext&lt;CCustLoginHisEntity&gt; sourceContext)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        ResultSet resultSet = ps.executeQuery();</span><br><span class="line">        <span class="keyword">while</span> (resultSet.next()) &#123;</span><br><span class="line">            CCustLoginHisEntity entity = <span class="keyword">new</span> CCustLoginHisEntity();</span><br><span class="line">            entity.setId(resultSet.getInt(<span class="string">"id"</span>));</span><br><span class="line">            entity.setEnv_type(resultSet.getString(<span class="string">"env_type"</span>));</span><br><span class="line">            entity.setApp_type(resultSet.getString(<span class="string">"app_type"</span>));</span><br><span class="line">            entity.setUser_ip(resultSet.getString(<span class="string">"user_ip"</span>));</span><br><span class="line">            entity.setUser_agent(resultSet.getString(<span class="string">"user_agent"</span>));</span><br><span class="line">            entity.setIp_addr(resultSet.getString(<span class="string">"ip_addr"</span>));</span><br><span class="line">            entity.setMac(resultSet.getString(<span class="string">"mac"</span>));</span><br><span class="line">            entity.setPhone(resultSet.getString(<span class="string">"phone"</span>));</span><br><span class="line">            entity.setImei(resultSet.getString(<span class="string">"imei"</span>));</span><br><span class="line">            entity.setRequest_time(resultSet.getDate(<span class="string">"request_time"</span>));</span><br><span class="line">            entity.setCreate_time(resultSet.getDate(<span class="string">"create_time"</span>));</span><br><span class="line"></span><br><span class="line">            lastIndex = entity.getId();</span><br><span class="line">            sourceContext.collect(entity);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>1.3、写入kafka</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.flink.configuration.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.functions.sink.RichSinkFunction;</span><br><span class="line"><span class="keyword">import</span> org.apache.kafka.clients.producer.KafkaProducer;</span><br><span class="line"><span class="keyword">import</span> org.apache.kafka.clients.producer.ProducerRecord;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Properties;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ExecutionException;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.atomic.AtomicInteger;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SinkToKafka011</span> <span class="keyword">extends</span> <span class="title">RichSinkFunction</span>&lt;<span class="title">String</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Properties props;</span><br><span class="line">    <span class="keyword">private</span> String topic;</span><br><span class="line">    <span class="keyword">private</span> KafkaProducer&lt;Integer, <span class="keyword">byte</span>[]&gt; producerB;</span><br><span class="line">    <span class="keyword">private</span> AtomicInteger messageNo = <span class="keyword">new</span> AtomicInteger(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SinkToKafka011</span><span class="params">(Properties props, String topic)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.props = props;</span><br><span class="line">        <span class="keyword">this</span>.topic = topic;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">open</span><span class="params">(Configuration parameters)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.open(parameters);</span><br><span class="line">        producerB = <span class="keyword">new</span> KafkaProducer(props);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">invoke</span><span class="params">(String value, Context context)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            producerB.send(<span class="keyword">new</span> ProducerRecord(</span><br><span class="line">                    topic,</span><br><span class="line">                    messageNo.getAndIncrement(),</span><br><span class="line">                    value.getBytes()))</span><br><span class="line">                    .get();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ExecutionException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> != producerB) producerB.close();</span><br><span class="line">        <span class="keyword">super</span>.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>1.4、写入文本文件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">import org.apache.flink.configuration.Configuration;</span><br><span class="line">import org.apache.flink.streaming.api.functions.sink.RichSinkFunction;</span><br><span class="line"></span><br><span class="line">import java.io.BufferedWriter;</span><br><span class="line">import java.io.File;</span><br><span class="line">import java.io.FileOutputStream;</span><br><span class="line">import java.io.OutputStreamWriter;</span><br><span class="line"></span><br><span class="line">public class SinkToTextFile extends RichSinkFunction&lt;String&gt; &#123;</span><br><span class="line">    private String filepath;</span><br><span class="line">    private String filename;</span><br><span class="line">    private FileOutputStream fos;</span><br><span class="line">    private OutputStreamWriter osw;</span><br><span class="line">    private BufferedWriter bufferedWriter;</span><br><span class="line"></span><br><span class="line">    public SinkToTextFile(String filepath, String filename) &#123;</span><br><span class="line">        this.filepath = filepath;</span><br><span class="line">        this.filename = filename;</span><br><span class="line">        File dir = new File(filepath);</span><br><span class="line">        if (!dir.isDirectory()) &#123;</span><br><span class="line">            dir.mkdir();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void open(Configuration parameters) throws Exception &#123;</span><br><span class="line">        super.open(parameters);</span><br><span class="line">        File file = new File(filepath);</span><br><span class="line">        if (!file.isDirectory()) &#123;</span><br><span class="line">            file.mkdir();</span><br><span class="line">        &#125;</span><br><span class="line">        fos = new FileOutputStream(new File(filepath + "/" + filename), true);</span><br><span class="line">        osw = new OutputStreamWriter(fos);</span><br><span class="line">        bufferedWriter = new BufferedWriter(osw);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void close() throws Exception &#123;</span><br><span class="line">        if (bufferedWriter != null) bufferedWriter.close();</span><br><span class="line">        if (osw != null) osw.close();</span><br><span class="line">        if (fos != null) fos.close();</span><br><span class="line">        super.close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void invoke(String value, Context context) throws Exception &#123;</span><br><span class="line">        bufferedWriter.write(value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>1.5、定义Job</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSONObject;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.lang3.StringUtils;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.api.java.utils.ParameterTool;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.shaded.jackson2.com.fasterxml.jackson.databind.ObjectMapper;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.datastream.DataStreamSource;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.datastream.SingleOutputStreamOperator;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.environment.StreamExecutionEnvironment;</span><br><span class="line"><span class="keyword">import</span> org.apache.kafka.clients.producer.ProducerConfig;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.text.ParseException;</span><br><span class="line"><span class="keyword">import</span> java.text.SimpleDateFormat;</span><br><span class="line"><span class="keyword">import</span> java.time.LocalDate;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"><span class="keyword">import</span> java.util.regex.Matcher;</span><br><span class="line"><span class="keyword">import</span> java.util.regex.Pattern;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TzdsLoginLogProcessJob</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> ObjectMapper mapper = <span class="keyword">new</span> ObjectMapper();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> ParameterTool argsParamTool = ParameterTool.fromArgs(args);</span><br><span class="line">        <span class="comment">// --logdate 2019-10-15</span></span><br><span class="line">        String logdate = argsParamTool.get(<span class="string">"logdate"</span>, <span class="string">"2019-10-15"</span>); </span><br><span class="line">        <span class="keyword">final</span> String propertiesFile = argsParamTool.get(<span class="string">"conf"</span>, <span class="string">"conf.properties"</span>);</span><br><span class="line">        <span class="keyword">final</span> ParameterTool propParamTool = ParameterTool.fromPropertiesFile(propertiesFile);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 创建上下文</span></span><br><span class="line">        <span class="keyword">final</span> StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment();</span><br><span class="line">        env.getConfig().setGlobalJobParameters(propParamTool);</span><br><span class="line"></span><br><span class="line">        DataStreamSource&lt;CCustLoginHisEntity&gt; dataStreamSource = env.addSource(</span><br><span class="line">                <span class="keyword">new</span> CCustLoginHisSource(</span><br><span class="line">                        propParamTool.get(<span class="string">"mysql.jdbc.url"</span>),</span><br><span class="line">                        propParamTool.get(<span class="string">"mysql.jdbc.username"</span>),</span><br><span class="line">                        propParamTool.get(<span class="string">"mysql.jdbc.password"</span>),</span><br><span class="line">                        LocalDate.parse(logdate))</span><br><span class="line">        );</span><br><span class="line">        SingleOutputStreamOperator&lt;String&gt; logStream = dataStreamSource.map(entity -&gt; &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                LogModel log = <span class="keyword">new</span> LogModel();</span><br><span class="line">                log.setAppType(<span class="string">"accessLog"</span>);</span><br><span class="line">                log.setCid(<span class="string">"0x000000000001"</span>);</span><br><span class="line">                log.setMid(<span class="string">"0x000000000002"</span>);</span><br><span class="line">                log.setName(<span class="string">"tagname"</span>);</span><br><span class="line">                log.setIp(entity.getUser_ip());</span><br><span class="line">                log.setIndicator(entity2Map(entity));</span><br><span class="line">                log.setTime_stamp(Long.toString(entity.getRequest_time().getTime()));</span><br><span class="line">                <span class="keyword">return</span> JSONObject.toJSONString(log) + <span class="string">"\n"</span>;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="string">""</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        SingleOutputStreamOperator&lt;String&gt; unifyLogStream = dataStreamSource.map(entity -&gt; &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Map unifyLog = <span class="keyword">new</span> HashMap();</span><br><span class="line">                initLoginLog(unifyLog);</span><br><span class="line">                procLoginLog(unifyLog, entity2Map(entity), Long.toString(entity.getRequest_time().getTime()));</span><br><span class="line">                <span class="keyword">return</span> JSONObject.toJSONString(unifyLog) + <span class="string">"\n"</span>;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="string">""</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="comment">// 写入日志</span></span><br><span class="line">        logStream.addSink(<span class="keyword">new</span> SinkToTextFile(</span><br><span class="line">                propParamTool.get(<span class="string">"log.filepath"</span>) + <span class="string">"/"</span> + logdate,</span><br><span class="line">                <span class="string">"login_log_"</span> + logdate.replace(<span class="string">"-"</span>, <span class="string">""</span>) + <span class="string">".log"</span></span><br><span class="line">                ));</span><br><span class="line">        <span class="comment">// 写入kafka</span></span><br><span class="line">        Properties kafkaProps = <span class="keyword">new</span> Properties();</span><br><span class="line">        kafkaProps.put(ProducerConfig.BOOTSTRAP_SERVERS_CONFIG, propParamTool.get(<span class="string">"kafka.bootstrap.servers"</span>));</span><br><span class="line">        kafkaProps.put(<span class="string">"client.id"</span>, propParamTool.get(<span class="string">"kafka.client.id"</span>));</span><br><span class="line">        kafkaProps.put(ProducerConfig.KEY_SERIALIZER_CLASS_CONFIG, <span class="string">"org.apache.kafka.common.serialization.IntegerSerializer"</span>);</span><br><span class="line">        kafkaProps.put(ProducerConfig.VALUE_SERIALIZER_CLASS_CONFIG, <span class="string">"org.apache.kafka.common.serialization.ByteArraySerializer"</span>);</span><br><span class="line">        String topic = propParamTool.get(<span class="string">"kafka.topic.login-log"</span>);</span><br><span class="line">        unifyLogStream.addSink(<span class="keyword">new</span> SinkToKafka011(kafkaProps, topic)).name(<span class="string">"sink-to-kafka"</span>).setParallelism(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        env.execute();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2、编译"><a href="#2、编译" class="headerlink" title="2、编译"></a>2、编译</h3><p> mvn clean package </p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/3/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/3/">3</a><span class="page-number current">4</span><a class="page-number" href="/page/5/">5</a><span class="space">&hellip;</span><a class="page-number" href="/page/24/">24</a><a class="extend next" rel="next" href="/page/5/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">Focus-1</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">236</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">59</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">100</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          

          
          

          
          
            <div class="links-of-blogroll motion-element links-of-blogroll-block">
              <div class="links-of-blogroll-title">
                <i class="fa  fa-fw fa-link"></i>
                Links
              </div>
              <ul class="links-of-blogroll-list">
                
                  <li class="links-of-blogroll-item">
                    <a href="https://gitee.com/carloz" title="repository - https://gitee.com/carloz" target="_blank">repository - https://gitee.com/carloz</a>
                  </li>
                
              </ul>
            </div>
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2015 &mdash; <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Focus-1</span>

  
</div>








  <div class="footer-custom">Hosted by <a target="_blank" href="https://gitee.com/carloz">Gitee Repo</a></div>


        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  
  

  
  
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
          processEscapes: true,
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
      });
    </script>

    <script type="text/x-mathjax-config">
      MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
        }
      });
    </script>
    <script type="text/javascript" src="//cdn.bootcss.com/mathjax/2.7.1/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
  


  

  

</body>
</html>
