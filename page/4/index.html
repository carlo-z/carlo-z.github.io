<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">




  
  
  
  

  
    
    
  

  

  

  
    
      
    

    
  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=consolas:300,300italic,400,400italic,700,700italic|Lobster Two:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT">










<meta name="keywords" content="Java Kafka Docker JVM NIO Netty">
<meta property="og:type" content="website">
<meta property="og:title" content="Focus-1">
<meta property="og:url" content="https://carlo-z.com/page/4/index.html">
<meta property="og:site_name" content="Focus-1">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Focus-1">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"left","display":"always","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://carlo-z.com/page/4/">





  <title>Focus-1</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Focus-1</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br>
            
            关于
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://carlo-z.com/distribution/rpc/rpc-core-principle/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Focus-1">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Focus-1">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/distribution/rpc/rpc-core-principle/" itemprop="url">RPC核心原理和实战 —— 基础篇</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-02-19T00:00:00+08:00">
                2020-02-19
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/rpc/" itemprop="url" rel="index">
                    <span itemprop="name">rpc</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <hr>
<br>

<blockquote>
<p>别老想着怎么用好RPC框架，你得多花时间琢磨原理</p>
</blockquote>
<h2 id="引言"><a href="#引言" class="headerlink" title="引言"></a>引言</h2><h3 id="1、为什么要学习-RPC？"><a href="#1、为什么要学习-RPC？" class="headerlink" title="1、为什么要学习 RPC？"></a>1、为什么要学习 RPC？</h3><p><u><strong>只要涉及网络通信，我们就有可能使用RPC</strong></u>。</p>
<p>在我看来，<strong><u>RPC 是解决分布式系统通信问题的一大利器</u></strong>。分布式系统中的网络通信一般都会采用四层的 TCP 协议或七层的 HTTP 协议，在我的了解中，前者占大多数，这主要得益于 TCP 协议的稳定性和高效性。网络通信说起来简单，但实际上是一个非常复杂的过程，这个过程主要包括：对端节点的查找、网络连接的建立、传输数据的编码解码以及网络连接的管理等等，每一项都很复杂。</p>
<br>

<h3 id="2、如何学习-RPC？"><a href="#2、如何学习-RPC？" class="headerlink" title="2、如何学习 RPC？"></a>2、如何学习 RPC？</h3><p>逐步深入</p>
<ol>
<li><p>使用 RPC 就可以像调用本地一样发起远程调用，用它可以解决通信问题，这时候我们肯定要去学<code>序列化、编解码以及网络传输</code>这些内容。</p>
</li>
<li><p>把这些内容掌握后，你就会发现，原来这些只是 RPC 的基础，RPC 还有更吸引人的点，它真正强大的地方是它的治理功能，比如<code>连接管理、健康检测、负载均衡、优雅启停机、异常重试、业务分组以及熔断限流等等</code>。突然间，你会感觉自己走进了一个新世界，这些内容会成为你今后学习 RPC 的重点和难点。</p>
</li>
<li><p>对 RPC 活学活用，学会提升 RPC 的性能以及它<code>在分布式环境下如何定位问题</code>等等</p>
</li>
</ol>
<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20200219111602.png" alt></p>
<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20200219111734.png" alt></p>
<br>

<br>

<h2 id="1、核心原理：能否画张图解释RPC通信流程？"><a href="#1、核心原理：能否画张图解释RPC通信流程？" class="headerlink" title="1、核心原理：能否画张图解释RPC通信流程？"></a>1、核心原理：能否画张图解释RPC通信流程？</h2><p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20200219141554.png" alt></p>
<h3 id="1-1、什么是RPC？"><a href="#1-1、什么是RPC？" class="headerlink" title="1.1、什么是RPC？"></a>1.1、什么是RPC？</h3><p>RPC 的全称是 Remote Procedure Call，即远程过程调用。简单解读字面上的意思，远程肯定是指要跨机器而非本机，所以需要用到网络编程才能实现。</p>
<p>RPC 的作用就是体现在这样两个方面：</p>
<ul>
<li>屏蔽远程调用跟本地调用的区别，让我们感觉就是调用项目内的方法；</li>
<li>隐藏底层网络通信的复杂性，让我们更专注于业务逻辑；</li>
</ul>
<h3 id="1-2、RPC通信流程"><a href="#1-2、RPC通信流程" class="headerlink" title="1.2、RPC通信流程"></a>1.2、RPC通信流程</h3><h4 id="1-、一个完成的RPC会涉及哪些步骤呢？"><a href="#1-、一个完成的RPC会涉及哪些步骤呢？" class="headerlink" title="1)、一个完成的RPC会涉及哪些步骤呢？"></a>1)、一个完成的RPC会涉及哪些步骤呢？</h4><ul>
<li><p>TCP通信：RPC 是一个远程调用，那肯定就需要通过网络来传输数据，并且 RPC 常用于业务系统之间的数据交互，需要保证其可靠性，所以 RPC 一般默认采用 TCP 来传输。</p>
</li>
<li><p>序列化：网络传输的数据必须是二进制数据，但调用方请求的出入参数都是对象。对象是肯定没法直接在网络中传输的，需要提前把它转成可传输的二进制，并且要求转换算法是可逆的，这个过程我们一般叫做“序列化”。</p>
</li>
<li><p>协议：在这里我们可以想想高速公路，它上面有很多出口，为了让司机清楚地知道从哪里出去，管理部门会在路上建立很多指示牌，并在指示牌上标明下一个出口是哪里、还有多远。那回到数据包识别这个场景，我们是不是也可以建立一些“指示牌”，并在上面标明数据包的类型和长度，这样就可以正确的解析数据了。确实可以，并且我们把<u><strong>数据格式的约定内容叫做“协议”</strong></u>。大多数的协议会分成两部分，分别是数据头和消息体。数据头一般用于身份识别，包括<code>协议标识、数据大小、请求类型、序列化类型</code>等信息；消息体主要是请求的业务<code>参数信息和扩展属性</code>等</p>
</li>
<li><p>反序列化：根据协议格式，服务提供方就可以正确地从二进制数据中分割出不同的请求来，同时根据请求类型和序列化类型，把二进制的消息体逆向还原成请求对象。这个过程叫作“反序列化”。</p>
</li>
<li><p>执行：服务提供方再根据反序列化出来的请求对象找到对应的实现类，完成真正的方法调用，然后把执行结果序列化后，回写到对应的 TCP 通道里面。调用方获取到应答的数据包后，再反序列化成应答对象，这样调用方就完成了一次 RPC 调用</p>
</li>
</ul>
<br>

<h4 id="2-、上述构成一个完成的RPC吗？"><a href="#2-、上述构成一个完成的RPC吗？" class="headerlink" title="2)、上述构成一个完成的RPC吗？"></a>2)、上述构成一个完成的RPC吗？</h4><p>缺点：对于研发人员来说，这样做需要掌握太多的RPC底层细节，需要手动写代码去构造请求、调用徐磊好、并进行网络调用，整个API非常不友好；</p>
<p>如何简单 API，屏蔽 RPC 细节？</p>
<p>如果你了解 Spring，一定对其 AOP 技术很佩服，其核心是采用动态代理的技术，通过字节码增强对方法进行拦截增强，以便于增加需要的额外处理逻辑。其实这个技术也可以应用到 RPC 场景来解决我们刚才面临的问题。</p>
<p>由服务提供者给出业务接口声明，在调用方的程序里面，RPC 框架根据调用的服务接口提前生成动态代理实现类，并通过依赖注入等技术注入到声明了该接口的相关业务逻辑里面。该代理实现类会拦截所有的方法调用，在提供的方法处理逻辑里面完成一整套的远程调用，并把远程调用结果返回给调用方，这样调用方在调用远程方法的时候就获得了像调用本地接口一样的体验。</p>
<p>到这里，一个简单版本的 RPC 框架就实现了。我把整个流程都画出来了，供你参考：</p>
<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20200219141554.png" alt></p>
<br>



<h3 id="1-3、RPC在架构中的位置"><a href="#1-3、RPC在架构中的位置" class="headerlink" title="1.3、RPC在架构中的位置"></a>1.3、RPC在架构中的位置</h3><p>RPC是解决应用间通信的一种方式；</p>
<p>RPC 框架能够帮助我们解决系统拆分后的通信问题，并且能让我们像调用本地一样去调用远程方法。利用 RPC 我们不仅可以很方便地将应用架构从“单体”演进成“微服务化”，而且还能解决实际开发过程中的效率低下、系统耦合等问题，这样可以使得我们的系统架构整体清晰、健壮，应用可运维度增强。</p>
<p>当然 RPC 不仅可以用来解决通信问题，它还被用在了很多其他场景，比如：发 MQ、分布式缓存、数据库等。下图是我之前开发的一个应用架构图：</p>
<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20200219143531.png" alt></p>
<br>

<h3 id="1-4、总结"><a href="#1-4、总结" class="headerlink" title="1.4、总结"></a>1.4、总结</h3><p>本讲我主要讲了下 RPC 的原理，RPC 就是提供一种透明调用机制，让使用者不必显式地区分本地调用和远程调用。RPC 虽然可以帮助开发者屏蔽远程调用跟本地调用的区别，但毕竟涉及到远程网络通信，所以这里还是有很多使用上的区别，比如：</p>
<ul>
<li><p>调用过程中超时了怎么处理业务？</p>
</li>
<li><p>什么场景下最适合使用 RPC？</p>
</li>
<li><p>什么时候才需要考虑开启压缩？</p>
</li>
</ul>
<p>无论你是一个初级开发者还是高级开发者，RPC 都应该是你日常开发过程中绕不开的一个话题，所以作为软件开发者的我们，真的很有必要详细地了解 RPC 实现细节。只有这样，才能帮助我们更好地在日常工作中使用 RPC。课后思考</p>
<br>

<br>

<h2 id="2、RPC协议：怎么设计可扩展向后兼容的协议？"><a href="#2、RPC协议：怎么设计可扩展向后兼容的协议？" class="headerlink" title="2、RPC协议：怎么设计可扩展向后兼容的协议？"></a>2、RPC协议：怎么设计可扩展向后兼容的协议？</h2><p>一提到协议，你最先想到的可能是 TCP 协议、UDP 协议等等；</p>
<p>那 HTTP 协议跟 RPC 协议又有什么关系呢？看起来他俩好像不搭边，但他们有一个共性就是都属于应用层协议；</p>
<p><u><strong>我们今天要讲的 RPC 协议就是围绕应用层协议展开的</strong></u>。我们可以先了解下 HTTP 协议，我们先看看它的协议格式是什么样子的。回想一下我们在浏览器里面输入一个 URL 会发生什么？抛开 DNS 解析暂且不谈，浏览器收到命令后会封装一个请求，并把请求发送到 DNS 解析出来的 IP 上，通过抓包工具我们可以抓到请求的数据包，如下图所示：</p>
<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20200219144451.png" alt></p>
<h3 id="2-1、协议的作用"><a href="#2-1、协议的作用" class="headerlink" title="2.1、协议的作用"></a>2.1、协议的作用</h3><p>看完 HTTP 协议之后，你可能会有一个疑问，我们为什么需要协议这个东西呢？没有协议就不能通信吗？</p>
<p>我们知道只有二进制才能在网络中传输，所以 RPC 请求在发送到网络中之前，他需要把方法调用的请求参数转成二进制；转成二进制后，写入本地 Socket 中，然后被网卡发送到网络设备中。</p>
<p>但在传输过程中，RPC 并不会把请求参数的所有二进制数据整体一下子发送到对端机器上，中间可能会拆分成好几个数据包，也可能会合并其他请求的数据包（合并的前提是同一个 TCP 连接上的数据），至于怎么拆分合并，这其中的细节会涉及到系统参数配置和 TCP 窗口大小。对于服务提供方应用来说，他会从 TCP 通道里面收到很多的二进制数据，那这时候怎么识别出哪些二进制是第一个请求的呢？</p>
<p>所以呢，<u><strong>为了避免语义不一致的事情发生，我们就需要在发送请求的时候设定一个边界，然后在收到请求的时候按照这个设定的边界进行数据分割。这个边界语义的表达，就是我们所说的协议</strong></u>。</p>
<br>

<h3 id="2-2、如何设计协议？"><a href="#2-2、如何设计协议？" class="headerlink" title="2.2、如何设计协议？"></a>2.2、如何设计协议？</h3><p>有了现成的 HTTP 协议，为啥不直接用，还要为 RPC 设计私有协议呢？</p>
<p>这还要从 RPC 的作用说起，相对于 HTTP 的用处，RPC 更多的是负责应用间的通信，所以性能要求相对更高。但 HTTP 协议的数据包大小相对请求数据本身要大很多，又需要加入很多无用的内容，比如换行符号、回车符等；还有一个更重要的原因是，HTTP 协议属于无状态协议，客户端无法对请求和响应进行关联，每次请求都需要重新建立连接，响应完成后再关闭连接。因此，对于要求高性能的 RPC 来说，HTTP 协议基本很难满足需求，所以 RPC 会选择设计更紧凑的私有协议。</p>
<p>那怎么设计一个私有 RPC 协议呢？</p>
<p>消息边界：消息长度，实现消息间正确断句</p>
<p>在协议头里面，我们除了会放协议长度、序列化方式，还会放一些像协议标示、消息 ID、消息类型这样的参数，而协议体一般只放请求接口方法、请求的业务参数值和一些扩展属性。这样一个完整的 RPC 协议大概就出来了，协议头是由一堆固定的长度参数组成，而协议体是根据请求接口和参数构造的，长度属于可变的，具体协议如下图所示：</p>
<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20200219151400.png" alt></p>
<br>

<h3 id="2-3、可扩展的协议"><a href="#2-3、可扩展的协议" class="headerlink" title="2.3、可扩展的协议"></a>2.3、可扩展的协议</h3><p>刚才讲的协议属于定长协议头，那也就是说往后就不能再往协议头里加新参数了，如果加参数就会导致线上兼容问题。举个具体例子，假设你设计了一个 88Bit 的协议头，其中协议长度占用 32bit，然后你为了加入新功能，在协议头里面加了 2bit，并且放到协议头的最后。升级后的应用，会用新的协议发出请求，然而没有升级的应用收到的请求后，还是按照 88bit 读取协议头，新加的 2 个 bit 会当作协议体前 2 个 bit 数据读出来，但原本的协议体最后 2 个 bit 会被丢弃了，这样就会导致协议体的数据是错的。</p>
<p>可能你会想：“那我把参数加在不定长的协议体里面行不行？而且刚才你也说了，协议体里面会放一些扩展属性。”</p>
<p>没错，协议体里面是可以加新的参数，但这里有一个关键点，就是协议体里面的内容都是经过序列化出来的，也就是说你要获取到你参数的值，就必须把整个协议体里面的数据经过反序列化出来。但在某些场景下，这样做的代价有点高啊！</p>
<p>比如说，服务提供方收到一个过期请求，这个过期是说服务提供方收到的这个请求的时间大于调用方发送的时间和配置的超时时间，既然已经过期，就没有必要接着处理，直接返回一个超时就好了。那要实现这个功能，就要在协议里面传递这个配置的超时时间，那如果之前协议里面没有加超时时间参数的话，我们现在把这个超时时间加到协议体里面是不是就有点重了呢？显然，会加重 CPU 的消耗。</p>
<p>所以为了保证能平滑地升级改造前后的协议，我们有必要设计一种支持可扩展的协议。其关键在于让协议头支持可扩展，扩展后协议头的长度就不能定长了。那要实现读取不定长的协议头里面的内容，在这之前肯定需要一个固定的地方读取长度，所以我们需要一个固定的写入协议头的长度。整体协议就变成了三部分内容：固定部分、协议头内容、协议体内容，前两部分我们还是可以统称为“协议头”，具体协议如下：</p>
<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20200219162433.png" alt></p>
<p>最后，我想说，<strong><u>设计一个简单的 RPC 协议并不难，难的就是怎么去设计一个可“升级”的协议</u></strong>。不仅要让我们在扩展新特性的时候能做到向下兼容，而且要尽可能地减少资源损耗，所以我们协议的结构不仅要支持协议体的扩展，还要做到协议头也能扩展。上述这种设计方法来源于我多年的线上经验，可以说做好扩展性是至关重要的，期待这个协议模版能帮你避掉一些坑。</p>
<br>

<h2 id="3、序列化：对象怎么在网络中传输"><a href="#3、序列化：对象怎么在网络中传输" class="headerlink" title="3、序列化：对象怎么在网络中传输"></a>3、序列化：对象怎么在网络中传输</h2><p>​    那么承接上一讲的一个重点，今天我会讲解下 RPC 框架中的序列化。要知道，在不同的场景下合理地选择序列化方式，对提升 RPC 框架整体的<u><strong>稳定性和性能</strong></u>是至关重要的</p>
<h3 id="3-1、为什么需要序列化？"><a href="#3-1、为什么需要序列化？" class="headerlink" title="3.1、为什么需要序列化？"></a>3.1、为什么需要序列化？</h3><p>​    网络传输的数据必须是二进制数据，但调用方请求的出入参数都是对象。对象是不能直接在网络中传输的，所以我们需要提前把它转成可传输的二进制</p>
<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20200225144044.png" alt></p>
<p>​    总结来说，序列化就是将对象转换成二进制数据的过程，而反序列就是反过来将二进制转换为对象的过程。</p>
<p>​    那么 RPC 框架为什么需要序列化呢？还是请你回想下 RPC 的通信流程：</p>
<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20200225144123.png" alt></p>
<p>​    不妨借用个例子帮助你理解，比如发快递，我们要发一个需要自行组装的物件。发件人发之前，会把物件拆开装箱，这就好比序列化；这时候快递员来了，不能磕碰呀，那就要打包，这就好比将序列化后的数据进行编码，封装成一个固定格式的协议；过了两天，收件人收到包裹了，就会拆箱将物件拼接好，这就好比是协议解码和反序列化。</p>
<p>​    所以现在你清楚了吗？因为网络传输的数据必须是二进制数据，所以在 RPC 调用中，对入参对象与返回值对象进行序列化与反序列化是一个必须的过程。</p>
<h3 id="3-2、有哪些常用的序列化"><a href="#3-2、有哪些常用的序列化" class="headerlink" title="3.2、有哪些常用的序列化"></a>3.2、有哪些常用的序列化</h3><h4 id="1-、JDK原生序列化"><a href="#1-、JDK原生序列化" class="headerlink" title="1)、JDK原生序列化"></a>1)、JDK原生序列化</h4><p>​    JDK 自带的序列化机制对使用者而言是非常简单的。序列化具体的实现是由 ObjectOutputStream 完成的，而反序列化的具体实现是由 ObjectInputStream 完成的。</p>
<p>​    那么 JDK 的序列化过程是怎样完成的呢？我们看下下面这张图：</p>
<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20200225144345.png" alt></p>
<p>序列化过程就是在读取对象数据的时候，不断加入一些特殊分隔符，这些特殊分隔符用于在反序列化过程中截断用。</p>
<ul>
<li><p>头部数据用来声明序列化协议、序列化版本，用于高低版本向后兼容</p>
</li>
<li><p>对象数据主要包括类名、签名、属性名、属性类型及属性值，当然还有开头结尾等数据，除了属性值属于真正的对象值，其他都是为了反序列化用的元数据</p>
</li>
<li><p>存在对象引用、继承的情况下，就是递归遍历“写对象”逻辑</p>
</li>
</ul>
<h4 id="2-、JSON"><a href="#2-、JSON" class="headerlink" title="2)、JSON"></a>2)、JSON</h4><p>一种文本型序列化框架。无论是前台 Web 用 Ajax 调用、用磁盘存储文本类型的数据，还是基于 HTTP 协议的 RPC 框架通信，都会选择 JSON 格式。</p>
<p>但用 JSON 进行序列化有这样<u><strong>两个问题</strong></u>，你需要格外注意：</p>
<ul>
<li><p>JSON 进行序列化的额外空间开销比较大，对于大数据量服务这意味着需要<u><strong>巨大的内存和磁盘开销</strong></u>；</p>
</li>
<li><p>JSON 没有类型，但像 Java 这种<u><strong>强类型语言</strong></u>，需要通过反射统一解决，所以性能不会太好。</p>
</li>
</ul>
<p>所以如果 RPC 框架选用 JSON 序列化，服务提供者与服务调用者之间传输的数据量要相对较小，否则将严重影响性能。</p>
<h4 id="3-、Hessian"><a href="#3-、Hessian" class="headerlink" title="3)、Hessian"></a>3)、Hessian</h4><p>Hessian 是动态类型、二进制、紧凑的，并且可跨语言移植的一种序列化框架。Hessian 协议要比 JDK、JSON 更加紧凑，性能上要比 JDK、JSON 序列化高效很多，而且生成的字节数也更小。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">Student student = <span class="keyword">new</span> Student();</span><br><span class="line">student.setNo(<span class="number">101</span>);</span><br><span class="line">student.setName(<span class="string">"HESSIAN"</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//把student对象转化为byte数组</span></span><br><span class="line">ByteArrayOutputStream bos = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">Hessian2Output output = <span class="keyword">new</span> Hessian2Output(bos);</span><br><span class="line">output.writeObject(student);</span><br><span class="line">output.flushBuffer();</span><br><span class="line"><span class="keyword">byte</span>[] data = bos.toByteArray();</span><br><span class="line">bos.close();</span><br><span class="line"></span><br><span class="line"><span class="comment">//把刚才序列化出来的byte数组转化为student对象</span></span><br><span class="line">ByteArrayInputStream bis = <span class="keyword">new</span> ByteArrayInputStream(data);</span><br><span class="line">Hessian2Input input = <span class="keyword">new</span> Hessian2Input(bis);</span><br><span class="line">Student deStudent = (Student) input.readObject();</span><br><span class="line">input.close();</span><br><span class="line"></span><br><span class="line">System.out.println(deStudent);</span><br></pre></td></tr></table></figure>

<p>相对于 JDK、JSON，由于 Hessian 更加高效，生成的字节数更小，有非常好的兼容性和稳定性，所以 Hessian 更加适合作为 RPC 框架远程通信的序列化协议。</p>
<p>但 Hessian 本身也有问题，官方版本对 Java 里面一些常见对象的类型不支持，比如：</p>
<ul>
<li>Linked 系列，LinkedHashMap、LinkedHashSet 等，但是可以通过扩展 CollectionDeserializer 类修复；</li>
<li>Locale 类，可以通过扩展 ContextSerializerFactory 类修复；</li>
<li>Byte/Short 反序列化的时候变成 Integer。以上这些情况，你在实践时需要格外注意。</li>
</ul>
<h4 id="4-、Protobuf"><a href="#4-、Protobuf" class="headerlink" title="4)、Protobuf"></a>4)、Protobuf</h4><p>Protobuf 是 Google 公司内部的混合语言数据标准，是一种轻便、高效的结构化数据存储格式，可以用于结构化数据序列化，支持 Java、Python、C++、Go 等语言。Protobuf 使用的时候需要定义 IDL（Interface description language），然后使用不同语言的 IDL 编译器，生成序列化工具类，它的优点是：</p>
<ul>
<li>序列化后体积相比 JSON、Hessian 小很多；</li>
<li>IDL 能清晰地描述语义，所以足以帮助并保证应用程序之间的类型不会丢失，无需类似 XML 解析器；</li>
<li>序列化反序列化速度很快，不需要通过反射获取类型；</li>
<li>消息格式升级和兼容性不错，可以做到向后兼容</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * // IDl 文件格式</span></span><br><span class="line"><span class="comment"> * synax = "proto3";</span></span><br><span class="line"><span class="comment"> * option java_package = "com.test";</span></span><br><span class="line"><span class="comment"> * option java_outer_classname = "StudentProtobuf";</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * message StudentMsg &#123;</span></span><br><span class="line"><span class="comment"> * //序号</span></span><br><span class="line"><span class="comment"> * int32 no = 1;</span></span><br><span class="line"><span class="comment"> * //姓名</span></span><br><span class="line"><span class="comment"> * string name = 2;</span></span><br><span class="line"><span class="comment"> * &#125;</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"> </span><br><span class="line">StudentProtobuf.StudentMsg.Builder builder = StudentProtobuf.StudentMsg.newBuilder();</span><br><span class="line">builder.setNo(<span class="number">103</span>);</span><br><span class="line">builder.setName(<span class="string">"protobuf"</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//把student对象转化为byte数组</span></span><br><span class="line">StudentProtobuf.StudentMsg msg = builder.build();</span><br><span class="line"><span class="keyword">byte</span>[] data = msg.toByteArray();</span><br><span class="line"></span><br><span class="line"><span class="comment">//把刚才序列化出来的byte数组转化为student对象</span></span><br><span class="line">StudentProtobuf.StudentMsg deStudent = StudentProtobuf.StudentMsg.parseFrom(data);</span><br><span class="line"></span><br><span class="line">System.out.println(deStudent);</span><br></pre></td></tr></table></figure>

<p>Protobuf 非常高效，但是对于具有反射和动态能力的语言来说，这样用起来很费劲，这一点就不如 Hessian，比如用 Java 的话，这个预编译过程不是必须的，可以考虑使用 Protostuff。</p>
<p>Protostuff 不需要依赖 IDL 文件，可以直接对 Java 领域对象进行反 / 序列化操作，在效率上跟 Protobuf 差不多，生成的二进制格式和 Protobuf 是完全相同的，可以说是一个 Java 版本的 Protobuf 序列化框架。但在使用过程中，我遇到过一些不支持的情况，也同步给你：</p>
<ul>
<li>不支持 null；</li>
<li>ProtoStuff 不支持单纯的 Map、List 集合对象，需要包在对象里面。</li>
</ul>
<h3 id="3-3、RPC框架中如何选择序列化"><a href="#3-3、RPC框架中如何选择序列化" class="headerlink" title="3.3、RPC框架中如何选择序列化"></a>3.3、RPC框架中如何选择序列化</h3><p>我刚刚简单地介绍了几种最常见的序列化协议，其实远不止这几种，还有 Message pack、kryo 等。那么面对这么多的序列化协议，在 RPC 框架中我们该如何选择呢？</p>
<ul>
<li><p>性能和效率</p>
</li>
<li><p>空间开销</p>
</li>
<li><p>序列化协议的通用性和兼容性（版本升级后的兼容性是否很好，是否支持更多的对象类型，是否是跨平台、跨语言的）</p>
</li>
<li><p>安全性（序列化存在安全漏洞，那么线上的服务就很可能被入侵）</p>
</li>
<li><p>易于调试</p>
</li>
</ul>
<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20200225151241.png" alt></p>
<p>我们首选的还是 Hessian 与 Protobuf，因为他们在性能、时间开销、空间开销、通用性、兼容性和安全性上，都满足了我们的要求。其中 Hessian 在使用上更加方便，在对象的兼容性上更好；Protobuf 则更加高效，通用性上更有优势。</p>
<h3 id="3-4、RPC框架在使用时要注意哪些问题？"><a href="#3-4、RPC框架在使用时要注意哪些问题？" class="headerlink" title="3.4、RPC框架在使用时要注意哪些问题？"></a>3.4、RPC框架在使用时要注意哪些问题？</h3><p>对象构造得过于复杂：属性很多，并且存在多层的嵌套</p>
<p>对象过于庞大：我经常遇到业务过来咨询，为啥他们的 RPC 请求经常超时，排查后发现他们的入参对象非常得大</p>
<p>用序列化框架不支持的类作为入参类：比如 Hessian 框架，他天然是不支持 LinkHashMap、LinkedHashSet 等，而且大多数情况下最好不要使用第三方集合类，Guava 中的集合类，很多开源的序列化框架都是优先支持编程语言原生的对象。因此如果入参是集合类，应尽量选用原生的、最为常用的集合类，如 HashMap、ArrayList</p>
<p>对象有复杂的继承关系：大多数序列化框架在序列化对象时都会将对象的属性一一进行序列化，当有继承关系时，会不停地寻找父类，遍历属性</p>
<h3 id="3-5、总结"><a href="#3-5、总结" class="headerlink" title="3.5、总结"></a>3.5、总结</h3><p>在使用 RPC 框架的过程中，我们构造入参、返回值对象，主要记住以下几点：</p>
<ol>
<li>对象要尽量简单，没有太多的依赖关系，属性不要太多，尽量高内聚；</li>
<li>入参对象与返回值对象体积不要太大，更不要传太大的集合；</li>
<li>尽量使用简单的、常用的、开发语言原生的对象，尤其是集合类；</li>
<li>对象不要有复杂的继承关系，最好不要有父子类的情况。</li>
</ol>
<br>

<br>




          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://carlo-z.com/java/jvm/arthas-docs/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Focus-1">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Focus-1">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/java/jvm/arthas-docs/" itemprop="url">arthas手册</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-01-13T00:00:00+08:00">
                2020-01-13
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/java/" itemprop="url" rel="index">
                    <span itemprop="name">java</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/java/jvm/" itemprop="url" rel="index">
                    <span itemprop="name">jvm</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/java/jvm/arthas/" itemprop="url" rel="index">
                    <span itemprop="name">arthas</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <hr>
<br>

<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20200113141230.png" alt></p>
<blockquote>
<p>官方文档：<a href="https://alibaba.github.io/arthas/" target="_blank" rel="noopener">https://alibaba.github.io/arthas/</a></p>
</blockquote>
<h1 id="下载安装"><a href="#下载安装" class="headerlink" title="下载安装"></a>下载安装</h1><p><a href="https://alibaba.github.io/arthas/manual-install.html" target="_blank" rel="noopener">https://alibaba.github.io/arthas/manual-install.html</a></p>
<p>下载</p>
<p><a href="https://maven.aliyun.com/repository/public/com/taobao/arthas/arthas-packaging/3.x.x/arthas-packaging-3.x.x-bin.zip" target="_blank" rel="noopener">https://maven.aliyun.com/repository/public/com/taobao/arthas/arthas-packaging/3.x.x/arthas-packaging-3.x.x-bin.zip</a></p>
<p>解压</p>
<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20200113141904.png" alt></p>
<h1 id="启动"><a href="#启动" class="headerlink" title="启动"></a>启动</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -jar arthas-boot.jar</span><br></pre></td></tr></table></figure>

<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20200113151900.png" alt></p>
<h1 id="查看dashboard"><a href="#查看dashboard" class="headerlink" title="查看dashboard"></a>查看dashboard</h1><blockquote>
<p> [arthas@14628]$ dashboard</p>
</blockquote>
<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20200113152011.png" alt></p>
<h1 id="查看线程"><a href="#查看线程" class="headerlink" title="查看线程"></a>查看线程</h1><blockquote>
<p> [arthas@14628]$ thread</p>
<p>// 拿到最忙的3个线程</p>
<p> [arthas@14628]$ thread -n 3</p>
</blockquote>
<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20200113152223.png" alt></p>
<h1 id="dump内存数据"><a href="#dump内存数据" class="headerlink" title="dump内存数据"></a>dump内存数据</h1><blockquote>
<p> [arthas@14628]$ heapdump d:/data/dump.hprof</p>
</blockquote>
<h3 id="jhat分析dump文件"><a href="#jhat分析dump文件" class="headerlink" title="jhat分析dump文件"></a>jhat分析dump文件</h3><blockquote>
<p>jhat d:/data/dump.hprof</p>
</blockquote>
<p>生成一个web，通过浏览器访问</p>
<h3 id="MAT分析dump文件"><a href="#MAT分析dump文件" class="headerlink" title="MAT分析dump文件"></a>MAT分析dump文件</h3>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://carlo-z.com/message-queue/rocketmq/rocketmq-how-to-submit-pr/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Focus-1">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Focus-1">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/message-queue/rocketmq/rocketmq-how-to-submit-pr/" itemprop="url">如何向rocketmq提交pr</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-01-13T00:00:00+08:00">
                2020-01-13
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/github/" itemprop="url" rel="index">
                    <span itemprop="name">github</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <hr>
<br>

<h1 id="1、fork仓库到自己账号下"><a href="#1、fork仓库到自己账号下" class="headerlink" title="1、fork仓库到自己账号下"></a>1、fork仓库到自己账号下</h1><p>官方仓库：<a href="https://github.com/apache/rocketmq" target="_blank" rel="noopener">https://github.com/apache/rocketmq</a></p>
<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20200113224109.png" alt></p>
<h1 id="2、clone代码到本地"><a href="#2、clone代码到本地" class="headerlink" title="2、clone代码到本地"></a>2、clone代码到本地</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">cd</span> /d/github</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 测试是否可以连接</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ssh -T git@github.com</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">cd</span> ~/.ssh</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ssh-keygen -t rsa</span></span><br></pre></td></tr></table></figure>

<p>将公钥添加到 github</p>
<p>github -&gt; Settings -&gt; SSH and GPG keys -&gt; New SSH key</p>
<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20200113225754.png" alt></p>
<p>再测试一下</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> ssh -T git@github.com</span></span><br><span class="line">Hi carlo-z! You've successfully authenticated, but GitHub does not provide shell access.</span><br></pre></td></tr></table></figure>

<p>clone 代码</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> git <span class="built_in">clone</span> git@github.com:carlo-z/rocketmq.git</span></span><br></pre></td></tr></table></figure>

<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20200113231711.png" alt></p>
<p>查看仓库状态，提示现在是 master 分支</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">cd</span> rocketmq/</span></span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> git status</span></span><br><span class="line">On branch master</span><br><span class="line">Your branch is up to date with 'origin/master'</span><br></pre></td></tr></table></figure>

<p>用<code>git remote -v</code>命令，可以看到此时只与自己的远程仓库建立了连接</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> git remote -v</span></span><br><span class="line">origin  git@github.com:carlo-z/rocketmq.git (fetch)</span><br><span class="line">origin  git@github.com:carlo-z/rocketmq.git (push)</span><br></pre></td></tr></table></figure>

<h1 id="3、与官方仓库建立连接"><a href="#3、与官方仓库建立连接" class="headerlink" title="3、与官方仓库建立连接"></a>3、与官方仓库建立连接</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> git remote add upstream https://github.com/apache/rocketmq.git</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> git remote -v</span></span><br><span class="line">origin  git@github.com:carlo-z/rocketmq.git (fetch)</span><br><span class="line">origin  git@github.com:carlo-z/rocketmq.git (push)</span><br><span class="line">upstream        https://github.com/apache/rocketmq.git (fetch)</span><br><span class="line">upstream        https://github.com/apache/rocketmq.git (push)</span><br></pre></td></tr></table></figure>

<p>再用<code>git remote -v</code>可以看到 已经与官方仓库建立了连接</p>
<h1 id="4、创建新分支用于修改"><a href="#4、创建新分支用于修改" class="headerlink" title="4、创建新分支用于修改"></a>4、创建新分支用于修改</h1><p>接着上面的运行命令：<code>git checkout -b rocketmq-read</code>，这个命令的意思是创建一个叫 rocketmq-read 的分支，运行这个命令后bash将自动切换到新的分支下</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> git checkout -b rocketmq-read</span></span><br><span class="line">Switched to a new branch 'rocketmq-read'</span><br></pre></td></tr></table></figure>

<h3 id="修改代码"><a href="#修改代码" class="headerlink" title="修改代码"></a>修改代码</h3><h3 id="提交"><a href="#提交" class="headerlink" title="提交"></a>提交</h3><h1 id="5、提交pr"><a href="#5、提交pr" class="headerlink" title="5、提交pr"></a>5、提交pr</h1><p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20200113233008.png" alt></p>
<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20200113233121.png" alt></p>
<p>然后点<code>Create pull request</code></p>
<p>写好名字，写好说明，提交，就OK啦。</p>
<h1 id="6、后期同步代码"><a href="#6、后期同步代码" class="headerlink" title="6、后期同步代码"></a>6、后期同步代码</h1><p>所以每次提交pr前，都要先从做代码同步。过程如下：</p>
<p>先fetch</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> git fetch upstream</span></span><br></pre></td></tr></table></figure>

<p>再 rebase</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> git rebase upstream/master</span></span><br></pre></td></tr></table></figure>

<p>再 push master</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> git push origin master</span></span><br></pre></td></tr></table></figure>

<p>push完后，远程仓库便可看到你的branch版本和master分支一致了，否则这个位置会显示与master相差了多少次commit。</p>
<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20200113233631.png" alt></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://carlo-z.com/devops/istio/service-mesh-init/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Focus-1">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Focus-1">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/devops/istio/service-mesh-init/" itemprop="url">Service Mesh 初体验</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-01-02T00:00:00+08:00">
                2020-01-02
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/service-mesh/" itemprop="url" rel="index">
                    <span itemprop="name">service-mesh</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <br>

<blockquote>
<p>来源：<a href="https://developer.aliyun.com/article/723524" target="_blank" rel="noopener">https://developer.aliyun.com/article/723524</a></p>
</blockquote>
<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>计算机软件技术发展到现在，软件架构的演进无不朝着让开发者能够更加轻松快捷地构建大型复杂应用的方向发展。容器技术最初是为了解决运行环境的不一致问题而产生的，随着不断地发展，围绕容器技术衍生出来越来越多的新方向。</p>
<p>最近几年，云计算领域不断地出现很多新的软件架构模式，其中有一些很热门的概念名词如：云原生、函数计算、Serverless、ServiceMesh等等，而本文将初窥一下ServiceMesh的面纱。下面结合自己的理解尽量以通俗的话进行叙述。</p>
<h1 id="背景和定义"><a href="#背景和定义" class="headerlink" title="背景和定义"></a>背景和定义</h1><h2 id="微服务及服务治理"><a href="#微服务及服务治理" class="headerlink" title="微服务及服务治理"></a>微服务及服务治理</h2><p>在微服务之前的软件开发中，往往通过一个应用的方式将所有的模块都包括进去，并一起编译、打包、部署、运维。这种方式存在很多问题，由于单个应用包含的东西太多，其中某个模块出现问题或者需要更新那么整个应用就需要重新部署。这种方式给开发和运维带来了很大的麻烦。随着应用的逐渐复杂，单个应用涉及的东西就会越来越多，慢慢地大家发现了其中很多的缺点，开始对服务进行划分，将一个大的应用按照不同的维度进行划分从而产生很多个小的应用，各应用之间会形成一个调用关系，每个小的应用由不同的开发负责，大家各自部署和运维，这样微服务就出现了。</p>
<p>由于微服务中各应用部署在不同的机器上，服务之间需要进行通信和协调，相比单个应用来说会麻烦很多。在同一个应用内不同方法之间的调用由于在相同的内存中，在代码编译打包时已经进行了链接，因此调用是可寻址且快速的。微服务下不同服务之间的调用涉及到不同进程或者机器之间的通信，一般需要通过第三方中间件的方式作为中介和协调，由于种种这些，面向微服务出现了很多中间件包括服务治理的框架。通过服务治理工具可以管理其接入的所有应用，使得服务之间的通信和协调更加简单高效。</p>
<h2 id="容器及容器编排"><a href="#容器及容器编排" class="headerlink" title="容器及容器编排"></a>容器及容器编排</h2><p>最初容器技术是为了解决应用运行环境不一致的问题而出现的，避免在本地环境或者测试环境能够跑通，等发到生产环境却出现问题。通过容器将程序及其依赖一起打包到镜像中去，将程序的镜像在任何安装并运行了容器软件的机器上启动若干的容器，每个容器就是应用运行时的实例，这些实例一般拥有完全相同的运行环境和参数。使得不管在任何机器上应用都可以表现出一样的效果。这给开发、测试、运维带来了极大的便利，不再需要为不同机器上构建相同的运行环境而头大。且镜像可以Push到镜像仓库，这使得应用可以进行很方便的迁移和部署。Docker就是一个应用广泛的容器技术。目前越来越多的应用以微服务的方式并通过容器进行部署，给了软件开发极大的活力。</p>
<p>与微服务和服务治理的关系类似，越来越多的应用通过容器进行部署，使得集群上的容器数量急剧增加，通过人工的管理和运维这些容器已经变得很艰难且低效，为了解决诸多容器及容器之间的关系出现了很多编排工具，容器编排工具能够管理容器的整个生命周期。如Docker官方出的docker-compose和docker swarm，这两个工具能实现批量容器的启动和编排，但功能较为简单，不足以支撑大型的容器集群。Google基于内部大量的容器管理经验，开源出了Kubernetes项目，Kubernetes（K8S）是针对Google集群上每周亿级别的容器而设计的，具有很强大的容器编排能力和丰富的功能。K8S通过定义了很多资源，这些资源以声明式的方式进行创建，可以通过JSON或者YAML文件表示一个资源，K8S支持多种容器，但主流的是Docker容器，K8S提供了容器接入的相关标准，只要容器实现了该标准就可以被K8S所编排。由于K8S的功能较多，不在此一一叙述，有兴趣可以参考官方文档或者ATA上搜索相关文章。</p>
<p>当某个公司的应用已经完全微服务化后，选择以容器的方式部署应用，此时可以在集群上部署K8S，通过K8S提供的能力进行应用容器的管理，运维可以也可以面向K8S进行工作。由于K8S是目前使用最广泛的容器编排工具，因此成为了容器编排的一个标准了，目前集团内部也有自己的容器和容器编排工具。</p>
<p>面向以K8S为代表的容器管理方式衍生出了一些新的技术。</p>
<h2 id="云原生"><a href="#云原生" class="headerlink" title="云原生"></a>云原生</h2><p>最近两年云原生被炒的很火，可以在各处看到很多大佬对云原生的高谈阔论，下面直接抛出CNCF对云原生的定义：</p>
<blockquote>
<p>云原生技术有利于各组织在公有云、私有云和混合云等新型动态环境中，构建和运行可弹性扩展的应用。云原生的代表技术包括容器、服务网格、微服务、不可变基础设施和声明式API。<br>这些技术能够构建容错性好、易于管理和便于观察的松耦合系统。结合可靠的自动化手段，云原生技术使工程师能够轻松地对系统作出频繁和可预测的重大变更。</p>
</blockquote>
<p>在我看来，通过微服务的方式开发应用，以容器进行部署，使用K8S等容器编排工具进行容器集群的管理，使得开发运维都面向K8S，这就是云原生。云原生可以方便的构建应用，并对应用进行完整的监控，以及在应用针对不同流量时能进行快速的扩容和缩容。如下图：</p>
<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/feb43679e45874c02f6e6c22e8bf4441.png" alt="image.png"></p>
<p>云原生主要包括四个部分:</p>
<ul>
<li>微服务</li>
<li>容器</li>
<li>持续集成和交付</li>
<li>DevOps</li>
</ul>
<p>PS：总是觉得云原生这个叫法太抽象了，很难让人通过名字想到这是个啥东西。</p>
<h2 id="ServiceMesh的定义"><a href="#ServiceMesh的定义" class="headerlink" title="ServiceMesh的定义"></a>ServiceMesh的定义</h2><p>前面讲了微服务、容器、容器编排、云原生等，其实就是为了得出什么是ServiceMesh，自己总结了一下：<strong>SeviceMesh是云原生下的微服务治理方案</strong>。</p>
<p>当我们通过微服务的方式将应用以容器的形式部署在K8S上后，服务之间调用和治理其实有新的方案，可以不需要依赖传统的微服务治理框架。ServiceMesh通过对每个应用在其Pod中启动一个Sidecar（边车）实现对应用的透明代理，所有出入应用的流量都先经过该应用的Sidecar，服务之间的调用转变成了Sidecar之间的调用，服务的治理转变成了对Sidecar的治理。在ServiceMesh中Sidecar是透明的，开发无感知的，之前一直觉得奇怪，总觉得一个应用要让别人发现它从而调用它，总得引入一些库然后进行主动的服务注册，不然啥都不做，别人咋知道这个应用的存在，为什么在ServiceMesh中就可以省去这些，做到对开发者完全地透明呢？这个的实现依赖于容器编排工具，通过K8S进行应用的持续集成和交付时，在启动应用Pod后，其实已经通过Yaml文件的形式向K8S注册了自己的服务以及声明了服务之间的关系，ServiceMesh通过和K8S进行通信获取集群上所有的服务信息，通过K8S这个中间者实现了对开发者的透明。如下图所示，是ServiceMesh的一个基本结构，包括数据平面和控制平面。</p>
<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/7c01430ea43e3669a874822631b15048.png" alt="image.png"></p>
<p>这种方式存在很多好处，我们可以发现在这种模式下应用的语言其实不会对整个服务治理过程有什么影响，对于ServiceMesh来说，它只关心Pod或者说是Pod中的容器实例，并不需要在乎容器中应用的实现语言是啥，Sidecar和其负责的容器在同一个Pod中。这样ServiceMesh就可以实现跨语言，这也是目前很多传统的服务治理框架的一大缺点，而且采用传统的服务治理，需要对应用引入大量的依赖，这样就会造成依赖之间的各种冲突，集团通过Pandora对应用的各种依赖进行隔离。再者传统的服务治理门槛较高，需要开发者对整个架构有一定的了解，且发现问题排查较为麻烦。这也造成了开发和运维之间的界限不清，在ServiceMesh中开发只需要交付代码，运维可以基于K8S去维护整个容器集群。</p>
<h1 id="发展现状"><a href="#发展现状" class="headerlink" title="发展现状"></a>发展现状</h1><p>通过目前查阅的资料来看，ServiceMesh一词最早出现在2016年，最近两年被炒的很火，蚂蚁金服已经有了自己的一套完整的ServiceMesh服务框架–SofaMesh，集团很多团队也在进行相应的跟进。</p>
<p>从历史发展的路线来看，程序的开发方式经历了很多的变化，但总的方向是变得越来越简单了，现在我们在集团内进行开发，可以很简单的构建一个支撑较大QPS的服务，这得益于集团的整个技术体系的完整和丰富以及强大的技术积淀。</p>
<p>我们下面来看看应用开发到底经历了啥？</p>
<h2 id="发展历史"><a href="#发展历史" class="headerlink" title="发展历史"></a>发展历史</h2><h3 id="主机直接阶段"><a href="#主机直接阶段" class="headerlink" title="主机直接阶段"></a>主机直接阶段</h3><p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/0dbc3158dffdae8d73a5e8efc031c75c.png" alt="image.png"></p>
<p>如上图，这一阶段应该是最古老的阶段，两台机器通过网线直接连接，一个应用包含了你能想到的所有的功能，包括两台机器的连接管理，这时还没有网络的概念，毕竟只能和通过网线直接连接在一起的机器进行通信。</p>
<h3 id="网络层的出现"><a href="#网络层的出现" class="headerlink" title="网络层的出现"></a>网络层的出现</h3><p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/b5831ce53a0abc03f438ef4a8085b28b.png" alt="image.png"></p>
<p>如上图，随着技术的发展，网络层出现了，机器可以和通过网络连接的其他所有机器进行通信，不再限制于必须要网线直连两台机器。</p>
<h3 id="集成到应用程序内部的流量控制"><a href="#集成到应用程序内部的流量控制" class="headerlink" title="集成到应用程序内部的流量控制"></a>集成到应用程序内部的流量控制</h3><p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/2ef0e49eaff46aa8847014ce1a33d0fe.png" alt="image.png"></p>
<p>如上图，由于每个应用所在环境和机器配置不一样，接受流量的能力也不相同，当A应用发送的流量大于了B应用的接受能力时，那么无法接收的数据包必定会被丢弃，这时就需要对流量进行控制，最开始流量的控制需要应用自己去实现，网络层只负责接收应用下发的数据包并进行传输。</p>
<h3 id="流量控制转移到网络层"><a href="#流量控制转移到网络层" class="headerlink" title="流量控制转移到网络层"></a>流量控制转移到网络层</h3><p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/ead7fcc503e4e6c2e10d4160c5be0858.png" alt="image.png"></p>
<p>如上图，慢慢地大家发应用中的网络流量控制是可以转移到网络层的，所以网络层中的流量控制出现了，我想大概就是指TCP的流量控制吧，这样还能保证可靠的网络通信。</p>
<h3 id="应用程序的中集成服务发现和断路器"><a href="#应用程序的中集成服务发现和断路器" class="headerlink" title="应用程序的中集成服务发现和断路器"></a>应用程序的中集成服务发现和断路器</h3><p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/c68b6f2f5093077d196c8c9b83e034ff.png" alt="image.png"></p>
<p>如上图，开发者通过在自己的代码模块中实现服务发现和断路器。</p>
<h3 id="专门用于服务发现和断路器的软件包-库"><a href="#专门用于服务发现和断路器的软件包-库" class="headerlink" title="专门用于服务发现和断路器的软件包/库"></a>专门用于服务发现和断路器的软件包/库</h3><p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/11222886203b348637235ce5abf95325.png" alt="image.png"></p>
<p>如上图，开发者通过引用第三方依赖去实现服务发现和断路器。</p>
<h3 id="出现了专门用于服务发现和断路器的开源软件"><a href="#出现了专门用于服务发现和断路器的开源软件" class="headerlink" title="出现了专门用于服务发现和断路器的开源软件"></a>出现了专门用于服务发现和断路器的开源软件</h3><p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/bc9d938db0b4949eb127838956f9bc8d.png" alt="image.png"></p>
<p>如上图，基于各种中间件去实现服务发现和断路器。</p>
<h3 id="ServiceMesh出现"><a href="#ServiceMesh出现" class="headerlink" title="ServiceMesh出现"></a>ServiceMesh出现</h3><p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/647e656d33fef1410d8f816e1d349c67.png" alt="image.png"></p>
<p>最终到了现在，ServiceMesh大法诞生，进一步解放了生产力，提高了软件整个生命周期的效率。</p>
<h2 id="ServiceMesh市场竞争"><a href="#ServiceMesh市场竞争" class="headerlink" title="ServiceMesh市场竞争"></a>ServiceMesh市场竞争</h2><blockquote>
<p>虽然直到2017年底，ServiceMesh才开始较大规模被世人了解，这场微服务市场之争也才显现，但是其实ServiceMesh这股微服务的新势力，早在 2016年初就开始萌芽：</p>
<p>2016年1月，离开Twitter的基础设施工程师William Morgan和Oliver Gould，在github上发布了Linkerd 0.0.7版本，业界第一个ServiceMesh项目就此诞生。Linkerd基于Twitter的Finagle开源项目，大量重用了Finagle的类库，但是实现了通用性，成为了业界第一个ServiceMesh项目。而Envoy是第二个ServiceMesh项目，两者的开发时间差不多，在2017年都相继成为CNCF项目。2017年5月24日，Istio 0.1 release版本发布，Google和IBM高调宣讲，社区反响热烈，很多公司在这时就纷纷站队表示支持Istio。Linkerd的风光瞬间被盖过，从意气风发的少年一夜之间变成过气网红。当然，从产品成熟度上来说，linkerd作为业界仅有的两个生产级ServiceMesh实现之一，暂时还可以在Istio成熟前继续保持市场。但是，随着Istio的稳步推进和日益成熟，外加第二代ServiceMesh的天然优势，Istio取代第一代的Linkerd只是个时间问题。自从在2016年决定委身于Istio之后，Envoy就开始了一条波澜不惊的平稳发展之路，和Linkerd的跌宕起伏完全不同。在功能方面，由于定位在数据平面，因此Envoy无需考虑太多，很多工作在Istio的控制平面完成就好，Envoy从此专心于将数据平面做好，完善各种细节。在市场方面，Envoy和Linkerd性质不同，不存在生存和发展的战略选择，也没有正面对抗生死大敌的巨大压力。</p>
<p>从Google和IBM联手决定推出Istio开始，Istio就注定永远处于风头浪尖，无论成败，Istio面世之后，赞誉不断，尤其是ServiceMesh技术的爱好者，可以说是为之一振：以新一代ServiceMesh之名横空出世的Istio，对比Linkerd，优势明显。同时产品路线图上有一大堆令人眼花缭乱的功能。假以时日，如果Istio能顺利地完成开发，稳定可靠，那么这会是一个非常美好、值得憧憬的大事件，</p>
</blockquote>
<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/634554bf1f3647071057357a4d577cc9.png" alt="image.png"></p>
<h1 id="Istio介绍"><a href="#Istio介绍" class="headerlink" title="Istio介绍"></a>Istio介绍</h1><p>Istio是目前最热的ServiceMesh开源项目，Istio主要分为两个部分：数据平面和控制平面。Istio实现了云原生下的微服务治理，能实现服务发现，流量控制，监控安全等。Istio通过在一个Pod里启动一个应用和Sidecar方式实现透明代理。Istio是一个拓展性较高的框架，其不仅可以支持K8S，还可以支持其他如Mesos等资源调度器。如下图所示，为Istio的整体架构：</p>
<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/801a66c5ed3e49f6eac068a20bc22ebe.png" alt="image.png"></p>
<ul>
<li>逻辑上分为数据平面（上图中的上半部分）和控制平面（上图中的下半部分）。</li>
<li>数据平面由一组以 Sidecar 方式部署的智能代理（Envoy）组成。这些代理可以调节和控制微服务及 Mixer 之间所有的网络通信。</li>
<li>控制平面负责管理和配置代理来路由流量。此外控制平面配置 Mixer 以实施策略和收集遥测数据。</li>
<li>Pilot是整个架构中的抽象层，将对接K8S等资源调度器的步骤进行抽象并以适配器的形式展现，并和用户以及Sidecar交互。</li>
<li>Galley负责资源配置为验证。</li>
<li>Citadel用于生成身份，及密钥和证书管理</li>
<li>核心功能包括流量控制、安全控制、可观测性、多平台支持、可定制化。</li>
</ul>
<h2 id="Mixer"><a href="#Mixer" class="headerlink" title="Mixer"></a>Mixer</h2><p>Mixer同样是一个可拓展的模块，其负责遥感数据的采集以及集成了一些后端服务（BAAS），Sidecar会不断向Mixer报告自己的流量情况，Mixer对流量情况进行汇总，以可视化的形式展现，此外Sidecar可以调用Mixer提供的一些后端服务能力，例如鉴权、登录、日志等等，Mixer通过适配器的方式对接各种后端服务。</p>
<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/403cc8c2367ca7efa446d002ffc3f34f.png" alt="image.png"></p>
<h4 id="In-process-Adapter形式"><a href="#In-process-Adapter形式" class="headerlink" title="In-process Adapter形式"></a>In-process Adapter形式</h4><p>之前版本的Isito采用这种将后端服务适配器集成在Mixer内部的形式，这种方式会有一个问题，就是某个后端服务适配器出现问题即会影响整个Mixer模块，但由于适配器和Mixer集成在一起，在同一个进程内，方法的调用会很快。</p>
<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/d0e35169905977c5aaac8572d2e78f0f.png" alt="image.png"></p>
<h4 id="Out-of-process-Adapter形式"><a href="#Out-of-process-Adapter形式" class="headerlink" title="Out-of-process Adapter形式"></a>Out-of-process Adapter形式</h4><p>目前版本的Istio将Adapter移到Mixer外部，这样可以实现Mixer与Adapter的解耦，当Adapter出现问题并不会影响Mixer，但这种方式同样也存在问题，即Adapter在Mixer外，是两个不同的进程，二者之间的调用是通过RPC的方式，这种方式比同进程内部的方法调用会慢很多，因此性能会受到影响。</p>
<h2 id="Pilot"><a href="#Pilot" class="headerlink" title="Pilot"></a>Pilot</h2><p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/3c0ea5bcdd7d095c8fb9534bdb222731.png" alt="image.png"></p>
<ul>
<li>Envoy API负责和Envoy的通讯, 主要是发送服务发现信息和流量控制规则给Envoy。</li>
<li>Abstract Model 是 Pilot 定义的服务的抽象模型, 以从特定平台细节中解耦, 为跨平台提供基础。</li>
<li>Platform Adapter则是这个抽象模型的实现版本, 用于对接外部的不同平台如k8s/mesos等。</li>
<li>Rules API提供接口给外部调用以管理 Pilot, 包括命令行工具Istioctl以及未来可能出现的第三方管理界面。</li>
</ul>
<h2 id="Galley"><a href="#Galley" class="headerlink" title="Galley"></a>Galley</h2><p>Galley 原来仅负责进行配置验证, 1.1 后升级为整个控制面的配置管理中心, 除了继续提供配置验证功能外, Galley还负责配置的管理和分发, Galley 使用 网格配置协议(Mesh Configuration Protocol) 和其他组件进行配置的交互.</p>
<p>Istio 创造了50多个CRD, 其复杂度可见一斑, 所以有人说面向k8s编程近似于面向yaml编程.早期的Galley 仅仅负责对配置进行运行时验证, Istio 控制面各个组件各自去list/watch 各自关注的配置。越来越多且复杂的配置给Istio用户带来了诸多不便, 主要体现在:</p>
<ul>
<li>配置的缺乏统一管理, 组件各自订阅, 缺乏统一回滚机制, 配置问题难以定位。</li>
<li>配置可复用度低, 比如在1.1之前, 每个Mixer adpater 就需要定义个新的CRD。</li>
<li>配置的隔离, ACL 控制, 一致性, 抽象程度, 序列化等等问题都还不太令人满意</li>
</ul>
<p>随着Istio功能的演进, 可预见的Istio CRD数量还会继续增加, 社区计划将Galley 强化为Istio配置控制层, Galley 除了继续提供配置验证功能外, 还将提供配置管理流水线, 包括输入, 转换, 分发, 以及适合Istio控制面的配置分发协议(MCP)。</p>
<h2 id="Citadel"><a href="#Citadel" class="headerlink" title="Citadel"></a>Citadel</h2><p>将服务拆分为微服务之后，在带来各种好处的同时，在安全方面也带来了比单体时代更多的需求，毕竟不同功能模块之间的调用方式从原来单体架构中的方法调用变成了微服务之间的远程调用：</p>
<ul>
<li>加密：为了不泄露信息，为了抵御中间人攻击，需要对服务间通讯进行加密。</li>
<li>访问控制：不是每个服务都容许被任意访问，因此需要提供灵活的访问控制，如双向 TLS 和细粒度的访问策略。</li>
<li>审计：如果需要审核系统中哪些用户做了什么，则需要提供审计功能。</li>
</ul>
<p><strong>Citadel 是 Istio 中负责安全性的组件，但是 Citadel 需要和其他多个组件配合才能完成工作：</strong></p>
<ul>
<li>Citadel：用于密钥管理和证书管理，下发到Envoy等负责通讯转发的组件。</li>
<li>Envoy：使用从Citadel下发而来的密钥和证书，实现服务间通讯的安全，注意在应用和Envoy之间是走Localhost，通常不用加密。</li>
<li>Pilot：将授权策略和安全命名信息分发给Envoy。</li>
<li>Mixer：负责管理授权，完成审计等。</li>
</ul>
<p><strong>Istio支持的安全类功能有：</strong></p>
<ul>
<li>流量加密：加密服务间的通讯流量。</li>
<li>身份认证：通过内置身份和凭证管理可以提供强大的服务间和最终用户身份验证，包括传输身份认证和来源身份认证，支持双向TLS。</li>
<li>授权和鉴权：提供基于角色的访问控制（RBAC），提供命名空间级别，服务级别和方法级别的访问控制。</li>
</ul>
<p><strong>作者信息：</strong>彭家浩，花名毅忻，阿里巴巴淘系技术部开发工程师，热爱云计算。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://carlo-z.com/devops/sonar/sonarqube-server-setup/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Focus-1">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Focus-1">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/devops/sonar/sonarqube-server-setup/" itemprop="url">sonarqube-8.3 安装</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-12-25T00:00:00+08:00">
                2019-12-25
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/devops/" itemprop="url" rel="index">
                    <span itemprop="name">devops</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <br>



<p>版本要求</p>
<p><a href="https://docs.sonarqube.org/latest/requirements/requirements/" target="_blank" rel="noopener">https://docs.sonarqube.org/latest/requirements/requirements/</a></p>
<h1 id="安装PostgreSQL"><a href="#安装PostgreSQL" class="headerlink" title="安装PostgreSQL"></a>安装PostgreSQL</h1><p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20200512153042.png" alt></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">docker pull postgres</span><br><span class="line">docker run --name postgres -e POSTGRES_USER=sonar -e POSTGRES_PASSWORD=sonar -p 5432:5432 -d postgres</span><br><span class="line">firewall-cmd --permanent --add-port=5432/tcp</span><br><span class="line">firewall-cmd --reload</span><br><span class="line">firewall-cmd --list-all</span><br><span class="line">docker exec -it postgres /bin/bash</span><br></pre></td></tr></table></figure>

<p>修改host</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/hosts</span><br><span class="line">10.1.171.41  dev.mypostgres.com</span><br><span class="line"></span><br><span class="line">C:\Windows\System32\drivers\etc\</span><br><span class="line">hosts</span><br><span class="line">10.1.171.41  dev.mypostgres.com</span><br></pre></td></tr></table></figure>

<p>通过Navicat for Postgres连接</p>
<blockquote>
<p>dev.mypostgres.com</p>
<p>5432</p>
<p>sonar/sonar</p>
</blockquote>
<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20200512171820.png" alt></p>
<br>

<h1 id="安装jdk11"><a href="#安装jdk11" class="headerlink" title="安装jdk11"></a>安装jdk11</h1><p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20200512152854.png" alt></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> vi /etc/profile</span></span><br><span class="line">export JAVA_HOME=/data/components/jdk-11.0.7</span><br><span class="line">export PATH=$JAVA_HOME/bin:$PATH</span><br><span class="line">export CLASSPATH=.:$JAVA_HOME/lib/dt.jar:$JAVA_HOME/lib/tools.jar</span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">source</span> /etc/profile</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> java -version</span></span><br><span class="line">java version "11.0.7" 2020-04-14 LTS</span><br><span class="line">Java(TM) SE Runtime Environment 18.9 (build 11.0.7+8-LTS)</span><br><span class="line">Java HotSpot(TM) 64-Bit Server VM 18.9 (build 11.0.7+8-LTS, mixed mode)</span><br></pre></td></tr></table></figure>

<br>

<h1 id="SonarQube安装配置"><a href="#SonarQube安装配置" class="headerlink" title="SonarQube安装配置"></a>SonarQube安装配置</h1><h3 id="使用zip安装"><a href="#使用zip安装" class="headerlink" title="使用zip安装"></a>使用zip安装</h3><p>下载zip文件（<a href="http://www.sonarqube.org/downloads/）" target="_blank" rel="noopener">http://www.sonarqube.org/downloads/）</a></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">unzip sonarqube-8.3.1.34397.zip</span><br><span class="line">ln -s /data/sonarqube-8.3.1.34397 /data/sonarqube</span><br><span class="line">cd /data/sonarqube</span><br></pre></td></tr></table></figure>

<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20200515152245.png" alt></p>
<br>

<h3 id="设置DB"><a href="#设置DB" class="headerlink" title="设置DB"></a>设置DB</h3><p>在pg中建立数据库</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">create database sonar;</span><br><span class="line">create user sonar;</span><br><span class="line">atler user sonar with password 'sonar';</span><br><span class="line">alter role sonar createdb;alter role sonar superuser;alter role sonar createrole;</span><br><span class="line">alter database sonar owner to sonar</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">vi /data/sonarqube/conf/sonar.properties</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> DATABASE</span></span><br><span class="line">sonar.jdbc.username=sonar</span><br><span class="line">sonar.jdbc.password=sonar</span><br><span class="line">sonar.jdbc.url=jdbc:postgresql://dev.mypostgres.com:5432/sonar</span><br><span class="line"></span><br><span class="line">sonar.jdbc.maxActive=60</span><br><span class="line">sonar.jdbc.maxIdle=5</span><br><span class="line">sonar.jdbc.minIdle=2</span><br><span class="line">sonar.jdbc.maxWait=5000</span><br><span class="line">sonar.jdbc.minEvictableIdleTimeMillis=600000</span><br><span class="line">sonar.jdbc.timeBetweenEvictionRunsMillis=30000</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> sonar.sorceEncoding=UTF-8</span></span><br></pre></td></tr></table></figure>

<br>

<h3 id="添加JDBC驱动程序"><a href="#添加JDBC驱动程序" class="headerlink" title="添加JDBC驱动程序"></a>添加JDBC驱动程序</h3><p>已经提供了支持的数据库（Oracle除外）的驱动程序。不要更换提供的驱动程序；他们是唯一受支持的。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">/data/sonarqube/lib/jdbc</span><br><span class="line">(base) [root@dev-10-1-171-41 jdbc]# ll</span><br><span class="line">total 12</span><br><span class="line">drwxr-xr-x 2 root root 4096 May  7 13:41 h2</span><br><span class="line">drwxr-xr-x 2 root root 4096 May  7 13:41 mssql</span><br><span class="line">drwxr-xr-x 2 root root 4096 May  7 13:41 postgresql</span><br></pre></td></tr></table></figure>

<p>oracle 数据库需要单独添加驱动，其他数据库已经默认提供</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">/data/sonarqube/extensions/jdbc-driver</span><br><span class="line">(base) [root@dev-10-1-171-41 jdbc-driver]# ll</span><br><span class="line">total 4</span><br><span class="line">drwxr-xr-x 2 root root 4096 May  7 13:22 oracle</span><br></pre></td></tr></table></figure>

<br>

<h3 id="配置Elasticsearch存储路径"><a href="#配置Elasticsearch存储路径" class="headerlink" title="配置Elasticsearch存储路径"></a>配置Elasticsearch存储路径</h3><p>默认情况下，Elasticsearch数据存储在<em>$ SONARQUBE-HOME / data中</em>，但不建议将其用于生产实例。相反，您应该将此数据存储在其他位置，最好是在具有快速I / O的专用卷中。除了保持可接受的性能外，这样做还可以简化SonarQube的升级。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">vi /data/sonarqube/conf/sonar.properties</span><br><span class="line"><span class="meta">#</span><span class="bash">sonar.path.data=/var/sonarqube/data</span></span><br><span class="line"><span class="meta">#</span><span class="bash">sonar.path.temp=/var/sonarqube/temp</span></span><br></pre></td></tr></table></figure>

<br>

<h3 id="特别配置jdk路径"><a href="#特别配置jdk路径" class="headerlink" title="特别配置jdk路径"></a>特别配置jdk路径</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">vi /data/sonarqube/conf/wrapper.conf</span><br><span class="line">wrapper.java.command=/data/components/jdk-11.0.7/bin/java</span><br></pre></td></tr></table></figure>

<br>

<h3 id="linux系统参数优化"><a href="#linux系统参数优化" class="headerlink" title="linux系统参数优化"></a>linux系统参数优化</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/sysctl.d/99-sonarqube.conf（或/etc/sysctl.conf文件）</span><br><span class="line">vm.max_map_count=262144</span><br><span class="line">fs.file-max=65536</span><br><span class="line"></span><br><span class="line">sysctl -w vm.max_map_count=262144</span><br><span class="line">sysctl -w fs.file-max=65536</span><br><span class="line">ulimit -n 65536</span><br><span class="line"></span><br><span class="line">sysctl vm.max_map_count </span><br><span class="line">sysctl fs.file-max </span><br><span class="line">ulimit -n</span><br></pre></td></tr></table></figure>

<br>

<h3 id="启动Web服务器"><a href="#启动Web服务器" class="headerlink" title="启动Web服务器"></a>启动Web服务器</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">vi /data/sonarqube/conf/sonar.properties</span><br><span class="line">sonar.web.host=0.0.0.0</span><br><span class="line">sonar.web.port=9011</span><br><span class="line">sonar.web.context=</span><br><span class="line"></span><br><span class="line">firewall-cmd --permanent --add-port=9011/tcp</span><br><span class="line">firewall-cmd --reload</span><br><span class="line">firewall-cmd --list-all</span><br></pre></td></tr></table></figure>

<p>sonar不能使用root启动</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">useradd sonar</span><br><span class="line">passwd sonar</span><br><span class="line">chown -R sonar:sonar /data/sonarqube/</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">su - sonar</span><br><span class="line">/data/sonarqube/bin/linux-x86-64/sonar.sh start</span><br><span class="line">/data/sonarqube/bin/linux-x86-64/sonar.sh restart</span><br><span class="line"></span><br><span class="line">jps -l</span><br></pre></td></tr></table></figure>

<p>设置域名</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/hosts</span><br><span class="line">10.1.171.41  dev.mysonar.com</span><br><span class="line">echo '10.1.171.41  dev.mysonar.com' &gt;&gt; /etc/hosts</span><br><span class="line"></span><br><span class="line">C:\Windows\System32\drivers\etc\</span><br><span class="line">hosts</span><br><span class="line">10.1.171.41  dev.mysonar.com</span><br></pre></td></tr></table></figure>

<p>访问：</p>
<p><a href="http://dev.mysonar.com:9011/" target="_blank" rel="noopener">http://dev.mysonar.com:9011/</a></p>
<p>默认账号：admin/admin</p>
<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20200514142721.png" alt></p>
<br>

<h3 id="安装中文插件"><a href="#安装中文插件" class="headerlink" title="安装中文插件"></a>安装中文插件</h3><p>install -&gt; restart</p>
<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20200514150054.png" alt></p>
<br>

<h3 id="使用systemd管理启动"><a href="#使用systemd管理启动" class="headerlink" title="使用systemd管理启动"></a>使用systemd管理启动</h3><br>

<h1 id="SonarScanner安装配置"><a href="#SonarScanner安装配置" class="headerlink" title="SonarScanner安装配置"></a>SonarScanner安装配置</h1><blockquote>
<p>文档：<a href="https://docs.sonarqube.org/latest/analysis/scan/sonarscanner/" target="_blank" rel="noopener">https://docs.sonarqube.org/latest/analysis/scan/sonarscanner/</a></p>
</blockquote>
<h3 id="下载zip包安装"><a href="#下载zip包安装" class="headerlink" title="下载zip包安装"></a>下载zip包安装</h3><p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20200514150509.png" alt></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> unzip sonar-scanner-cli-4.3.0.2102-linux.zip</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ln -s /data/downloads/sonar-scanner-4.3.0.2102-linux /data/sonar-scanner</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ln -s /data/sonar-scanner/bin/sonar-scanner /usr/bin/sonar-scanner</span></span><br></pre></td></tr></table></figure>

<br>

<h3 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> vi /data/sonar-scanner/conf/sonar-scanner.properties</span></span><br><span class="line">sonar.host.url=http://dev.mysonar.com:9011</span><br><span class="line">sonar.sourceEncoding=UTF-8</span><br></pre></td></tr></table></figure>

<br>

<h3 id="扫描maven工程示例"><a href="#扫描maven工程示例" class="headerlink" title="扫描maven工程示例"></a>扫描maven工程示例</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">cd</span> /data/components/leancloud-proxy</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> vi sonar-project.properties</span></span><br><span class="line">sonar.projectKey=leancloud-proxy</span><br><span class="line">sonar.projectName=leancloud-proxy</span><br><span class="line">sonar.projectVersion=1.0</span><br><span class="line">sonar.sources=./</span><br><span class="line">sonar.language=java</span><br><span class="line">sonar.sources=src</span><br><span class="line">sonar.java.binaries=target</span><br><span class="line">sonar.sourceEncoding=UTF-8</span><br><span class="line">sonar.dynamicAnalysis=false</span><br><span class="line">sonar.scm.disabled=true</span><br><span class="line">sonar.scm.provider=svn</span><br><span class="line">sonar.host.url=http://dev.mysonar.com:9011</span><br></pre></td></tr></table></figure>

<p>执行扫描</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> sonar-scanner</span></span><br></pre></td></tr></table></figure>

<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20200514175808.png" alt></p>
<p><a href="http://dev.mysonar.com:9011/projects" target="_blank" rel="noopener">http://dev.mysonar.com:9011/projects</a></p>
<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20200514191037.png" alt></p>
<br>

<h3 id="扫描php工程示例"><a href="#扫描php工程示例" class="headerlink" title="扫描php工程示例"></a>扫描php工程示例</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">cd</span> /data/public_html</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> vi sonar-project.properties</span></span><br><span class="line">sonar.projectKey=php-trunk</span><br><span class="line">sonar.projectName=php-trunk</span><br><span class="line">sonar.projectVersion=1.0</span><br><span class="line">sonar.sources=./</span><br><span class="line">sonar.language=php</span><br><span class="line">sonar.sourceEncoding=UTF-8</span><br><span class="line">sonar.dynamicAnalysis=false</span><br><span class="line">sonar.scm.disabled=true</span><br><span class="line">sonar.scm.provider=svn</span><br><span class="line">sonar.host.url=http://dev.mysonar.com:9011</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> sonar-scanner</span></span><br></pre></td></tr></table></figure>

<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20200514191525.png" alt></p>
<p><a href="http://dev.mysonar.com:9011/projects" target="_blank" rel="noopener">http://dev.mysonar.com:9011/projects</a></p>
<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20200514190949.png" alt></p>
<br>

<h1 id="jenkins-SonarScanner"><a href="#jenkins-SonarScanner" class="headerlink" title="jenkins + SonarScanner"></a>jenkins + SonarScanner</h1><h3 id="安装SonarQube-Scanner插件"><a href="#安装SonarQube-Scanner插件" class="headerlink" title="安装SonarQube Scanner插件"></a>安装SonarQube Scanner插件</h3><p>Jenkins → 系统管理 → 管理插件 → 可选插件 → 🔍SonarQueue Scanner</p>
<p>安装以后重启</p>
<br>

<h3 id="配置SonarQube"><a href="#配置SonarQube" class="headerlink" title="配置SonarQube"></a>配置SonarQube</h3><p>首先，在SonarQube中生成一个Token（PS：用token代替输入用户名和密码）</p>
<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20200514192610.png" alt></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bb6ad69138f3607af1082565551846a5b23eb310</span><br></pre></td></tr></table></figure>

<p>然后，在Jenkins中配置连接sonarqube服务器的地址，这里用到的token就是刚才在sonarqube中创建的那个token</p>
<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20200514193841.png" alt></p>
<p>系统设置</p>
<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20200514193817.png" alt></p>
<p>最后，配置全局工具配置</p>
<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20200514194221.png" alt></p>
<h3 id="创建任务"><a href="#创建任务" class="headerlink" title="创建任务"></a>创建任务</h3><p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20200514194328.png" alt></p>
<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20200514200516.png" alt></p>
<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20200514200539.png" alt></p>
<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20200514200634.png" alt></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">sonar.projectKey=php-trunk</span><br><span class="line">sonar.projectName=php-trunk</span><br><span class="line">sonar.projectVersion=1.0</span><br><span class="line">sonar.sources=$WORKSPACE</span><br><span class="line">sonar.language=php</span><br><span class="line">sonar.sourceEncoding=UTF-8</span><br><span class="line">sonar.dynamicAnalysis=false</span><br><span class="line">sonar.scm.disabled=true</span><br><span class="line">sonar.scm.provider=svn</span><br><span class="line">sonar.host.url=http://dev.mysonar.com:9011</span><br></pre></td></tr></table></figure>

<h3 id="开始构建任务"><a href="#开始构建任务" class="headerlink" title="开始构建任务"></a>开始构建任务</h3><p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20200514200830.png" alt></p>
<br>

<br>

<br>

<br>

<br>

<br>


          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://carlo-z.com/message-queue/rocketmq/linux-rocketmq-setup/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Focus-1">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Focus-1">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/message-queue/rocketmq/linux-rocketmq-setup/" itemprop="url">centos7 下 rocketmq 单机版安装</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-12-01T00:00:00+08:00">
                2019-12-01
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/rocketmq/" itemprop="url" rel="index">
                    <span itemprop="name">rocketmq</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <hr>
<br>

<blockquote>
<p>文档：<a href="http://rocketmq.apache.org/docs/quick-start/" target="_blank" rel="noopener">http://rocketmq.apache.org/docs/quick-start/</a></p>
</blockquote>
<h1 id="先决条件"><a href="#先决条件" class="headerlink" title="先决条件"></a>先决条件</h1><p>假定已安装以下软件：</p>
<ol>
<li>建议使用64位操作系统，建议使用Linux / Unix / Mac；</li>
<li>64位JDK 1.8+;</li>
<li>Maven 3.2.x;</li>
<li>Git;</li>
<li>适用于Broker服务器的4g +可用磁盘</li>
</ol>
<h1 id="下载安装"><a href="#下载安装" class="headerlink" title="下载安装"></a>下载安装</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7cz ~]# cd /data/download/</span><br><span class="line">[root@centos7cz download]# wget http://mirror.bit.edu.cn/apache/rocketmq/4.6.0/rocketmq-all-4.6.0-bin-release.zip</span><br><span class="line">[root@centos7cz download]# mkdir -p /data/tools/</span><br><span class="line">[root@centos7cz download]# unzip rocketmq-all-4.6.0-bin-release.zip -d /data/tools</span><br><span class="line">[root@centos7cz download]# tar -zxf rocketmq-all-4.6.0.tar.gz  -C /data/tools</span><br><span class="line">[root@centos7cz download]# cd /data/tools/</span><br><span class="line">[root@centos7cz tools]# mv rocketmq-all-4.6.0-bin-release/ rocketmq-all-4.6.0</span><br><span class="line">[root@centos7cz tools]# cd rocketmq-all-4.6.0/</span><br><span class="line">[root@centos7cz rocketmq-all-4.6.0]# ll</span><br><span class="line">total 40</span><br><span class="line">drwxr-xr-x. 2 root root    83 Nov 20 11:04 benchmark</span><br><span class="line">drwxr-xr-x. 3 root root  4096 Aug 19 15:31 bin</span><br><span class="line">drwxr-xr-x. 6 root root   211 Aug  6 16:23 conf</span><br><span class="line">drwxr-xr-x. 2 root root  4096 Nov 20 11:04 lib</span><br><span class="line">-rw-r--r--. 1 root root 17336 Aug  6 16:23 LICENSE</span><br><span class="line">-rw-r--r--. 1 root root  1338 Aug  6 16:23 NOTICE</span><br><span class="line">-rw-r--r--. 1 root root  4225 Nov  1 16:54 README.md</span><br><span class="line">[root@centos7cz rocketmq-all-4.6.0]#</span><br></pre></td></tr></table></figure>

<h1 id="启动和关闭"><a href="#启动和关闭" class="headerlink" title="启动和关闭"></a>启动和关闭</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 安装nohup</span></span><br><span class="line">[root@centos7cz ~]# yum install coreutils -y</span><br><span class="line"></span><br><span class="line">[root@centos7cz ~]# mkdir -p /data/tools/rocketmq-all-4.6.0/logs/</span><br></pre></td></tr></table></figure>

<h3 id="NameSrv"><a href="#NameSrv" class="headerlink" title="NameSrv"></a>NameSrv</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7cz ~]# cd /data/tools/rocketmq-all-4.6.0</span><br><span class="line"></span><br><span class="line">[root@centos7cz rocketmq-all-4.6.0]# nohup sh /data/tools/rocketmq-all-4.6.0/bin/mqnamesrv &gt; /data/tools/rocketmq-all-4.6.0/logs/namesrv.log 2&gt;&amp;1 &amp;</span><br><span class="line"></span><br><span class="line">[root@centos7cz rocketmq-all-4.6.0]# tail -f /data/tools/rocketmq-all-4.6.0/logs/namesrv.log</span><br><span class="line"></span><br><span class="line">[root@centos7cz rocketmq-all-4.6.0]# /data/tools/rocketmq-all-4.6.0/bin/mqshutdown namesrv</span><br></pre></td></tr></table></figure>

<h3 id="Broker"><a href="#Broker" class="headerlink" title="Broker"></a>Broker</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7cz ~]# cd /data/tools/rocketmq-all-4.6.0</span><br><span class="line"></span><br><span class="line">[root@centos7cz rocketmq-all-4.6.0]# nohup sh /data/tools/rocketmq-all-4.6.0/bin/mqbroker &gt; /data/tools/rocketmq-all-4.6.0/logs/broker.log 2&gt;&amp;1 &amp;</span><br><span class="line"></span><br><span class="line">[root@centos7cz rocketmq-all-4.6.0]# tail -f /data/tools/rocketmq-all-4.6.0/logs/broker.log</span><br><span class="line"></span><br><span class="line">[root@centos7cz rocketmq-all-4.6.0]# /data/tools/rocketmq-all-4.6.0/bin/mqshutdown broker</span><br></pre></td></tr></table></figure>

<h1 id="收发消息"><a href="#收发消息" class="headerlink" title="收发消息"></a>收发消息</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7cz ~]# cd /data/tools/rocketmq-all-4.6.0</span><br><span class="line"></span><br><span class="line">[root@centos7cz rocketmq-all-4.6.0]# export NAMESRV_ADDR=localhost:9876</span><br><span class="line"></span><br><span class="line">[root@centos7cz rocketmq-all-4.6.0]# sh bin/tools.sh org.apache.rocketmq.example.quickstart.Producer</span><br><span class="line"></span><br><span class="line">[root@centos7cz rocketmq-all-4.6.0]# sh bin/tools.sh org.apache.rocketmq.example.quickstart.Consumer</span><br></pre></td></tr></table></figure>


          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://carlo-z.com/mysql/mysql-tpc-tpcc-tpmc/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Focus-1">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Focus-1">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/mysql/mysql-tpc-tpcc-tpmc/" itemprop="url">TPC,TPCC,TPMC(数据库性能衡量指标)</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-11-20T00:00:00+08:00">
                2019-11-20
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/mysql/" itemprop="url" rel="index">
                    <span itemprop="name">mysql</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="第一章-什么是TPC和tpmC"><a href="#第一章-什么是TPC和tpmC" class="headerlink" title="第一章 什么是TPC和tpmC?"></a>第一章 什么是TPC和tpmC?</h1><h2 id="1-TPC"><a href="#1-TPC" class="headerlink" title="1 TPC"></a>1 TPC</h2><p>TPC(Transaction Processing Performance Council，事务处理性能委员会)是由数10家会员公司创建的非盈利组织，总部设在美国。该组织对全世界开放，但迄今为止，绝大多数会员都是美、日、西欧的大公司。TPC的成员主要是计算机软硬件厂家，而非计算机用户，它的功 能是制定商务应用基准程序(Benchmark)的标准规范、性能和价格度量，并管理测 试结果的发布。</p>
<p>TPC的出版物是开放的，可以通过网络获取(<a href="http://www.tpc.org/" target="_blank" rel="noopener">http://www.tpc.org</a>)。TPC不给出基准程序的代码，而只给出基准程序的标准规范(Standard Specification)。任何厂家或其它测试者都可以根据规范，最优地构造出自己的系统(测试平台和测试程序)。为保证测试结果的客观性，被测试者(通常是厂家)必须提交给TPC一套完整的报告(Full Disclosure Report)，包括被测系统的详细配置、分类价格和包含五年维护费用在内的总价 格。该报告必须由TPC授权的审核员核实(TPC本身并不做审计)。现在全球只有几个审核员，全部在美国。</p>
<p>TPC已经推出了四套基准程序，被称为TPC－A、TPC－B、TPC－C和TPC－D。其中A和B已经过时，不再使用了。TPC－C是在线事务处理(OLTP)的基准程序，TPC－D是决策支持(Decision Support) 的基准程序。TPC即将推TPC－E，作为大型企业(Enterprise)信息服务的基准程序。</p>
<h2 id="2-tpmC"><a href="#2-tpmC" class="headerlink" title="2 tpmC"></a>2 tpmC</h2><p>tpmC值在国内外被广 泛用于衡量计算机系统的事务处理能力。但究竟什么是tpmC值呢?作者曾向一些 用户、推销人员乃至某些国外大公司的技术人员问过这个问题，但回答的精确度 与tpmC值的流行程度远非相称。tpmC这一度量也常被误写为TPM或TPMC。</p>
<p>TPC-C模拟一个批发商的货物管理环境。该批发公司有N个仓库，每个仓库供应10个地区，其中每个地区为3000名顾客服务。在每个仓库中有10个终端，每一个终端用于一个地区。在运行时，10×N个终端操作员向公司的数据库发出5类请求。由于一个仓库中不可能存储公司所有的货物，有一些请求必须发往其它仓库，因此，数据库在逻辑上是 分布的。N是一个可变参数，测试者可以随意改变N，以获得最佳测试效果。</p>
<p>TPC-C使用三种性能和价格度量，其中性能由TPC-C吞吐率衡量，单位是tpmC。tpm是transactions per minute的简称；C指TPC中的C基准程序。它的定义是每分钟内系统处理的新订单个数。要注意的是，在处理新订单的同时，系统还要按表1的要求处理其它4类事务 请求。从表1可以看出，新订单请求不可能超出全部事务请求的45％，因此，当一个 系统的性能为1000tpmC时，它每分钟实际处理的请求数是2000多个。价格是指系 统的总价格，单位是美元，而价格性能比则定义为总价格÷性能，单位是＄/tpmC。</p>
<p>tpmC定义: TPC-C的吞吐量，按有效TPC-C配置期间每分钟处理的平均交易次数测量，至少要运行12分钟。</p>
<p>（吞吐量测试结果以比特/秒或字节/秒表示。）</p>
<h1 id="第二章-TPCC"><a href="#第二章-TPCC" class="headerlink" title="第二章 TPCC"></a>第二章 TPCC</h1><h2 id="1-基准测试"><a href="#1-基准测试" class="headerlink" title="1 基准测试"></a>1 基准测试</h2><p>TPCC值被广泛用于衡量C/S环境下,由服务器和客户端构筑的整体系统的性能,它由事物处理性能委员会（TPC，Transaction Processing Corp）制定,TPC为非赢利性国际组织。</p>
<p>TPCC值可以反映出系统的性能价格比。TPCC测试系统每分钟处理的任务数,单位为tpm,(transactions per minute)。系统的总体价格(单位为美元)除以TPCC值,就可以衡量出系统的性价比,系统的性价比值越大,系统的性价比越好。</p>
<p>需要注意的是,TPC-C值描述的是C/S整体系统的性能,它与系统的服务器和客户机的性能都有关系,也就是说,同样的服务器配置不同的客户端将会影响TPCC值,任何厂商和测试者都可以根据TPC提供的测试规范构造出自己最优的系统,当然测试的结果要经过TPC审核。</p>
<h2 id="2-性能测试指标介绍"><a href="#2-性能测试指标介绍" class="headerlink" title="2 性能测试指标介绍"></a>2 性能测试指标介绍</h2><p>TPC-C</p>
<p>作为一家非盈利性机构，事务处理性能委员会（TPC）负责定义诸如TPC-C、TPC-H和TPC-W基准测试之类的事务处理与数据库性能基准测试，并依据这些基准测试项目发布客观性能数据。TPC基准测试采用极为严格的运行环境，并且必须在独立审计机构监督下进行。委员会成员包括大多数主要数据库产品厂商以及服务器硬件系统供应商。</p>
<p>相关企业参与TPC基准测试以期在规定运行环境中获得客观性能验证，并通过应用测试过程中所使用的技术开发出更加强健且更具伸缩性的软件产品及硬件设备。</p>
<p>TPC-C是一种旨在衡量联机事务处理（OLTP）系统性能与可伸缩性的行业标准基准测试项目。这种基准测试项目将对包括查询、更新及队列式小批量事务在内的广泛数据库功能进行测试。许多IT专业人员将TPC-C视为衡量“真实”OLTP系统性能的有效指示器。</p>
<p>TPC-C基准测试针对一种模拟订单录入与销售环境测量每分钟商业事务（tpmC）吞吐量。特别值得一提的是，它将专门测量系统在同时执行其它四种事务类型（如支付、订单状态更新、交付及证券级变更）时每分钟所生成的新增订单事务数量。独立审计机构将负责对基准测试结果进行公证，同时，TPC将出据一份全面彻底的测试报告。这份测试报告可以从TPC Web站点(<a href="http://www.tpc.org)上获得。" target="_blank" rel="noopener">http://www.tpc.org)上获得。</a></p>
<h2 id="3-TPC-C规范概要"><a href="#3-TPC-C规范概要" class="headerlink" title="3 TPC-C规范概要"></a>3 TPC-C规范概要</h2><p>TPC-C是专门针对联机交易处理系统（OLTP系统）的，一般情况下我们也把这类系统称为业务处理系统。</p>
<p>TPC-C测试规范中模拟了一个比较复杂并具有代表意义的OLTP应用环境:假设有一个大型商品批发商，它拥有若干个分布在不同区域的商品库；每个仓库负责为10个销售点供货；每个销售点为3000个客户提供服务；每个客户平均一个订单有10项产品;所有订单中约1%的产品在其直接所属的仓库中没有存货，需要由其他区域的仓库来供货。同时，每个仓库都要维护公司销售的100000种商品的库存记录。</p>
<p>该系统需要处理的交易为以下几种：</p>
<p>New-Order：客户输入一笔新的订货交易；</p>
<p>Payment:更新客户账户余额以反映其支付状况;</p>
<p>Delivery:发货(模拟批处理交易);</p>
<p>Order-Status:查询客户最近交易的状态；</p>
<p>Stock-Level:查询仓库库存状况，以便能够及时补货。</p>
<p>对于前四种类型的交易，要求响应时间在5秒以内；对于库存状况查询交易，要求响应时间在20秒以内。</p>
<h2 id="4评测指标"><a href="#4评测指标" class="headerlink" title="4评测指标"></a>4评测指标</h2><p>TPC-C测试规范经过两年的研制，于1992年7月发布。几乎所有在OLTP市场提供软硬件平台的厂商都发布了相应的TPC-C测试结果，随着计算机技术的不断发展，这些测试结果也在不断刷新。</p>
<p>TPC-C的测试结果主要有两个指标：</p>
<h3 id="①流量指标-Throughput，简称tpmC"><a href="#①流量指标-Throughput，简称tpmC" class="headerlink" title="①流量指标(Throughput，简称tpmC)"></a>①流量指标(Throughput，简称tpmC)</h3><p>按照TPC的定义，流量指标描述了系统在执行Payment、Order-status、Delivery、Stock-Level这四种交易的同时，每分钟可以处理多少个New-Order交易。所有交易的响应时间必须满足TPC-C测试规范的要求。</p>
<p>流量指标值越大越好！</p>
<h3 id="②性价比-Price-Performance，简称Price-tpmC"><a href="#②性价比-Price-Performance，简称Price-tpmC" class="headerlink" title="②性价比(Price/Performance，简称Price/tpmC)"></a>②性价比(Price/Performance，简称Price/tpmC)</h3><p>即测试系统价格（指在美国的报价）与流量指标的比值。</p>
<p>性价比越大越好！</p>
<h1 id="第三章（TPCC）如何衡量计算机系统的性能和价格"><a href="#第三章（TPCC）如何衡量计算机系统的性能和价格" class="headerlink" title="第三章（TPCC）如何衡量计算机系统的性能和价格"></a>第三章（TPCC）如何衡量计算机系统的性能和价格</h1><p>在系统选型时，我们一定不要忘记我们是为特定用户环境中的特定应用选择系统。切忌为了“与国际接轨”而盲目套用“国际通用”的东西。在性能评价领域，越是通用的度量常常越是不准确的。据我所知，美国的一些大用户从不相信任何“国际通用”的度量，而是花相当精力，比如预算的5％，使用自己的应用来测试系统，决定选型。在使用任何一种性能和价格度量时，一定要弄明白该度量的定义，以及它是在什么系统配置和运行环境下得到的，如何解释它的意义等。下面我们由好到差讨论三种方式。</p>
<h2 id="1在真实环境中运行-实际应用"><a href="#1在真实环境中运行-实际应用" class="headerlink" title="1在真实环境中运行 实际应用"></a>1在真实环境中运行 实际应用</h2><p>最理想的方式是搞一个试点，要求制造商或系统集成商配合将系统(含平台、软件和操作流程)在一个 实际用户点真正试运行一段时间。这样，用户不仅能看到实际性能，也能观察到系统是否稳定可靠、使用是否方便、服务是否周到、配置是否足够、全部价格是否合理。如果一个部门需要购买一批同类的系统，这种方式应列为首选，因为它不仅最精确、稳妥，也常常最有效率，用户还可先租一套系统作为试点。用这种方式得到的度量值常常具有很明确和实际的含义。</p>
<h2 id="2使用用户定义的基准程序"><a href="#2使用用户定义的基准程序" class="headerlink" title="2使用用户定义的基准程序"></a>2使用用户定义的基准程序</h2><p>如果由于某种原因第一种方式不可行，用户可以定义一组含有自己实际应用环境特征的应用基准程序。 我举两个例子：近年来，由于R/3软件是应用层软件，SAP公司的基准程序获得了越来越多国外企业的认可；中国税务总局最近也开发了自己的基准程序，以帮助税务系统进行计算机选型。这种方式在中国尤其重要，因为中国的信息系统有其特殊性。</p>
<h2 id="3使用通用基准程序"><a href="#3使用通用基准程序" class="headerlink" title="3使用通用基准程序"></a>3使用通用基准程序</h2><p>如果第1种和第2种方式都不行，则使用如TPC-C之类的通用基准程序，这是不得已的一种近似方法。因 此，tpmC值只能用作参考。我们应当注意以下几点：</p>
<h3 id="①实际应用是否与基准程序相符"><a href="#①实际应用是否与基准程序相符" class="headerlink" title="①实际应用是否与基准程序相符"></a>①实际应用是否与基准程序相符</h3><p>绝大多数基准程序都是在美国制订的，而中国的企事业单位与美国的运作方式常常不一样(恐怕也不应该或不可能一样)。在使用TPC－C时，我们应该清楚地知道：我的应用是否符合批发商模式?事务请求是否与表1近似?对响应时间的要求是否满足表1?如果都不是，则tpmC值的参考价值就不太大了。</p>
<h3 id="②TPC度量的解释"><a href="#②TPC度量的解释" class="headerlink" title="②TPC度量的解释"></a>②TPC度量的解释</h3><p>TPC基准程序是用来测系统而不是测主机的，厂家肯定要充分优化他们的被测系统。此处的“系统”包括主机、外设(如硬盘或RAID)、主机端操作系统、数据库软件、客户端计算机及其 操作系统、数据库软件和网络连接等。在很多厂家的TPC测试系统中，主机的价格只是系统总价格的1/4或更小，而硬盘的价格有可能占到总价格的1/3以上，因为TPC－C要求被测系统必须保存180天的事务记录。如果同样的主机被用到用户的环境中，厂家报的tpmC值就意义不大，因为用户的实际系统与厂家原来用于TPC测试的系统大不一样。当同样的主机用在不同的系统中时，tpmC值可能有相当大的变化，现在很多用户还没有意识到这一点。</p>
<p>我举一个例子。假设用 户希望购买一批同类系统，每一系统至少需要1GB的内存和50GB的硬盘。厂家A、B、C 各报了三个价格相当的系统，tpmC值分别为3000、2800、2600。用户是否应该选厂家A的产品呢?答案是：不一定。厂家用于测试tpmC值的系统与实际提供给用户的系统配置大不一样。tpmC最低的厂家C提供给用户的系统反而有可能性能最好，不 论是以实际系统的tpmC值还是以用户的实际应用性能来衡量。</p>
<h3 id="③TPC测试的成本"><a href="#③TPC测试的成本" class="headerlink" title="③TPC测试的成本"></a>③TPC测试的成本</h3><p>TPC－C和TPC－D都是很复杂的基准程序，做一个严格的测试是很消耗资源的，厂家当然不会说出他们花费了多少钱和时间。但据国外知情人士透露，一个厂家做第一个TPC－C测试需 要几十万到上百万美元的资金和半年左右的时间投入。因此，很多TPC的度量值都 是估计的。由于计算机系统换代频繁，如果用户一定要用通过审核的度量值，就必 须多等待半年时间，因此而不能用最先进的系统。中国的厂家通过审核的时间则更长。</p>
<p>综上所述，我们对中国 用户(尤其是大用户)在计算机系统的选型方面有如下建议：</p>
<p>最好建立一个真实的试点，因为实际应用环境是检验计算机系统的最好标准。</p>
<p>中国的行业应该建立符合自己实际应用的基准程序和测试标准。中国税务总局的做法值得提倡。国家有关部门应该建立独立的测试中心，制定跨行业、符合中国企事业运作模式的性能测试标准。</p>
<p>“国际通用”的度量可以作为参考值，而不应作为必要条件。尤其是一定要弄清这些流行度量有什么含义，是在什么样的系统环境中测得的，以及基准程序是否符合企业真实的业务流程和运作模式。</p>
<p>作为一家非盈利性机构，事务处理性能委员会（TPC）负责定义诸如TPC-C、TPC-H和TPC-W基准测试之类的事务处理与数据库性能基准测试，并依据这些基准测试项目发布客观性能数据。TPC基准测试采用极为严格的运行环境，并且必须在独立审计机构监督下进行。委员会成员包括大多数主要数据库产品厂商以及服务器硬件系统供应商。</p>
<p>相关企业参与TPC基准测试以期在规定运行环境中获得客观性能验证，并通过应用测试过程中所使用的技术开发出更加强健且更具伸缩性的软件产品及硬件设备。</p>
<p>TPC-C是一种旨在衡量联机事务处理（OLTP）系统性能与可伸缩性的行业标准基准测试项目。这种基准测试项目将对包括查询、更新及队列式小批量事务在内的广泛数据库功能进行测试。许多IT专业人员将TPC-C视为衡量“真实”OLTP系统性能的有效指示器。</p>
<p>TPC-C基准测试针对一种模拟订单录入与销售环境测量每分钟商业事务（tpmC）吞吐量。特别值得一提的是，它将专门测量系统在同时执行其它四种事务类型（如支付、订单状态更新、交付及证券级变更）时每分钟所生成的新增订单事务数量。独立审计机构将负责对基准测试结果进行公证，同时，TPC将出据一份全面彻底的测试报告。这份测试报告可以从TPC Web站点(<a href="http://www.tpc.org/" target="_blank" rel="noopener">http://www.tpc.org</a>)上获得。</p>
<h1 id="第四章-TPCC计算原则"><a href="#第四章-TPCC计算原则" class="headerlink" title="第四章 TPCC计算原则"></a>第四章 TPCC计算原则</h1><h2 id="1建议"><a href="#1建议" class="headerlink" title="1建议"></a>1建议</h2><p>不管是TPC-C还是SPECjbb2000，计算结果都只能作为一个横向比较的参考。在实际应用中，决定系统性能的因素除了硬件、系统软件外，与应用软件的设计也是有很大关系的，此外，基于系统可扩展性的考虑，更多时候也倾向于一次性的采购。<br>从长远考虑，以政府信息化主管部门的角度考虑，建立一套评估机制是非常有用的，这其中包括：<br>1、 通过对各单位业务系统运行情况的调查，进行历史数据的收集分析，按分类建立基准指标库。收集的信息包括：服务器的配置、并发用户数（每天业务量）、CPU负荷等；<br>2、 由厂商定期提供基准值，更新基准指标库；<br>有了基准指标库的信息参照，不仅可以用于评估项目建设方案中服务器选型，也可以对各部门进行系统架构设计的优化提供指导。如以下是一些指导原则：<br>1、 数据库服务器选型：采购两台相同配置的小型机，进行虚拟分区和并行处理，以提高系统资源的利用率；日后扩容时采取垂直扩展的方式进行升级；<br>2、 应用服务器：采用负载均衡的方式提高并发处理能力，一般可配置2台以上，每台的硬件配置完全可以不同，应首先考虑使用旧的数据库服务器（利旧），如需采购新的服务器，应采用水平扩展的方式逐步升级；<br>3、 WEB服务器，可以考虑采用刀片服务器，提高扩展性和可管理性。</p>
<h2 id="2参考：某项目计算实例"><a href="#2参考：某项目计算实例" class="headerlink" title="2参考：某项目计算实例"></a>2参考：某项目计算实例</h2><h3 id="参考1"><a href="#参考1" class="headerlink" title="参考1"></a>参考1</h3><p>为了方便计算数据库服务器的造型，我们约定：<br>“ 系统同时在线用户数为1500人（U1）；<br>“ 平均每个用户每分钟发出2次业务请求（N1）；<br>“ 系统发出的业务请求中，更新、查询、统计各占1/3；<br>“ 平均每次更新业务产生3个事务（T1）；<br>“ 平均每次查询业务产生8个事务（T2）；<br>“ 平均每次统计业务产生13个事务（T3）；<br>“ 一天内忙时的处理量为平均值的5倍；<br>“ 经验系数为1.6；(实际工程经验)<br>“ 考虑服务器保留30％的冗余；<br>服务器需要的处理能力为：<br>TPC-C=U1<em>N1</em>（T1+T2+T3）/3<em>3</em>经验系数/冗余系数<br>则应用服务器的处理性能估算为：<br>TPC-C= 1500<em>2</em>（3+8+13）/3<em>5</em>1.6/0.7= 274,285 tpmC</p>
<p>数据库服务器关系到整个系统的稳定运行，考虑到高可靠性和高可用性，并注重设备的可扩展性和性价比，系统将配置两台TPC-C值不小于28万的高性能数据库服务器。</p>
<h3 id="参考2"><a href="#参考2" class="headerlink" title="参考2"></a>参考2</h3><p>以单台服务器性能进行计算，即确保单台服务器工作的时候可以满足系统正常运行的需要；</p>
<p>假设每天有1万人次来窗口办理业务，每人次办理一项业务。即以每日1万笔前台交易为例进行<strong><em>\</em>综合系数**</strong>的推导：</p>
<p>\1. 假设每月前台交易数（未来5年内的设计指标）为220,000 （有些业务在月初、月末的处理量比较高，按月统计可以平衡此项差异）;<br>\2. 每日前台交易数=220000/22=10,000 ，即每日 1万笔；<br>\3. 忙时处理能力：每日交易的80%在4个小时内完成，即10000<em>80%/4=2000（笔/小时）<br>\4. 峰值处理能力：2000</em>2=4000（笔/小时），即峰值处理能力为每小时4000笔，或 67笔/分，假设业务人员同时在线为100人，即每人每分钟处理0.7笔）<br>\5. 假设每笔交易对应数据库事务数=20<strong>（这个是不是有点夸张了，有这么复杂的交易，TPC的标准交易都不算简单了吧，这只能说明数据库设计的有问题，按这样，支付宝咋弄）</strong>，基准TPC指标值对应的比例=8，cpu保留30%的处理能力冗余，计算值与公布值（最优值）的偏差经验值为4 <strong>（这几个参数估算的依据不足，更多的是经验值）</strong></p>
<p>则 tpmC值为：<br>tpmC= 67<em>20<em>8</em>4/(1-30%)= 61257[颠峰处理能力时（笔/分）<em>每笔交易对应数据库事务数</em>基准TPC指标值对应的比例<em>计算值与公布值（最优值）的偏差经验值/（1- cpu保留30%的处理能力冗余）<br>倒算出 综合系数 = 61257/10000=6.1<br>即数据库服务器tpmC= **</em>*每日前台交易数 \</em> 6.1**** （实际计算值应不高于该值）<br>应用服务器的 tpmC = 数据库服务器 tpmC *50% （一般）</p>
<p>应用服务器的 tpmC = tpmC *70% </p>
<p>某单位要建立一个系统，设计容量是 2008 年要达到 1500 万客户的规模，在花费巨资（将近 100 M $）建设起此系统后，运行只有几个月，客户量也只达到几十万，厂商就说此系统容量不够，要花数 M $ 要扩容，并声称不是拍脑袋是，按 TPCC 计算的结果 …</p>
<p>以前只大致了解 TPCC 指标的一些情况，平常也就看看 By Performace 和　By Price/Performace 的 Top 10 列表，了解一下各厂商的实力和产品的情况，这次对 TPCC 进行了一下深入了解，发现了一些容易被厂商搞猫腻的地方。</p>
<p><a href="http://www.tpc.org/tpcc" target="_blank" rel="noopener">TPCC</a> 简单的来说，就是事务处理性能委员会 <a href="http://www.tpc.org/" target="_blank" rel="noopener">TPC</a> 组织针对联机数据库应用系统（OLTP）制定的一个综合性能考评指标，它模拟了一个批发 商的货物管理环境，有标准的数据库结构（Schema），可以很容易的扩展，在此系统中，主要有五类交易：</p>
<p>\1. 新订单（New-Order） </p>
<p>\2. 支付（Payment ） 43%（最小比例）</p>
<p>\3. 订单查询（Order-Status） 4%（最小比例）</p>
<p>\4. 交付（Delivery） 4%（最小比例）</p>
<p>\5. 库存查询（Stock-Level） 4%（最小比例）</p>
<p>因为 TPCC 指标值主要是衡量“新订单”交易的数量，所以厂商都会趋向于增加新订单交易的数量，这样并不满足实际的应用场景，所以 TPCC 的规范中指定了后四种交易数量的最小比例，这样意味着 “新订单” 的数量最多只能占到45%（这个 45% 不知出于什么原因，在很多 TPCC 的指标介绍中并没有提及）。</p>
<p>这就说明了：如果一台机器有 1000 tpm (Transactions per Minute)，那么它实际上处理的交易（请求）为 1000/45% = 2222 ，而实际上大多数厂商在面对用户估算应用系统需要多少个 TPCC 的服务器的时候，是计算所有交易量的，这样带来的评估结果是用户至少买比实际需要大一倍性能容量的机器，获得利益的谁呢？当然是服务器厂商，越高 TPCC 值的机器，价格越高，性价比也一般要偏小。</p>
<p>此外，服务器厂商还容易在以下方面愚弄客户：</p>
<p>１、交易复杂度（用户的一个交易约等于多少个 TPCC 的标准交易），某国际著名的服务器厂商建议此值取 10 - 20 ，这个值也忒大了点， 在 TPCC 的场景，交易也不是很简单的，和实际的应用交易差别并不是很大。</p>
<p>2、按一些峰值指标来计算性能，实际上，这些峰值只是在极少数情况下出现，所以在计算时，应乘以 80% 的系数。</p>
<p>​    3、预留容量，很多厂商建议预留容量，甚至达到一半，这有点过份，在实际容量要求增高的时候，可以通过服务器的横向扩展来纵向扩展来满足应用要求，何必为未来五年的要求，要在眼下一下子要做全部的硬件投资呢？ 何况硬件的价格在不断下降呢。</p>
<p><strong>具体情况具体分析，还得按中国国情来实测，国际标准有时不适合我们。<br>而且这个标准好多年了，现在很少在纵向扩展上花心思了，都注重横向扩展，按成本购置小机，尽量优化小机的数据库性能，得出TPCM值，然后对数据库进行横向扩展（虽然横向扩展有诸多问题，但是还是要扩展），利用集群提高整体的TPS</strong></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://carlo-z.com/mysql/2-mysql-benchmark-test/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Focus-1">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Focus-1">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/mysql/2-mysql-benchmark-test/" itemprop="url">centos7.5下对mysql5.6基准测试</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-11-18T00:00:00+08:00">
                2019-11-18
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/mysql/" itemprop="url" rel="index">
                    <span itemprop="name">mysql</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <hr>
<br>

<h1 id="一、测试环境准备"><a href="#一、测试环境准备" class="headerlink" title="一、测试环境准备"></a>一、测试环境准备</h1><ul>
<li><p>操作系统：centos7.5</p>
</li>
<li><p>处理器：Intel 8核  Current Speed: 2000 MHz， Max Speed: 2000 MHz，三级缓存</p>
</li>
<li><p>内存：16G</p>
</li>
<li><p>磁盘：100G SSD</p>
</li>
<li><p>数据库：mysql 5.6.28</p>
</li>
<li><p>sysbench：1.0.18</p>
</li>
</ul>
<br>

<h1 id="二、测试工具"><a href="#二、测试工具" class="headerlink" title="二、测试工具"></a>二、测试工具</h1><h3 id="1、sysbench"><a href="#1、sysbench" class="headerlink" title="1、sysbench"></a>1、sysbench</h3><p>安装文档： <a href="https://github.com/akopytov/sysbench#installing-from-binary-packages" target="_blank" rel="noopener">https://github.com/akopytov/sysbench#installing-from-binary-packages</a> </p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> centos7.5使用官方镜像安装</span><br><span class="line">curl -s https://packagecloud.io/install/repositories/akopytov/sysbench/script.rpm.sh | sudo bash</span><br><span class="line">sudo yum -y install sysbench</span><br></pre></td></tr></table></figure>

<p>帮助：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[root@10-10-135-172 benchmark]# sysbench --help</span><br><span class="line"></span><br><span class="line">[root@10-10-135-172 benchmark]# sysbench fileio help</span><br><span class="line">sysbench 1.0.18 (using bundled LuaJIT 2.1.0-beta2)</span><br><span class="line"></span><br><span class="line">fileio options:</span><br><span class="line">  --file-num=N                  number of files to create [128]</span><br><span class="line">  --file-block-size=N           block size to use in all IO operations [16384]</span><br><span class="line">  --file-total-size=SIZE        total size of files to create [2G]</span><br><span class="line">  --file-test-mode=STRING       test mode &#123;seqwr, seqrewr, seqrd, rndrd, rndwr, rndrw&#125;</span><br><span class="line">  --file-io-mode=STRING         file operations mode &#123;sync,async,mmap&#125; [sync]</span><br><span class="line">  --file-async-backlog=N        number of asynchronous operatons to queue per thread [128]</span><br><span class="line">  --file-extra-flags=[LIST,...] list of additional flags to use to open files &#123;sync,dsync,direct&#125; []</span><br><span class="line">  --file-fsync-freq=N           do fsync() after this number of requests (0 - don't use fsync()) [100]</span><br><span class="line">  --file-fsync-all[=on|off]     do fsync() after each write operation [off]</span><br><span class="line">  --file-fsync-end[=on|off]     do fsync() at the end of test [on]</span><br><span class="line">  --file-fsync-mode=STRING      which method to use for synchronization &#123;fsync, fdatasync&#125; [fsync]</span><br><span class="line">  --file-merged-requests=N      merge at most this number of IO requests if possible (0 - don't merge) [0]</span><br><span class="line">  --file-rw-ratio=N             reads/writes ratio for combined test [1.5]</span><br></pre></td></tr></table></figure>

<br>

<h3 id="2、tpcc-mysql"><a href="#2、tpcc-mysql" class="headerlink" title="2、tpcc-mysql"></a>2、tpcc-mysql</h3><p>github： <a href="https://github.com/Percona-Lab/tpcc-mysql" target="_blank" rel="noopener">https://github.com/Percona-Lab/tpcc-mysql</a> </p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /var/lib/mysql/benchmark</span><br><span class="line">cd /var/lib/mysql/benchmark</span><br><span class="line">wget https://github.com/Percona-Lab/tpcc-mysql/archive/master.zip -O tpcc-mysql.zip</span><br><span class="line">unzip -d ./ tpcc-mysql.zip</span><br><span class="line">cd /var/lib/mysql/benchmark/tpcc-mysql-master/src</span><br><span class="line">yum install mysql-devel</span><br><span class="line">make</span><br></pre></td></tr></table></figure>

<p>编译完成后，生成 tpcc_load  tpcc_start：</p>
<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20191118181430.png" alt></p>
<br>

<h1 id="三、测试目标"><a href="#三、测试目标" class="headerlink" title="三、测试目标"></a>三、测试目标</h1><ul>
<li><p>处理器性能</p>
</li>
<li><p>内存性能</p>
</li>
<li><p>磁盘顺序读写，随机读写性能</p>
</li>
<li><p>mysql 吞吐量，响应时间</p>
</li>
</ul>
<br>

<h1 id="四、测试步骤"><a href="#四、测试步骤" class="headerlink" title="四、测试步骤"></a>四、测试步骤</h1><h3 id="1、准备获取系统性能和状态的脚本"><a href="#1、准备获取系统性能和状态的脚本" class="headerlink" title="1、准备获取系统性能和状态的脚本"></a>1、准备获取系统性能和状态的脚本</h3><p>vi /root/benchmark/1-collect-system-status.sh</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span>!/bin/sh</span><br><span class="line"></span><br><span class="line">mkdir -p status_data</span><br><span class="line"></span><br><span class="line">INTERVAL=5</span><br><span class="line">PREFIX=./status_data/$INTERVAL-sec-status</span><br><span class="line">RUNFILE=/root/benchmark/running</span><br><span class="line"></span><br><span class="line">mysql -uroot -p123456 -e 'SHOW GLOBAL VARIABLES' &gt;&gt; mysql-variables</span><br><span class="line">while test -e $RUNFILE; do</span><br><span class="line">    tfile=$(date +%F_%I)</span><br><span class="line">    sleep=$(date +%s.%N | awk "&#123;print $INTERVAL - (\$1 % $INTERVAL)&#125;")</span><br><span class="line">    sleep $sleep</span><br><span class="line">    ts="$(date +"TS %s.%N %F %T")"</span><br><span class="line">    loadavg="$(uptime)"</span><br><span class="line">    echo "$ts $loadavg" &gt;&gt; $PREFIX-$&#123;tfile&#125;-status</span><br><span class="line">    mysql -uroot -p123456 -e 'SHOW GLOBAL STATUS' &gt;&gt; $PREFIX-$&#123;tfile&#125;-status &amp;</span><br><span class="line">    echo "$ts $loadavg" &gt;&gt; $PREFIX-$&#123;tfile&#125;-innodbstatus</span><br><span class="line">    mysql -uroot -p123456 -e 'SHOW GLOBAL STATUS\G' &gt;&gt; $PREFIX-$&#123;tfile&#125;-innodbstatus &amp;</span><br><span class="line">    echo "$ts $loadavg" &gt;&gt; $PREFIX-$&#123;tfile&#125;-processlist</span><br><span class="line">    mysql -uroot -p123456 -e 'SHOW FULL PROCESSLIST\G' &gt;&gt; $PREFIX-$&#123;tfile&#125;-processlist &amp;</span><br><span class="line">    echo $ts</span><br><span class="line">done</span><br><span class="line">echo Exiting because $RUNFILE does not exist.</span><br></pre></td></tr></table></figure>

<p>分析收集到的数据</p>
<p>vi /root/benchmark/2-system-status-analyzer.sh</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span>!/bin/bash</span><br><span class="line"></span><br><span class="line">awk '</span><br><span class="line">    BEGIN &#123;</span><br><span class="line">        printf "#ts date time load QPS";</span><br><span class="line">        fmt = " %.2f";</span><br><span class="line">    &#125;</span><br><span class="line">    /^TS/ &#123;</span><br><span class="line">        ts      = substr($2, 1, index($2, ".") - 1);</span><br><span class="line">        load    = NF -2;</span><br><span class="line">        diff    = ts - prev_ts;</span><br><span class="line">        prev_ts = ts;</span><br><span class="line">        printf "\n%s %s %s %s", ts, $3, $4, substr($load, 1, length($load) - 1);</span><br><span class="line">    &#125;</span><br><span class="line">    /Queries/ &#123;</span><br><span class="line">        printf fmt, ($2-Queries)/diff;</span><br><span class="line">        Queries=$2</span><br><span class="line">    &#125;</span><br><span class="line">' "$@"</span><br></pre></td></tr></table></figure>

<p>用法示例</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sh 2-system-status-analyzer.sh status_data/5-sec-status-2019-11-19_10-status</span><br></pre></td></tr></table></figure>

<br>

<h3 id="2、使用sysbench服务器性能测试"><a href="#2、使用sysbench服务器性能测试" class="headerlink" title="2、使用sysbench服务器性能测试"></a>2、使用sysbench服务器性能测试</h3><h4 id="1-、cpu测试"><a href="#1-、cpu测试" class="headerlink" title="1)、cpu测试"></a>1)、cpu测试</h4><p> 计算20000个素数。8核cpu，分别测试 1，4，8，12  线程时的 CPU表现</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sysbench --test=cpu --threads=1 --cpu-max-prime=20000 run</span><br></pre></td></tr></table></figure>

<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20191119112016.png" alt></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sysbench --test=cpu --threads=4 --cpu-max-prime=20000 run</span><br></pre></td></tr></table></figure>

<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20191119111943.png" alt></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sysbench --test=cpu --threads=8 --cpu-max-prime=20000 run</span><br></pre></td></tr></table></figure>

<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20191119112049.png" alt></p>
<blockquote>
<p> 结论：随着线程数增加，计算能力线性增加；</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sysbench --test=cpu --threads=12 --cpu-max-prime=20000 run</span><br></pre></td></tr></table></figure>

<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20191119112250.png" alt></p>
<blockquote>
<p> 结论：当线程数超过cpu核数之后，随着线程数增加，计算能力不再增加，甚至略微下降，这是因为线程上下文切换以后的时间损耗；</p>
</blockquote>
<br>

<h4 id="2-、文件I-O测试"><a href="#2-、文件I-O测试" class="headerlink" title="2)、文件I/O测试"></a>2)、文件I/O测试</h4><p><u><strong>① 准备30G的数据</strong></u></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sysbench --test=fileio --file-total-size=30G prepare</span><br></pre></td></tr></table></figure>

<p><u><strong>② 运行阶段</strong></u></p>
<ul>
<li>seqwr：顺序写入</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sysbench --test=fileio --file-test-mode=seqwr --file-total-size=30G --time=60 run</span><br></pre></td></tr></table></figure>

<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20191119143818.png" alt></p>
<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20191119143929.png" alt></p>
<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20191119144029.png" alt></p>
<blockquote>
<p>结论：可以看到，顺序写的过程中 CPU占用很低，但是 buff、cache、block out、in、cs(上下文切换)都很高，这是因为 linux 写磁盘用了 页缓存  和 DMA。</p>
</blockquote>
<ul>
<li>seqrewr：顺序重写</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sysbench --test=fileio --file-test-mode=seqrewr --file-total-size=30G --time=60 run</span><br></pre></td></tr></table></figure>

<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20191119144945.png" alt></p>
<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20191119145023.png" alt></p>
<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20191119145125.png" alt></p>
<ul>
<li>seqrd：顺序读取</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sysbench --test=fileio --file-test-mode=seqrd --file-total-size=30G --time=60 run</span><br></pre></td></tr></table></figure>

<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20191119143529.png" alt></p>
<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20191119143630.png" alt></p>
<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20191119143651.png" alt></p>
<ul>
<li>rndrd：随机读取</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sysbench --test=fileio --file-test-mode=rndrd --file-total-size=30G --time=60 run</span><br></pre></td></tr></table></figure>

<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20191119143319.png" alt></p>
<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20191119143406.png" alt></p>
<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20191119150157.png" alt></p>
<blockquote>
<p>结论： SSD是没有寻道时间的，但是 随机读（46.95MiB/s） 仍然比顺序读（184.46MiB/s）要慢很多</p>
</blockquote>
<ul>
<li>rndwr：随机写入</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sysbench --test=fileio --file-test-mode=rndwr --file-total-size=30G --time=60 run</span><br></pre></td></tr></table></figure>

<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20191119142856.png" alt></p>
<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20191119142944.png" alt></p>
<blockquote>
<p>随机写（26.25MiB/s）更慢了，顺序写的速度有138.38MiB/s</p>
</blockquote>
<ul>
<li>rndrw：混合随机读/写</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sysbench --test=fileio --file-test-mode=rndrw --file-total-size=30G --time=60 run</span><br></pre></td></tr></table></figure>

<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20191119140202.png" alt></p>
<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20191119141529.png" alt></p>
<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20191119141833.png" alt></p>
<blockquote>
<p>混合随机读写的速度更是龟速，然而我们平时业务场景中使用最多的就是这种情况，所以一定要注意，能顺序写的，一定不随机写</p>
</blockquote>
<p><u><strong>③ 清除数据</strong></u></p>
<p>sysbench –test=fileio –file-total-size=30G cleanup</p>
<br>

<h4 id="3-、内存测试"><a href="#3-、内存测试" class="headerlink" title="3)、内存测试"></a>3)、内存测试</h4><p>测试8K顺序分配</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sysbench --test=memory --memory-access-mode=seq --memory-block-size=8K --memory-total-size=100G --threads=12 --events=10000 run</span><br></pre></td></tr></table></figure>

<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20191119151942.png" alt></p>
<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20191119151311.png" alt></p>
<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20191119151447.png" alt></p>
<blockquote>
<p>结论：可以看到 CPU 占用极高，内存写入速度为 10138.32 MiB / sec</p>
</blockquote>
<p><u><strong>测试8K随机分配</strong></u></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sysbench --test=memory --memory-access-mode=rnd --memory-block-size=8K --memory-total-size=100G --threads=12 --events=10000 run</span><br></pre></td></tr></table></figure>

<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20191119151857.png" alt></p>
<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20191119151718.png" alt></p>
<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20191119151756.png" alt></p>
<blockquote>
<p>结论：cpu占用极高，随机分配速度为 1381.41 MiB / sec，只有顺序分配的 1/7 左右，内存都有顺序写都有差距。</p>
</blockquote>
<br>

<h3 id="3、sysbench对mysql进行OLTP测试"><a href="#3、sysbench对mysql进行OLTP测试" class="headerlink" title="3、sysbench对mysql进行OLTP测试"></a>3、sysbench对mysql进行OLTP测试</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sysbench /usr/share/sysbench/oltp_read_write.lua help</span><br></pre></td></tr></table></figure>

<h4 id="1-、新建数据库-sbtest"><a href="#1-、新建数据库-sbtest" class="headerlink" title="1) 、新建数据库 sbtest"></a>1) 、新建数据库 sbtest</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysqladmin create sbtest -uroot -p</span><br></pre></td></tr></table></figure>

<h4 id="2-、运行状态收集脚本"><a href="#2-、运行状态收集脚本" class="headerlink" title="2) 、运行状态收集脚本"></a>2) 、运行状态收集脚本</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sh /root/benchmark/1-collect-system-status.sh</span><br></pre></td></tr></table></figure>

<h4 id="3-、-准备1百万条数据"><a href="#3-、-准备1百万条数据" class="headerlink" title="3)、 准备1百万条数据"></a>3)、 准备1百万条数据</h4><p> 可以在/usr/share/sysbench/中找到需要使用的lua脚本：</p>
<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20191119171723.png" alt></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> 开始插入数据</span><br><span class="line">sysbench /usr/share/sysbench/oltp_read_write.lua --threads=64 --time=600 --histogram=on --mysql-host=10.10.135.172 --mysql-port=3306 --mysql-db=sbtest --mysql-user=root --mysql-password=123456 --table-size=10000000 prepare</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 关键参数说明：</span><br><span class="line">--threads=64           测试时使用的线程数</span><br><span class="line">--time=600             测试时间</span><br><span class="line">--histogram=on         在报告中是否输出关于延迟的直方图，建议开启</span><br><span class="line">--table_size=10000000  数据表的大小</span><br></pre></td></tr></table></figure>

<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20191119183230.png" alt></p>
<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20191119183337.png" alt></p>
<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20191119183835.png" alt></p>
<br>

<h4 id="4-、-运行压测程序"><a href="#4-、-运行压测程序" class="headerlink" title="4)、 运行压测程序"></a>4)、 运行压测程序</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sysbench /usr/share/sysbench/oltp_read_write.lua --threads=64 --time=600 --histogram=on --mysql-host=10.10.135.172 --mysql-port=3306 --mysql-db=sbtest --mysql-user=root --table-size=10000000 run</span><br></pre></td></tr></table></figure>

<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20191119184201.png" alt></p>
<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20191119185243.png" alt></p>
<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20191119185550.png" alt></p>
<ul>
<li><p>总事务数：820388</p>
</li>
<li><p>每秒事务数：1367.22 per sec</p>
</li>
<li><p>总查询数：16407760</p>
</li>
<li><p>每秒查询数：27344.47 per sec</p>
</li>
</ul>
<p>请求分布直方图</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br></pre></td><td class="code"><pre><span class="line">[root@10-10-135-172 benchmark]#  sysbench /usr/share/sysbench/oltp_read_write.lua --threads=64 --time=600 --histogram=on --mysql-host=10.10.135.172 --mysql-port=3306 --mysql-db=sbtest --mysql-user=root --table-size=10000000 run</span><br><span class="line">sysbench 1.0.18 (using bundled LuaJIT 2.1.0-beta2)</span><br><span class="line"></span><br><span class="line">Running the test with following options:</span><br><span class="line">Number of threads: 64</span><br><span class="line">Initializing random number generator from current time</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Initializing worker threads...</span><br><span class="line"></span><br><span class="line">Threads started!</span><br><span class="line"></span><br><span class="line"> Latency histogram (values are in milliseconds)</span><br><span class="line">       value  ------------- distribution ------------- count</span><br><span class="line">       4.329 |                                         64</span><br><span class="line">       4.407 |*****                                    1030</span><br><span class="line">       4.487 |****************                         3445</span><br><span class="line">       4.569 |**************************               5587</span><br><span class="line">       4.652 |****************************             5867</span><br><span class="line">       4.737 |*************************                5250</span><br><span class="line">       4.823 |********************                     4190</span><br><span class="line">       4.910 |****************                         3476</span><br><span class="line">       4.999 |**************                           2922</span><br><span class="line">       5.090 |************                             2605</span><br><span class="line">       5.183 |***********                              2329</span><br><span class="line">       5.277 |*********                                1991</span><br><span class="line">       5.373 |*********                                1813</span><br><span class="line">       5.470 |********                                 1600</span><br><span class="line">       5.570 |*******                                  1476</span><br><span class="line">       5.671 |******                                   1279</span><br><span class="line">       5.774 |******                                   1178</span><br><span class="line">       5.879 |*****                                    1043</span><br><span class="line">       5.986 |*****                                    974</span><br><span class="line">       6.095 |****                                     924</span><br><span class="line">       6.205 |****                                     843</span><br><span class="line">       6.318 |****                                     768</span><br><span class="line">       6.433 |****                                     786</span><br><span class="line">       6.550 |****                                     839</span><br><span class="line">       6.669 |****                                     943</span><br><span class="line">       6.790 |*****                                    1012</span><br><span class="line">       6.913 |*****                                    1126</span><br><span class="line">       7.039 |******                                   1171</span><br><span class="line">       7.167 |******                                   1310</span><br><span class="line">       7.297 |******                                   1305</span><br><span class="line">       7.430 |******                                   1291</span><br><span class="line">       7.565 |*****                                    1167</span><br><span class="line">       7.702 |*****                                    1072</span><br><span class="line">       7.842 |*****                                    1066</span><br><span class="line">       7.985 |*****                                    1051</span><br><span class="line">       8.130 |*****                                    1102</span><br><span class="line">       8.277 |*****                                    1081</span><br><span class="line">       8.428 |*****                                    1120</span><br><span class="line">       8.581 |*****                                    1129</span><br><span class="line">       8.737 |******                                   1244</span><br><span class="line">       8.895 |*******                                  1444</span><br><span class="line">       9.057 |********                                 1692</span><br><span class="line">       9.222 |*********                                1984</span><br><span class="line">       9.389 |**********                               2161</span><br><span class="line">       9.560 |**********                               2057</span><br><span class="line">       9.734 |*********                                1944</span><br><span class="line">       9.910 |*********                                1930</span><br><span class="line">      10.090 |********                                 1773</span><br><span class="line">      10.274 |********                                 1753</span><br><span class="line">      10.460 |********                                 1698</span><br><span class="line">      10.651 |********                                 1605</span><br><span class="line">      10.844 |*******                                  1553</span><br><span class="line">      11.041 |********                                 1601</span><br><span class="line">      11.242 |********                                 1636</span><br><span class="line">      11.446 |********                                 1649</span><br><span class="line">      11.654 |********                                 1667</span><br><span class="line">      11.866 |********                                 1673</span><br><span class="line">      12.081 |********                                 1733</span><br><span class="line">      12.301 |*********                                1821</span><br><span class="line">      12.524 |*********                                1838</span><br><span class="line">      12.752 |*********                                1844</span><br><span class="line">      12.984 |**********                               2031</span><br><span class="line">      13.219 |*********                                1978</span><br><span class="line">      13.460 |**********                               2206</span><br><span class="line">      13.704 |************                             2449</span><br><span class="line">      13.953 |*************                            2681</span><br><span class="line">      14.207 |*************                            2675</span><br><span class="line">      14.465 |*************                            2744</span><br><span class="line">      14.728 |*************                            2694</span><br><span class="line">      14.995 |*************                            2667</span><br><span class="line">      15.268 |************                             2652</span><br><span class="line">      15.545 |************                             2650</span><br><span class="line">      15.828 |*************                            2671</span><br><span class="line">      16.115 |************                             2644</span><br><span class="line">      16.408 |*************                            2757</span><br><span class="line">      16.706 |*************                            2760</span><br><span class="line">      17.010 |*************                            2845</span><br><span class="line">      17.319 |**************                           2933</span><br><span class="line">      17.633 |***************                          3217</span><br><span class="line">      17.954 |***************                          3105</span><br><span class="line">      18.280 |****************                         3294</span><br><span class="line">      18.612 |*****************                        3587</span><br><span class="line">      18.950 |*****************                        3704</span><br><span class="line">      19.295 |******************                       3845</span><br><span class="line">      19.645 |******************                       3763</span><br><span class="line">      20.002 |******************                       3743</span><br><span class="line">      20.366 |******************                       3852</span><br><span class="line">      20.736 |******************                       3763</span><br><span class="line">      21.112 |******************                       3891</span><br><span class="line">      21.496 |*******************                      4076</span><br><span class="line">      21.886 |*******************                      4108</span><br><span class="line">      22.284 |********************                     4191</span><br><span class="line">      22.689 |*********************                    4400</span><br><span class="line">      23.101 |**********************                   4702</span><br><span class="line">      23.521 |***********************                  4863</span><br><span class="line">      23.948 |************************                 5072</span><br><span class="line">      24.384 |************************                 5043</span><br><span class="line">      24.827 |*************************                5224</span><br><span class="line">      25.278 |************************                 5196</span><br><span class="line">      25.737 |*************************                5285</span><br><span class="line">      26.205 |**************************               5442</span><br><span class="line">      26.681 |**************************               5452</span><br><span class="line">      27.165 |***************************              5727</span><br><span class="line">      27.659 |****************************             5867</span><br><span class="line">      28.162 |*****************************            6097</span><br><span class="line">      28.673 |******************************           6367</span><br><span class="line">      29.194 |******************************           6414</span><br><span class="line">      29.725 |******************************           6441</span><br><span class="line">      30.265 |*******************************          6512</span><br><span class="line">      30.815 |*******************************          6479</span><br><span class="line">      31.375 |********************************         6828</span><br><span class="line">      31.945 |********************************         6876</span><br><span class="line">      32.525 |**********************************       7128</span><br><span class="line">      33.116 |**********************************       7241</span><br><span class="line">      33.718 |***********************************      7372</span><br><span class="line">      34.330 |************************************     7548</span><br><span class="line">      34.954 |************************************     7653</span><br><span class="line">      35.589 |*************************************    7788</span><br><span class="line">      36.236 |*************************************    7808</span><br><span class="line">      36.894 |*************************************    7910</span><br><span class="line">      37.565 |**************************************   8106</span><br><span class="line">      38.247 |***************************************  8177</span><br><span class="line">      38.942 |***************************************  8311</span><br><span class="line">      39.650 |**************************************** 8451</span><br><span class="line">      40.370 |**************************************   8058</span><br><span class="line">      41.104 |***************************************  8309</span><br><span class="line">      41.851 |***************************************  8260</span><br><span class="line">      42.611 |**************************************** 8481</span><br><span class="line">      43.385 |**************************************** 8493</span><br><span class="line">      44.173 |**************************************** 8478</span><br><span class="line">      44.976 |**************************************** 8394</span><br><span class="line">      45.793 |***************************************  8369</span><br><span class="line">      46.625 |**************************************** 8398</span><br><span class="line">      47.472 |**************************************** 8459</span><br><span class="line">      48.335 |**************************************** 8455</span><br><span class="line">      49.213 |**************************************** 8446</span><br><span class="line">      50.107 |***************************************  8245</span><br><span class="line">      51.018 |***************************************  8215</span><br><span class="line">      51.945 |***************************************  8215</span><br><span class="line">      52.889 |**************************************   8087</span><br><span class="line">      53.850 |**************************************   8119</span><br><span class="line">      54.828 |**************************************   8043</span><br><span class="line">      55.824 |*************************************    7959</span><br><span class="line">      56.839 |**************************************   8043</span><br><span class="line">      57.871 |************************************     7746</span><br><span class="line">      58.923 |************************************     7650</span><br><span class="line">      59.993 |***********************************      7522</span><br><span class="line">      61.083 |***********************************      7535</span><br><span class="line">      62.193 |**********************************       7250</span><br><span class="line">      63.323 |**********************************       7254</span><br><span class="line">      64.474 |**********************************       7118</span><br><span class="line">      65.645 |*********************************        6983</span><br><span class="line">      66.838 |********************************         6868</span><br><span class="line">      68.053 |********************************         6890</span><br><span class="line">      69.289 |*******************************          6688</span><br><span class="line">      70.548 |*******************************          6530</span><br><span class="line">      71.830 |******************************           6437</span><br><span class="line">      73.135 |*****************************            6127</span><br><span class="line">      74.464 |******************************           6278</span><br><span class="line">      75.817 |****************************             5952</span><br><span class="line">      77.194 |***************************              5767</span><br><span class="line">      78.597 |**************************               5581</span><br><span class="line">      80.025 |**************************               5522</span><br><span class="line">      81.479 |*************************                5374</span><br><span class="line">      82.959 |*************************                5217</span><br><span class="line">      84.467 |***********************                  4957</span><br><span class="line">      86.002 |***********************                  4947</span><br><span class="line">      87.564 |**********************                   4767</span><br><span class="line">      89.155 |**********************                   4673</span><br><span class="line">      90.775 |*********************                    4499</span><br><span class="line">      92.424 |*********************                    4358</span><br><span class="line">      94.104 |********************                     4230</span><br><span class="line">      95.814 |*******************                      4021</span><br><span class="line">      97.555 |******************                       3871</span><br><span class="line">      99.327 |******************                       3750</span><br><span class="line">     101.132 |*****************                        3665</span><br><span class="line">     102.969 |****************                         3465</span><br><span class="line">     104.840 |****************                         3322</span><br><span class="line">     106.745 |***************                          3286</span><br><span class="line">     108.685 |**************                           3019</span><br><span class="line">     110.659 |**************                           2963</span><br><span class="line">     112.670 |*************                            2707</span><br><span class="line">     114.717 |*************                            2712</span><br><span class="line">     116.802 |************                             2528</span><br><span class="line">     118.924 |***********                              2379</span><br><span class="line">     121.085 |***********                              2269</span><br><span class="line">     123.285 |**********                               2138</span><br><span class="line">     125.525 |**********                               2105</span><br><span class="line">     127.805 |*********                                1861</span><br><span class="line">     130.128 |*********                                1820</span><br><span class="line">     132.492 |********                                 1735</span><br><span class="line">     134.899 |*******                                  1575</span><br><span class="line">     137.350 |*******                                  1502</span><br><span class="line">     139.846 |*******                                  1412</span><br><span class="line">     142.387 |******                                   1302</span><br><span class="line">     144.974 |******                                   1231</span><br><span class="line">     147.608 |*****                                    1056</span><br><span class="line">     150.290 |*****                                    1015</span><br><span class="line">     153.021 |****                                     927</span><br><span class="line">     155.801 |****                                     879</span><br><span class="line">     158.632 |****                                     815</span><br><span class="line">     161.514 |***                                      685</span><br><span class="line">     164.449 |***                                      696</span><br><span class="line">     167.437 |***                                      613</span><br><span class="line">     170.479 |***                                      591</span><br><span class="line">     173.577 |**                                       499</span><br><span class="line">     176.731 |**                                       457</span><br><span class="line">     179.942 |**                                       447</span><br><span class="line">     183.211 |**                                       360</span><br><span class="line">     186.540 |**                                       352</span><br><span class="line">     189.929 |*                                        298</span><br><span class="line">     193.380 |*                                        304</span><br><span class="line">     196.894 |*                                        224</span><br><span class="line">     200.472 |*                                        208</span><br><span class="line">     204.114 |*                                        204</span><br><span class="line">     207.823 |*                                        173</span><br><span class="line">     211.599 |*                                        155</span><br><span class="line">     215.443 |*                                        113</span><br><span class="line">     219.358 |*                                        129</span><br><span class="line">     223.344 |                                         106</span><br><span class="line">     227.402 |                                         82</span><br><span class="line">     231.534 |                                         67</span><br><span class="line">     235.740 |                                         66</span><br><span class="line">     240.024 |                                         43</span><br><span class="line">     244.385 |                                         53</span><br><span class="line">     248.825 |                                         30</span><br><span class="line">     253.346 |                                         31</span><br><span class="line">     257.950 |                                         26</span><br><span class="line">     262.636 |                                         19</span><br><span class="line">     267.408 |                                         25</span><br><span class="line">     272.267 |                                         12</span><br><span class="line">     277.214 |                                         11</span><br><span class="line">     282.251 |                                         11</span><br><span class="line">     287.379 |                                         11</span><br><span class="line">     292.601 |                                         5</span><br><span class="line">     297.917 |                                         11</span><br><span class="line">     303.330 |                                         5</span><br><span class="line">     308.842 |                                         6</span><br><span class="line">     314.453 |                                         14</span><br><span class="line">     320.167 |                                         10</span><br><span class="line">     325.984 |                                         16</span><br><span class="line">     331.907 |                                         11</span><br><span class="line">     337.938 |                                         2</span><br><span class="line">     344.078 |                                         8</span><br><span class="line">     350.330 |                                         10</span><br><span class="line">     356.695 |                                         11</span><br><span class="line">     363.176 |                                         10</span><br><span class="line">     369.775 |                                         15</span><br><span class="line">     376.494 |                                         12</span><br><span class="line">     383.334 |                                         14</span><br><span class="line">     390.299 |                                         10</span><br><span class="line">     397.391 |                                         5</span><br><span class="line">     404.611 |                                         11</span><br><span class="line">     411.963 |                                         2</span><br><span class="line">     419.448 |                                         11</span><br><span class="line">     427.069 |                                         7</span><br><span class="line">     434.829 |                                         6</span><br><span class="line">     442.730 |                                         6</span><br><span class="line">     450.774 |                                         5</span><br><span class="line">     458.964 |                                         2</span><br><span class="line">     475.794 |                                         1</span><br><span class="line">     484.439 |                                         2</span><br><span class="line">     493.242 |                                         1</span><br><span class="line">     559.501 |                                         1</span><br><span class="line"> </span><br><span class="line">SQL statistics:</span><br><span class="line">    queries performed:</span><br><span class="line">        read:                            11485432</span><br><span class="line">        write:                           3281552</span><br><span class="line">        other:                           1640776</span><br><span class="line">        total:                           16407760</span><br><span class="line">    transactions:                        820388 (1367.22 per sec.)</span><br><span class="line">    queries:                             16407760 (27344.47 per sec.)</span><br><span class="line">    ignored errors:                      0      (0.00 per sec.)</span><br><span class="line">    reconnects:                          0      (0.00 per sec.)</span><br><span class="line"></span><br><span class="line">General statistics:</span><br><span class="line">    total time:                          600.0372s</span><br><span class="line">    total number of events:              820388</span><br><span class="line"></span><br><span class="line">Latency (ms):</span><br><span class="line">         min:                                    4.30</span><br><span class="line">         avg:                                   46.80</span><br><span class="line">         max:                                  556.16</span><br><span class="line">         95th percentile:                      112.67</span><br><span class="line">         sum:                             38398062.70</span><br><span class="line"></span><br><span class="line">Threads fairness:</span><br><span class="line">    events (avg/stddev):           12818.5625/107.50</span><br><span class="line">    execution time (avg/stddev):   599.9697/0.01</span><br><span class="line"></span><br><span class="line">[root@10-10-135-172 benchmark]#</span><br></pre></td></tr></table></figure>

<br>

<h4 id="5-、清理数据"><a href="#5-、清理数据" class="headerlink" title="5)、清理数据"></a>5)、清理数据</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sysbench /usr/share/sysbench/oltp_read_write.lua --threads=64 --time=600 --histogram=on --mysql-host=10.10.135.172 --mysql-port=3306 --mysql-db=sbtest --mysql-user=root --table-size=10000000 cleanup</span><br></pre></td></tr></table></figure>

<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20191119190316.png" alt></p>
<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20191119190336.png" alt></p>
<br>

<h4 id="6-、分析收集到的状态"><a href="#6-、分析收集到的状态" class="headerlink" title="6)、分析收集到的状态"></a>6)、分析收集到的状态</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span> sh 2-system-status-analyzer.sh status_data/5-sec-status-2019-11-19_06-status &gt; status.txt</span><br><span class="line"><span class="meta">$</span> vi status.txt</span><br><span class="line">unix时间戳    时间            系统负载 QPS(数据库)</span><br><span class="line">1574160560 18:49:20 18:49:20 51.53 28179.80</span><br><span class="line">1574160565 18:49:25 18:49:25 51.80 26713.20</span><br><span class="line">1574160570 18:49:30 18:49:30 50.86 27784.60</span><br><span class="line">1574160575 18:49:35 18:49:35 51.19 26912.40</span><br><span class="line">1574160580 18:49:40 18:49:40 52.30 27048.20</span><br><span class="line">1574160585 18:49:45 18:49:45 52.99 26843.00</span><br><span class="line">1574160590 18:49:50 18:49:50 53.87 27478.80</span><br><span class="line">1574160595 18:49:55 18:49:55 54.61 28724.60</span><br><span class="line">1574160600 18:50:00 18:50:00 55.68 27960.00</span><br><span class="line">1574160605 18:50:05 18:50:05 55.46 25874.40</span><br><span class="line">1574160610 18:50:10 18:50:10 56.07 25936.40</span><br><span class="line">1574160615 18:50:15 18:50:15 52.54 25914.20</span><br><span class="line">1574160620 18:50:20 18:50:20 52.66 27237.60</span><br><span class="line">1574160625 18:50:25 18:50:25 52.92 27507.20</span><br><span class="line">1574160630 18:50:30 18:50:30 53.89 26005.40</span><br><span class="line">1574160635 18:50:35 18:50:35 55.02 26745.00</span><br><span class="line">1574160640 18:50:40 18:50:40 54.86 25643.80</span><br><span class="line">1574160645 18:50:45 18:50:45 55.75 24751.20</span><br><span class="line">1574160650 18:50:50 18:50:50 53.69 27608.80</span><br><span class="line">1574160655 18:50:55 18:50:55 52.51 26590.20</span><br><span class="line">1574160660 18:51:00 18:51:00 51.83 27411.60</span><br><span class="line">1574160665 18:51:05 18:51:05 49.68 28504.20</span><br><span class="line">1574160670 18:51:10 18:51:10 50.27 20451.00</span><br><span class="line">1574160675 18:51:15 18:51:15 46.24 1.40</span><br><span class="line">1574160680 18:51:20 18:51:20 42.62 2.20</span><br><span class="line">1574160685 18:51:25 18:51:25 39.21 1.40</span><br><span class="line">1574160690 18:51:30 18:51:30 36.07 1.80</span><br><span class="line">1574160695 18:51:35 18:51:35 33.18 2.40</span><br><span class="line">1574160700 18:51:40 18:51:40 30.52 1.00</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span> cat status_data/5-sec-status-2019-11-19_06-status | grep 'TS ' &gt; load_status.txt</span><br><span class="line"><span class="meta">$</span> vi load_status.txt</span><br><span class="line"></span><br><span class="line">TS 1574160295.047916883 18:44:55  18:44:55 up 1 day,  2:22,  5 users,  load average: 52.13, 24.94, 9.96</span><br><span class="line">TS 1574160300.059352736 18:45:00  18:45:00 up 1 day,  2:22,  5 users,  load average: 53.08, 25.59, 10.25</span><br><span class="line">TS 1574160305.042101201 18:45:05  18:45:05 up 1 day,  2:22,  5 users,  load average: 50.91, 25.60, 10.33</span><br><span class="line">TS 1574160310.052530257 18:45:10  18:45:10 up 1 day,  2:22,  5 users,  load average: 51.72, 26.19, 10.60</span><br><span class="line">TS 1574160315.046490819 18:45:15  18:45:15 up 1 day,  2:22,  5 users,  load average: 52.78, 26.83, 10.89</span><br><span class="line">TS 1574160320.008893450 18:45:20  18:45:20 up 1 day,  2:22,  5 users,  load average: 53.68, 27.45, 11.18</span><br><span class="line">TS 1574160325.203247981 18:45:25  18:45:25 up 1 day,  2:22,  5 users,  load average: 54.67, 28.09, 11.47</span><br><span class="line">TS 1574160330.118228229 18:45:30  18:45:30 up 1 day,  2:22,  5 users,  load average: 55.57, 28.72, 11.77</span><br><span class="line">TS 1574160335.016869072 18:45:35  18:45:35 up 1 day,  2:22,  5 users,  load average: 55.61, 29.17, 12.00</span><br><span class="line">TS 1574160340.042057908 18:45:40  18:45:40 up 1 day,  2:22,  5 users,  load average: 54.84, 29.45, 12.19</span><br><span class="line">TS 1574160345.056853963 18:45:45  18:45:45 up 1 day,  2:23,  5 users,  load average: 55.65, 30.04, 12.47</span><br><span class="line">TS 1574160350.059495691 18:45:50  18:45:50 up 1 day,  2:23,  5 users,  load average: 55.84, 30.50, 12.72</span><br><span class="line">TS 1574160355.238934528 18:45:55  18:45:55 up 1 day,  2:23,  5 users,  load average: 56.65, 31.09, 13.00</span><br><span class="line">TS 1574160360.115909774 18:46:00  18:46:00 up 1 day,  2:23,  5 users,  load average: 56.76, 31.54, 13.24</span><br><span class="line">TS 1574160365.067470620 18:46:05  18:46:05 up 1 day,  2:23,  5 users,  load average: 57.34, 32.08, 13.52</span><br><span class="line">TS 1574160370.111400548 18:46:10  18:46:10 up 1 day,  2:23,  5 users,  load average: 55.39, 32.09, 13.62</span><br><span class="line">TS 1574160375.074730081 18:46:15  18:46:15 up 1 day,  2:23,  5 users,  load average: 53.76, 32.14, 13.74</span><br><span class="line">TS 1574160380.210612654 18:46:20  18:46:20 up 1 day,  2:23,  5 users,  load average: 54.34, 32.62, 13.99</span><br><span class="line">TS 1574160385.102457806 18:46:25  18:46:25 up 1 day,  2:23,  5 users,  load average: 50.87, 32.26, 13.97</span><br><span class="line">TS 1574160390.117591568 18:46:30  18:46:30 up 1 day,  2:23,  5 users,  load average: 50.48, 32.49, 14.14</span><br><span class="line">TS 1574160395.076076309 18:46:35  18:46:35 up 1 day,  2:23,  5 users,  load average: 51.40, 32.98, 14.40</span><br><span class="line">TS 1574160400.191211227 18:46:40  18:46:40 up 1 day,  2:23,  5 users,  load average: 52.09, 33.43, 14.65</span><br><span class="line">TS 1574160405.153420741 18:46:45  18:46:45 up 1 day,  2:24,  5 users,  load average: 49.20, 33.14, 14.65</span><br><span class="line">TS 1574160410.013108072 18:46:50  18:46:50 up 1 day,  2:24,  5 users,  load average: 49.58, 33.49, 14.87</span><br><span class="line">TS 1574160415.084485731 18:46:55  18:46:55 up 1 day,  2:24,  5 users,  load average: 48.82, 33.59, 15.00</span><br><span class="line">TS 1574160420.011562959 18:47:00  18:47:00 up 1 day,  2:24,  5 users,  load average: 47.55, 33.58, 15.10</span><br><span class="line">TS 1574160425.018923271 18:47:05  18:47:05 up 1 day,  2:24,  5 users,  load average: 48.95, 34.11, 15.37</span><br></pre></td></tr></table></figure>

<br>

<h3 id="4、tpcc-mysql对mysql进行测试"><a href="#4、tpcc-mysql对mysql进行测试" class="headerlink" title="4、tpcc-mysql对mysql进行测试"></a>4、tpcc-mysql对mysql进行测试</h3><blockquote>
<ol>
<li>Build binaries<ul>
<li><code>cd src ; make</code> ( you should have mysql_config available in $PATH)</li>
</ul>
</li>
<li>Load data<ul>
<li>create database <code>mysqladmin create tpcc1000</code></li>
<li>create tables <code>mysql tpcc1000 &lt; create_table.sql</code></li>
<li>create indexes and FK ( this step can be done after loading data) <code>mysql tpcc1000 &lt; add_fkey_idx.sql</code></li>
<li>populate data<ul>
<li>simple step <code>tpcc_load -h127.0.0.1 -d tpcc1000 -u root -p &quot;&quot; -w 1000</code> |hostname:port| |dbname| |user| |password| |WAREHOUSES| ref. tpcc_load –help for all options</li>
<li>load data in parallel check load.sh script</li>
</ul>
</li>
</ul>
</li>
<li>Start benchmark<ul>
<li><code>./tpcc_start -h127.0.0.1 -P3306 -dtpcc1000 -uroot -w1000 -c32 -r10 -l10800</code></li>
<li>|hostname| |port| |dbname| |user| |WAREHOUSES| |CONNECTIONS| |WARMUP TIME| |BENCHMARK TIME|</li>
<li>ref. tpcc_start –help for all options</li>
</ul>
</li>
</ol>
</blockquote>
<h4 id="1-、-创建数据库和表结构"><a href="#1-、-创建数据库和表结构" class="headerlink" title="1)、 创建数据库和表结构"></a>1)、 创建数据库和表结构</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cd tpcc-mysql-master</span><br><span class="line"></span><br><span class="line">mysqladmin create tpcc1000 -uroot -p123456</span><br><span class="line">mysql -uroot -p123456 tpcc1000 &lt; create_table.sql</span><br><span class="line">mysql -uroot -p123456 tpcc1000 &lt; add_fkey_idx.sql</span><br></pre></td></tr></table></figure>

<h4 id="2-、加载数据"><a href="#2-、加载数据" class="headerlink" title="2)、加载数据"></a>2)、加载数据</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">./tpcc_load -h10.10.135.172 -P3306 -d tpcc1000 -u root -p 123456 -w 10</span><br><span class="line"><span class="meta">#</span> 1 代表1个仓库大小，10代表 10个仓库大小</span><br><span class="line"><span class="meta">#</span> sh load.sh tpcc1000 1000</span><br></pre></td></tr></table></figure>

<p>加载完后查看数据量</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">count</span>(*) <span class="keyword">from</span> tpcc1000.customer;</span><br><span class="line"><span class="keyword">select</span> <span class="keyword">count</span>(*) <span class="keyword">from</span> tpcc1000.district;</span><br><span class="line"><span class="keyword">select</span> <span class="keyword">count</span>(*) <span class="keyword">from</span> tpcc1000.history;</span><br><span class="line"><span class="keyword">select</span> <span class="keyword">count</span>(*) <span class="keyword">from</span> tpcc1000.item;</span><br><span class="line"><span class="keyword">select</span> <span class="keyword">count</span>(*) <span class="keyword">from</span> tpcc1000.new_orders;</span><br><span class="line"><span class="keyword">select</span> <span class="keyword">count</span>(*) <span class="keyword">from</span> tpcc1000.order_line;</span><br><span class="line"><span class="keyword">select</span> <span class="keyword">count</span>(*) <span class="keyword">from</span> tpcc1000.orders;</span><br><span class="line"><span class="keyword">select</span> <span class="keyword">count</span>(*) <span class="keyword">from</span> tpcc1000.stock;</span><br><span class="line"><span class="keyword">select</span> <span class="keyword">count</span>(*) <span class="keyword">from</span> tpcc1000.warehouse;</span><br></pre></td></tr></table></figure>

<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20191119201805.png" alt></p>
<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20191119195506.png" alt></p>
<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20191119202942.png" alt></p>
<br>

<h4 id="3-、运行状态收集脚本"><a href="#3-、运行状态收集脚本" class="headerlink" title="3)、运行状态收集脚本"></a>3)、运行状态收集脚本</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sh /root/benchmark/1-collect-system-status.sh</span><br></pre></td></tr></table></figure>

<h4 id="4-、执行测试"><a href="#4-、执行测试" class="headerlink" title="4)、执行测试"></a>4)、执行测试</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> -w 指定仓库数量</span><br><span class="line"><span class="meta">#</span> -c 指定并发连接数</span><br><span class="line"><span class="meta">#</span> -r 指定开始测试前进行warmup的时间，进行预热后，测试效果更好</span><br><span class="line"><span class="meta">#</span> -l 指定测试持续时间</span><br><span class="line"><span class="meta">#</span> -i 指定生成报告间隔时长</span><br><span class="line"><span class="meta">#</span> -f 指定生成的报告文件名</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 真实测试场景中，建议预热时间不小于5分钟，持续压测时长不小于30分钟，否则测试数据可能不具参考意义</span><br><span class="line"><span class="meta">#</span> 耗时：1800, 即 30分钟</span><br><span class="line">./tpcc_start -h10.10.135.172 -P3306 -dtpcc1000 -uroot -p123456 -w10 -c32 -r300 -l1800 &gt; tpcc_output.txt</span><br></pre></td></tr></table></figure>

<p>top</p>
<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20191119203105.png" alt></p>
<p>vmstat 1</p>
<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20191119203144.png" alt></p>
<p>执行结果</p>
<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20191120101926.png" alt></p>
<br>

<h4 id="5-、分析收集到的状态数据"><a href="#5-、分析收集到的状态数据" class="headerlink" title="5)、分析收集到的状态数据"></a>5)、分析收集到的状态数据</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span> sh 2-system-status-analyzer.sh status_data/5-sec-status-2019-11-19_06-status &gt; status.txt</span><br><span class="line"><span class="meta">$</span> vi status.txt</span><br><span class="line">unix时间戳    时间              系统负载 QPS(数据库)</span><br><span class="line">1574177360 2019-11-19 23:29:20 22.00 37156.60</span><br><span class="line">1574177365 2019-11-19 23:29:25 20.24 36821.80</span><br><span class="line">1574177370 2019-11-19 23:29:30 21.26 36879.80</span><br><span class="line">1574177375 2019-11-19 23:29:35 19.56 37217.60</span><br><span class="line">1574177380 2019-11-19 23:29:40 20.63 37646.80</span><br><span class="line">1574177385 2019-11-19 23:29:45 21.62 35293.20</span><br><span class="line">1574177390 2019-11-19 23:29:50 19.89 36457.80</span><br><span class="line">1574177395 2019-11-19 23:29:55 18.30 37464.00</span><br><span class="line">1574177400 2019-11-19 23:30:00 19.72 36722.60</span><br><span class="line">1574177405 2019-11-19 23:30:05 20.78 37913.60</span><br><span class="line">1574177410 2019-11-19 23:30:10 19.12 36294.00</span><br><span class="line">1574177415 2019-11-19 23:30:15 17.58 35279.20</span><br><span class="line">1574177420 2019-11-19 23:30:20 18.98 39051.20</span><br><span class="line">1574177425 2019-11-19 23:30:25 20.10 37700.20</span><br><span class="line">1574177430 2019-11-19 23:30:30 18.49 37632.20</span><br><span class="line">1574177435 2019-11-19 23:30:35 17.01 38068.00</span><br><span class="line">1574177440 2019-11-19 23:30:40 15.65 38218.40</span><br><span class="line">1574177445 2019-11-19 23:30:45 14.48 34143.40</span><br><span class="line">1574177450 2019-11-19 23:30:50 13.40 7794.60</span><br><span class="line">1574177455 2019-11-19 23:30:55 12.40 7744.80</span><br><span class="line">1574177460 2019-11-19 23:31:00 11.41 613.40</span><br><span class="line">1574177465 2019-11-19 23:31:05 10.50 2.20</span><br><span class="line">1574177470 2019-11-19 23:31:10 9.66 1.40</span><br><span class="line">1574177475 2019-11-19 23:31:15 8.88 1.80</span><br><span class="line">1574177480 2019-11-19 23:31:20 8.17 1.80</span><br><span class="line">1574177485 2019-11-19 23:31:25 7.52 1.80</span><br><span class="line">1574177490 2019-11-19 23:31:30 6.92 2.00</span><br><span class="line">1574177495 2019-11-19 23:31:35 6.36 2.00</span><br><span class="line">1574177500 2019-11-19 23:31:40 5.85 1.60</span><br></pre></td></tr></table></figure>

<p>vi tpcc_output.txt</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line">***************************************</span><br><span class="line">*** ###easy### TPC-C Load Generator ***</span><br><span class="line">***************************************</span><br><span class="line">option h with value '10.10.135.172'</span><br><span class="line">option P with value '3306'</span><br><span class="line">option d with value 'tpcc1000'</span><br><span class="line">option u with value 'root'</span><br><span class="line">option p with value '123456'</span><br><span class="line">option w with value '10'</span><br><span class="line">option c with value '32'</span><br><span class="line">option r with value '300'</span><br><span class="line">option l with value '1800'</span><br><span class="line">&lt;Parameters&gt;</span><br><span class="line">     [server]: 10.10.135.172   -- 主机</span><br><span class="line">     [port]: 3306              -- 端口</span><br><span class="line">     [DBname]: tpcc1000        -- 压测的数据库</span><br><span class="line">       [user]: root            -- 账号</span><br><span class="line">       [pass]: 123456          -- 密码</span><br><span class="line">  [warehouse]: 10              -- 仓库数</span><br><span class="line"> [connection]: 32              -- 并发线程数 </span><br><span class="line">     [rampup]: 300 (sec.)      -- 数据预热时长 </span><br><span class="line">    [measure]: 1800 (sec.)     -- 压测时长</span><br><span class="line"></span><br><span class="line">RAMP-UP TIME.(300 sec.)       --预热结束</span><br><span class="line"></span><br><span class="line">MEASURING START.              --开始压测</span><br><span class="line"></span><br><span class="line">-- 每10秒输出一次压测数据</span><br><span class="line">-- 以逗号分隔，共9列</span><br><span class="line">-- 第1列，第N次10秒</span><br><span class="line">-- 第2列，New-Order在本轮取样时间内成功执行事务的次数(即吞吐量)</span><br><span class="line">-- 第3列，New-Order在本轮取样时间内，95%事务 在响应时间内（ms）完成</span><br><span class="line">-- 第4列，New-Order在本轮取样时间内，99%事务 在响应时间内完成</span><br><span class="line">-- 第5列，New-Order在本轮取样时间内，本轮测试最大响应时间（ms）</span><br><span class="line">-- 第6列，Payment 有效事务数（吞吐量） | 最大响应时间（ms）</span><br><span class="line">-- 第7列，Order-Status 有效事务数（吞吐量） | 最大响应时间（ms）</span><br><span class="line">-- 第8列，Delivery 有效事务数（吞吐量） | 最大响应时间（ms）</span><br><span class="line">-- 第9列，Stock-Level 有效事务数（吞吐量） | 最大响应时间（ms）</span><br><span class="line">  10, trx: 6322, 95%: 58.880, 99%: 80.384, max_rt: 465.298, 6319|311.356, 632|147.998, 633|518.363, 632|840.708</span><br><span class="line">  20, trx: 6402, 95%: 57.161, 99%: 74.165, max_rt: 108.881, 6399|102.155, 640|54.569, 640|187.683, 641|125.100</span><br><span class="line">  30, trx: 6215, 95%: 58.616, 99%: 83.674, max_rt: 240.631, 6224|149.658, 623|135.217, 622|332.418, 621|168.763</span><br><span class="line">  40, trx: 6365, 95%: 57.109, 99%: 76.190, max_rt: 136.020, 6362|140.110, 637|35.815, 637|142.510, 636|154.135</span><br><span class="line">  50, trx: 6426, 95%: 56.973, 99%: 76.281, max_rt: 131.508, 6427|171.652, 641|45.733, 640|145.872, 643|156.595</span><br><span class="line">  60, trx: 6198, 95%: 58.476, 99%: 80.384, max_rt: 229.300, 6197|238.621, 620|37.124, 621|269.572, 619|261.585</span><br><span class="line">  70, trx: 6418, 95%: 57.366, 99%: 76.648, max_rt: 116.301, 6421|115.735, 643|42.165, 643|172.855, 643|151.629</span><br><span class="line">  80, trx: 6406, 95%: 57.815, 99%: 76.877, max_rt: 115.657, 6396|99.119, 639|39.815, 640|152.090, 640|159.341</span><br><span class="line">  90, trx: 5841, 95%: 62.047, 99%: 87.229, max_rt: 290.416, 5836|291.379, 584|42.550, 585|301.866, 584|142.273</span><br><span class="line"> 100, trx: 6168, 95%: 56.362, 99%: 76.717, max_rt: 125.903, 6183|115.971, 618|47.143, 619|158.824, 618|162.145</span><br><span class="line"> 110, trx: 6249, 95%: 57.573, 99%: 78.200, max_rt: 138.199, 6232|126.211, 624|40.234, 623|155.532, 624|152.938</span><br><span class="line"> 120, trx: 6107, 95%: 58.511, 99%: 78.694, max_rt: 121.301, 6125|146.152, 611|37.128, 608|156.622, 609|126.521</span><br><span class="line"> 130, trx: 6076, 95%: 58.424, 99%: 84.227, max_rt: 346.854, 6074|266.228, 608|48.112, 608|361.008, 610|140.032</span><br><span class="line"> 140, trx: 6365, 95%: 55.992, 99%: 75.599, max_rt: 115.579, 6367|110.699, 637|47.943, 637|156.809, 634|126.359</span><br><span class="line">....</span><br><span class="line">1760, trx: 6386, 95%: 56.599, 99%: 74.588, max_rt: 115.095, 6386|103.424, 638|44.586, 640|143.890, 637|139.005</span><br><span class="line">1770, trx: 6148, 95%: 59.039, 99%: 76.510, max_rt: 124.202, 6149|99.945, 615|37.548, 612|152.861, 615|157.265</span><br><span class="line">1780, trx: 5831, 95%: 59.786, 99%: 82.061, max_rt: 291.887, 5826|335.447, 583|47.130, 585|365.992, 583|156.420</span><br><span class="line">1790, trx: 6161, 95%: 57.676, 99%: 78.294, max_rt: 130.952, 6162|132.039, 616|46.349, 616|149.911, 615|173.092</span><br><span class="line">1800, trx: 6164, 95%: 56.295, 99%: 74.098, max_rt: 117.632, 6169|131.690, 616|39.105, 616|202.839, 618|126.449</span><br><span class="line"></span><br><span class="line">STOPPING THREADS................................          -- 结束压测</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 成功(success,简写sc)次数，延迟(late,简写lt)次数，重试(retry,简写rt)次数，失败(failure,简写fl)次数</span><br><span class="line">&lt;Raw Results&gt;                                             -- 第一次统计结果</span><br><span class="line">  [0] sc:35421 lt:1093057  rt:0  fl:0 avg_rt: 30.0 (5)    -- New-Order，新订单业务</span><br><span class="line">  [1] sc:457714 lt:670742  rt:0  fl:0 avg_rt: 15.6 (5)    -- Payment，支付业务统计</span><br><span class="line">  [2] sc:96544 lt:16304  rt:0  fl:0 avg_rt: 3.6 (5)       -- Order-Status，订单状态业务统计</span><br><span class="line">  [3] sc:87922 lt:24927  rt:0  fl:0 avg_rt: 72.5 (80)     -- Delivery，发货业务统计</span><br><span class="line">  [4] sc:1565 lt:111282  rt:0  fl:0 avg_rt: 62.8 (20)     -- Stock-Level，库存业务统计</span><br><span class="line"> in 1800 sec.</span><br><span class="line"></span><br><span class="line">&lt;Raw Results2(sum ver.)&gt;                                  -- 第二次统计结果，其他同上</span><br><span class="line">  [0] sc:35421  lt:1093057  rt:0  fl:0</span><br><span class="line">  [1] sc:457717  lt:670764  rt:0  fl:0</span><br><span class="line">  [2] sc:96544  lt:16304  rt:0  fl:0</span><br><span class="line">  [3] sc:87922  lt:24927  rt:0  fl:0</span><br><span class="line">  [4] sc:1565  lt:111283  rt:0  fl:0</span><br><span class="line"></span><br><span class="line">&lt;Constraint Check&gt; (all must be [OK])     -- 下面所有业务逻辑结果都必须为 OK 才行</span><br><span class="line"> [transaction percentage]</span><br><span class="line">        Payment: 43.48% (&gt;=43.0%) [OK]    -- 支付成功次数(上述统计结果中sc + lt)必须大于43.0%，否则结果为NG，而不是OK</span><br><span class="line">   Order-Status: 4.35% (&gt;= 4.0%) [OK]     --订单状态，其他同上</span><br><span class="line">       Delivery: 4.35% (&gt;= 4.0%) [OK]     -- 发货，其他同上</span><br><span class="line">    Stock-Level: 4.35% (&gt;= 4.0%) [OK]     -- 库存，其他同上</span><br><span class="line"> [response time (at least 90% passed)]    -- 响应耗时指标必须超过90%通过才行</span><br><span class="line">      New-Order: 3.14%  [NG] *            -- 标准5ms，只有3.14% 响应时间合格</span><br><span class="line">        Payment: 40.56%  [NG] *           -- 标准5ms，</span><br><span class="line">   Order-Status: 85.55%  [NG] *           -- 标准5ms，</span><br><span class="line">       Delivery: 77.91%  [NG] *           -- 标准80ms，</span><br><span class="line">    Stock-Level: 1.39%  [NG] *            -- 标准20ms，</span><br><span class="line"></span><br><span class="line">&lt;TpmC&gt;</span><br><span class="line">                 37615.934 TpmC          -- TpmC结果值&#123;每分钟事务数，该值是第一次统计结果中的新订单事务数除以总耗时分钟数，例如本例中是：（35421+1093057）/30 ≈ 37615.93..&#125;；1000tpmC相当于2000个事务；</span><br></pre></td></tr></table></figure>

<blockquote>
<p>tpcc-mysql的业务逻辑及其相关的几个表作用如下：</p>
<ul>
<li>New-Order：新订单，一次完整的订单事务，几乎涉及到全部表</li>
<li>Payment：支付，主要对应 orders、history 表</li>
<li>Order-Status：订单状态，主要对应 orders、order_line 表</li>
<li>Delivery：发货，主要对应 order_line 表</li>
<li>Stock-Level：库存，主要对应 stock 表</li>
</ul>
<p>其它表说明:</p>
<ul>
<li>客户：主要对应 customer 表</li>
<li>地区：主要对应 district 表</li>
<li>商品：主要对应 item 表</li>
<li>仓库：主要对应 warehouse 表</li>
</ul>
</blockquote>
<br>

<h4 id="6-、清理数据"><a href="#6-、清理数据" class="headerlink" title="6)、清理数据"></a>6)、清理数据</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">drop database tpcc1000;</span><br></pre></td></tr></table></figure>

<h4 id="7-、使用gunplot绘图"><a href="#7-、使用gunplot绘图" class="headerlink" title="7)、使用gunplot绘图"></a>7)、使用gunplot绘图</h4><p>① 安装 gunplot</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">yum install -y gnuplot</span><br><span class="line"></span><br><span class="line">gnuplot -V</span><br><span class="line"><span class="meta">#</span> gnuplot 4.6 patchlevel 2</span><br></pre></td></tr></table></figure>

<p>帮助文档： <a href="http://gnuplot.info/docs_4.6/gnuplot.pdf" target="_blank" rel="noopener">http://gnuplot.info/docs_4.6/gnuplot.pdf</a> </p>
<p>② 准备分析脚本和绘图脚本</p>
<p>gunplot-analyze-tpcc.sh</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span>!/bin/bash</span><br><span class="line">TIMESLOT=1</span><br><span class="line"></span><br><span class="line">if [ -n "$2" ]</span><br><span class="line">then</span><br><span class="line">    TIMESLOT=$2</span><br><span class="line">    echo "Defined $2"</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">cat $1 | grep -v HY000 | grep -v payment | grep -v neword | \</span><br><span class="line">awk -v timeslot=$TIMESLOT '\</span><br><span class="line">BEGIN &#123; FS="[,():|]"; s=0; cntr=0; aggr=0 &#125; \</span><br><span class="line">/MEASURING START/ &#123;s=1&#125; \</span><br><span class="line">/STOPPING THREADS/ &#123;s=0&#125; \</span><br><span class="line">/0/ &#123; \</span><br><span class="line">    if (s==1) &#123; cntr++; aggr+=$2; &#125; \</span><br><span class="line">    if (cntr==timeslot ) &#123; printf ("%d %3f %d\n",$1,$5,$3) ; cntr=0; aggr=0  &#125; \</span><br><span class="line">&#125;'</span><br></pre></td></tr></table></figure>

<blockquote>
<p>解释： 把 <code>140, trx: 6365, 95%: 55.992, 99%: 75.599, max_rt: 115.579, 6367|110.699, 637|47.943, 637|156.809, 634|126.359</code>中的 “[,():|]” 字符去掉以后，就剩下了<code>140 trx 6365 95% 55.992 99% 75.599 max_rt 115.579 6367 110.699 637 47.943 637 156.809 634 126.359</code>。$1就是140， $5就是55.992，打印的语法就跟c语言一样</p>
<p>帮助文档：man awk</p>
</blockquote>
<p>③ 对 tpcc-mysql 测试生成的数据文件进行提取</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sh gunplot-analyze-tpcc.sh tpcc_output.txt &gt; tpcc_output_transfer.txt</span><br></pre></td></tr></table></figure>

<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20191120200034.png" alt></p>
<p>④  使用tpcc-graph-build.sh脚本生成图表 </p>
<ul>
<li>画95%的事务响应时间图：gunplot-graph-build-rt.sh</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span>!/bin/bash</span><br><span class="line"><span class="meta">#</span>## goto user homedir and remove previous file</span><br><span class="line">rm -f '$2'</span><br><span class="line">gnuplot &lt;&lt; EOP</span><br><span class="line"><span class="meta">#</span>## set data source file</span><br><span class="line">datafile = '$1'</span><br><span class="line"><span class="meta">#</span>## set graph type and size</span><br><span class="line">set terminal jpeg size 720,640</span><br><span class="line"><span class="meta">#</span>## set titles</span><br><span class="line">set grid x y</span><br><span class="line">set xlabel "Time (sec)"</span><br><span class="line">set ylabel "Response Times(sec)"</span><br><span class="line"><span class="meta">#</span>## set output filename</span><br><span class="line">set output '$2'</span><br><span class="line"><span class="meta">#</span>## build graph</span><br><span class="line"><span class="meta">#</span> plot datafile using 1:2 title "95%-rt" with lines,datafile using 1:3 title "max_rt" with lines axes x1y1</span><br><span class="line">plot datafile using 1:2 title "95%-rt" with lines axes x1y1</span><br><span class="line">EOP</span><br></pre></td></tr></table></figure>

<ul>
<li>画间隔时间内完成的事务数的图：gunplot-graph-build-trx.sh</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span>!/bin/bash</span><br><span class="line"><span class="meta">#</span>## goto user homedir and remove previous file</span><br><span class="line">rm -f '$2'</span><br><span class="line">gnuplot &lt;&lt; EOP</span><br><span class="line"><span class="meta">#</span>## set data source file</span><br><span class="line">datafile = '$1'</span><br><span class="line"><span class="meta">#</span>## set graph type and size</span><br><span class="line">set terminal jpeg size 720,640</span><br><span class="line"><span class="meta">#</span>## set titles</span><br><span class="line">set grid x y</span><br><span class="line">set xlabel "Time (sec)"</span><br><span class="line">set ylabel "Transaction Nums"</span><br><span class="line"><span class="meta">#</span>## set output filename</span><br><span class="line">set output '$2'</span><br><span class="line"><span class="meta">#</span>## build graph</span><br><span class="line"><span class="meta">#</span> plot datafile using 1:2 title "95%-rt" with lines,datafile using 1:3 title "max_rt" with lines axes x1y1</span><br><span class="line">plot datafile using 1:3 title "Transaction Nums" with lines axes x1y1</span><br><span class="line">EOP</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sh gunplot-graph-build-rt.sh tpcc_output_transfer.txt tpcc_output.jpg</span><br></pre></td></tr></table></figure>

<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20191120200505.png" alt></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sh gunplot-graph-build-trx.sh tpcc_output_transfer.txt tpcc_output.jpg</span><br></pre></td></tr></table></figure>

<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20191120200955.png" alt></p>
<br>

<h1 id="五、mysql性能调优"><a href="#五、mysql性能调优" class="headerlink" title="五、mysql性能调优"></a>五、mysql性能调优</h1><p>可以看到tpcc-mysql基准测试中 rt项全部不合格，所以需要对mysql进行性能调优</p>
<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20191120134255.png" alt></p>
<br>


          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://carlo-z.com/linux/linux-cache-and-buffer/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Focus-1">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Focus-1">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/linux/linux-cache-and-buffer/" itemprop="url">Centos7 管理 buff/cache 方法</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-11-17T00:00:00+08:00">
                2019-11-17
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/linux/" itemprop="url" rel="index">
                    <span itemprop="name">linux</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <hr>
<br>

<h1 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h1><p>　　Linux服务器运行一段时间后，由于其内存管理机制，会将暂时不用的内存转为buff/cache，这样在程序使用到这一部分数据时，能够很快的取出，从而提高系统的运行效率，所以这也正是linux内存管理中非常出色的一点，所以乍一看内存剩余的非常少，但是在程序真正需要内存空间时，linux会将缓存让出给程序使用，这样达到对内存的最充分利用，所以真正剩余的内存是free+buff/cache</p>
<p>　　但是有些时候大量的缓存占据空间，这时候应用程序回去使用swap交换空间，从而使系统变慢，这时候需要手动去释放内存，释放内存的时候，首先执行命令 <code>sync 将所有正在内存中的缓冲区写到磁盘中，其中包括已经修改的文件inode、已延迟的块I/O以及读写映射文件，从而确保文件系统的完整性</code></p>
<br>

<h1 id="linux机制"><a href="#linux机制" class="headerlink" title="linux机制"></a>linux机制</h1><p>　　说到清理内存，那么不得不提到/proc这一个虚拟文件系统，这里面的数据和文件都是内存中的实时数据，很多参数的获取都可以从下面相应的文件中得到，比如查看某一进程占用的内存大小和各项参数，cpu和主板的详细信息，显卡的参数等等；相应的关于内存的管理方式是在/proc/sys/vm/drop_chches文件中，一定要注意这个文件中存放的并不是具体的内存内容，而是0-3这几个数字，通过文件大小只有1B也可以知道，而这些代号分别告诉系统代表不同的含义如下：</p>
<ul>
<li>0：0是系统默认值，默认情况下表示不释放内存，由操作系统自动管理</li>
<li>1：释放页缓存</li>
<li>2：释放dentries和inodes</li>
<li>3：释放所有缓存</li>
</ul>
<p>　　所以根据上面的说明，分别将1,2,3这3个数字重定向到drop_caches中可以实现内存的释放，一般释放内存都是重定向3到文件中，释放所有的缓存</p>
<br>

<h1 id="使用方法"><a href="#使用方法" class="headerlink" title="使用方法"></a>使用方法</h1><p>那么下面举个例子，比如这里只释放页缓存，首先使用</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">free -m</span><br></pre></td></tr></table></figure>

<p>查看当前内存剩余</p>
<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20191117173637.png" alt></p>
<p>当前内存剩余570M左右，另外buff/cache是1.3G，根据上面说的现在真正的剩余内存应该是1.8G左右，首先写缓存到文件系统：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sync</span><br></pre></td></tr></table></figure>

<p>然后执行下面命令释放内存(页缓存buff/cache)：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo 1 &gt; /proc/sys/vm/drop_caches</span><br></pre></td></tr></table></figure>

<p>执行完之后，再次查看内存剩余：</p>
<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20191117173925.png" alt></p>
<p>会发现内存被释放了，可用内存确实变为1.5G左右</p>
<p>　　到这里内存就释放完了，现在drop_caches中的值为1，如果现在想让操作系统重新分配内存，那么设置drop_caches的值为0即可：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo 0 &gt; /proc/sys/vm/drop_caches</span><br></pre></td></tr></table></figure>

<p><strong>但是我走到这里报错，从0可以设置为1-3 ，但是不能设置为0了。一直没有找到原因，最后直接重启服务器了，然后开机之后自己恢复成0了。</strong></p>
<p><strong>所以命令慎用！！！</strong></p>
<p>另外需要注意的是，在生产环境中的服务器我们不要频繁的去释放内存，只在必要时候清理内存即可，更重要的是我们应该从应用程序层面去优化内存的利用和释放，经常清理内存可能只是暂时屏蔽的应用程序中的一些bug，所以更重要的是程序的调优，其他的交给操作系统来管理</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://carlo-z.com/computer-network/keepalived-vrrp/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Focus-1">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Focus-1">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/computer-network/keepalived-vrrp/" itemprop="url">keepalived+ip组播</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-11-14T00:00:00+08:00">
                2019-11-14
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/computer-network/" itemprop="url" rel="index">
                    <span itemprop="name">computer-network</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/computer-network/keepalived/" itemprop="url" rel="index">
                    <span itemprop="name">keepalived</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <hr>
<br>

<h1 id="开启ip组播"><a href="#开启ip组播" class="headerlink" title="开启ip组播"></a>开启ip组播</h1><h3 id="centos7"><a href="#centos7" class="headerlink" title="centos7"></a>centos7</h3><h3 id="centos6"><a href="#centos6" class="headerlink" title="centos6"></a>centos6</h3><h1 id="keepalived安装配置"><a href="#keepalived安装配置" class="headerlink" title="keepalived安装配置"></a>keepalived安装配置</h1><p>2台主机</p>
<table>
<thead>
<tr>
<th>server</th>
<th>hostname</th>
<th>ip</th>
</tr>
</thead>
<tbody><tr>
<td>keepalived</td>
<td>ka1</td>
<td>192.168.99.103</td>
</tr>
<tr>
<td>keepalived</td>
<td>ka2</td>
<td>192.168.99.104</td>
</tr>
</tbody></table>
<hr>
<h3 id="1、2台分别安装keepalived"><a href="#1、2台分别安装keepalived" class="headerlink" title="1、2台分别安装keepalived"></a>1、2台分别安装keepalived</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">[ka1]$</span> yum -y install keepalived</span><br><span class="line"><span class="meta">[ka2]$</span> yum -y install keepalived</span><br></pre></td></tr></table></figure>

<h3 id="2、修改ka1的配置"><a href="#2、修改ka1的配置" class="headerlink" title="2、修改ka1的配置"></a>2、修改ka1的配置</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">[ka1]#</span> vim /etc/keepalived/keepalived.conf</span><br><span class="line">! Configuration File for keepalived</span><br><span class="line"></span><br><span class="line">global_defs &#123;</span><br><span class="line">   notification_email &#123;</span><br><span class="line">       root@localhost</span><br><span class="line">   &#125;</span><br><span class="line">   notification_email_from root@localhost</span><br><span class="line">   smtp_server 127.0.0.1</span><br><span class="line">   smtp_connect_timeout 30</span><br><span class="line">   router_id ka1</span><br><span class="line">   vrrp_skip_check_adv_addr</span><br><span class="line">   vrrp_strict</span><br><span class="line">   vrrp_iptables</span><br><span class="line">   vrrp_mcast_group4 224.100.100.100   #不写默认是224.0.0.18</span><br><span class="line">   vrrp_garp_interval 0</span><br><span class="line">   vrrp_gna_interval 0</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state MASTER</span><br><span class="line">    interface eth0</span><br><span class="line">    virtual_router_id 11</span><br><span class="line">    priority 100</span><br><span class="line">    advert_int 1</span><br><span class="line">    #nopreempt   #非抢占模式，当优先级更高的主机上线时，不会抢占为主服务器</span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass 123</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        192.168.0.100 dev eth0 label eth0:1</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3、修改ka2的配置"><a href="#3、修改ka2的配置" class="headerlink" title="3、修改ka2的配置"></a>3、修改ka2的配置</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">! Configuration File for keepalived</span><br><span class="line"></span><br><span class="line">global_defs &#123;</span><br><span class="line">   notification_email &#123;</span><br><span class="line">       root@localhost</span><br><span class="line">   &#125;</span><br><span class="line">   notification_email_from root@localhost</span><br><span class="line">   smtp_server 127.0.0.1</span><br><span class="line">   smtp_connect_timeout 30</span><br><span class="line">   router_id ka2</span><br><span class="line">   vrrp_skip_check_adv_addr</span><br><span class="line">   vrrp_strict</span><br><span class="line">   vrrp_iptables</span><br><span class="line">   vrrp_mcast_group4 224.100.100.100   #不写默认是224.0.0.18</span><br><span class="line">   vrrp_garp_interval 0</span><br><span class="line">   vrrp_gna_interval 0</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state BACKUP</span><br><span class="line">    interface eth0</span><br><span class="line">    virtual_router_id 11</span><br><span class="line">    priority 80</span><br><span class="line">    advert_int 1</span><br><span class="line">    #nopreempt   #非抢占模式，当优先级更高的主机上线时，不会抢占为主服务器</span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass 123</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        192.168.0.100 dev eth0 label eth0:1</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="4、在ka1或ka2新开个终端准备抓包"><a href="#4、在ka1或ka2新开个终端准备抓包" class="headerlink" title="4、在ka1或ka2新开个终端准备抓包"></a>4、在ka1或ka2新开个终端准备抓包</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">[ka1]$</span> tcpdump -i eth0 -nn net 224.100.100.100</span><br><span class="line"></span><br><span class="line">tcpdump: verbose output suppressed, use -v or -vv for full protocol decode</span><br><span class="line">listening on eth0, link-type EN10MB (Ethernet), capture size 262144 bytes</span><br></pre></td></tr></table></figure>

<p>5、启动ka2的keepalived(先启动backup)</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">[ka2]$</span> systemctl restart keepalived</span><br></pre></td></tr></table></figure>

<p>抓到包了。</p>
<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20200114223152.png" alt></p>
<p>VIP绑定上了</p>
<h3 id="6、再启动ka1的keepalived-注意看抓包"><a href="#6、再启动ka1的keepalived-注意看抓包" class="headerlink" title="6、再启动ka1的keepalived(注意看抓包)"></a>6、再启动ka1的keepalived(注意看抓包)</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">[ka1]$</span> systemctl start keepalived</span><br></pre></td></tr></table></figure>

<p>可以看到，宣告的IP变成了ka1的了</p>
<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20200114223237.png" alt></p>
<p>VIP漂移到ka1了，因为ka1的优先级比ka2高</p>
<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20200114223253.png" alt></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/3/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/3/">3</a><span class="page-number current">4</span><a class="page-number" href="/page/5/">5</a><span class="space">&hellip;</span><a class="page-number" href="/page/25/">25</a><a class="extend next" rel="next" href="/page/5/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">Focus-1</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">250</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">63</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">102</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          

          
          

          
          
            <div class="links-of-blogroll motion-element links-of-blogroll-block">
              <div class="links-of-blogroll-title">
                <i class="fa  fa-fw fa-link"></i>
                Links
              </div>
              <ul class="links-of-blogroll-list">
                
                  <li class="links-of-blogroll-item">
                    <a href="https://gitee.com/carloz" title="repository - https://gitee.com/carloz" target="_blank">repository - https://gitee.com/carloz</a>
                  </li>
                
              </ul>
            </div>
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2015 &mdash; <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Focus-1</span>

  
</div>








  <div class="footer-custom">Hosted by <a target="_blank" href="https://gitee.com/carloz">Gitee Repo</a></div>


        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  
  

  
  
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
          processEscapes: true,
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
      });
    </script>

    <script type="text/x-mathjax-config">
      MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
        }
      });
    </script>
    <script type="text/javascript" src="//cdn.bootcss.com/mathjax/2.7.1/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
  


  

  

</body>
</html>
