<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">




  
  
  
  

  
    
    
  

  

  

  
    
      
    

    
  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=consolas:300,300italic,400,400italic,700,700italic|Lobster Two:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT">










<meta name="keywords" content="Java Kafka Docker JVM NIO Netty">
<meta property="og:type" content="website">
<meta property="og:title" content="Focus-1">
<meta property="og:url" content="https://carlo-z.com/page/6/index.html">
<meta property="og:site_name" content="Focus-1">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Focus-1">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"left","display":"always","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://carlo-z.com/page/6/">





  <title>Focus-1</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Focus-1</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br>
            
            关于
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://carlo-z.com/computer-network/simulated-network-delay-loss-interrupt/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Focus-1">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Focus-1">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/computer-network/simulated-network-delay-loss-interrupt/" itemprop="url">linux 模拟  网络延迟、网络丢包、网络中断</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-07-20T14:17:09+08:00">
                2019-07-20
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/linux/" itemprop="url" rel="index">
                    <span itemprop="name">linux</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/linux/centos7/" itemprop="url" rel="index">
                    <span itemprop="name">centos7</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <hr>
<p>昨天，笔者讲述了如何将CPU和IO撑满，这个其实很好理解，写个CPU密集型的程序让CPU忙个不停就可以撑满CPU；弄个程序一直写就可以让IO也撑满。有兴趣的同学可以看下昨天的这篇文章《<a href="http://mp.weixin.qq.com/s?__biz=MzU0MzQ5MDA0Mw==&mid=2247486457&idx=2&sn=e4cf6bfdbb0c8dd40fb8b4df747c5771&chksm=fb0be16dcc7c687b721516784a041358ccbc8aa77c94bea2d8028945151fe1ebc083d5ea055d&scene=21#wechat_redirect" target="_blank" rel="noopener">看我如何作死 | 将CPU、IO撑满</a>》，不过里面的做法分别是使用openssl speed和linux dd工具来实现这两个功能。</p>
<p>面对CPU和IO时，相信大家都能很快的反应出如何实现，那么面对网络问题时，大家的反应又是如何呢？不会是拔网线吧。。。</p>
<p>在故障注入，或者说故障演练，甚至说混沌工程中，可以设计很多类型的故障，今天要介绍的就是网络故障。</p>
<blockquote>
<p>混沌系统是在分布式系统上进行实验的学科，目的是建立对系统抵御生产环境中失控条件的能力以及信心。</p>
</blockquote>
<p>在复杂的网络环境下，数据包发送和接收的时间间隔或长或短。在网络状况较差时，调用下游服务时可能要过很久才能收到返回，这时服务的反应如何，直接关系到稳定性与高可用。</p>
<p>我们这里索要模拟的网络故障有三类，分别是：网络延时、网络中断以及网络丢包。</p>
<p>​    </p>
<h2 id="一、tc工具介绍"><a href="#一、tc工具介绍" class="headerlink" title="一、tc工具介绍"></a>一、tc工具介绍</h2><p>笔者也不卖关子，本文模拟的网络故障是通过linux的tc工具来实现的。Linux内核网络协议栈从2.2.x开始，就实现了对服务质量的支持模块。具体的代码位于net/sched/目录。在Linux里面，对这个功能模块的称呼是Traffic Control ,简称TC。TC是一个在上层协议处添加Qos功能的工具，原理上看，它实质是专门供用户利用内核Qos调度模块去定制Qos的中间件。</p>
<p>Linux操作系统中的流量控制器TC（Traffic Control）用于Linux内核的流量控制，主要是通过在输出端口处建立一个队列来实现流量控制。</p>
<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20190824210656.png" alt></p>
<p>接收包从输入接口（Input Interface）进来后，经过流量限制（Ingress Policing）丢弃不符合规定的数据包，由输入多路分配器（Input De-Multiplexing）进行判断选择：如果接收包的目的是本主机，那么将该包送给上层处理；否则需要进行转发，将接收包交到转发块（Forwarding Block）处理。转发块同时也接收本主机上层（TCP、UDP等）产生的包。转发块通过查看路由表，决定所处理包的下一跳。然后，对包进行排列以便将它们传送到输出接口（Output Interface）。一般我们只能限制网卡发送的数据包，不能限制网卡接收的数据包，所以我们可以通过改变发送次序来控制传输速率。Linux流量控制主要是在输出接口排列时进行处理和实现的。</p>
<p>tc工具的语法还是很复杂的，笔者（微信公众号：朱小厮的博客）试图想要在本文中详细的讲解一下tc的用法，最后还是放弃了，篇幅太长，难以穷尽。所以本文中只是针对前面说的三种故障简单的演示一下tc的用法以及对应故障的实现方式，希望能够能大家有个小小的印象。如果以后遇到类似问题，或者说对这个东西感兴趣，可以再深度的学习一下。</p>
<p>​    </p>
<h2 id="二、paping工具介绍"><a href="#二、paping工具介绍" class="headerlink" title="二、paping工具介绍"></a>二、paping工具介绍</h2><p>在正式介绍如何模拟网络故障之前，还要介绍一个工具来查看模拟的效果如何。</p>
<p>通常我们测试数据包能否通过IP协议到达特定主机，都习惯使用Ping命令，工作时发送一个ICMP Echo，等待接受Echo响应，但是Ping使用的是ICMP协议，如果防火墙放通了此协议，依旧能够ping通，但是无法确定通过tcp传送的数据包是否正常到达对端。</p>
<p>而paping可以在Linux平台上测试网络的连通性及网络延时等。它的用法很简单:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">-p, --port N 指定被测试服务的 TCP 端口（必须）；</span><br><span class="line">--nocolor 屏蔽彩色输出；</span><br><span class="line">-t, --timeout 指定超时时长，单位为毫秒，默认值为 1000；</span><br><span class="line">-c, --count N 指定测试次数。</span><br></pre></td></tr></table></figure>

<p>比如下面的示例（记得先要开启一个以80为端口的服务, 示例中的xxx.xxx.xxx.xxx代表ip地址）:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">hidden@hidden$</span> ./paping -p 80 -c 5 xxx.xxx.xxx.xxx</span><br><span class="line">paping v1.5.5 - Copyright (c) 2011 Mike Lovell</span><br><span class="line"></span><br><span class="line">Connecting to xxx.xxx.xxx.xxx on TCP 80:</span><br><span class="line"></span><br><span class="line">Connected to xxx.xxx.xxx.xxx: time=27.47ms protocol=TCP port=80</span><br><span class="line">Connected to xxx.xxx.xxx.xxx: time=97.83ms protocol=TCP port=80</span><br><span class="line">Connected to xxx.xxx.xxx.xxx: time=37.38ms protocol=TCP port=80</span><br><span class="line">Connected to xxx.xxx.xxx.xxx: time=57.62ms protocol=TCP port=80</span><br><span class="line">Connected to xxx.xxx.xxx.xxx: time=71.87ms protocol=TCP port=80</span><br><span class="line"></span><br><span class="line">Connection statistics:</span><br><span class="line">    Attempted = 5, Connected = 5, Failed = 0 (0.00%)</span><br><span class="line">Approximate connection times:</span><br><span class="line">    Minimum = 27.47ms, Maximum = 97.83ms, Average = 58.43ms</span><br></pre></td></tr></table></figure>

<p>可以看到平均链接时间为58.43ms。</p>
<p>如果你的机器上没有安装paping，那么可以采用如下的方式安装：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">wget https://storage.googleapis.com/google-code-archive-downloads/v2/code.google.com/paping/paping_1.5.5_x86_linux.tar.gz</span><br><span class="line">tar -zvxf paping_1.5.5_x86_linux.tar.gz</span><br><span class="line"> ./paping -p 80 -c 5000 www.baidu.com</span><br></pre></td></tr></table></figure>

<p>如果有以下的错误：</p>
<p>./paping: error while loading shared libraries: libstdc++.so.6: cannot open shared object file: No such file or directory</p>
<p>可以先安装对应的库来解决：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install libstdc++6</span><br><span class="line">sudo apt-get install lib32stdc++6</span><br></pre></td></tr></table></figure>

<p>​    </p>
<h2 id="三、模拟网络延时"><a href="#三、模拟网络延时" class="headerlink" title="三、模拟网络延时"></a>三、模拟网络延时</h2><p>使用tc命令模拟延迟300ms（对应的删除命令为tc qdisc del dev eth0 root netem）：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"> tc qdisc add dev eth0 root netem delay 300ms</span><br><span class="line">// 该命令将网卡eth0的传输设置为延迟300ms发送</span><br></pre></td></tr></table></figure>

<p>此时再次执行paping命令:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">hidden@hidden$</span> ./paping -p 80 -c 5 xxx.xxx.xxx.xxx</span><br><span class="line">paping v1.5.5 - Copyright (c) 2011 Mike Lovell</span><br><span class="line"></span><br><span class="line">Connecting to xxx.xxx.xxx.xxx on TCP 80:</span><br><span class="line"></span><br><span class="line">Connected to xxx.xxx.xxx.xxx : time=326.11ms protocol=TCP port=80</span><br><span class="line">Connected to xxx.xxx.xxx.xxx : time=417.02ms protocol=TCP port=80</span><br><span class="line">Connected to xxx.xxx.xxx.xxx : time=326.94ms protocol=TCP port=80</span><br><span class="line">Connected to xxx.xxx.xxx.xxx : time=326.19ms protocol=TCP port=80</span><br><span class="line">Connected to xxx.xxx.xxx.xxx : time=353.51ms protocol=TCP port=80</span><br><span class="line"></span><br><span class="line">Connection statistics:</span><br><span class="line">    Attempted = 5, Connected = 5, Failed = 0 (0.00%)</span><br><span class="line">Approximate connection times:</span><br><span class="line">    Minimum = 326.11ms, Maximum = 417.02ms, Average = 349.95ms</span><br></pre></td></tr></table></figure>

<p>与之前的58.43ms相比相差了291.52ms ≈ 300ms。</p>
<p>更真实的情况下，延迟值不会这么精确，会有一定的波动，我们可以用下面的情况来模拟出带有波动性的延迟值：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">tc qdisc add dev eth0 root netem delay 300ms 50ms</span><br><span class="line">//该命令将 eth0 网卡的传输设置为延迟 300ms ± 50ms (250 ~ 350 ms 之间的任意值)发送</span><br></pre></td></tr></table></figure>

<p>​     </p>
<h2 id="四、模拟网络中断"><a href="#四、模拟网络中断" class="headerlink" title="四、模拟网络中断"></a>四、模拟网络中断</h2><p>这次使用如下的命令：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">tc qdisc add dev eth0 root netem corrupt 10%</span><br><span class="line">//该命令将 eth0 网卡的传输设置为随机产生 10% 的损坏的数据包</span><br></pre></td></tr></table></figure>

<p>此时再次执行paping命令:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./paping -p 80 -c 100 xxx.xxx.xxx.xxx</span><br></pre></td></tr></table></figure>

<p>注意这里的次数改成了100，为了更能清楚的看到中断的实际效果。</p>
<p>运行这个命令的过程中，会有“Connection timed out”字样报出，类似：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&lt;snip&gt;</span><br><span class="line">Connected to xxx.xxx.xxx.xxx: time=26.26ms protocol=TCP port=80</span><br><span class="line">Connection timed out</span><br><span class="line">Connected to xxx.xxx.xxx.xxx: time=65.10ms protocol=TCP port=80</span><br><span class="line">Connection timed out</span><br><span class="line">Connected to xxx.xxx.xxx.xxx: time=26.50ms protocol=TCP port=80</span><br><span class="line">Connected to xxx.xxx.xxx.xxx: time=25.93ms protocol=TCP port=80</span><br><span class="line">Connected to xxx.xxx.xxx.xxx: time=27.71ms protocol=TCP port=80</span><br><span class="line">&lt;snip&gt;</span><br></pre></td></tr></table></figure>

<p>最终的统计结果如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Connection statistics:</span><br><span class="line">    Attempted = 100, Connected = 90, Failed = 10 (10.00%)</span><br><span class="line">Approximate connection times:</span><br><span class="line">    Minimum = 25.67ms, Maximum = 133.77ms, Average = 51.98ms</span><br></pre></td></tr></table></figure>

<p>结果显而易见，验证了此次故障模拟所对应的效果。</p>
<p>​    </p>
<h2 id="五、模拟网络丢包"><a href="#五、模拟网络丢包" class="headerlink" title="五、模拟网络丢包"></a>五、模拟网络丢包</h2><p>使用如下命令：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">tc qdisc add dev eth0 root netem loss 7% 25%</span><br><span class="line">//该命令将 eth0 网卡的传输设置为随机丢掉 7% 的数据包, 成功率为 25% </span><br><span class="line">//如果不加上后面的25%，那么一丝就是随机丢掉7%的数据包</span><br></pre></td></tr></table></figure>

<p>再次执行paping命令时，也会有Connection timed out报出，最终的统计结果如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Connection statistics:</span><br><span class="line">    Attempted = 100, Connected = 99, Failed = 1 (1.00%)</span><br><span class="line">Approximate connection times:</span><br><span class="line">    Minimum = 25.80ms, Maximum = 133.87ms, Average = 60.94ms</span><br></pre></td></tr></table></figure>

<p>7%*25%的值在1%-2%之间，符合测试的结果预期。</p>
<p>tc还可以模拟一些其它的网络故障，比如网络包重复、网络包错序等等，有兴趣的同学可以继续深入了解一下。</p>
<p>​    </p>
<h2 id="六、引申混沌工程和传统测试之间的区别"><a href="#六、引申混沌工程和传统测试之间的区别" class="headerlink" title="六、引申混沌工程和传统测试之间的区别"></a>六、引申混沌工程和传统测试之间的区别</h2><p>很多同学在进行一些故障测试的时候，会认为其正在进行混沌实验，其实混沌工程和传统的测试之间是有区别的。</p>
<p>混沌工程和传统测试（故障注入FIT、故障测试）在关注点和工具集上都有很大的重叠。譬如，在Netflix（如果还不知道Netflix是谁，可以先看看这篇《<a href="http://mp.weixin.qq.com/s?__biz=MzU0MzQ5MDA0Mw==&mid=2247486380&idx=2&sn=55b15a061093871fe736ad1af9dbd0b4&chksm=fb0be138cc7c682e22f3f895c1dcd900a51d93480d802e64f5e1b80bbe62c5f423737e7f3b9a&scene=21#wechat_redirect" target="_blank" rel="noopener">明星公司之Netflix</a>》了解一下）的很多混沌工程实验研究的对象都是基于故障注入来引入的。混沌工程和这些传统测试方法的主要区别在于：混沌工程是发现新信息的实践过程，而故障注入则是对一个特定的条件、变量的验证方法。</p>
<p>当你希望探究复杂系统如何应对异常时，对系统中的服务注入通信故障（如超时、错误等）不失为一种很好的方法。但有时我们希望探究更多其他的非故障类的场景，如流量激增、资源竞争条件、拜占庭故障（例如性能差或有异常的节点发出有错误的响应、异常的行为、对调用者随机性的返回不同的响应，等等）、非计划中的或非正常组合的消息处理等等。因为如果一个面向公众用户的网站突然收到激增的流量，从而产生更多的收入时我们很难称之为故障，但我们仍然需要探究清楚系统在这种情况下的影响。</p>
<p>和故障注入类似，故障测试方法通过对预先设想到的可以破坏系统的点进行测试，但是并没能去探究上述这类更广阔领域里的、不可预知的、但很可能发生的事情。</p>
<p>在传统测试中，我们可以写一个断言（assertion），即我们给定一个特定的条件，产生一个特定的输出。测试一般来说只会产生二元的结果，验证一个结果是真还是假，从而判定测试是否通过。严格意义上来说，这个过程并不能让我们发掘出对于系统未知的、尚不明确的认知，它仅仅是对我们已知的系统属性可能的取值进行测验。而实验可以产生新的认知，而且通常还能开辟出一个更广袤的对复杂系统的认知空间。</p>
<p>混沌工程是一种帮助我们获得更多的关于系统的新认知的实验方法。它和已有的功能测试、集成测试等以测试已知属性的方法有本质上的区别。</p>
<p>​    </p>
<h2 id="七、后续"><a href="#七、后续" class="headerlink" title="七、后续"></a>七、后续</h2><p>后面还会有几篇相同主题的文章发出，不出意外，下一篇应该是《怎么让进程假死》，如果有兴趣的话，可以持续关注本公众号（朱小厮的博客）。如果你还有有什么需要进一步了解的可以在下方留言，或者也聊聊你对这一块的认知和想法。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://carlo-z.com/devops/k8s/rancher2-docker-install/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Focus-1">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Focus-1">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/devops/k8s/rancher2-docker-install/" itemprop="url">Rancher 2.x docker安装</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-07-12T00:00:00+08:00">
                2019-07-12
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/devops/" itemprop="url" rel="index">
                    <span itemprop="name">devops</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/devops/rancher/" itemprop="url" rel="index">
                    <span itemprop="name">rancher</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <br>

<blockquote>
<p>中文文档：<a href="https://docs.rancher.cn/rancher2x/" target="_blank" rel="noopener">https://docs.rancher.cn/rancher2x/</a></p>
<p><a href="https://rancher2.docs.rancher.cn/docs/releases/v2.4.5/" target="_blank" rel="noopener">https://rancher2.docs.rancher.cn/docs/releases/v2.4.5/</a></p>
</blockquote>
<h1 id="安装-Docker"><a href="#安装-Docker" class="headerlink" title="安装 Docker"></a>安装 Docker</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl https://releases.rancher.com/install-docker/18.09.sh | sh</span><br></pre></td></tr></table></figure>

<p>要了解某个 Docker 版本是否有可用的安装脚本，请参考这个<a href="https://github.com/rancher/install-docker" target="_blank" rel="noopener">GitHub 仓库</a>，这里包含了 Rancher 的所有 Docker 安装脚本。</p>
<h1 id="安装-Rancher-2-x"><a href="#安装-Rancher-2-x" class="headerlink" title="安装 Rancher 2.x"></a>安装 Rancher 2.x</h1><p>首先连接到主机，然后使用 shell 安装 Rancher。</p>
<ol>
<li><p>使用 shell 工具（如 PuTTy 或其他连接工具）登录 Linux 主机。</p>
</li>
<li><p>执行以下命令：</p>
</li>
</ol>
<p>   sudo docker run -d –restart=unless-stopped -p 80:80 -p 443:443 rancher/rancher</p>
<p><strong>结果：</strong> Rancher 已经安装在了 Linux 主机上。</p>
<h1 id="登录-Rancher-界面并配置初始设置"><a href="#登录-Rancher-界面并配置初始设置" class="headerlink" title="登录 Rancher 界面并配置初始设置"></a>登录 Rancher 界面并配置初始设置</h1><p>您需要先登录 Rancher，然后再开始使用 Rancher。登录以后，您需要完成一些一次性的配置。</p>
<ol>
<li><p>打开浏览器，输入主机的 IP 地址：<code>https://&lt;SERVER_IP&gt;</code></p>
<p>请使用真实的主机 IP 地址替换 <code>&lt;SERVER_IP&gt;</code> 。</p>
</li>
<li><p>首次登录时，请按照页面提示设置登录密码。</p>
</li>
<li><p>设置 <strong>Rancher Server URL</strong>。URL 既可以是一个 IP 地址，也可以是一个主机名称。请确保您在集群内添加的每个节点都可以连接到这个 URL。如果您使用的是主机名称，请保证主机名称可以被节点的 DNS 服务器成功解析。</p>
</li>
</ol>
<p><strong>结果：</strong>完成 Rancher 管理员用户的密码设置和访问地址设置。下次使用 Rancher 时，可以输入 IP 地址或主机地址访问 Rancher 界面，然后输入管理员用户名<code>admin</code>和您设置的密码登录 Rancher 界面。</p>
<blockquote>
<p><a href="https://local-rancher/" target="_blank" rel="noopener">https://local-rancher/</a></p>
<p>设置密码：admin/123456</p>
</blockquote>
<h1 id="创建业务集群"><a href="#创建业务集群" class="headerlink" title="创建业务集群"></a>创建业务集群</h1><p>完成安装和登录 Rancher 的步骤之后，您现在可以参考以下步骤，在 Rancher 中创建第一个 Kubernetes 集群。</p>
<p>在这个任务中，您可以使用<strong>自定义集群</strong>选项，使用的<strong>任意</strong> Linux 主机（云主机、虚拟机或裸金属服务器）创建集群。</p>
<ol>
<li>访问<strong>集群</strong>页面，单击<strong>添加集群</strong>。</li>
<li>选择<strong>自定义</strong>选项。</li>
<li>输入<strong>集群名称</strong>。</li>
<li>跳过<strong>集群角色</strong>和<strong>集群选项</strong>。</li>
<li>单击<strong>下一步</strong>。</li>
<li>勾选<strong>主机选项 - 角色选择</strong>中的所有角色： <strong>Etcd</strong>、 <strong>Control</strong> 和 <strong>Worker</strong>。</li>
<li><strong>可选：</strong> Rancher 会自动探查用于 Rancher 通信和集群通信的 IP 地址。您可以通过<strong>主机选项 &gt; 显示高级选项</strong>中的<code>公网地址</code>和<code>内网地址</code>指定 IP 地址。</li>
<li>跳过<strong>主机标签</strong>参数，因为对快速入门来说，这部分的参数不太重要。</li>
<li>复制代码框中的命令。</li>
<li>登录您的 Linux 主机，打开命令行工具，粘贴命令，单击回车键运命令。</li>
<li>运行完成后，回到 Rancher 界面，单击<strong>完成</strong>。</li>
</ol>
<p><strong>结果：</strong> 在 Rancher 中创建了一个 Kubernetes 集群。</p>
<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20200709022046.png" alt></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo docker run -d --privileged --restart=unless-stopped --net=host -v /etc/kubernetes:/etc/kubernetes -v /var/run:/var/run rancher/rancher-agent:v2.4.5 --server https://local-rancher --token htxp8hrk95jjghg74zngg2j8bj2bkwxc9s7rxcv7dgs7lx42lddd9f --ca-checksum 7fb6276d3eefaf30a82c9dd0a40e0d1118863a640f37939fd5b168aa6392e7dc --etcd --controlplane --worker</span><br></pre></td></tr></table></figure>

<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20200712203348.png" alt></p>
<h1 id="部署带有-Ingress-的工作负载"><a href="#部署带有-Ingress-的工作负载" class="headerlink" title="部署带有 Ingress 的工作负载"></a>部署带有 Ingress 的工作负载</h1><h2 id="先决条件"><a href="#先决条件" class="headerlink" title="#先决条件"></a><a href="https://rancher2.docs.rancher.cn/docs/quick-start-guide/workload/quickstart-deploy-workload-ingress/_index#先决条件" target="_blank" rel="noopener">#</a>先决条件</h2><p>已经有一个正在运行的集群，且集群中有至少一个节点</p>
<h2 id="部署工作负载"><a href="#部署工作负载" class="headerlink" title="#部署工作负载"></a><a href="https://rancher2.docs.rancher.cn/docs/quick-start-guide/workload/quickstart-deploy-workload-ingress/_index#部署工作负载" target="_blank" rel="noopener">#</a>部署工作负载</h2><p>参考前文完成 <a href="https://rancher2.docs.rancher.cn/docs/quick-start-guide/deployment/_index" target="_blank" rel="noopener">Rancher Server 的快速部署</a>后，您可以创建 <em>工作负载</em>。工作负载即 Kubernetes 对一组 Pod 的抽象模型，用于描述业务的运行载体，包括 Deployment、Statefulset、Daemonset、Job、CronJob 等多种类型，详情请参考<a href="https://rancher2.docs.rancher.cn/docs/overview/glossary/_index" target="_blank" rel="noopener">名词解释</a>。</p>
<p>以下步骤讲解了如何在 Rancher Server 中部署带有 Ingress 的工作负载。本文部署的工作负载是一个“Hello-World”应用。</p>
<ol>
<li><p>访问<strong>集群</strong>页面，选择您刚刚创建的集群，进入集群页面。</p>
</li>
<li><p>从集群页面的主菜单中选择<strong>项目/命名空间</strong>。</p>
</li>
<li><p>打开 <strong>项目：Default</strong>。</p>
</li>
<li><p>单击<strong>资源 &gt; 工作负载</strong>。如果您使用的是 v2.3.0 之前的版本，请单击 <strong>工作负载 &gt; 工作负载</strong>。</p>
</li>
<li><p>单击<strong>部署</strong>。</p>
<p><strong>结果：</strong> 打开<strong>部署工作负载</strong> 页面。</p>
</li>
<li><p>输入工作负载的名称。</p>
</li>
<li><p>在<strong>Docker 镜像</strong>一栏，输入<code>rancher/hello-world</code>，请注意区分大小写字母。</p>
</li>
<li><p>余下的选项保持默认配置即可。</p>
</li>
<li><p>单击<strong>运行</strong>。</p>
</li>
</ol>
<p><strong>结果：</strong></p>
<ul>
<li>部署了工作负载。这个过程可能需要几分钟完成。</li>
<li>当您的工作负载部署完成后，它的状态将变为<strong>Active</strong>，您可以从项目的<strong>工作负载</strong>页面查看工作负载当前的状态。</li>
</ul>
<h2 id="暴露服务"><a href="#暴露服务" class="headerlink" title="#暴露服务"></a><a href="https://rancher2.docs.rancher.cn/docs/quick-start-guide/workload/quickstart-deploy-workload-ingress/_index#暴露服务" target="_blank" rel="noopener">#</a>暴露服务</h2><p>上述步骤帮助您完成了工作负载的部署，现在您需要将服务暴露出来，让其他服务可以通过网络连接和调用这个工作负载。</p>
<ol>
<li>访问<strong>集群</strong>页面，选择您刚刚创建的集群，进入集群页面。</li>
<li>从集群页面的主菜单中选择<strong>项目/命名空间</strong>。</li>
<li>打开 <strong>项目 &gt; Default</strong>。</li>
<li>单击<strong>资源 &gt; 工作负载 &gt; 负载均衡</strong>。如果您使用的是 v2.3.0 之前的版本，请单击 <strong>工作负载 &gt; 负载均衡</strong>。</li>
<li>单击<strong>添加 Ingress</strong></li>
<li>输入 Ingress 负载均衡的名称，如 “hello”。</li>
<li>在<strong>目标</strong>一栏，从下拉菜单选择您服务的名称。</li>
<li>在<strong>端口</strong>一栏输入 <code>80</code>。</li>
<li>余下的选项保持默认配置即可，单击<strong>保存</strong>。</li>
</ol>
<p><strong>结果：</strong> 这个工作负载分配到了一个<code>xip.io</code>地址，已经暴露出去了。可能需要 1~2 分钟完成服务关联。</p>
<h2 id="查看您的应用"><a href="#查看您的应用" class="headerlink" title="#查看您的应用"></a><a href="https://rancher2.docs.rancher.cn/docs/quick-start-guide/workload/quickstart-deploy-workload-ingress/_index#查看您的应用" target="_blank" rel="noopener">#</a>查看您的应用</h2><p>从<strong>负载均衡</strong>页面单击目标链接<code>hello.default.xxx.xxx.xxx.xxx.xip.io &gt; hello-world</code>，您的应用会在一个新窗口中打开。</p>
<h2 id="结果"><a href="#结果" class="headerlink" title="#结果"></a><a href="https://rancher2.docs.rancher.cn/docs/quick-start-guide/workload/quickstart-deploy-workload-ingress/_index#结果" target="_blank" rel="noopener">#</a>结果</h2><p>成功部署工作负载并通过 Ingress 暴露该工作负载。</p>
<h2 id="后续操作"><a href="#后续操作" class="headerlink" title="#后续操作"></a><a href="https://rancher2.docs.rancher.cn/docs/quick-start-guide/workload/quickstart-deploy-workload-ingress/_index#后续操作" target="_blank" rel="noopener">#</a>后续操作</h2><p>使用完您通过快速入门搭建的 Rancher 沙盒后，您可能想要清理遗留在环境中与 Rancher 相关的资源，并删除 Rancher Server 和您的集群，请单击下方链接查看操作指导。</p>
<ul>
<li><a href="https://rancher2.docs.rancher.cn/docs/quick-start-guide/deployment/amazon-aws-qs/_index" target="_blank" rel="noopener">清理环境：Amazon AWS</a></li>
<li><a href="https://rancher2.docs.rancher.cn/docs/quick-start-guide/deployment/digital-ocean-qs/_index" target="_blank" rel="noopener">清理环境：DigitalOcean</a></li>
<li><a href="https://rancher2.docs.rancher.cn/docs/quick-start-guide/deployment/quickstart-vagrant/_index" target="_blank" rel="noopener">清理环境：Vagrant</a></li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://carlo-z.com/devops/k8s/rancher2-ha-install/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Focus-1">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Focus-1">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/devops/k8s/rancher2-ha-install/" itemprop="url">Rancher 2.x 部署 管理k8s集群</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-07-12T00:00:00+08:00">
                2019-07-12
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/devops/" itemprop="url" rel="index">
                    <span itemprop="name">devops</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/devops/rancher/" itemprop="url" rel="index">
                    <span itemprop="name">rancher</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <br>

<blockquote>
<p>中文文档：<a href="https://docs.rancher.cn/rancher2x/" target="_blank" rel="noopener">https://docs.rancher.cn/rancher2x/</a></p>
<p><a href="https://rancher2.docs.rancher.cn/docs/releases/v2.4.5/" target="_blank" rel="noopener">https://rancher2.docs.rancher.cn/docs/releases/v2.4.5/</a></p>
<p><a href="https://cloud.tencent.com/developer/article/1633991" target="_blank" rel="noopener">https://cloud.tencent.com/developer/article/1633991</a></p>
</blockquote>
<p>Rancher 是一个全栈式的 Kubernetes 容器管理平台，也是一个可以在任何地方都能成功运行 Kubernetes 的工具。</p>
<h1 id="产品介绍"><a href="#产品介绍" class="headerlink" title="产品介绍"></a>产品介绍</h1><p><img src="https://rancher2.docs.rancher.cn/img/rancher/platform.png" alt="Platform"></p>
<h2 id="Rancher-Server-架构"><a href="#Rancher-Server-架构" class="headerlink" title="Rancher Server 架构"></a>Rancher Server 架构</h2><p>Rancher Server 由认证代理（Authentication Proxy）、Rancher API Server、集群控制器（Cluster Controller）、etcd 节点和集群 Agent（Cluster Agent） 组成。除了集群 Agent 以外，其他组件都部署在 Rancher Server 中。</p>
<p>图中描述的是用户通过 Rancher Server 管控 Rancher 部署的 Kubernetes 集群（RKE 集群）和托管的 Kubernetes 集群的（EKS）集群的流程。以用户下发指令为例，指令的流动路径如下：</p>
<ol>
<li>首先，用户通过 Rancher UI（即 Rancher 控制台） Rancher 命令行工具（Rancher CLI）输入指令；直接调用 Rancher API 接口也可以达到相同的效果。</li>
<li>用户通过 Rancher 的代理认证后，指令会进一步下发到 Rancher Server 。</li>
<li>与此同时，Rancher Server 也会执行容灾备份，将数据备份到 etcd 节点。</li>
<li>然后 Rancher Server 把指令传递给集群控制器。集群控制器把指令传递到下游集群的 Agent，最终通过 Agent 把指令下发到指定的集群中。</li>
</ol>
<p>如果 Rancher Server 出现问题，我们也提供了备用方案，您可以通过<a href="https://rancher2.docs.rancher.cn/docs/overview/architecture/_index#授权集群端点" target="_blank" rel="noopener">授权集群端点</a>管理集群。</p>
<p>考虑到性能表现和安全因素，我们建议您使用两个 Kubernetes 集群，分开部署 Rancher Server 和工作负载。部署 Rancher Server 后，您可以创建或导入集群，然后在这些集群上运行您的工作负载。</p>
<p>通过Rancher认证代理管理 Kubernetes 集群</p>
<p><img src="https://rancher2.docs.rancher.cn/img/rancher/rancher-architecture-rancher-api-server.svg" alt="Architecture"></p>
<p>​    您可以在单个节点或高可用的 Kubernetes 集群上安装 Rancher。由于单节点安装只适用于开发和测试环境，而且单节点和高可用集群之间无法进行数据迁移，所以我们建议您从一开始就使用高可用的 Kubernetes 集群来部署 Rancher Server，而且您需要分开部署运行 Rancher Server 的集群和运行自己业务的下游集群</p>
<h2 id="与下游集群交互"><a href="#与下游集群交互" class="headerlink" title="与下游集群交互"></a>与下游集群交互</h2><p>本小节通过两个用户 Bob 和 Alice 的案例，讲解 Rancher 启动和管理下游集群的具体过程，和每个 Rancher 组件的作用。</p>
<p>下图演示了集群控制器、集群 Agent 和 Node Agent 是如何允许 Rancher 控制下游集群的。</p>
<p>与下游集群通信</p>
<p><img src="https://rancher2.docs.rancher.cn/img/rancher/rancher-architecture-cluster-controller.svg" alt="Rancher Components"></p>
<p><img src="https://rancher2.docs.rancher.cn/img/rancher/rancher-architecture-separation-of-rancher-server.svg" alt="Separation of Rancher Server from User Clusters"></p>
<h2 id="Kubernetes-的安装环境"><a href="#Kubernetes-的安装环境" class="headerlink" title="Kubernetes 的安装环境"></a>Kubernetes 的安装环境</h2><p>我们强烈建议您使用云服务提供商的虚拟机，如 AWS EC2、Goolge Compute Enginee (GCE)、AliCloud ECS 等，安装 Kubernetes 集群，然后在集群中安装 Rancher。</p>
<p>为了达到最好的性能和安全条件，我们建议您为 Rancher 创建一个专用的 Kubernetes 集群，只在这个机器中部署 Rancher Server，不在这个集群中运行应用或程序。部署 Rancher 后，您可以<a href="https://rancher2.docs.rancher.cn/docs/cluster-provisioning/_index" target="_blank" rel="noopener">创建新集群或导入已有集群</a>，然后用这些集群启动您自己的应用或程序。</p>
<p>我们不建议在托管的 Kubernetes 集群上，如 EKS 和 GKE，安装 Rancher。 这些托管的 Kubernetes 集群不会将 etcd 暴露给 Rancher ，达到 Rancher 可以管理的程度，而且它们的特殊改动可能与 Rancher 的操作冲突。</p>
<h1 id="快速入门"><a href="#快速入门" class="headerlink" title="快速入门"></a>快速入门</h1><p>Rancher 提供这些快速入门手册的目的是帮助您快速地建造一个 Rancher 的沙盒，您可以在这个沙盒中评估 Rancher 是否满足您的需求。请注意，快速入门手册不适用于正式的生产环境，请参考<a href="https://rancher2.docs.rancher.cn/docs/installation/_index" target="_blank" rel="noopener">安装介绍</a>获取适用于正式的生产环境的操作指导。</p>
<p>目前 Rancher 提供了以下三本快速入门手册：</p>
<ul>
<li><a href="https://rancher2.docs.rancher.cn/docs/quick-start-guide/deployment/_index" target="_blank" rel="noopener">部署 Rancher Server</a>：使用对您来说最方便的方式运行 Rancher Server。</li>
<li><a href="https://rancher2.docs.rancher.cn/docs/quick-start-guide/workload/_index" target="_blank" rel="noopener">部署工作负载</a>：部署一个简单的工作负载，然后暴露工作负载，这样您就可以从集群外部访问工作负载。</li>
<li><a href="https://rancher2.docs.rancher.cn/docs/quick-start-guide/cli/_index" target="_blank" rel="noopener">命令行工具</a>：使用<code>kubectl</code>或 Rancher 命令行工具（Rancher CLI）管理 Rancher 实例。</li>
</ul>
<blockquote>
<p><a href="https://rancher2.docs.rancher.cn/docs/installation/k8s-install/_index" target="_blank" rel="noopener">https://rancher2.docs.rancher.cn/docs/installation/k8s-install/_index</a></p>
</blockquote>
<h1 id="安装-Docker"><a href="#安装-Docker" class="headerlink" title="安装 Docker"></a>安装 Docker</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl https://releases.rancher.com/install-docker/18.09.sh | sh</span><br></pre></td></tr></table></figure>

<p>要了解某个 Docker 版本是否有可用的安装脚本，请参考这个<a href="https://github.com/rancher/install-docker" target="_blank" rel="noopener">GitHub 仓库</a>，这里包含了 Rancher 的所有 Docker 安装脚本。</p>
<h1 id="需要的-CLI-工具"><a href="#需要的-CLI-工具" class="headerlink" title="需要的 CLI 工具"></a>需要的 CLI 工具</h1><p>此安装需要以下 CLI 工具。请确保这些工具已经安装并在<code>$PATH</code>中可用</p>
<ul>
<li><a href="https://kubernetes.io/docs/tasks/tools/install-kubectl/#install-kubectl" target="_blank" rel="noopener">kubectl</a> - Kubernetes 命令行工具.</li>
<li><a href="https://rancher.com/docs/rke/latest/en/installation/" target="_blank" rel="noopener">rke</a> - Rancher Kubernetes Engine，用于构建 Kubernetes 集群的 cli。</li>
<li><a href="https://rancher.com/docs/k3s/latest/en/" target="_blank" rel="noopener">k3s</a> - Rancher K3s。</li>
<li><a href="https://docs.helm.sh/using_helm/#installing-helm" target="_blank" rel="noopener">helm</a> - Kubernetes 的软件包管理工具。请参阅<a href="https://rancher2.docs.rancher.cn/docs/installation/options/helm-version/_index" target="_blank" rel="noopener">Helm 版本要求</a>选择 Helm 的版本来安装 Rancher。</li>
</ul>
<h1 id="配置基础设置"><a href="#配置基础设置" class="headerlink" title="配置基础设置"></a>配置基础设置</h1><blockquote>
<p><a href="https://rancher2.docs.rancher.cn/docs/installation/k8s-install/create-nodes-lb/_index" target="_blank" rel="noopener">https://rancher2.docs.rancher.cn/docs/installation/k8s-install/create-nodes-lb/_index</a></p>
</blockquote>
<p><strong><u>1、Linux主机配置</u></strong></p>
<p><u><strong>3、配置负载均衡器</strong></u></p>
<p>您还需要设置一个负载均衡器，以将流量定向到两个节点上的 Rancher 副本。这样可以在单个节点不可用时，继续保障与 Rancher 管理面的连接。</p>
<p>在后续步骤中配置 Kubernetes 时，K3s 工具将部署 Traefik Ingress 控制器。该控制器将侦听 worker 节点的 80 端口和 443 端口，以响应发送给特定主机名的流量。</p>
<p>在安装 Rancher 时（也是在后续步骤中），Rancher 系统将创建一个 Ingress 资源。该 Ingress 通知 Traefik Ingress 控制器侦听发往 Rancher 主机名的流量。Traefik Ingress 控制器在收到发往 Rancher 主机名的流量时，会将其转发到集群中正在运行的 Rancher Server Pod。</p>
<p>对于实现，请考虑是否要使用 4 层或 7 层负载均衡器：</p>
<ul>
<li><strong>4 层负载均衡器</strong> 是两种选择中相对简单的一种，它将 TCP 流量转发到您到节点。我们建议使用 4 层负载均衡器，将流量从 TCP / 80 端口和 TCP / 443 端口转发到 Rancher 管理面的集群节点上。集群上的 Ingress 控制器会将 HTTP 流量重定向到 HTTPS，并在 TCP / 443 端口上终止 SSL / TLS。Ingress 控制器会将流量转发到 Rancher Server Pod 的 TCP / 443 端口。</li>
<li><strong>7 层负载均衡器</strong> 相对有些复杂，但可以提供您可能需要的功能。例如，与 Rancher 本身进行 TLS 终止相反，7 层负载均衡器能够在负载均衡器处理 TLS 终止。如果要在基础设施中进行 TLS 终止，7 层负载均衡可能会很有用。7 层负载均衡还可以为您的负载均衡器提供基于 HTTP 属性（例如 cookie 等）做出决策的能力，而 4 层负载均衡器无法提供这种功能。如果决定在 7 层负载均衡器上终止 SSL / TLS 流量，则在安装 Rancher 时（后续步骤）需要使用<code>--set tls=external</code>选项。有关更多信息，请参阅<a href="https://rancher2.docs.rancher.cn/docs/installation/options/chart-options/_index" target="_blank" rel="noopener">Rancher Helm Chart 选项</a>。</li>
<li>有关如何设置 NGINX 负载均衡器的示例，请参考<a href="https://rancher2.docs.rancher.cn/docs/installation/options/nginx/_index" target="_blank" rel="noopener">本页</a>。</li>
<li>有关如何设置 Amazon ELB Network Load Balancer 的示例，请参考<a href="https://rancher2.docs.rancher.cn/docs/installation/options/nlb/_index" target="_blank" rel="noopener">本页</a>。</li>
<li>有关如何配置 F5 作为 Rancher 前端 7 层负载均衡器的示例，请参考<a href="https://rancher2.docs.rancher.cn/docs/installation/options/F5-7-layer-loadbalancer/_index" target="_blank" rel="noopener">本页</a>。</li>
<li>有关如何为 F5 启动 WAF 功能的示例，请参考<a href="https://rancher2.docs.rancher.cn/docs/installation/options/F5-WAF/_index" target="_blank" rel="noopener">本页</a>。</li>
</ul>
<p><u><strong>4、配置DNS记录</strong></u></p>
<p>配置完负载均衡器后，您将需要创建 DNS 记录，以将流量发送到该负载均衡器。</p>
<h1 id="安装-高可用-k3s-集群"><a href="#安装-高可用-k3s-集群" class="headerlink" title="安装 高可用 k3s 集群"></a>安装 高可用 k3s 集群</h1><blockquote>
<p>在 K3s 集群中安装 Rancher 高可用，我们建议为高可用安装配置以下基础设施：</p>
<ul>
<li><strong>2 个 Linux 节点</strong>，通常是虚拟机，您可以自行选择的基础设施提供商，例如 Amazon EC2，阿里云，腾讯云或者 vShpere 等。</li>
<li><strong>1 个外置数据库</strong>，用于存储集群数据。我们建议使用 MySQL。</li>
<li><strong>1 个负载均衡器</strong>，用于将流量转发到这两个节点。</li>
<li><strong>一条 DNS 记录</strong>，用于将 URL 指向负载均衡器。这将成为 Rancher Server 的 URL，下游集群需要可以访问到这个地址。</li>
</ul>
</blockquote>
<br>

<h3 id="准备外置Mysql数据库"><a href="#准备外置Mysql数据库" class="headerlink" title="准备外置Mysql数据库"></a>准备外置Mysql数据库</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[root@nna ~]# mkdir -p /data/rancher/ &amp;&amp; cd /data/rancher</span><br><span class="line">[root@nna rancher]# wget https://dev.mysql.com/get/mysql57-community-release-el7-9.noarch.rpm</span><br><span class="line">[root@nna rancher]# rpm -ivh mysql57-community-release-el7-9.noarch.rpm</span><br><span class="line">[root@nna rancher]# yum install mysql-server -y</span><br><span class="line">[root@nna rancher]# systemctl start mysqld</span><br><span class="line">[root@nna rancher]# systemctl enable mysqld</span><br><span class="line">[root@nna rancher]# grep 'temporary password' /var/log/mysqld.log</span><br><span class="line"><span class="meta">#</span><span class="bash"> tpp!e.ecj6eP</span></span><br><span class="line">[root@nna ~]# mysql -uroot -p</span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> use mysql;</span></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> <span class="built_in">set</span> global validate_password_policy=LOW;</span></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> <span class="built_in">set</span> global validate_password_length=6;</span></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> <span class="built_in">set</span> password=password(<span class="string">"123456"</span>);</span></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> GRANT ALL PRIVILEGES ON *.* TO <span class="string">'root'</span>@<span class="string">'%'</span> IDENTIFIED BY <span class="string">'123456'</span>;</span></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> flush privileges;</span></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> create database k3s;</span></span><br><span class="line"></span><br><span class="line">[root@nna rancher]# yum install -y nc</span><br><span class="line">[root@nna rancher]# nc -vz nna 3306</span><br></pre></td></tr></table></figure>

<br>

<h3 id="安装-K3s-Server"><a href="#安装-K3s-Server" class="headerlink" title="安装 K3s Server"></a>安装 K3s Server</h3><blockquote>
<p>在nna和nns上安装 k3s server</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">[root@nna ~]# mkdir -p /data/rancher/ &amp;&amp; cd /data/rancher</span><br><span class="line">[root@nna rancher]# yum install -y container-selinux selinux-policy-base</span><br><span class="line">[root@nna rancher]# rpm -i https://rpm.rancher.io/k3s-selinux-0.1.1-rc1.el7.noarch.rpm</span><br><span class="line">warning: /var/tmp/rpm-tmp.WXgsrS: Header V4 RSA/SHA1 Signature, key ID e257814a: NOKEY</span><br><span class="line"></span><br><span class="line">[root@nna rancher]# curl -sfL https://docs.rancher.cn/k3s/k3s-install.sh | INSTALL_K3S_MIRROR=cn sh -s - server --datastore-endpoint="mysql://root:123456@tcp(nna:3306)/k3s"</span><br><span class="line">[INFO]  Finding release for channel stable</span><br><span class="line">[INFO]  Using v1.18.4+k3s1 as release</span><br><span class="line">[INFO]  Downloading hash https://mirror-k3s.rancher.cn/download/v1.18.4-k3s1/sha256sum-amd64.txt</span><br><span class="line">[INFO]  Downloading binary https://mirror-k3s.rancher.cn/download/v1.18.4-k3s1/k3s</span><br><span class="line">[INFO]  Verifying binary download</span><br><span class="line">[INFO]  Installing k3s to /usr/local/bin/k3s</span><br><span class="line">[INFO]  Creating /usr/local/bin/kubectl symlink to k3s</span><br><span class="line">[INFO]  Creating /usr/local/bin/crictl symlink to k3s</span><br><span class="line">[INFO]  Skipping /usr/local/bin/ctr symlink to k3s, command exists in PATH at /usr/bin/ctr</span><br><span class="line">[INFO]  Creating killall script /usr/local/bin/k3s-killall.sh</span><br><span class="line">[INFO]  Creating uninstall script /usr/local/bin/k3s-uninstall.sh</span><br><span class="line">[INFO]  env: Creating environment file /etc/systemd/system/k3s.service.env</span><br><span class="line">[INFO]  systemd: Creating service file /etc/systemd/system/k3s.service</span><br><span class="line">[INFO]  systemd: Enabling k3s unit</span><br><span class="line">Created symlink from /etc/systemd/system/multi-user.target.wants/k3s.service to /etc/systemd/system/k3s.service.</span><br><span class="line">[INFO]  systemd: Starting k3s</span><br><span class="line">[root@nna ~]#</span><br></pre></td></tr></table></figure>

<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20200707233218.png" alt></p>
<br>

<h3 id="确认-K3s-是否创建成功"><a href="#确认-K3s-是否创建成功" class="headerlink" title="确认 K3s 是否创建成功"></a>确认 K3s 是否创建成功</h3><p>要确认已成功设置 K3s，请在任一 K3s Server 节点上运行以下命令：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@nna ~]# k3s kubectl get nodes</span><br><span class="line">NAME   STATUS   ROLES    AGE   VERSION</span><br><span class="line">nna    Ready    master   72s   v1.18.4+k3s1</span><br><span class="line">[root@nna ~]# k3s kubectl get nodes</span><br><span class="line">NAME   STATUS   ROLES    AGE     VERSION</span><br><span class="line">nna    Ready    master   4m50s   v1.18.4+k3s1</span><br><span class="line">nns    Ready    master   22s     v1.18.4+k3s1</span><br><span class="line"></span><br><span class="line">[root@nna ~]# k3s kubectl get pods --all-namespaces</span><br><span class="line">NAMESPACE     NAME                                     READY   STATUS              RESTARTS   AGE</span><br><span class="line">kube-system   helm-install-traefik-6l8xj               0/1     ContainerCreating   0          6m43s</span><br><span class="line">kube-system   metrics-server-7566d596c8-v757d          1/1     Running             0          6m42s</span><br><span class="line">kube-system   local-path-provisioner-6d59f47c7-gt6ch   1/1     Running             0          6m42s</span><br><span class="line">kube-system   coredns-8655855d6-d9l8x                  1/1     Running             0          6m42s</span><br><span class="line">[root@nna ~]#</span><br></pre></td></tr></table></figure>

<br>

<h3 id="启动k3s"><a href="#启动k3s" class="headerlink" title="启动k3s"></a>启动k3s</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">/usr/local/bin/k3s server --datastore-endpoint=mysql://root:123456@tcp(nna:3306)/k3s</span><br><span class="line"></span><br><span class="line">systemctl enable k3s</span><br><span class="line">systemctl status k3s</span><br><span class="line">systemctl start k3s</span><br><span class="line">systemctl stop k3s</span><br></pre></td></tr></table></figure>

<br>



<h3 id="卸载-k3s-备用"><a href="#卸载-k3s-备用" class="headerlink" title="卸载 k3s (备用)"></a>卸载 k3s (备用)</h3><p>如果是通过 <code>install.sh</code> 脚本安装的k3s，默认会在服务中安装一个卸载的脚本文件：</p>
<p><code>/usr/local/bin/k3s-uninstall.sh</code> (or as <code>k3s-agent-uninstall.sh</code>).</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@nns ~]# ll /usr/local/bin/k3s*</span><br><span class="line">-rwxr-xr-x. 1 root root 53604352 Jul  2 00:52 /usr/local/bin/k3s</span><br><span class="line">-rwxr-xr-x. 1 root root     1710 Jul  2 00:52 /usr/local/bin/k3s-killall.sh</span><br><span class="line">-rwxr-xr-x. 1 root root      881 Jul  2 00:52 /usr/local/bin/k3s-uninstall.sh</span><br></pre></td></tr></table></figure>

<h3 id="安装-kubectl-并配置-kubeconfig"><a href="#安装-kubectl-并配置-kubeconfig" class="headerlink" title="安装 kubectl 并配置 kubeconfig"></a>安装 kubectl 并配置 kubeconfig</h3><blockquote>
<p>官方文档：<a href="https://kubernetes.io/docs/tasks/tools/install-kubectl/#install-kubectl" target="_blank" rel="noopener">https://kubernetes.io/docs/tasks/tools/install-kubectl/#install-kubectl</a></p>
<p>我的系统是centos7.5，选用如下内容</p>
</blockquote>
<p>配置 kubeconfig</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">\cp /etc/rancher/k3s/k3s.yaml ~/.kube/config</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">curl -LO https://storage.googleapis.com/kubernetes-release/release/v1.18.0/bin/linux/amd64/kubectl</span><br><span class="line">chmod +x ./kubectl</span><br><span class="line">mv ./kubectl /usr/local/bin/kubectl</span><br><span class="line">kubectl version --client</span><br></pre></td></tr></table></figure>

<br>

<h1 id="在-k3s-集群中安装-Rancher"><a href="#在-k3s-集群中安装-Rancher" class="headerlink" title="在 k3s 集群中安装 Rancher"></a>在 k3s 集群中安装 Rancher</h1><blockquote>
<p>官方文档：<a href="https://rancher2.docs.rancher.cn/docs/installation/k8s-install/helm-rancher/_index" target="_blank" rel="noopener">https://rancher2.docs.rancher.cn/docs/installation/k8s-install/helm-rancher/_index</a></p>
</blockquote>
<h3 id="1、安装需要的-CLI-工具"><a href="#1、安装需要的-CLI-工具" class="headerlink" title="1、安装需要的 CLI 工具"></a>1、安装需要的 CLI 工具</h3><p>以下 CLI 工具是创建 Kubernetes 集群所必需的。请确保这些工具已安装并在您的<code>$PATH</code>中可用。</p>
<p>请查看 <a href="https://helm.sh/docs/intro/install/" target="_blank" rel="noopener">Helm 项目提供的安装指南</a>，来在您的平台上进行安装。</p>
<ul>
<li><a href="https://kubernetes.io/docs/tasks/tools/install-kubectl/#install-kubectl" target="_blank" rel="noopener">kubectl</a> - Kubernetes 命令行工具。</li>
<li><a href="https://docs.helm.sh/using_helm/#installing-helm" target="_blank" rel="noopener">helm</a> - Kubernetes 的软件包管理工具。请参阅 <a href="https://rancher2.docs.rancher.cn/docs/installation/options/helm-version/_index" target="_blank" rel="noopener">Helm 版本要求</a>以选择要安装 Rancher 的 Helm 版本</li>
</ul>
<p>在 github（<a href="https://github.com/helm/helm/releases）下载：" target="_blank" rel="noopener">https://github.com/helm/helm/releases）下载：</a></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">wget https://get.helm.sh/helm-v3.2.4-linux-amd64.tar.gz</span><br><span class="line">tar -zxvf helm-v3.2.4-linux-amd64.tar.gz</span><br><span class="line">mv linux-amd64/helm /usr/local/bin/helm</span><br><span class="line">helm help</span><br></pre></td></tr></table></figure>

<h3 id="2、添加-Helm-Chart-仓库"><a href="#2、添加-Helm-Chart-仓库" class="headerlink" title="2、添加 Helm Chart 仓库"></a>2、添加 Helm Chart 仓库</h3><p>添加含有 Rancher Chart 的 Helm Chart 仓库</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">helm repo add rancher-stable http://rancher-mirror.oss-cn-beijing.aliyuncs.com/server-charts/stable</span><br></pre></td></tr></table></figure>

<h3 id="3、为-Rancher-创建-Namespace"><a href="#3、为-Rancher-创建-Namespace" class="headerlink" title="3、为 Rancher 创建 Namespace"></a>3、为 Rancher 创建 Namespace</h3><p>我们需要定义一个 Kubernetes Namespace，在 Namespace 中安装由 Chart 创建的资源。这个命名空间的名称为<code>cattle-system</code>：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@nna rancher]# kubectl create namespace cattle-system</span><br><span class="line">namespace/cattle-system created</span><br></pre></td></tr></table></figure>

<h3 id="4、选择您的-SSL-选项"><a href="#4、选择您的-SSL-选项" class="headerlink" title="4、选择您的 SSL 选项"></a>4、选择您的 SSL 选项</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /data/rancher/certs &amp;&amp; cd /data/rancher/certs</span><br><span class="line">touch ~/.rnd</span><br><span class="line">yum install -y openssl</span><br><span class="line">cp /etc/pki/tls/openssl.cnf ./</span><br><span class="line">vim openssl.cnf</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[req]</span><br><span class="line">distinguished_name      = req_distinguished_name</span><br><span class="line">req_extetions           = v3_req</span><br><span class="line">x509_extensions         = v3_ca</span><br><span class="line"></span><br><span class="line">[ v3_req ]</span><br><span class="line">basicConstraints = CA:FALSE</span><br><span class="line">keyUsage = nonRepudiation, digitalSignature, keyEncipherment</span><br><span class="line">extendedKeyUsage = clientAuth, serverAuth</span><br><span class="line">subjectAltName = @alt_names</span><br><span class="line">[ v3_ca ]</span><br><span class="line">subjectKeyIdentifier=hash</span><br><span class="line">authorityKeyIdentifier=keyid:always,issuer:always</span><br><span class="line">basicConstraints = critical,CA:true</span><br><span class="line">subjectAltName = @alt_names</span><br><span class="line"></span><br><span class="line">[alt_names]</span><br><span class="line">DNS.1 = local-rancher</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">openssl genrsa -out cakey.pem 2048</span><br><span class="line">openssl req -x509 -new -nodes -key cakey.pem \</span><br><span class="line">    -days 36500 \</span><br><span class="line">    -out cacerts.pem \</span><br><span class="line">    -extensions v3_ca \</span><br><span class="line">    -subj "/CN=rancher.local.com" \</span><br><span class="line">    -config ./openssl.cnf</span><br><span class="line">openssl genrsa -out server.key 2048</span><br><span class="line">openssl req -new -key server.key \</span><br><span class="line">    -out server.csr \</span><br><span class="line">    -subj "/CN=local-rancher" \</span><br><span class="line">    -config ./openssl.cnf</span><br><span class="line"></span><br><span class="line">openssl x509 -req -in server.csr \</span><br><span class="line">    -CA cacerts.pem \</span><br><span class="line">    -CAkey cakey.pem \</span><br><span class="line">    -CAcreateserial -out server.crt \</span><br><span class="line">    -days  36500 -extensions v3_req \</span><br><span class="line">    -extfile ./openssl.cnf</span><br><span class="line">openssl x509 -noout -in server.crt -text | grep DNS</span><br><span class="line">cp server.crt tls.crt</span><br><span class="line">cp server.key tls.key</span><br></pre></td></tr></table></figure>

<p>ca证书密文</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">kubectl -n cattle-system create secret tls tls-rancher-ingress \</span><br><span class="line">	--cert=./tls.crt --key=./tls.key</span><br><span class="line">kubectl -n cattle-system create secret generic tls-ca \</span><br><span class="line">	--from-file=cacerts.pem</span><br></pre></td></tr></table></figure>

<p>部署 Rancher 集群</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">echo '192.168.145.131 local-rancher' &gt;&gt; /etc/hosts</span><br><span class="line"></span><br><span class="line">helm install rancher rancher-stable/rancher \</span><br><span class="line">     --namespace cattle-system \</span><br><span class="line">     --set hostname=local-rancher \</span><br><span class="line">     --set ingress.tls.source=secret \</span><br><span class="line">     --set privateCA=true</span><br></pre></td></tr></table></figure>

<h3 id="6、根据您选择的-SSL-选项，通过-Helm-安装-Rancher"><a href="#6、根据您选择的-SSL-选项，通过-Helm-安装-Rancher" class="headerlink" title="6、根据您选择的 SSL 选项，通过 Helm 安装 Rancher"></a>6、根据您选择的 SSL 选项，通过 Helm 安装 Rancher</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">echo '192.168.145.131 local-rancher' &gt;&gt; /etc/hosts</span><br><span class="line"></span><br><span class="line">helm install rancher rancher-stable/rancher \</span><br><span class="line">     --namespace cattle-system \</span><br><span class="line">     --set hostname=local-rancher \</span><br><span class="line">     --set ingress.tls.source=secret \</span><br><span class="line">     --set privateCA=true</span><br></pre></td></tr></table></figure>

<h3 id="7、验证Rancher-Server-是否成功部署"><a href="#7、验证Rancher-Server-是否成功部署" class="headerlink" title="7、验证Rancher Server 是否成功部署"></a>7、验证Rancher Server 是否成功部署</h3><p>等待 Rancher 运行，检查 Rancher Server 是否运行成功：：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">kubectl -n cattle-system rollout status deploy/rancher</span><br><span class="line"></span><br><span class="line">Waiting for deployment "rancher" rollout to finish: 0 of 3 updated replicas are available...</span><br><span class="line"></span><br><span class="line">deployment "rancher" successfully rolled out</span><br></pre></td></tr></table></figure>

<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20200709010122.png" alt></p>
<p>如果看到以下错误： <code>error: deployment &quot;rancher&quot; exceeded its progress deadline</code>, 您可以通过运行以下命令来检查 deployment 的状态：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@nna ~]# kubectl -n cattle-system get deploy rancher</span><br><span class="line">NAME      READY   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">rancher   3/3     3            3           23h</span><br><span class="line">[root@nna ~]#</span><br></pre></td></tr></table></figure>

<p><code>DESIRED</code>和<code>AVAILABLE</code>应该显示相同的个数。</p>
<h3 id="8、保存您的选项"><a href="#8、保存您的选项" class="headerlink" title="8、保存您的选项"></a>8、保存您的选项</h3><p>请保存您使用的全部<code>--set</code>选项。使用 Helm 升级 Rancher 到新版本时，您将需要使用相同的选项。</p>
<h3 id="安装完成"><a href="#安装完成" class="headerlink" title="安装完成"></a>安装完成</h3><p>现在您应该具有一个功能正常的 Rancher Server 了。</p>
<p>打开浏览器，访问您的 DNS，这个 DNS 会将流量转发到您的负载均衡器，您应该会看到一个色彩丰富的登录页面。</p>
<p>遇到了问题？查看<a href="https://rancher2.docs.rancher.cn/docs/installation/options/troubleshooting/_index" target="_blank" rel="noopener">故障排查</a>页面。</p>
<p>rancher 中映射的端口无法用lsof或者netstat查看。可以通过<code>iptables -L -t nat -n</code>查看。</p>
<br>

<h1 id="使用-Rancher-创建-真正-k8s-集群"><a href="#使用-Rancher-创建-真正-k8s-集群" class="headerlink" title="使用 Rancher 创建 真正 k8s 集群"></a>使用 Rancher 创建 真正 k8s 集群</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /etc/docker</span><br><span class="line">vi /etc/docker/daemon.json</span><br><span class="line">&#123;</span><br><span class="line">  "registry-mirrors": ["https://k8spv7nq.mirror.aliyuncs.com"]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl restart docker</span><br></pre></td></tr></table></figure>

<blockquote>
<p>文档：<a href="https://rancher2.docs.rancher.cn/docs/cluster-provisioning/rke-clusters/custom-nodes/_index" target="_blank" rel="noopener">https://rancher2.docs.rancher.cn/docs/cluster-provisioning/rke-clusters/custom-nodes/_index</a></p>
</blockquote>
<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20200713002202.png" alt></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 删除以前的安装残留</span></span><br><span class="line">rm -rf /etc/kubernetes/ &amp;&amp; rm -rf /var/run/utmp &amp;&amp; rm -rf /var/run/lock/ &amp;&amp; rm -rf /var/lib/etcd/</span><br><span class="line">docker rm -f xx xx xx ...</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 重新安装</span></span><br><span class="line">docker run -d --privileged --restart=unless-stopped --net=host -v /etc/kubernetes:/etc/kubernetes -v /var/run:/var/run rancher/rancher-agent:v2.4.5 --server https://local-rancher --token 27wnwkrq6sd9t9cc7g686jc888w2p84zz4l8755nbkn8crvdstnj2b --ca-checksum 1050e7e484e48667c4d2bb94675302162b302b51157cc8a91235bf1e747f44c3 --internal-address 192.168.145.133 --etcd --controlplane --worker</span><br></pre></td></tr></table></figure>

<p>成功：</p>
<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20200715020933.png" alt></p>
<br>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://carlo-z.com/devops/k8s/kubesphere-devops/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Focus-1">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Focus-1">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/devops/k8s/kubesphere-devops/" itemprop="url">KubeSphere 多节点安装k8s</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-07-01T00:00:00+08:00">
                2019-07-01
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/devops/" itemprop="url" rel="index">
                    <span itemprop="name">devops</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/devops/k8s/" itemprop="url" rel="index">
                    <span itemprop="name">k8s</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <br>

<h1 id="准备主机"><a href="#准备主机" class="headerlink" title="准备主机"></a>准备主机</h1><table>
<thead>
<tr>
<th align="left">主机 IP</th>
<th align="left">主机名</th>
<th align="left">集群角色</th>
</tr>
</thead>
<tbody><tr>
<td align="left">192.168.145.133</td>
<td align="left">dn1</td>
<td align="left">master，etcd</td>
</tr>
<tr>
<td align="left">192.168.145.134</td>
<td align="left">dn2</td>
<td align="left">node</td>
</tr>
<tr>
<td align="left">192.168.145.135</td>
<td align="left">dn3</td>
<td align="left">node</td>
</tr>
</tbody></table>
<p><strong>集群架构：</strong> 单 master 单 etcd 双 node</p>
<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20200701210053.png" alt></p>
<h1 id="准备安装配置文件"><a href="#准备安装配置文件" class="headerlink" title="准备安装配置文件"></a>准备安装配置文件</h1>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://carlo-z.com/java/jvm/arthas-cpu100%/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Focus-1">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Focus-1">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/java/jvm/arthas-cpu100%/" itemprop="url">arthas 解决cpu高</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-07-01T00:00:00+08:00">
                2019-07-01
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/java/" itemprop="url" rel="index">
                    <span itemprop="name">java</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/java/jvm/" itemprop="url" rel="index">
                    <span itemprop="name">jvm</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/java/jvm/arthas/" itemprop="url" rel="index">
                    <span itemprop="name">arthas</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="现象"><a href="#现象" class="headerlink" title="现象"></a>现象</h1><p>win7下，OCR服务 tesseract-ocr 运行3个小时以上时，稳定出现CPU过高。但其实此时并没有请求，也就是说服务本身没什么负载</p>
<h1 id="jvisualvm观察"><a href="#jvisualvm观察" class="headerlink" title="jvisualvm观察"></a>jvisualvm观察</h1><p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20200113193231.png" alt></p>
<p>可以看到 GC 非常是频繁，推测是GC导致 CPU高</p>
<h1 id="jmap分析"><a href="#jmap分析" class="headerlink" title="jmap分析"></a>jmap分析</h1><p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20200113193601.png" alt></p>
<blockquote>
<p>查看整个JVM内存状态<br>jmap -heap [pid]<br>要注意的是在使用CMS GC 情况下，jmap -heap的执行有可能会导致JAVA 进程挂起</p>
<p>查看JVM堆中对象详细占用情况<br>jmap -histo [pid]</p>
<p>导出整个JVM 中内存信息<br>jmap -dump:format=b,file=文件名 [pid]</p>
<p>jhat是sun 1.6及以上版本中自带的一个用于分析JVM 堆DUMP 文件的工具，基于此工具可分析JVM HEAP 中对象的内存占用情况<br>jhat -J-Xmx1024M [file]<br>执行后等待console 中输入start HTTP server on port 7000 即可使用浏览器访问 IP：7000</p>
<p>eclipse Memory Analyzer<br>Eclipse 提供的一个用于分析JVM 堆Dump文件的插件。借助这个插件可查看对象的内存占用状况，引用关系，分析内存泄露等。<br><a href="http://www.eclipse.org/mat/" target="_blank" rel="noopener">http://www.eclipse.org/mat/</a></p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jmap -histo:live 7304 &gt; aaaa.log</span><br></pre></td></tr></table></figure>

<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20200113193444.png" alt></p>
<p>可以看到是一个 Collection 占用内存高</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">jmap -dump:format=b,file=dumpocr.dump 16800</span><br><span class="line">jhat -J-Xmx2048M dumpocr.dump</span><br></pre></td></tr></table></figure>

<h1 id="arthas分析"><a href="#arthas分析" class="headerlink" title="arthas分析"></a>arthas分析</h1><p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20200113193843.png" alt></p>
<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20200113193934.png" alt></p>
<p>此时有观测到 是 两个线程各占50%的CPU，并没有GC线程，所以根源是 这两个线程导致 CPU高，而不是 GC导致的。</p>
<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20200113193905.png" alt></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">"http-nio-16080-BlockPoller" Id=17 cpuUsage=50% RUNNABLE</span><br><span class="line">    at sun.nio.ch.WindowsSelectorImpl$SubSelector.poll0(Native Method)</span><br><span class="line">    at sun.nio.ch.WindowsSelectorImpl$SubSelector.poll(WindowsSelectorImpl.java:296)</span><br><span class="line">    at sun.nio.ch.WindowsSelectorImpl$SubSelector.access$400(WindowsSelectorImpl.java:278)</span><br><span class="line">    at sun.nio.ch.WindowsSelectorImpl.doSelect(WindowsSelectorImpl.java:159)</span><br><span class="line">    at sun.nio.ch.SelectorImpl.lockAndDoSelect(SelectorImpl.java:86)</span><br><span class="line">    -  locked sun.nio.ch.Util$2@41003c41</span><br><span class="line">    -  locked java.util.Collections$UnmodifiableSet@453fa0b9</span><br><span class="line">    -  locked sun.nio.ch.WindowsSelectorImpl@3d367a</span><br><span class="line">    at sun.nio.ch.SelectorImpl.select(SelectorImpl.java:97)</span><br><span class="line">    at org.apache.tomcat.util.net.NioBlockingSelector$BlockPoller.run(NioBlockingSelector.java:313)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">"http-nio-16080-ClientPoller" Id=28 cpuUsage=50% RUNNABLE</span><br><span class="line">    at sun.nio.ch.WindowsSelectorImpl$SubSelector.poll0(Native Method)</span><br><span class="line">    at sun.nio.ch.WindowsSelectorImpl$SubSelector.poll(WindowsSelectorImpl.java:296)</span><br><span class="line">    at sun.nio.ch.WindowsSelectorImpl$SubSelector.access$400(WindowsSelectorImpl.java:278)</span><br><span class="line">    at sun.nio.ch.WindowsSelectorImpl.doSelect(WindowsSelectorImpl.java:159)</span><br><span class="line">    at sun.nio.ch.SelectorImpl.lockAndDoSelect(SelectorImpl.java:86)</span><br><span class="line">    -  locked sun.nio.ch.Util$2@71d53c37</span><br><span class="line">    -  locked java.util.Collections$UnmodifiableSet@31f7f478</span><br><span class="line">    -  locked sun.nio.ch.WindowsSelectorImpl@9f5a097</span><br><span class="line">    at sun.nio.ch.SelectorImpl.select(SelectorImpl.java:97)</span><br><span class="line">    at org.apache.tomcat.util.net.NioEndpoint$Poller.run(NioEndpoint.java:708)</span><br><span class="line">    at java.lang.Thread.run(Thread.java:745)</span><br></pre></td></tr></table></figure>

<h1 id="查看tomcat源码"><a href="#查看tomcat源码" class="headerlink" title="查看tomcat源码"></a>查看tomcat源码</h1><p><code>NioEndpoint$Poller.run(NioEndpoint.java:708)</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// Loop until destroy() is called</span></span><br><span class="line">    <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">boolean</span> hasEvents = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (!close) &#123;</span><br><span class="line">                hasEvents = events();</span><br><span class="line">                <span class="keyword">if</span> (wakeupCounter.getAndSet(-<span class="number">1</span>) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="comment">//if we are here, means we have other stuff to do</span></span><br><span class="line">                    <span class="comment">//do a non blocking select</span></span><br><span class="line">                    keyCount = selector.selectNow();</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    keyCount = selector.select(selectorTimeout);</span><br><span class="line">                &#125;</span><br><span class="line">                wakeupCounter.set(<span class="number">0</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (close) &#123;</span><br><span class="line">                events();</span><br><span class="line">                timeout(<span class="number">0</span>, <span class="keyword">false</span>);</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    selector.close();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException ioe) &#123;</span><br><span class="line">                    log.error(sm.getString(<span class="string">"endpoint.nio.selectorCloseFail"</span>), ioe);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable x) &#123;</span><br><span class="line">            ExceptionUtils.handleThrowable(x);</span><br><span class="line">            log.error(<span class="string">""</span>,x);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后调用 <code>keyCount = selector.select(selectorTimeout);</code></p>
<p>结果跟踪到了 jdk 中的调用，赶脚碰上了jdk nio selector空轮询导致cpu 100%问题</p>
<p><code>C:/Program Files/Java/jdk1.8.0_65/jre/lib/rt.jar!/sun/nio/ch/SelectorImpl.class</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">lockAndDoSelect</span><span class="params">(<span class="keyword">long</span> var1)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span>(<span class="keyword">this</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span>(!<span class="keyword">this</span>.isOpen()) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ClosedSelectorException();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            Set var4 = <span class="keyword">this</span>.publicKeys;</span><br><span class="line">            <span class="keyword">int</span> var10000;</span><br><span class="line">            <span class="keyword">synchronized</span>(<span class="keyword">this</span>.publicKeys) &#123;</span><br><span class="line">                Set var5 = <span class="keyword">this</span>.publicSelectedKeys;</span><br><span class="line">                <span class="keyword">synchronized</span>(<span class="keyword">this</span>.publicSelectedKeys) &#123;</span><br><span class="line">                    var10000 = <span class="keyword">this</span>.doSelect(var1);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> var10000;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20200114111750.png" alt></p>
<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20200114111835.png" alt></p>
<p>跟踪到了native方法，再看就需要找到c的实现去看</p>
<h1 id="抬头看看网友"><a href="#抬头看看网友" class="headerlink" title="抬头看看网友"></a>抬头看看网友</h1><p><a href="https://stackoverflow.com/questions/36284833/spring-boot-application-starts-using-all-cpu" target="_blank" rel="noopener">https://stackoverflow.com/questions/36284833/spring-boot-application-starts-using-all-cpu</a></p>
<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20200114173909.png" alt></p>
<h1 id="优化tomcat"><a href="#优化tomcat" class="headerlink" title="优化tomcat"></a>优化tomcat</h1><p>使用NIO2</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.jzsec.tesseractocr.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.apache.catalina.connector.Connector;</span><br><span class="line"><span class="keyword">import</span> org.apache.coyote.ProtocolHandler;</span><br><span class="line"><span class="keyword">import</span> org.apache.coyote.http11.AbstractHttp11Protocol;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.web.embedded.tomcat.TomcatConnectorCustomizer;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.web.embedded.tomcat.TomcatServletWebServerFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.web.server.WebServerFactoryCustomizer;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.web.servlet.server.ConfigurableServletWebServerFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyTomcatConnectorCustomizer</span> <span class="keyword">implements</span> <span class="title">WebServerFactoryCustomizer</span>&lt;<span class="title">ConfigurableServletWebServerFactory</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">customize</span><span class="params">(ConfigurableServletWebServerFactory factory)</span> </span>&#123;</span><br><span class="line">        ((TomcatServletWebServerFactory) factory).setProtocol(<span class="string">"org.apache.coyote.http11.Http11Nio2Protocol"</span>);</span><br><span class="line">        ((TomcatServletWebServerFactory) factory).addConnectorCustomizers(<span class="keyword">new</span> TomcatConnectorCustomizer() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">customize</span><span class="params">(Connector connector)</span> </span>&#123;</span><br><span class="line">                ProtocolHandler protocol = connector.getProtocolHandler();</span><br><span class="line"></span><br><span class="line">                log.info(<span class="string">"Tomcat(&#123;&#125;)  -- MaxConnection:&#123;&#125;;MaxThreads:&#123;&#125;;MinSpareThreads:&#123;&#125;"</span>, <span class="comment">//</span></span><br><span class="line">                        protocol.getClass().getName(), <span class="comment">//</span></span><br><span class="line">                        ((AbstractHttp11Protocol&lt;?&gt;) protocol).getMaxConnections(), <span class="comment">//</span></span><br><span class="line">                        ((AbstractHttp11Protocol&lt;?&gt;) protocol).getMaxThreads(), <span class="comment">//</span></span><br><span class="line">                        ((AbstractHttp11Protocol&lt;?&gt;) protocol).getMinSpareThreads());</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20200114172142.png" alt></p>
<h1 id="后续观察"><a href="#后续观察" class="headerlink" title="后续观察"></a>后续观察</h1><p>持续运行一条后，没有再复现， 也不再有 <code>http-nio-16080-BlockPoller</code> 和 <code>http-nio-16080-ClientPoller</code> 线程</p>
<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20200115092745.png" alt></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://carlo-z.com/java/jdk/openjdk-download/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Focus-1">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Focus-1">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/java/jdk/openjdk-download/" itemprop="url">oracle-jdk收费 和 openjdk下载</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-06-20T00:00:00+08:00">
                2019-06-20
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/java/" itemprop="url" rel="index">
                    <span itemprop="name">java</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="oracle-jdk-License变更"><a href="#oracle-jdk-License变更" class="headerlink" title="oracle-jdk License变更"></a>oracle-jdk License变更</h1><p>oracle-jdk 从 jdk 8u111更新开始收费</p>
<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20190918092633.png" alt></p>
<p>可以看到Oracle对于个人使用还是免费，不过商业版就要收费；</p>
<p>此外，还提供了openjdk的下载地址（<a href="https://jdk.java.net/）；" target="_blank" rel="noopener">https://jdk.java.net/）；</a></p>
<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20190918092916.png" alt></p>
<h1 id="openjdk-下载"><a href="#openjdk-下载" class="headerlink" title="openjdk 下载"></a>openjdk 下载</h1><p><a href="https://jdk.java.net/java-se-ri/8" target="_blank" rel="noopener">https://jdk.java.net/java-se-ri/8</a></p>
<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20190918093320.png" alt></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://carlo-z.com/devops/k8s/rancher2-prometheus-grafana/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Focus-1">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Focus-1">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/devops/k8s/rancher2-prometheus-grafana/" itemprop="url">Rancher2.x 一键式部署 Prometheus + Grafana 监控 Kubernetes 集群</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-06-12T00:00:00+08:00">
                2019-06-12
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/devops/" itemprop="url" rel="index">
                    <span itemprop="name">devops</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/devops/rancher/" itemprop="url" rel="index">
                    <span itemprop="name">rancher</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <br>

<blockquote>
</blockquote>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://carlo-z.com/elasticsearch/doc/11-Elasticsearch-For-Hadoop/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Focus-1">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Focus-1">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/elasticsearch/doc/11-Elasticsearch-For-Hadoop/" itemprop="url">11、Elasticsearch For Hadoop</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-06-10T00:01:00+08:00">
                2019-06-10
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/elastic/" itemprop="url" rel="index">
                    <span itemprop="name">elastic</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/elastic/elasticsearch/" itemprop="url" rel="index">
                    <span itemprop="name">elasticsearch</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <hr>
<p>11.1、单机版Hadoop安装</p>
<p>11.2、ES-Hadoop安装</p>
<p>11.3、从 HDFS 到 Elasticsearch</p>
<p>11.4、从Elasticsearch 到 HDFS</p>
<p>-—————————————————–</p>
<h1 id="11-1、单机版Hadoop安装"><a href="#11-1、单机版Hadoop安装" class="headerlink" title="11.1、单机版Hadoop安装"></a>11.1、单机版Hadoop安装</h1><p>hadoop分为 单机模式、伪分布式模式、完全分布式模式</p>
<h4 id="1、ssh免密登录"><a href="#1、ssh免密登录" class="headerlink" title="1、ssh免密登录"></a>1、ssh免密登录</h4><p> <img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20190825160237.png" alt></p>
<p>vi /etc/ssh/ssh_config</p>
<p>文件尾添加：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">StrictHostKeyChecking no</span><br><span class="line">UserKnownHostsFile /dev/null</span><br></pre></td></tr></table></figure>

<p> <img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20190825160318.png" alt></p>
<h4 id="2、hadoop下载安装"><a href="#2、hadoop下载安装" class="headerlink" title="2、hadoop下载安装"></a>2、hadoop下载安装</h4><p>[root@localhost data]# mkdir -p /data/hadoop</p>
<p>[root@localhost data]# cd /data/hadoop</p>
<p>[root@localhost hadoop]# wget <a href="http://mirrors.tuna.tsinghua.edu.cn/apache/hadoop/common/hadoop-2.7.7/hadoop-2.7.7.tar.gz" target="_blank" rel="noopener">http://mirrors.tuna.tsinghua.edu.cn/apache/hadoop/common/hadoop-2.7.7/hadoop-2.7.7.tar.gz</a></p>
<h4 id="3、haoop-单机模式"><a href="#3、haoop-单机模式" class="headerlink" title="3、haoop 单机模式"></a>3、haoop 单机模式</h4><p>[root@localhost hadoop]# tar -zxf hadoop-2.7.7.tar.gz</p>
<p>[root@localhost hadoop]# mkdir input</p>
<p>[root@localhost hadoop]# echo “hello world” &gt; input/file1.txt</p>
<p>[root@localhost hadoop]# echo “hello hadoop” &gt; input/file2.txt</p>
<p>[root@localhost hadoop]# ./hadoop-2.7.7/bin/hadoop jar ./hadoop-2.7.7/share/hadoop/mapreduce/hadoop-mapreduce-examples-2.7.7.jar wordcount /data/hadoop/input/ /data/hadoop/output</p>
<p>[root@localhost hadoop]# cat output/part-r-00000</p>
<p> <img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20190825160340.png" alt></p>
<h4 id="4、hadoop-伪分布式模式"><a href="#4、hadoop-伪分布式模式" class="headerlink" title="4、hadoop 伪分布式模式"></a>4、hadoop 伪分布式模式</h4><p>[root@localhost hadoop]# vi hadoop-2.7.7/etc/hadoop/hadoop-env.sh</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">修改JAVA_HOME 为：</span><br><span class="line">export JAVA_HOME=/data/tools/jdk1.8.0_65</span><br><span class="line"></span><br><span class="line">export HADOOP_OPTS="$HADOOP_OPTS -Djava.net.preferIPv4Stack=true"</span><br><span class="line">改为：</span><br><span class="line">export HADOOP_OPTS="$HADOOP_OPTS -Djava.net.preferIPv4Stack=true -Djava.security.krb5.realm= -Djava.security.krb5.kdc="</span><br></pre></td></tr></table></figure>

<p>[root@localhost hadoop]# mkdir -p /data/hadoop/hdfs/tmp</p>
<p>[root@localhost hadoop]# vi hadoop-2.7.7/etc/hadoop/core-site.xml</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&lt;<span class="selector-tag">configuration</span>&gt;</span><br><span class="line">        &lt;<span class="selector-tag">property</span>&gt;</span><br><span class="line">                &lt;name&gt;hadoop.tmp.dir&lt;/name&gt;</span><br><span class="line">                &lt;value&gt;/data/hadoop/hdfs/tmp&lt;/value&gt;</span><br><span class="line">                &lt;description&gt;A base for other temporary directories&lt;/description&gt;</span><br><span class="line">        &lt;/property&gt;</span><br><span class="line">        &lt;<span class="selector-tag">property</span>&gt;</span><br><span class="line">                &lt;name&gt;fs.default.name&lt;/name&gt;</span><br><span class="line">                &lt;value&gt;hdfs://localhost:9000&lt;/value&gt;</span><br><span class="line">        &lt;/property&gt;</span><br><span class="line">&lt;/configuration&gt;</span><br></pre></td></tr></table></figure>

<p>hadoop.tmp.dir 可以自定义；</p>
<p>fs.default.name 保存了NameNode的位置，HDFS和MapReduce组件都需要用到它；</p>
<p>[root@localhost hadoop]# vi hadoop-2.7.7/etc/hadoop/mapred-site.xml.template</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;<span class="selector-tag">configuration</span>&gt;</span><br><span class="line">        &lt;<span class="selector-tag">property</span>&gt;</span><br><span class="line">                &lt;name&gt;mapred.job.tracker&lt;/name&gt;</span><br><span class="line">                &lt;value&gt;localhost:9010&lt;/value&gt;</span><br><span class="line">        &lt;/property&gt;</span><br><span class="line">&lt;<span class="selector-tag">tconfiguration</span>&gt;</span><br></pre></td></tr></table></figure>

<p>mapred.job.tracker 保存JobTracker的位置，只有MapReduce需要知道；</p>
<p>[root@localhost hadoop]# vi hadoop-2.7.7/etc/hadoop/hdfs-site.xml</p>
<p>配置HDFS数据库的复制次数：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;<span class="selector-tag">configuration</span>&gt;</span><br><span class="line">        &lt;<span class="selector-tag">property</span>&gt;</span><br><span class="line">                &lt;name&gt;dfs.replication&lt;/name&gt;</span><br><span class="line">                &lt;value&gt;1&lt;/value&gt;</span><br><span class="line">        &lt;/property&gt;</span><br><span class="line">&lt;/configuration&gt;</span><br></pre></td></tr></table></figure>

<p>以上就配置完了，接下来格式化 namenode：</p>
<p>[root@localhost hadoop]# ./hadoop-2.7.7/bin/hadoop namenode -format</p>
<p> <img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20190825160510.png" alt></p>
<p> <img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20190825160517.png" alt></p>
<p>启动hadoop：</p>
<p>[root@localhost hadoop]# ./hadoop-2.7.7/sbin/start-all.sh </p>
<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20190825160545.png" alt></p>
<p> <img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20190825160606.png" alt></p>
<p>启动成功；</p>
<p>添加hadoop到环境变量：</p>
<p>[root@localhost hadoop-2.7.7]# vi /etc/profile</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">export HADOOP_HOME=/data/hadoop/hadoop-2.7.7</span><br><span class="line">export PATH=$PATH:$HADOOP_HOME/bin:$HADOOP_HOME/sbin</span><br></pre></td></tr></table></figure>

<p>[root@localhost hadoop-2.7.7]# source /etc/profile</p>
<h4 id="5、HDFS常用操作"><a href="#5、HDFS常用操作" class="headerlink" title="5、HDFS常用操作"></a>5、HDFS常用操作</h4><p>开放 50070 端口</p>
<p>[root@localhost hadoop-2.7.7]# firewall-cmd –permanent –add-port=50070/tcp</p>
<p>success</p>
<p>[root@localhost hadoop-2.7.7]# firewall-cmd –reload</p>
<p>success</p>
<p>[root@localhost hadoop-2.7.7]# firewall-cmd –query-port=50070/tcp</p>
<p>yes</p>
<p>访问hdfs：<a href="http://172.18.1.51:50070/" target="_blank" rel="noopener">http://172.18.1.51:50070/</a></p>
<p> <img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20190825160658.png" alt></p>
<p>[root@localhost hadoop]# hadoop fs -ls /</p>
<p>[root@localhost hadoop]# hadoop fs -mkdir /work</p>
<p>[root@localhost hadoop]# touch aa.txt</p>
<p>[root@localhost hadoop]# hadoop fs -put aa.txt /work</p>
<p>[root@localhost hadoop]# hadoop fs -test -e /work/aa.txt</p>
<p>[root@localhost hadoop]# echo $?</p>
<p>0</p>
<p>[root@localhost hadoop]# echo “hello hdfs” &gt; aa.txt </p>
<p>[root@localhost hadoop]# hadoop fs -appendToFile aa.txt /work/aa.txt</p>
<p>[root@localhost hadoop]# hadoop fs -cat /work/aa.txt</p>
<p>hello hdfs</p>
<p> <img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20190825160712.png" alt></p>
<p>[root@localhost hadoop]# hadoop fs -rm /work/aa.txt</p>
<p>19/06/10 05:04:30 INFO fs.TrashPolicyDefault: Namenode trash configuration: Deletion interval = 0 minutes, Emptier interval = 0 minutes.</p>
<p>Deleted /work/aa.txt</p>
<p>[root@localhost hadoop]# hadoop fs -rmr /work/a</p>
<p>rmr: DEPRECATED: Please use ‘rm -r’ instead.</p>
<p>rmr: `/work/a’: No such file or directory</p>
<p>[root@localhost hadoop]# hadoop dfsadmin -report</p>
<p>[root@localhost hadoop]# </p>
<p>​     </p>
<h1 id="11-2、引入ES-Hadoop依赖"><a href="#11-2、引入ES-Hadoop依赖" class="headerlink" title="11.2、引入ES-Hadoop依赖"></a>11.2、引入ES-Hadoop依赖</h1><p> <img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20190825160740.png" alt></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.elasticsearch<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>elasticsearch<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>7.0.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.elasticsearch.client<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>elasticsearch-rest-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>7.0.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.elasticsearch.client<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>elasticsearch-rest-high-level-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>7.0.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.elasticsearch<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>elasticsearch-hadoop<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>7.0.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.hadoop<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>hadoop-common<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.7.7<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.hadoop<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>hadoop-mapreduce-client-common<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.7.7<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>​           </p>
<h1 id="11-3、从-HDFS-到-Elasticsearch"><a href="#11-3、从-HDFS-到-Elasticsearch" class="headerlink" title="11.3、从 HDFS 到 Elasticsearch"></a>11.3、从 HDFS 到 Elasticsearch</h1><p>准备json文档，上传到HDFS中</p>
<p>vi blog.json</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="attr">"id"</span>:<span class="number">5</span>,<span class="attr">"title"</span>:<span class="string">"JavaScript高级程序设计"</span>,<span class="attr">"language"</span>:<span class="string">"javascript"</span>,<span class="attr">"author"</span>:<span class="string">"NicholasC.Zakas"</span>,<span class="attr">"price"</span>:<span class="number">66.4</span>,<span class="attr">"publish_time"</span>:<span class="string">"2012-03-02"</span>,<span class="attr">"desc"</span>:<span class="string">"JavaScript技术经典名著。"</span>&#125;</span><br><span class="line">&#123;<span class="attr">"id"</span>:<span class="number">3</span>,<span class="attr">"title"</span>:<span class="string">"Python科学计算"</span>,<span class="attr">"language"</span>:<span class="string">"python"</span>,<span class="attr">"author"</span>:<span class="string">"张若愚"</span>,<span class="attr">"price"</span>:<span class="number">81.4</span>,<span class="attr">"publish_time"</span>:<span class="string">"2014-01-02"</span>,<span class="attr">"desc"</span>:<span class="string">"零基础学python，光盘中坐着度假开发winPython运行环境，涵盖了Python各个扩展库。"</span>&#125;</span><br><span class="line">&#123;<span class="attr">"id"</span>:<span class="number">4</span>,<span class="attr">"title"</span>:<span class="string">"Python基础教程"</span>,<span class="attr">"language"</span>:<span class="string">"python"</span>,<span class="attr">"author"</span>:<span class="string">"Helant"</span>,<span class="attr">"price"</span>:<span class="number">54.5</span>,<span class="attr">"publish_time"</span>:<span class="string">"2014-03-02"</span>,<span class="attr">"desc"</span>:<span class="string">"经典的python入门教程，层次鲜明，结构严谨，内容详实。"</span>&#125;</span><br></pre></td></tr></table></figure>

<p>[root@localhost hadoop]# hadoop fs -put blog.json /work <img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20190825160832.png" alt></p>
<p>编写代码，从 hdfs 读取数据，写入到 Elasticsearch：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.learn.eshdoop;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.conf.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.fs.Path;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.io.NullWritable;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.io.Text;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.mapreduce.Job;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.mapreduce.Mapper;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.mapreduce.lib.input.FileInputFormat;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.mapreduce.lib.input.TextInputFormat;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.util.GenericOptionsParser;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.hadoop.mr.EsOutputFormat;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 读取 HDFS 上的内容然后写入 Elasticsearch</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HdfsToEs</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">		Configuration conf = <span class="keyword">new</span> Configuration();</span><br><span class="line">		String[] otherArgs = <span class="keyword">new</span> GenericOptionsParser(conf, args).getRemainingArgs();</span><br><span class="line">		conf.setBoolean(<span class="string">"mapred.map.tasks.speculative.execution"</span>, <span class="keyword">false</span>);</span><br><span class="line">		conf.setBoolean(<span class="string">"mapred.reduce.tasks.speculative.execution"</span>, <span class="keyword">false</span>);</span><br><span class="line">		conf.set(<span class="string">"es.nodes"</span>, <span class="string">"10.10.139.42"</span>);</span><br><span class="line">		conf.set(<span class="string">"es.port"</span>, <span class="string">"9200"</span>);</span><br><span class="line">		conf.set(<span class="string">"es.nodes.wan.only"</span>, <span class="string">"true"</span>);</span><br><span class="line">		conf.set(<span class="string">"es.resource"</span>, <span class="string">"blog/_doc"</span>);</span><br><span class="line">		conf.set(<span class="string">"es.mapping.id"</span>, <span class="string">"id"</span>);</span><br><span class="line">		conf.set(<span class="string">"es.input.json"</span>, <span class="string">"yes"</span>);</span><br><span class="line">		Job job = Job.getInstance(conf, <span class="string">"EmrToES"</span>);</span><br><span class="line">		job.setJarByClass(HdfsToEs.class);</span><br><span class="line">		job.setMapperClass(MyMapper.class);</span><br><span class="line">		job.setInputFormatClass(TextInputFormat.class);</span><br><span class="line">		job.setOutputFormatClass(EsOutputFormat.class);</span><br><span class="line">		job.setMapOutputKeyClass(NullWritable.class);</span><br><span class="line">		job.setMapOutputValueClass(Text.class);</span><br><span class="line">		FileInputFormat.setInputPaths(job, <span class="keyword">new</span> Path(otherArgs[<span class="number">0</span>]));</span><br><span class="line">		System.exit(job.waitForCompletion(<span class="keyword">true</span>) ? <span class="number">0</span> : <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MyMapper</span> <span class="keyword">extends</span> <span class="title">Mapper</span>&lt;<span class="title">Object</span>, <span class="title">Text</span>, <span class="title">NullWritable</span>, <span class="title">Text</span>&gt; </span>&#123;</span><br><span class="line">		<span class="keyword">private</span> Text line = <span class="keyword">new</span> Text();</span><br><span class="line"></span><br><span class="line">		<span class="meta">@Override</span></span><br><span class="line">		<span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">map</span><span class="params">(Object key, Text value, Context context)</span> <span class="keyword">throws</span> IOException, InterruptedException </span>&#123;</span><br><span class="line">			<span class="keyword">if</span> (value.getLength() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">				line.set(value);</span><br><span class="line">				context.write(NullWritable.get(), line);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>pom中指定主类：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-assembly-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">archive</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">manifest</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">mainClass</span>&gt;</span>com.learn.eshdoop.HdfsToEs<span class="tag">&lt;/<span class="name">mainClass</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">manifest</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">archive</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">descriptorRefs</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">descriptorRef</span>&gt;</span>jar-with-dependencies<span class="tag">&lt;/<span class="name">descriptorRef</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">descriptorRefs</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">executions</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">execution</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">id</span>&gt;</span>make-assembly<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">phase</span>&gt;</span>package<span class="tag">&lt;/<span class="name">phase</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">goals</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">goal</span>&gt;</span>single<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">goals</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">execution</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">executions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-shade-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.0.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">executions</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">execution</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">phase</span>&gt;</span>package<span class="tag">&lt;/<span class="name">phase</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">goals</span>&gt;</span><span class="tag">&lt;<span class="name">goal</span>&gt;</span>shade<span class="tag">&lt;/<span class="name">goal</span>&gt;</span><span class="tag">&lt;/<span class="name">goals</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">transformers</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">transformer</span> <span class="attr">implementation</span>=<span class="string">"org.apache.maven.plugins.shade.resource.ManifestResourceTransformer"</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">mainClass</span>&gt;</span>com.learn.eshdoop.HdfsToEs<span class="tag">&lt;/<span class="name">mainClass</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;/<span class="name">transformer</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">transformer</span> <span class="attr">implementation</span>=<span class="string">"org.apache.maven.plugins.shade.resource.ApacheLicenseResourceTransformer"</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;/<span class="name">transformer</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">transformers</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">execution</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">executions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>运行：mvn clean package 生成对应的jar 包</p>
<p> <img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20190825160957.png" alt></p>
<p> [root@localhost hadoop]# mv es-hadoop-learn-1.0-SNAPSHOT-jar-with-dependencies.jar HdfsToEs.jar</p>
<p>[root@localhost hadoop]# hadoop jar HdfsToEs.jar /work/blog.json</p>
<p> <img src="C:%5CUsers%5CCarloZ%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5C1566720615487.png" alt="1566720615487"></p>
<p>在Kibana 中 查看</p>
<p>GET blog/_mapping</p>
<p>GET blog/_search</p>
<p> <img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20190825161036.png" alt></p>
<h1 id="11-4、从Elasticsearch-到-HDFS"><a href="#11-4、从Elasticsearch-到-HDFS" class="headerlink" title="11.4、从Elasticsearch 到 HDFS"></a>11.4、从Elasticsearch 到 HDFS</h1><h4 id="1、将索引-blog-保存到-hdfs"><a href="#1、将索引-blog-保存到-hdfs" class="headerlink" title="1、将索引 blog 保存到 hdfs"></a>1、将索引 blog 保存到 hdfs</h4><p>添加Java类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.learn.eshdoop;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.conf.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.fs.Path;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.io.NullWritable;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.io.Text;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.io.Writable;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.mapreduce.Job;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.mapreduce.Mapper;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.mapreduce.lib.output.FileOutputFormat;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.util.GenericOptionsParser;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.hadoop.mr.EsInputFormat;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 查询 Elasticsearch 索引然后将结果写入 HDFS</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EsToHdfs</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">		Configuration conf = <span class="keyword">new</span> Configuration();</span><br><span class="line">		String[] otherArgs = <span class="keyword">new</span> GenericOptionsParser(conf, args).getRemainingArgs();</span><br><span class="line">		conf.set(<span class="string">"es.nodes"</span>, <span class="string">"10.10.139.42"</span>);</span><br><span class="line">		conf.set(<span class="string">"es.port"</span>, <span class="string">"9200"</span>);</span><br><span class="line">		conf.set(<span class="string">"es.resource"</span>, <span class="string">"blog/_doc"</span>);</span><br><span class="line">		conf.set(<span class="string">"es.output.json"</span>, <span class="string">"true"</span>);</span><br><span class="line">		Job job = Job.getInstance(conf, <span class="string">"hadoop es write test"</span>);</span><br><span class="line">		job.setMapperClass(MyMapper.class);</span><br><span class="line">		job.setNumReduceTasks(<span class="number">1</span>);</span><br><span class="line">		job.setMapOutputKeyClass(NullWritable.class);</span><br><span class="line">		job.setMapOutputValueClass(Text.class);</span><br><span class="line">		job.setInputFormatClass(EsInputFormat.class);</span><br><span class="line">		FileOutputFormat.setOutputPath(job, <span class="keyword">new</span> Path(otherArgs[<span class="number">0</span>]));</span><br><span class="line">		job.waitForCompletion(<span class="keyword">true</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MyMapper</span> <span class="keyword">extends</span> <span class="title">Mapper</span>&lt;<span class="title">Writable</span>, <span class="title">Writable</span>, <span class="title">NullWritable</span>, <span class="title">Text</span>&gt; </span>&#123;</span><br><span class="line">		<span class="meta">@Override</span></span><br><span class="line">		<span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">map</span><span class="params">(Writable key, Writable value, Context context)</span> <span class="keyword">throws</span> IOException, InterruptedException </span>&#123;</span><br><span class="line">			Text text = <span class="keyword">new</span> Text();</span><br><span class="line">			text.set(value.toString());</span><br><span class="line">			context.write(NullWritable.get(), text);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>修改pom.xml中的主类为：com.learn.eshdoop.EsToHdfs。</p>
<p>mvn clean package 重新打包</p>
<p>上传以后执行：</p>
<p>[root@localhost hadoop]# mv es-hadoop-learn-1.0-SNAPSHOT-jar-with-dependencies.jar EsIndexToHdfs.jar</p>
<p>[root@localhost hadoop]# hadoop jar EsIndexToHdfs.jar /work/blog_mapping</p>
<p> <img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20190825161119.png" alt></p>
<p>[root@localhost hadoop]# hadoop fs -cat /work/blog_mapping/part-r-00000</p>
<p> <img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20190825161138.png" alt></p>
<h4 id="2、将带条件查询-blog-的-数据-保存到-hdfs"><a href="#2、将带条件查询-blog-的-数据-保存到-hdfs" class="headerlink" title="2、将带条件查询 blog 的 数据 保存到 hdfs"></a>2、将带条件查询 blog 的 数据 保存到 hdfs</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.learn.eshdoop;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.conf.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.fs.Path;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.io.NullWritable;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.io.Text;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.io.Writable;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.mapreduce.Job;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.mapreduce.Mapper;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.mapreduce.lib.output.FileOutputFormat;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.util.GenericOptionsParser;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.hadoop.mr.EsInputFormat;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 查询 Elasticsearch 数据 然后将结果写入 HDFS</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EsQueryToHdfs</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">		Configuration conf = <span class="keyword">new</span> Configuration();</span><br><span class="line">		String[] otherArgs = <span class="keyword">new</span> GenericOptionsParser(conf, args).getRemainingArgs();</span><br><span class="line">		conf.set(<span class="string">"es.nodes"</span>, <span class="string">"10.10.139.42"</span>);</span><br><span class="line">		conf.set(<span class="string">"es.port"</span>, <span class="string">"9200"</span>);</span><br><span class="line">		conf.set(<span class="string">"es.resource"</span>, <span class="string">"blog/_doc"</span>);</span><br><span class="line">		conf.set(<span class="string">"es.output.json"</span>, <span class="string">"true"</span>);</span><br><span class="line">		conf.set(<span class="string">"es.query"</span>, <span class="string">"?q=title:python"</span>);</span><br><span class="line">		Job job = Job.getInstance(conf, <span class="string">"query es to HDFS"</span>);</span><br><span class="line">		job.setMapperClass(EsToHdfs.MyMapper.class);</span><br><span class="line">		job.setNumReduceTasks(<span class="number">1</span>);</span><br><span class="line">		job.setMapOutputKeyClass(NullWritable.class);</span><br><span class="line">		job.setMapOutputValueClass(Text.class);</span><br><span class="line">		job.setInputFormatClass(EsInputFormat.class);</span><br><span class="line">		FileOutputFormat.setOutputPath(job, <span class="keyword">new</span> Path(otherArgs[<span class="number">0</span>]));</span><br><span class="line">		job.waitForCompletion(<span class="keyword">true</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MyMapper</span> <span class="keyword">extends</span> <span class="title">Mapper</span>&lt;<span class="title">Writable</span>, <span class="title">Writable</span>, <span class="title">NullWritable</span>, <span class="title">Text</span>&gt; </span>&#123;</span><br><span class="line">		<span class="meta">@Override</span></span><br><span class="line">		<span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">map</span><span class="params">(Writable key, Writable value, Context context)</span> <span class="keyword">throws</span> IOException, InterruptedException </span>&#123;</span><br><span class="line">			Text text = <span class="keyword">new</span> Text();</span><br><span class="line">			text.set(value.toString());</span><br><span class="line">			context.write(NullWritable.get(), text);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在pom.xml中修改主类名称为：com.learn.eshdoop.EsQueryToHdfs；</p>
<p>mvn clean package 重新打包，然后上传；</p>
<p>[root@localhost hadoop]# mv es-hadoop-learn-1.0-SNAPSHOT-jar-with-dependencies.jar EsQueryToHdfs.jar</p>
<p>[root@localhost hadoop]# hadoop jar EsQueryToHdfs.jar /work/EsQueryToHdfs</p>
<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20190825161209.png" alt></p>
<p>[root@localhost hadoop]# hadoop fs -cat /work/EsQueryToHdfs/part-r-00000</p>
<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20190825161225.png" alt></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://carlo-z.com/micro-service/spring-cloud/register-center/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Focus-1">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Focus-1">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/micro-service/spring-cloud/register-center/" itemprop="url">常用微服务组件</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-06-09T00:00:00+08:00">
                2019-06-09
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="注册中心"><a href="#注册中心" class="headerlink" title="注册中心"></a>注册中心</h1><p>nacos、eureka、zookeeper、redis、consul、etcd3</p>
<h1 id="配置中心"><a href="#配置中心" class="headerlink" title="配置中心"></a>配置中心</h1>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://carlo-z.com/java/sharding-sphere/disributed-transaction/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Focus-1">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Focus-1">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/java/sharding-sphere/disributed-transaction/" itemprop="url">shardingSphere 之分布式事务</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-06-05T00:00:00+08:00">
                2019-06-05
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <br>



<h1 id="强一致性事务XA"><a href="#强一致性事务XA" class="headerlink" title="强一致性事务XA"></a>强一致性事务XA</h1><p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20200605212607.png" alt></p>
<h3 id="2PC"><a href="#2PC" class="headerlink" title="2PC"></a>2PC</h3><p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20200605212503.png" alt></p>
<h3 id="3PC"><a href="#3PC" class="headerlink" title="3PC"></a>3PC</h3><p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20200605213557.png" alt></p>
<p>缺点：协调者或参与者 故障以后，会出现数据不一致的问题、3PC虽然比2PC有所改善，但并没有从根本上解决问题</p>
<p>市面上有关于2PC模型的实现，没有3PC模型的实现</p>
<p>基于2PC的模型：TCC、Seata</p>
<p>sharding-shere 通过SPI实现的XA事务的组件：</p>
<ul>
<li>bitronix</li>
<li>narayana</li>
<li>atomickos</li>
</ul>
<br>

<h1 id="柔性事务BASE-gt-Seata-AT模型"><a href="#柔性事务BASE-gt-Seata-AT模型" class="headerlink" title="柔性事务BASE -&gt; Seata(AT模型)"></a>柔性事务BASE -&gt; Seata(AT模型)</h1><p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20200605220315.png" alt></p>
<br>

<h1 id="其他事务"><a href="#其他事务" class="headerlink" title="其他事务"></a>其他事务</h1><p>通过SPI自己实现</p>
<h3 id="TCC"><a href="#TCC" class="headerlink" title="TCC"></a>TCC</h3><p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20200607204123.png" alt></p>
<p>XA 和 TCC 的去别：XA 是基于资源的，代码不用改；TCC是基于应用的，比较复杂</p>
<p>TCC：try()  ==&gt; 预留资源</p>
<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20200607204556.png" alt></p>
<ul>
<li>ByteTCC</li>
<li>TinyTCC</li>
<li>transactionTCC</li>
</ul>
<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20200607205621.png" alt></p>
<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20200607210419.png" alt></p>
<h3 id="Saga"><a href="#Saga" class="headerlink" title="Saga"></a>Saga</h3><p>应用场景：长事务（整个事务运行时间比较长）</p>
<p>实现方式：MQ，ZK</p>
<p>拆分成，多个子事务</p>
<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20200607212729.png" alt></p>
<h5 id="事件编排"><a href="#事件编排" class="headerlink" title="事件编排"></a>事件编排</h5><h5 id="命令协调"><a href="#命令协调" class="headerlink" title="命令协调"></a>命令协调</h5><p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20200607213515.png" alt></p>
<h3 id="Seata"><a href="#Seata" class="headerlink" title="Seata"></a>Seata</h3><h5 id="AT模式"><a href="#AT模式" class="headerlink" title="AT模式"></a>AT模式</h5><p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20200607214101.png" alt></p>
<h5 id="工作流程"><a href="#工作流程" class="headerlink" title="工作流程"></a>工作流程</h5><p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20200607215143.png" alt></p>
<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20200607215503.png" alt></p>
<h5 id="使用示例"><a href="#使用示例" class="headerlink" title="使用示例"></a>使用示例</h5><br>

<p>Seata</p>
<ul>
<li><p>XA Atomikos</p>
</li>
<li><p>TCC 业务实现TCC过程，由TM去调度 =&gt; 本地状态表</p>
</li>
<li><p>Saga 正向和反向， 编排+命令 =&gt; MQ/ZK</p>
</li>
<li><p>AT 本地事务表</p>
</li>
<li><p>MQ</p>
</li>
</ul>
<h1 id="JTA（Java-Transaction-API）"><a href="#JTA（Java-Transaction-API）" class="headerlink" title="JTA（Java Transaction API）"></a>JTA（Java Transaction API）</h1><p>轻量级事务：XA</p>
<p>重量级事务：容器事务Weblogic JBoss</p>
<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20200605214937.png" alt></p>
<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20200605214952.png" alt></p>
<h1 id="数据编排治理"><a href="#数据编排治理" class="headerlink" title="数据编排治理"></a>数据编排治理</h1><p>配置中心：如果修改了配置，不需要重启应用</p>
<p>注册中心：运行时让DB动态上下线（熔断）</p>
<p>元数据中心：</p>
<p>数据库结构</p>
<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20200609212227.png" alt></p>
<p>zk做配置中心和注册中心</p>
<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20200609212141.png" alt></p>
<p>元数据中心</p>
<p>工程结构</p>
<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20200609212458.png" alt></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/5/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/5/">5</a><span class="page-number current">6</span><a class="page-number" href="/page/7/">7</a><span class="space">&hellip;</span><a class="page-number" href="/page/24/">24</a><a class="extend next" rel="next" href="/page/7/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">Focus-1</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">236</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">59</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">100</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          

          
          

          
          
            <div class="links-of-blogroll motion-element links-of-blogroll-block">
              <div class="links-of-blogroll-title">
                <i class="fa  fa-fw fa-link"></i>
                Links
              </div>
              <ul class="links-of-blogroll-list">
                
                  <li class="links-of-blogroll-item">
                    <a href="https://gitee.com/carloz" title="repository - https://gitee.com/carloz" target="_blank">repository - https://gitee.com/carloz</a>
                  </li>
                
              </ul>
            </div>
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2015 &mdash; <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Focus-1</span>

  
</div>








  <div class="footer-custom">Hosted by <a target="_blank" href="https://gitee.com/carloz">Gitee Repo</a></div>


        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  
  

  
  
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
          processEscapes: true,
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
      });
    </script>

    <script type="text/x-mathjax-config">
      MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
        }
      });
    </script>
    <script type="text/javascript" src="//cdn.bootcss.com/mathjax/2.7.1/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
  


  

  

</body>
</html>
