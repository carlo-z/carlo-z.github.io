<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">




  
  
  
  

  
    
    
  

  

  

  
    
      
    

    
  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=consolas:300,300italic,400,400italic,700,700italic|Lobster Two:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT">










<meta name="keywords" content="Java Kafka Docker JVM NIO Netty">
<meta property="og:type" content="website">
<meta property="og:title" content="Focus-1">
<meta property="og:url" content="https://carlo-z.com/page/3/index.html">
<meta property="og:site_name" content="Focus-1">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Focus-1">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"left","display":"always","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://carlo-z.com/page/3/">





  <title>Focus-1</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Focus-1</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br>
            
            关于
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://carlo-z.com/flink/flink-on-k8s/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Focus-1">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Focus-1">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/flink/flink-on-k8s/" itemprop="url">Flink on K8s 部署</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-04-05T00:00:00+08:00">
                2020-04-05
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/flink/" itemprop="url" rel="index">
                    <span itemprop="name">flink</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <br>

<blockquote>
<p>参考文档：</p>
</blockquote>
<blockquote>
<p>官网文档：</p>
<p><a href="https://ci.apache.org/projects/flink/flink-docs-stable/zh/ops/deployment/kubernetes.html" target="_blank" rel="noopener">https://ci.apache.org/projects/flink/flink-docs-stable/zh/ops/deployment/kubernetes.html</a></p>
<p><a href="https://ci.apache.org/projects/flink/flink-docs-release-1.11/zh/ops/deployment/native_kubernetes.html" target="_blank" rel="noopener">https://ci.apache.org/projects/flink/flink-docs-release-1.11/zh/ops/deployment/native_kubernetes.html</a></p>
</blockquote>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://carlo-z.com/computer-network/tcpdump-tcp-3-and-4/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Focus-1">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Focus-1">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/computer-network/tcpdump-tcp-3-and-4/" itemprop="url">TCP三次握手与Tcpdump抓包分析过程</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-03-22T14:51:54+08:00">
                2020-03-22
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <hr>
<br>

<h2 id="一、TCP连接建立（三次握手）"><a href="#一、TCP连接建立（三次握手）" class="headerlink" title="一、TCP连接建立（三次握手）"></a>一、TCP连接建立（三次握手）</h2><h4 id="过程"><a href="#过程" class="headerlink" title="过程"></a><em>过程</em></h4><p>客户端A，服务器B，初始序号seq，确认号ack</p>
<p>初始状态：B处于监听状态，A处于打开状态</p>
<ul>
<li>A -&gt; B : seq = x （A向B发送连接请求报文段，A进入同步发送状态SYN-SENT）</li>
<li>B -&gt; A : ack = x + 1,seq = y （B收到报文段，向A发送确认，B进入同步收到状态SYN-RCVD）</li>
<li>A -&gt; B : ack = y+1 （A收到B的确认后，再次确认，A进入连接状态ESTABLISHED）</li>
</ul>
<p>连接后的状态：B收到A的确认后，进入连接状态ESTABLISHED</p>
<h4 id="为什么要握手要三次"><a href="#为什么要握手要三次" class="headerlink" title="为什么要握手要三次"></a><em>为什么要握手要三次</em></h4><p>防止失效的连接请求突然传到服务器端，让服务器端误认为要建立连接。</p>
<h2 id="二、TCP连接释放（四次挥手）"><a href="#二、TCP连接释放（四次挥手）" class="headerlink" title="二、TCP连接释放（四次挥手）"></a>二、TCP连接释放（四次挥手）</h2><h4 id="过程-1"><a href="#过程-1" class="headerlink" title="过程"></a><em>过程</em></h4><p>A -&gt; B : seq = u （A发出连接释放报文段，进入终止等待1状态FIN-WAIT-1）</p>
<p>B -&gt; A : ack = u + 1,seq = v （B收到报文段，发出确认，TCP处于半关闭，B还可向A发数据，B进入关闭等待状态WAIT）</p>
<p>B -&gt; A : ack = u + 1,seq = w （B重复发送确认号，进入最后确认状态LAST-ACK）</p>
<p>A -&gt; B : ack = w + 1,seq = u + 1 （A发出确认，进入时间等待状态TIME-WAIT）</p>
<p>经过时间等待计时器设置的时间2MSL后，A才进入CLOSED状态</p>
<h4 id="为什么A进入TIME-WAIT后必须等待2MSL"><a href="#为什么A进入TIME-WAIT后必须等待2MSL" class="headerlink" title="为什么A进入TIME-WAIT后必须等待2MSL"></a><em>为什么A进入TIME-WAIT后必须等待2MSL</em></h4><ul>
<li>保证A发送的最后一个ACK报文段能达到B</li>
<li>防止失效的报文段出现在连接中</li>
</ul>
<h2 id="三、需要思考的问题"><a href="#三、需要思考的问题" class="headerlink" title="三、需要思考的问题"></a>三、需要思考的问题</h2><p>问题1: 请详细描述三次握手和四次挥手的过程<br>要求熟悉三次握手和四次挥手的机制，要求画出状态图。</p>
<p>问题2: 四次挥手中TIME_WAIT状态存在的目的是什么?<br>这个问题是画出四次挥手状态图，会引申问你。不排除还会问为什么四次挥手是四次不是二次等问题。最好是把相关问题均掌握。</p>
<p>问题3: TCP是通过什么机制保障可靠性的?<br>从四个方面进行回答，ACK确认机制、超时重传、滑动窗口以及流量控制，深入的话要求详细讲出流量控制的机制。</p>
<h2 id="四、Tcpdump使用"><a href="#四、Tcpdump使用" class="headerlink" title="四、Tcpdump使用"></a>四、Tcpdump使用</h2><p>tcpdump是对网络上的数据包进行截获的包分析工具，它支持针对网络层、协议、主机、网络或端口的过滤，并提供and、or、not等逻辑语句来去掉无用的信息。</p>
<h4 id="监视指定主机的数据包"><a href="#监视指定主机的数据包" class="headerlink" title="监视指定主机的数据包"></a><em>监视指定主机的数据包</em></h4><p><code>tcpdump host</code>：截获该IP的主机收到的和发出的所有的数据包<br><code>tcpdump host  and</code>：截获两个IP对应主机之间的通信</p>
<h4 id="监视指定端口的数据包"><a href="#监视指定端口的数据包" class="headerlink" title="监视指定端口的数据包"></a><em>监视指定端口的数据包</em></h4><p><code>tcpdump port &lt;端口号&gt;</code>：截获本机80端口的数据包</p>
<h2 id="五、抓包分析握手过程"><a href="#五、抓包分析握手过程" class="headerlink" title="五、抓包分析握手过程"></a>五、抓包分析握手过程</h2><p>抓包方法：首先使用tcpdump命令截获本机与某远程主机的数据包，然后打开某远程主机对应的网站，这里用我的域名<code>www.fonxian.cn</code>来做试验。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Copyping www.fonxian.cn</span><br></pre></td></tr></table></figure>

<p>得到域名对应的ip：<code>151.101.100.133</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Copyifconfg</span><br></pre></td></tr></table></figure>

<p>得到本机内网ip：<code>192.168.0.108</code></p>
<p>-S 参数的目的是获得ack的绝对值，不加该参数，第三次握手的ack为相对值1</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Copysudo tcpdump -S host 192.168.0.108 and 151.101.100.133</span><br></pre></td></tr></table></figure>

<p>得到下图<br><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20200322152925.png" alt></p>
<h2 id="参考文档"><a href="#参考文档" class="headerlink" title="参考文档"></a>参考文档</h2>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://carlo-z.com/computer-network/traceroute-icmp-and-tcp/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Focus-1">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Focus-1">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/computer-network/traceroute-icmp-and-tcp/" itemprop="url">ping通tcp不通</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-03-21T23:08:22+08:00">
                2020-03-21
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <hr>
<br>

<h1 id="linux-机器"><a href="#linux-机器" class="headerlink" title="linux 机器"></a>linux 机器</h1><h3 id="TraceRoute-实现原理"><a href="#TraceRoute-实现原理" class="headerlink" title="TraceRoute 实现原理"></a>TraceRoute 实现原理</h3><p>Traceroute是用来侦测主机到目的主机之间所经路由情况的重要工具。</p>
<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20200322010041.png" alt></p>
<ol>
<li>从源地址发出一个UDP探测包到目的地址，并将TTL设置为1；</li>
<li>到达路由器时，将TTL减1；</li>
<li>当TTL变为0时，包被丢弃，路由器向源地址发回一个ICMP超时通知（ICMP Time Exceeded Message），内含发送IP包的源地址，IP包的所有内容及路由器的IP地址；</li>
<li>当源地址收到该ICMP包时，显示这一跳路由信息；</li>
<li>重复1～5，并每次设置TTL加1；</li>
<li>直至目标地址收到探测数据包，并返回端口不可达通知（ICMP Port Unreachable）；</li>
<li>当源地址收到ICMP Port Unreachable包时停止traceroute。</li>
</ol>
<blockquote>
<ol>
<li>Linux和Mac OS等系统使用UDP包进行探测，目标端口号默认为33434，每次探测目标端口号加1。Traceroute故意使用了一个大于 30000 的目标端口号，以保证目标地址收到数据包后能够返回一个“端口不可达”的 ICMP 报文，于是源地址就可将端口不可达报文当作跟踪结束的标志。</li>
<li>Traceroute每跳默认发送3个探测包（发包的数量可通过-q进行设置），探测包的返回会受到网络情况的影响。如果防火墙封掉了ICMP的返回信息，那么相应的延时位置会以*显示。如果某台网关阻塞或者某台DNS出现问题，那么相应行的延时会变长。可以加-n 参数来避免DNS解析，以IP格式输出数据。</li>
<li>每个探测包都有唯一的标识号，使得Traceroute能够识别返回的包。UDP数据包使用递增的目标端口号进行标识。</li>
</ol>
</blockquote>
<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20200322003733.png" alt></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">traceroute [-n] -T -p &lt;目标端口号&gt; Host</span><br></pre></td></tr></table></figure>

<p><strong>参数说明</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">traceroute [-46dFITUnreAV] [-f first_ttl] [-g gate,...]</span><br><span class="line">        [-i device] [-m max_ttl] [-p port] [-s src_addr]</span><br><span class="line">        [-q nqueries] [-N squeries] [-t tos]</span><br><span class="line">        [-l flow_label] [-w waittime] [-z sendwait] [-UL] [-D]</span><br><span class="line">        [-P proto] [--sport=port] [-M method] [-O mod_options]</span><br><span class="line">        [--mtu] [--back]</span><br><span class="line">        host [packet_len]</span><br><span class="line">traceroute6  [options]</span><br><span class="line">       </span><br><span class="line">Host 目标服务器域名或 IP。</span><br><span class="line">-4, -6 指定使用 IPv4 or IPv6</span><br><span class="line">-I 使用icmp探测</span><br><span class="line">-T 通过 TCP 探测</span><br><span class="line">-n 直接使用 IP 地址而非主机名称（禁用 DNS 反查）。</span><br><span class="line">-p port</span><br><span class="line">   对于UDP跟踪，指定将使用的目标端口基traceroute（目标端口号将由每个探测递增）。</span><br><span class="line">   对于ICMP跟踪，指定初始ICMP序列值（也由每个探测递增）。</span><br><span class="line">   对于TCP和其他端口，只指定要连接的（常量）目标端口。</span><br><span class="line">-r 绕过常规路由表，直接发送到连接网络上的主机。如果主机不在直接连接的网络上，则返回错误。此选项可用于通过没有路由的接口ping本地主机。</span><br><span class="line">-m max_ttl 默认最多30跳</span><br><span class="line">-w waittime 每一跳最多等待多长时间，默认5秒</span><br><span class="line">-g gateway 指定包出口网关</span><br><span class="line">-i interface 指定网卡名</span><br><span class="line">-s source_addr 指定源ip（必须是某个网卡ip）</span><br><span class="line">-z sendwait 指定每一跳的时间间隔（默认0）</span><br><span class="line">-e, --extensions 显示ICMP扩展（rfc4884）。一般形式是类/类型：后跟十六进制转储。MPLS（rfc4950）以如下形式显示：MPLS:L=label，E=exp_use，S=stack_bottom，T=TTL（更多由/）分隔的对象。</span><br><span class="line">-A 在路由注册表中执行路径查找，并在相应地址后直接打印结果。</span><br><span class="line">-q num, 每个网关发送num个数据包</span><br><span class="line"></span><br><span class="line">-------------</span><br><span class="line">--sport=port 选择一个源端口</span><br><span class="line">--fwmark=mark 设置一个防火墙标记</span><br><span class="line">-U, --udp 使用udp协议探测目标端口</span><br><span class="line">-UL, 使用 UDPLITE 进行探测</span><br><span class="line">-D, 使用DCCP（数据包拥塞控制协议）请求进行探测</span><br><span class="line">-P protocol，使用指定协议的原始数据包进行跟踪路由。默认协议是253</span><br><span class="line">--mtu 路径MTU是指一条因特网传输路径中，从源地址到目的地址所经过的“路径”上的所有IP跳的最大传输单元的最小值。或者从另外一个角度来看，就是无需进行分片处理就能穿过这条“路径”的最大传输单元的最大值。</span><br><span class="line">--back 响应包可能与探测包路径不同，打印响应包的跳数</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">更多关于 traceroute 的用法，您可以通过man帮助查阅。</span><br></pre></td></tr></table></figure>

<p>异常节点判定方法：如果相关端口在某一跳被阻断，则其后各跳均不会返回数据。据此就可以判定出异常节点</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[root@10-1-53-21 ~]# traceroute -n -T -p 443 183.3.217.36</span><br><span class="line">traceroute to 183.3.217.36 (183.3.217.36), 30 hops max, 60 byte packets</span><br><span class="line"> 1  172.23.0.43  0.099 ms  0.051 ms  0.035 ms</span><br><span class="line"> 2  172.23.0.254  4.176 ms  4.487 ms  4.789 ms</span><br><span class="line"> 3  10.1.255.6  0.307 ms  0.425 ms  0.420 ms</span><br><span class="line"> 4  122.115.48.65  3.080 ms  3.535 ms  3.806 ms</span><br><span class="line"> 5  10.78.3.5  6.626 ms  7.133 ms  7.533 ms</span><br><span class="line"> 6  172.16.0.1  1.333 ms  1.355 ms  1.454 ms</span><br><span class="line"> 7  219.142.20.49  1.731 ms  1.738 ms  1.690 ms</span><br><span class="line"> 8  * * *</span><br><span class="line"> 9  * * *</span><br><span class="line">10  219.141.152.53  2.621 ms * *</span><br><span class="line">11  * * *</span><br><span class="line">12  * 119.147.222.122  42.294 ms 119.147.220.74  39.959 ms</span><br><span class="line">13  113.106.51.70  39.030 ms  38.859 ms 113.106.51.86  35.560 ms</span><br><span class="line">14  113.106.52.134  39.720 ms  40.552 ms  41.223 ms</span><br><span class="line">15  183.3.217.36  34.676 ms  36.169 ms  36.221 ms</span><br><span class="line">16  * * *</span><br><span class="line">17  * * *</span><br><span class="line">18  183.3.217.36  38.777 ms  39.290 ms  39.291 ms</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">[root@10-1-53-21 ~]# traceroute -n -T -p 443 183.3.217.36</span><br><span class="line">traceroute to 183.3.217.36 (183.3.217.36), 30 hops max, 60 byte packets</span><br><span class="line"> 1  172.23.0.43  0.127 ms  0.101 ms  0.084 ms</span><br><span class="line"> 2  172.23.0.254  5.911 ms  7.257 ms  7.248 ms</span><br><span class="line"> 3  10.1.255.6  0.451 ms  0.441 ms  0.426 ms</span><br><span class="line"> 4  122.115.48.65  3.120 ms  3.574 ms  3.813 ms</span><br><span class="line"> 5  10.78.3.5  6.859 ms  7.208 ms  7.575 ms</span><br><span class="line"> 6  172.16.0.1  1.258 ms  1.364 ms  1.429 ms</span><br><span class="line"> 7  219.142.20.49  10.966 ms  10.785 ms  10.764 ms</span><br><span class="line"> 8  * * *</span><br><span class="line"> 9  * * *</span><br><span class="line">10  219.141.152.61  3.043 ms 219.141.152.65  6.084 ms *</span><br><span class="line">11  * * *</span><br><span class="line">12  * * *</span><br><span class="line">13  113.106.51.86  36.000 ms  35.589 ms 113.106.51.82  36.043 ms</span><br><span class="line">14  113.106.52.130  41.988 ms 113.106.52.134  38.881 ms  39.337 ms</span><br><span class="line">15  183.3.217.36  35.303 ms  36.716 ms  36.751 ms</span><br><span class="line">16  * * *</span><br><span class="line">17  * * *</span><br><span class="line">18  * * *</span><br><span class="line">19  * * *</span><br><span class="line">20  * * *</span><br><span class="line">21  * * *</span><br><span class="line">22  * * *</span><br><span class="line">23  * * *</span><br><span class="line">24  * * *</span><br><span class="line">25  * * *</span><br><span class="line">26  * * *</span><br><span class="line">27  * * *</span><br><span class="line">28  * * *</span><br><span class="line">29  * * *</span><br><span class="line">30  * * *</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">yum install -y sshpass</span><br><span class="line"></span><br><span class="line">nc 183.3.217.36 443</span><br><span class="line">nc -vz jzjyszdx01.jzsec.com 443</span><br><span class="line">nc -vz 183.3.217.36 443</span><br><span class="line">traceroute 183.3.217.36</span><br><span class="line">ping 183.3.217.36</span><br><span class="line">sshpass -p 'sdfsfsdfsgg' ssh root@10.198.45.139</span><br><span class="line">sshpass -p 'sdfsfsdfsgg' ssh root@10.198.45.141</span><br><span class="line">traceroute -n -T -p 443 183.3.217.36</span><br><span class="line">traceroute -4nTe -p 443 -m 40 183.3.217.36</span><br><span class="line">traceroute -4nIe -m 40 183.3.217.36</span><br><span class="line">traceroute -4nUe -p 443 -m 40 183.3.217.36</span><br><span class="line">traceroute -4nTe -m 40 -p 22 10.198.45.139</span><br><span class="line"></span><br><span class="line">nc 112.95.153.36 443</span><br><span class="line">nc -vz jzjyszlt01.jzsec.com 443</span><br><span class="line">nc -vz 112.95.153.36 443</span><br><span class="line">traceroute -m 40 112.95.153.36</span><br><span class="line">traceroute -n -T -p 443 112.95.153.36</span><br><span class="line">traceroute -4nTe -p 443 -m 40 112.95.153.36</span><br><span class="line">sshpass -p 'sdfsfsdfsgg' ssh root@10.198.45.140</span><br><span class="line">sshpass -p 'sdfsfsdfsgg' ssh root@10.198.45.142</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@10-1-53-21 ~]# nc 183.3.217.36 443</span><br><span class="line">123ewq</span><br><span class="line">[root@10-1-53-21 ~]# netstat -atn | grep "ES" | grep 183.3.217.36</span><br><span class="line">[root@10-1-53-21 ~]# netstat -atn | grep "ES" | grep 112.95.153.36</span><br><span class="line">[root@10-198-45-139 ~]# tcpdump 'tcp and src 122.115.48.123 and dst port 443 and (((ip[2:2] - ((ip[0]&amp;0xf)&lt;&lt;2)) - ((tcp[12]&amp;0xf0)&gt;&gt;2)) &lt; 20)' -XX</span><br><span class="line">[root@10-198-45-139 ~]# tcpdump 'tcp and src 43.227.140.124 and dst port 443 and (((ip[2:2] - ((ip[0]&amp;0xf)&lt;&lt;2)) - ((tcp[12]&amp;0xf0)&gt;&gt;2)) &lt; 20)' -XX</span><br><span class="line">tcpdump 'tcp and dst port 443 and (0 &lt; ((ip[2:2] - ((ip[0]&amp;0xf)&lt;&lt;2)) - ((tcp[12]&amp;0xf0)&gt;&gt;2))) and (((ip[2:2] - ((ip[0]&amp;0xf)&lt;&lt;2)) - ((tcp[12]&amp;0xf0)&gt;&gt;2)) &lt; 20)' -XX</span><br></pre></td></tr></table></figure>

<h1 id="windows-机器"><a href="#windows-机器" class="headerlink" title="windows 机器"></a>windows 机器</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tracetcp &lt;目标服务器域名或 IP&gt;:&lt;待探测端口号&gt;</span><br></pre></td></tr></table></figure>

<p>异常节点判定方法：如果相关端口在某一跳被阻断，则其后各跳均不会返回数据。据此就可以判定出异常节点</p>
<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20200322010343.png" alt></p>
<h3 id="Tracert实现原理"><a href="#Tracert实现原理" class="headerlink" title="Tracert实现原理"></a>Tracert实现原理</h3><ol>
<li><p>从源地址发出一个ICMP请求回显（ICMP Echo Request）数据包到目的地址，并将TTL设置为1；</p>
</li>
<li><p>到达路由器时，将TTL减1；</p>
</li>
<li><p>当TTL变为0时，包被丢弃，路由器向源地址发回一个ICMP超时通知（ICMP Time Exceeded Message），内含发送IP包的源地址，IP包的所有内容及路由器的IP地址；</p>
</li>
<li><p>当源地址收到该ICMP包时，显示这一跳路由信息；</p>
</li>
<li><p>重复1～5，并每次设置TTL加1；</p>
</li>
<li><p>直至目标地址收到探测数据包，并返回ICMP回应答复（ICMPEcho Reply）；</p>
</li>
<li><p>当源地址收到ICMP Echo Reply包时停止tracert。</p>
</li>
</ol>
<blockquote>
<p><strong>注：</strong></p>
<p>1.Windows系统使用ICMP请求回显（ICMP Echo Request）数据包进行探测，源地址以目的地址返回的ICMP回应答复（ICMP Echo Reply）作为跟踪结束标志。</p>
<p>2.Traceroute每跳默认发送3个探测包。在未能到达路由器或未返回ICMP超时通知的情况下，相应的延时位置会以*显示。</p>
<p>3.每个探测包都有唯一的标识号，ICMP数据包使用seq进行标识。</p>
</blockquote>
<h3 id="tracetcp"><a href="#tracetcp" class="headerlink" title="tracetcp"></a>tracetcp</h3><p>安装依赖</p>
<p><a href="https://www.winpcap.org/" target="_blank" rel="noopener">https://www.winpcap.org/</a></p>
<p>下载tracetcp，解压后放在c:/windows下</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://www.github.com/simulatedsimian/tracetcp</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">tracetcp host [options]</span><br><span class="line">    where host = hostName|ipAddress[:portNumber|serviceName]</span><br><span class="line">    if portNumber or serviceName is not present then port 80 (http) </span><br><span class="line">    is assumed.</span><br><span class="line"></span><br><span class="line">Options:</span><br><span class="line">    -?            Displays help information.</span><br><span class="line"></span><br><span class="line">    -c            Select condensed output mode</span><br><span class="line"></span><br><span class="line">    -h start_hop  Starts trace at hop specified.</span><br><span class="line"></span><br><span class="line">    -m max_hops   Maximum number of hops to reach target.</span><br><span class="line"></span><br><span class="line">    -n            No reverse DNS lookups for each node.</span><br><span class="line"></span><br><span class="line">    -p num_pings  # of pings per hop (default 3).</span><br><span class="line"></span><br><span class="line">    -r p1 p2      Multiple traces from port p1 to p2.</span><br><span class="line"></span><br><span class="line">    -t timeout    Wait timeout milliseconds for each reply.</span><br><span class="line"></span><br><span class="line">    -v            Displays version information.</span><br><span class="line"></span><br><span class="line">    -s p1 p2      Easy port scan mode. gives the same result as</span><br><span class="line">                  setting the following options:</span><br><span class="line">                  -cnr p1 p2 -h 128 -m 1 -p 1</span><br><span class="line"></span><br><span class="line">    -F            Disables the Anti-flood timer. Normally tracetcp</span><br><span class="line">                  waits *at least* 0.5 seconds between sending out </span><br><span class="line">                  each packet, because if the packets are sent too </span><br><span class="line">                  fast some host seem to detect this as some form of </span><br><span class="line">                  flood and stop responding for a time. This option </span><br><span class="line">                  disables the 0.5 second timer, so the traces occur</span><br><span class="line">                  faster.</span><br><span class="line"></span><br><span class="line">    -R            Use raw socket interface to send/receive packets</span><br><span class="line">                  this will not work on XP sp2. </span><br><span class="line">                  (you still need winpcap installed)</span><br><span class="line"></span><br><span class="line">    -g address    use the specified host as a a gateway to remote</span><br><span class="line">                  systems rather than the default gateway.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Examples:</span><br><span class="line">    tracetcp www.microsoft.com:80 -m 60</span><br><span class="line">    tracetcp post.sponge.com:smtp</span><br><span class="line">    tracetcp 192.168.0.1 -n -t 500</span><br></pre></td></tr></table></figure>

<h3 id="itracert"><a href="#itracert" class="headerlink" title="itracert"></a>itracert</h3><h3 id="tcping"><a href="#tcping" class="headerlink" title="tcping"></a>tcping</h3><h3 id="httpping"><a href="#httpping" class="headerlink" title="httpping"></a>httpping</h3>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://carlo-z.com/micro-service/spring-cloud/nacos/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Focus-1">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Focus-1">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/micro-service/spring-cloud/nacos/" itemprop="url">Nacos 快速开始</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-03-14T00:00:00+08:00">
                2020-03-14
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/springcloud/" itemprop="url" rel="index">
                    <span itemprop="name">springcloud</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <hr>
<blockquote>
<p>官网：<a href="https://nacos.io/zh-cn/docs/quick-start.html" target="_blank" rel="noopener">https://nacos.io/zh-cn/docs/quick-start.html</a></p>
</blockquote>
<h1 id="Nacos-Server-安装"><a href="#Nacos-Server-安装" class="headerlink" title="Nacos Server 安装"></a>Nacos Server 安装</h1><p>这个快速开始手册是帮忙您快速在您的电脑上，下载、安装并使用 Nacos。</p>
<h2 id="0-版本选择"><a href="#0-版本选择" class="headerlink" title="0.版本选择"></a>0.版本选择</h2><p>您可以在Nacos的<a href="https://github.com/alibaba/nacos/releases" target="_blank" rel="noopener">release notes</a>及<a href="https://nacos.io/zh-cn/blog/index.html" target="_blank" rel="noopener">博客</a>中找到每个版本支持的功能的介绍，当前推荐的稳定版本为1.1.4。</p>
<h2 id="1-预备环境准备"><a href="#1-预备环境准备" class="headerlink" title="1.预备环境准备"></a>1.预备环境准备</h2><p>Nacos 依赖 <a href="https://docs.oracle.com/cd/E19182-01/820-7851/inst_cli_jdk_javahome_t/" target="_blank" rel="noopener">Java</a> 环境来运行。如果您是从代码开始构建并运行Nacos，还需要为此配置 <a href="https://maven.apache.org/index.html" target="_blank" rel="noopener">Maven</a>环境，请确保是在以下版本环境中安装使用:</p>
<ol>
<li>64 bit OS，支持 Linux/Unix/Mac/Windows，推荐选用 Linux/Unix/Mac。</li>
<li>64 bit JDK 1.8+；<a href="http://www.oracle.com/technetwork/java/javase/downloads/jdk8-downloads-2133151.html" target="_blank" rel="noopener">下载</a> &amp; <a href="https://docs.oracle.com/cd/E19182-01/820-7851/inst_cli_jdk_javahome_t/" target="_blank" rel="noopener">配置</a>。</li>
<li>Maven 3.2.x+；<a href="https://maven.apache.org/download.cgi" target="_blank" rel="noopener">下载</a> &amp; <a href="https://maven.apache.org/settings.html" target="_blank" rel="noopener">配置</a>。</li>
</ol>
<h2 id="2-下载源码或者安装包"><a href="#2-下载源码或者安装包" class="headerlink" title="2.下载源码或者安装包"></a>2.下载源码或者安装包</h2><p>你可以通过源码和发行包两种方式来获取 Nacos。</p>
<h3 id="从-Github-上下载源码方式"><a href="#从-Github-上下载源码方式" class="headerlink" title="从 Github 上下载源码方式"></a>从 Github 上下载源码方式</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://github.com/alibaba/nacos.git</span><br><span class="line"><span class="built_in">cd</span> nacos/</span><br><span class="line">mvn -Prelease-nacos -Dmaven.test.skip=<span class="literal">true</span> clean install -U  </span><br><span class="line">ls -al distribution/target/</span><br><span class="line"></span><br><span class="line">// change the <span class="variable">$version</span> to your actual path</span><br><span class="line"><span class="built_in">cd</span> distribution/target/nacos-server-<span class="variable">$version</span>/nacos/bin</span><br></pre></td></tr></table></figure>

<h3 id="下载编译后压缩包方式"><a href="#下载编译后压缩包方式" class="headerlink" title="下载编译后压缩包方式"></a>下载编译后压缩包方式</h3><p>您可以从 <a href="https://github.com/alibaba/nacos/releases" target="_blank" rel="noopener">最新稳定版本</a> 下载 <code>nacos-server-$version.zip</code> 包。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">unzip nacos-server-<span class="variable">$version</span>.zip 或者 tar -xvf nacos-server-<span class="variable">$version</span>.tar.gz</span><br><span class="line"><span class="built_in">cd</span> nacos/bin</span><br></pre></td></tr></table></figure>

<h2 id="3-启动服务器"><a href="#3-启动服务器" class="headerlink" title="3.启动服务器"></a>3.启动服务器</h2><h3 id="Linux-Unix-Mac"><a href="#Linux-Unix-Mac" class="headerlink" title="Linux/Unix/Mac"></a>Linux/Unix/Mac</h3><p>启动命令(standalone代表着单机模式运行，非集群模式):</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sh startup.sh -m standalone</span><br></pre></td></tr></table></figure>

<p>如果您使用的是ubuntu系统，或者运行脚本报错提示[[符号找不到，可尝试如下运行：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bash startup.sh -m standalone</span><br></pre></td></tr></table></figure>

<h3 id="Windows"><a href="#Windows" class="headerlink" title="Windows"></a>Windows</h3><p>启动命令：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cmd startup.cmd</span><br></pre></td></tr></table></figure>

<p>或者双击startup.cmd运行文件。</p>
<h2 id="4-服务注册-amp-发现和配置管理"><a href="#4-服务注册-amp-发现和配置管理" class="headerlink" title="4.服务注册&amp;发现和配置管理"></a>4.服务注册&amp;发现和配置管理</h2><h3 id="服务注册"><a href="#服务注册" class="headerlink" title="服务注册"></a>服务注册</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -X POST 'http://127.0.0.1:8848/nacos/v1/ns/instance?serviceName=nacos.naming.serviceName&amp;ip=20.18.7.10&amp;port=8080'</span><br></pre></td></tr></table></figure>

<h3 id="服务发现"><a href="#服务发现" class="headerlink" title="服务发现"></a>服务发现</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -X GET 'http://127.0.0.1:8848/nacos/v1/ns/instance/list?serviceName=nacos.naming.serviceName'</span><br></pre></td></tr></table></figure>

<h3 id="发布配置"><a href="#发布配置" class="headerlink" title="发布配置"></a>发布配置</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -X POST "http://127.0.0.1:8848/nacos/v1/cs/configs?dataId=nacos.cfg.dataId&amp;group=test&amp;content=HelloWorld"</span><br></pre></td></tr></table></figure>

<h3 id="获取配置"><a href="#获取配置" class="headerlink" title="获取配置"></a>获取配置</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -X GET "http://127.0.0.1:8848/nacos/v1/cs/configs?dataId=nacos.cfg.dataId&amp;group=test"</span><br></pre></td></tr></table></figure>

<h2 id="5-关闭服务器"><a href="#5-关闭服务器" class="headerlink" title="5.关闭服务器"></a>5.关闭服务器</h2><h3 id="Linux-Unix-Mac-1"><a href="#Linux-Unix-Mac-1" class="headerlink" title="Linux/Unix/Mac"></a>Linux/Unix/Mac</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sh shutdown.sh</span><br></pre></td></tr></table></figure>

<h3 id="Windows-1"><a href="#Windows-1" class="headerlink" title="Windows"></a>Windows</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cmd shutdown.cmd</span><br></pre></td></tr></table></figure>

<p>或者双击shutdown.cmd运行文件。</p>
<h2 id="6-浏览器访问"><a href="#6-浏览器访问" class="headerlink" title="6.浏览器访问"></a>6.浏览器访问</h2><blockquote>
<p><a href="http://localhost:8848/nacos/" target="_blank" rel="noopener">http://localhost:8848/nacos/</a></p>
<p>nacos/nacos</p>
</blockquote>
<h2 id="7-配置mysql"><a href="#7-配置mysql" class="headerlink" title="7.配置mysql"></a>7.配置mysql</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">create database nacos_config;</span><br><span class="line">show variables like 'innodb_large_prefix'</span><br><span class="line">show variables like 'innodb_file_format'</span><br><span class="line">set global innodb_large_prefix  = 1;</span><br><span class="line">set global innodb_file_format=BARRACUDA</span><br></pre></td></tr></table></figure>

<p>问题解决</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[Err] 1071 - Specified key was too long; max key length is 767 bytes</span><br><span class="line">[Err] 1709 - Index column size too large. The maximum column size is 767 bytes.</span><br><span class="line"></span><br><span class="line">1、set global innodb_large_prefix=on</span><br><span class="line">2、set global variable innodb_file_format=BARRACUDA</span><br><span class="line">3、使用 Innodb引擎在建表语句后加入ROW_FORMAT=DYNAMIC or ROW_FORMAT=COMPRESSED ，默认是ROW_FORMAT=COMPACT</span><br><span class="line"></span><br><span class="line">vim /etc/my.cnf</span><br><span class="line">innodb_large_prefix=on</span><br><span class="line">innodb_file_format=BARRACUDA</span><br></pre></td></tr></table></figure>

<h1 id="Nacos-Docker安装"><a href="#Nacos-Docker安装" class="headerlink" title="Nacos Docker安装"></a>Nacos Docker安装</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run --env MODE=standalone --name nacos -d -p 8848:8848 docker.io/nacos/nacos-server:latest</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://github.com/nacos-group/nacos-docker/blob/master/build/Dockerfile</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">cd /data/components/nacos-docker/</span><br><span class="line">docker-compose -f example/standalone-mysql-5.7.yaml up -d</span><br><span class="line">docker-compose -f example/standalone-mysql-5.7.yaml down</span><br><span class="line"></span><br><span class="line">docker-compose -f example/standalone-mysql.yaml up -d</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">(base) [root@dev-10-1-171-41 env]# route -n</span><br><span class="line">Kernel IP routing table</span><br><span class="line">Destination     Gateway         Genmask         Flags Metric Ref    Use Iface</span><br><span class="line">0.0.0.0         10.1.171.1      0.0.0.0         UG    100    0        0 eth0</span><br><span class="line">10.1.171.0      0.0.0.0         255.255.255.0   U     100    0        0 eth0</span><br><span class="line">172.17.0.0      0.0.0.0         255.255.0.0     U     0      0        0 docker0</span><br><span class="line">172.18.1.84     10.1.171.1      255.255.255.255 UGH   0      0        0 eth0</span><br><span class="line"></span><br><span class="line">(base) [root@dev-10-1-171-41 nacos-docker]# docker network ls</span><br><span class="line">NETWORK ID          NAME                  DRIVER              SCOPE</span><br><span class="line">4d95fdb44032        bridge                bridge              local</span><br><span class="line">b19a30233e5d        example_ncosnetwork   bridge              local</span><br><span class="line">2b9e87501791        host                  host                local</span><br><span class="line">dbc75370a996        none                  null                local</span><br></pre></td></tr></table></figure>


          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://carlo-z.com/distribution/rpc/rpc-core-principle/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Focus-1">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Focus-1">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/distribution/rpc/rpc-core-principle/" itemprop="url">RPC核心原理和实战 —— 基础篇</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-02-19T00:00:00+08:00">
                2020-02-19
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/rpc/" itemprop="url" rel="index">
                    <span itemprop="name">rpc</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <hr>
<br>

<blockquote>
<p>别老想着怎么用好RPC框架，你得多花时间琢磨原理</p>
</blockquote>
<h2 id="引言"><a href="#引言" class="headerlink" title="引言"></a>引言</h2><h3 id="1、为什么要学习-RPC？"><a href="#1、为什么要学习-RPC？" class="headerlink" title="1、为什么要学习 RPC？"></a>1、为什么要学习 RPC？</h3><p><u><strong>只要涉及网络通信，我们就有可能使用RPC</strong></u>。</p>
<p>在我看来，<strong><u>RPC 是解决分布式系统通信问题的一大利器</u></strong>。分布式系统中的网络通信一般都会采用四层的 TCP 协议或七层的 HTTP 协议，在我的了解中，前者占大多数，这主要得益于 TCP 协议的稳定性和高效性。网络通信说起来简单，但实际上是一个非常复杂的过程，这个过程主要包括：对端节点的查找、网络连接的建立、传输数据的编码解码以及网络连接的管理等等，每一项都很复杂。</p>
<br>

<h3 id="2、如何学习-RPC？"><a href="#2、如何学习-RPC？" class="headerlink" title="2、如何学习 RPC？"></a>2、如何学习 RPC？</h3><p>逐步深入</p>
<ol>
<li><p>使用 RPC 就可以像调用本地一样发起远程调用，用它可以解决通信问题，这时候我们肯定要去学<code>序列化、编解码以及网络传输</code>这些内容。</p>
</li>
<li><p>把这些内容掌握后，你就会发现，原来这些只是 RPC 的基础，RPC 还有更吸引人的点，它真正强大的地方是它的治理功能，比如<code>连接管理、健康检测、负载均衡、优雅启停机、异常重试、业务分组以及熔断限流等等</code>。突然间，你会感觉自己走进了一个新世界，这些内容会成为你今后学习 RPC 的重点和难点。</p>
</li>
<li><p>对 RPC 活学活用，学会提升 RPC 的性能以及它<code>在分布式环境下如何定位问题</code>等等</p>
</li>
</ol>
<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20200219111602.png" alt></p>
<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20200219111734.png" alt></p>
<br>

<br>

<h2 id="1、核心原理：能否画张图解释RPC通信流程？"><a href="#1、核心原理：能否画张图解释RPC通信流程？" class="headerlink" title="1、核心原理：能否画张图解释RPC通信流程？"></a>1、核心原理：能否画张图解释RPC通信流程？</h2><p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20200219141554.png" alt></p>
<h3 id="1-1、什么是RPC？"><a href="#1-1、什么是RPC？" class="headerlink" title="1.1、什么是RPC？"></a>1.1、什么是RPC？</h3><p>RPC 的全称是 Remote Procedure Call，即远程过程调用。简单解读字面上的意思，远程肯定是指要跨机器而非本机，所以需要用到网络编程才能实现。</p>
<p>RPC 的作用就是体现在这样两个方面：</p>
<ul>
<li>屏蔽远程调用跟本地调用的区别，让我们感觉就是调用项目内的方法；</li>
<li>隐藏底层网络通信的复杂性，让我们更专注于业务逻辑；</li>
</ul>
<h3 id="1-2、RPC通信流程"><a href="#1-2、RPC通信流程" class="headerlink" title="1.2、RPC通信流程"></a>1.2、RPC通信流程</h3><h4 id="1-、一个完成的RPC会涉及哪些步骤呢？"><a href="#1-、一个完成的RPC会涉及哪些步骤呢？" class="headerlink" title="1)、一个完成的RPC会涉及哪些步骤呢？"></a>1)、一个完成的RPC会涉及哪些步骤呢？</h4><ul>
<li><p>TCP通信：RPC 是一个远程调用，那肯定就需要通过网络来传输数据，并且 RPC 常用于业务系统之间的数据交互，需要保证其可靠性，所以 RPC 一般默认采用 TCP 来传输。</p>
</li>
<li><p>序列化：网络传输的数据必须是二进制数据，但调用方请求的出入参数都是对象。对象是肯定没法直接在网络中传输的，需要提前把它转成可传输的二进制，并且要求转换算法是可逆的，这个过程我们一般叫做“序列化”。</p>
</li>
<li><p>协议：在这里我们可以想想高速公路，它上面有很多出口，为了让司机清楚地知道从哪里出去，管理部门会在路上建立很多指示牌，并在指示牌上标明下一个出口是哪里、还有多远。那回到数据包识别这个场景，我们是不是也可以建立一些“指示牌”，并在上面标明数据包的类型和长度，这样就可以正确的解析数据了。确实可以，并且我们把<u><strong>数据格式的约定内容叫做“协议”</strong></u>。大多数的协议会分成两部分，分别是数据头和消息体。数据头一般用于身份识别，包括<code>协议标识、数据大小、请求类型、序列化类型</code>等信息；消息体主要是请求的业务<code>参数信息和扩展属性</code>等</p>
</li>
<li><p>反序列化：根据协议格式，服务提供方就可以正确地从二进制数据中分割出不同的请求来，同时根据请求类型和序列化类型，把二进制的消息体逆向还原成请求对象。这个过程叫作“反序列化”。</p>
</li>
<li><p>执行：服务提供方再根据反序列化出来的请求对象找到对应的实现类，完成真正的方法调用，然后把执行结果序列化后，回写到对应的 TCP 通道里面。调用方获取到应答的数据包后，再反序列化成应答对象，这样调用方就完成了一次 RPC 调用</p>
</li>
</ul>
<br>

<h4 id="2-、上述构成一个完成的RPC吗？"><a href="#2-、上述构成一个完成的RPC吗？" class="headerlink" title="2)、上述构成一个完成的RPC吗？"></a>2)、上述构成一个完成的RPC吗？</h4><p>缺点：对于研发人员来说，这样做需要掌握太多的RPC底层细节，需要手动写代码去构造请求、调用徐磊好、并进行网络调用，整个API非常不友好；</p>
<p>如何简单 API，屏蔽 RPC 细节？</p>
<p>如果你了解 Spring，一定对其 AOP 技术很佩服，其核心是采用动态代理的技术，通过字节码增强对方法进行拦截增强，以便于增加需要的额外处理逻辑。其实这个技术也可以应用到 RPC 场景来解决我们刚才面临的问题。</p>
<p>由服务提供者给出业务接口声明，在调用方的程序里面，RPC 框架根据调用的服务接口提前生成动态代理实现类，并通过依赖注入等技术注入到声明了该接口的相关业务逻辑里面。该代理实现类会拦截所有的方法调用，在提供的方法处理逻辑里面完成一整套的远程调用，并把远程调用结果返回给调用方，这样调用方在调用远程方法的时候就获得了像调用本地接口一样的体验。</p>
<p>到这里，一个简单版本的 RPC 框架就实现了。我把整个流程都画出来了，供你参考：</p>
<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20200219141554.png" alt></p>
<br>



<h3 id="1-3、RPC在架构中的位置"><a href="#1-3、RPC在架构中的位置" class="headerlink" title="1.3、RPC在架构中的位置"></a>1.3、RPC在架构中的位置</h3><p>RPC是解决应用间通信的一种方式；</p>
<p>RPC 框架能够帮助我们解决系统拆分后的通信问题，并且能让我们像调用本地一样去调用远程方法。利用 RPC 我们不仅可以很方便地将应用架构从“单体”演进成“微服务化”，而且还能解决实际开发过程中的效率低下、系统耦合等问题，这样可以使得我们的系统架构整体清晰、健壮，应用可运维度增强。</p>
<p>当然 RPC 不仅可以用来解决通信问题，它还被用在了很多其他场景，比如：发 MQ、分布式缓存、数据库等。下图是我之前开发的一个应用架构图：</p>
<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20200219143531.png" alt></p>
<br>

<h3 id="1-4、总结"><a href="#1-4、总结" class="headerlink" title="1.4、总结"></a>1.4、总结</h3><p>本讲我主要讲了下 RPC 的原理，RPC 就是提供一种透明调用机制，让使用者不必显式地区分本地调用和远程调用。RPC 虽然可以帮助开发者屏蔽远程调用跟本地调用的区别，但毕竟涉及到远程网络通信，所以这里还是有很多使用上的区别，比如：</p>
<ul>
<li><p>调用过程中超时了怎么处理业务？</p>
</li>
<li><p>什么场景下最适合使用 RPC？</p>
</li>
<li><p>什么时候才需要考虑开启压缩？</p>
</li>
</ul>
<p>无论你是一个初级开发者还是高级开发者，RPC 都应该是你日常开发过程中绕不开的一个话题，所以作为软件开发者的我们，真的很有必要详细地了解 RPC 实现细节。只有这样，才能帮助我们更好地在日常工作中使用 RPC。课后思考</p>
<br>

<br>

<h2 id="2、RPC协议：怎么设计可扩展向后兼容的协议？"><a href="#2、RPC协议：怎么设计可扩展向后兼容的协议？" class="headerlink" title="2、RPC协议：怎么设计可扩展向后兼容的协议？"></a>2、RPC协议：怎么设计可扩展向后兼容的协议？</h2><p>一提到协议，你最先想到的可能是 TCP 协议、UDP 协议等等；</p>
<p>那 HTTP 协议跟 RPC 协议又有什么关系呢？看起来他俩好像不搭边，但他们有一个共性就是都属于应用层协议；</p>
<p><u><strong>我们今天要讲的 RPC 协议就是围绕应用层协议展开的</strong></u>。我们可以先了解下 HTTP 协议，我们先看看它的协议格式是什么样子的。回想一下我们在浏览器里面输入一个 URL 会发生什么？抛开 DNS 解析暂且不谈，浏览器收到命令后会封装一个请求，并把请求发送到 DNS 解析出来的 IP 上，通过抓包工具我们可以抓到请求的数据包，如下图所示：</p>
<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20200219144451.png" alt></p>
<h3 id="2-1、协议的作用"><a href="#2-1、协议的作用" class="headerlink" title="2.1、协议的作用"></a>2.1、协议的作用</h3><p>看完 HTTP 协议之后，你可能会有一个疑问，我们为什么需要协议这个东西呢？没有协议就不能通信吗？</p>
<p>我们知道只有二进制才能在网络中传输，所以 RPC 请求在发送到网络中之前，他需要把方法调用的请求参数转成二进制；转成二进制后，写入本地 Socket 中，然后被网卡发送到网络设备中。</p>
<p>但在传输过程中，RPC 并不会把请求参数的所有二进制数据整体一下子发送到对端机器上，中间可能会拆分成好几个数据包，也可能会合并其他请求的数据包（合并的前提是同一个 TCP 连接上的数据），至于怎么拆分合并，这其中的细节会涉及到系统参数配置和 TCP 窗口大小。对于服务提供方应用来说，他会从 TCP 通道里面收到很多的二进制数据，那这时候怎么识别出哪些二进制是第一个请求的呢？</p>
<p>所以呢，<u><strong>为了避免语义不一致的事情发生，我们就需要在发送请求的时候设定一个边界，然后在收到请求的时候按照这个设定的边界进行数据分割。这个边界语义的表达，就是我们所说的协议</strong></u>。</p>
<br>

<h3 id="2-2、如何设计协议？"><a href="#2-2、如何设计协议？" class="headerlink" title="2.2、如何设计协议？"></a>2.2、如何设计协议？</h3><p>有了现成的 HTTP 协议，为啥不直接用，还要为 RPC 设计私有协议呢？</p>
<p>这还要从 RPC 的作用说起，相对于 HTTP 的用处，RPC 更多的是负责应用间的通信，所以性能要求相对更高。但 HTTP 协议的数据包大小相对请求数据本身要大很多，又需要加入很多无用的内容，比如换行符号、回车符等；还有一个更重要的原因是，HTTP 协议属于无状态协议，客户端无法对请求和响应进行关联，每次请求都需要重新建立连接，响应完成后再关闭连接。因此，对于要求高性能的 RPC 来说，HTTP 协议基本很难满足需求，所以 RPC 会选择设计更紧凑的私有协议。</p>
<p>那怎么设计一个私有 RPC 协议呢？</p>
<p>消息边界：消息长度，实现消息间正确断句</p>
<p>在协议头里面，我们除了会放协议长度、序列化方式，还会放一些像协议标示、消息 ID、消息类型这样的参数，而协议体一般只放请求接口方法、请求的业务参数值和一些扩展属性。这样一个完整的 RPC 协议大概就出来了，协议头是由一堆固定的长度参数组成，而协议体是根据请求接口和参数构造的，长度属于可变的，具体协议如下图所示：</p>
<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20200219151400.png" alt></p>
<br>

<h3 id="2-3、可扩展的协议"><a href="#2-3、可扩展的协议" class="headerlink" title="2.3、可扩展的协议"></a>2.3、可扩展的协议</h3><p>刚才讲的协议属于定长协议头，那也就是说往后就不能再往协议头里加新参数了，如果加参数就会导致线上兼容问题。举个具体例子，假设你设计了一个 88Bit 的协议头，其中协议长度占用 32bit，然后你为了加入新功能，在协议头里面加了 2bit，并且放到协议头的最后。升级后的应用，会用新的协议发出请求，然而没有升级的应用收到的请求后，还是按照 88bit 读取协议头，新加的 2 个 bit 会当作协议体前 2 个 bit 数据读出来，但原本的协议体最后 2 个 bit 会被丢弃了，这样就会导致协议体的数据是错的。</p>
<p>可能你会想：“那我把参数加在不定长的协议体里面行不行？而且刚才你也说了，协议体里面会放一些扩展属性。”</p>
<p>没错，协议体里面是可以加新的参数，但这里有一个关键点，就是协议体里面的内容都是经过序列化出来的，也就是说你要获取到你参数的值，就必须把整个协议体里面的数据经过反序列化出来。但在某些场景下，这样做的代价有点高啊！</p>
<p>比如说，服务提供方收到一个过期请求，这个过期是说服务提供方收到的这个请求的时间大于调用方发送的时间和配置的超时时间，既然已经过期，就没有必要接着处理，直接返回一个超时就好了。那要实现这个功能，就要在协议里面传递这个配置的超时时间，那如果之前协议里面没有加超时时间参数的话，我们现在把这个超时时间加到协议体里面是不是就有点重了呢？显然，会加重 CPU 的消耗。</p>
<p>所以为了保证能平滑地升级改造前后的协议，我们有必要设计一种支持可扩展的协议。其关键在于让协议头支持可扩展，扩展后协议头的长度就不能定长了。那要实现读取不定长的协议头里面的内容，在这之前肯定需要一个固定的地方读取长度，所以我们需要一个固定的写入协议头的长度。整体协议就变成了三部分内容：固定部分、协议头内容、协议体内容，前两部分我们还是可以统称为“协议头”，具体协议如下：</p>
<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20200219162433.png" alt></p>
<p>最后，我想说，<strong><u>设计一个简单的 RPC 协议并不难，难的就是怎么去设计一个可“升级”的协议</u></strong>。不仅要让我们在扩展新特性的时候能做到向下兼容，而且要尽可能地减少资源损耗，所以我们协议的结构不仅要支持协议体的扩展，还要做到协议头也能扩展。上述这种设计方法来源于我多年的线上经验，可以说做好扩展性是至关重要的，期待这个协议模版能帮你避掉一些坑。</p>
<br>

<h2 id="3、序列化：对象怎么在网络中传输"><a href="#3、序列化：对象怎么在网络中传输" class="headerlink" title="3、序列化：对象怎么在网络中传输"></a>3、序列化：对象怎么在网络中传输</h2><p>​    那么承接上一讲的一个重点，今天我会讲解下 RPC 框架中的序列化。要知道，在不同的场景下合理地选择序列化方式，对提升 RPC 框架整体的<u><strong>稳定性和性能</strong></u>是至关重要的</p>
<h3 id="3-1、为什么需要序列化？"><a href="#3-1、为什么需要序列化？" class="headerlink" title="3.1、为什么需要序列化？"></a>3.1、为什么需要序列化？</h3><p>​    网络传输的数据必须是二进制数据，但调用方请求的出入参数都是对象。对象是不能直接在网络中传输的，所以我们需要提前把它转成可传输的二进制</p>
<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20200225144044.png" alt></p>
<p>​    总结来说，序列化就是将对象转换成二进制数据的过程，而反序列就是反过来将二进制转换为对象的过程。</p>
<p>​    那么 RPC 框架为什么需要序列化呢？还是请你回想下 RPC 的通信流程：</p>
<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20200225144123.png" alt></p>
<p>​    不妨借用个例子帮助你理解，比如发快递，我们要发一个需要自行组装的物件。发件人发之前，会把物件拆开装箱，这就好比序列化；这时候快递员来了，不能磕碰呀，那就要打包，这就好比将序列化后的数据进行编码，封装成一个固定格式的协议；过了两天，收件人收到包裹了，就会拆箱将物件拼接好，这就好比是协议解码和反序列化。</p>
<p>​    所以现在你清楚了吗？因为网络传输的数据必须是二进制数据，所以在 RPC 调用中，对入参对象与返回值对象进行序列化与反序列化是一个必须的过程。</p>
<h3 id="3-2、有哪些常用的序列化"><a href="#3-2、有哪些常用的序列化" class="headerlink" title="3.2、有哪些常用的序列化"></a>3.2、有哪些常用的序列化</h3><h4 id="1-、JDK原生序列化"><a href="#1-、JDK原生序列化" class="headerlink" title="1)、JDK原生序列化"></a>1)、JDK原生序列化</h4><p>​    JDK 自带的序列化机制对使用者而言是非常简单的。序列化具体的实现是由 ObjectOutputStream 完成的，而反序列化的具体实现是由 ObjectInputStream 完成的。</p>
<p>​    那么 JDK 的序列化过程是怎样完成的呢？我们看下下面这张图：</p>
<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20200225144345.png" alt></p>
<p>序列化过程就是在读取对象数据的时候，不断加入一些特殊分隔符，这些特殊分隔符用于在反序列化过程中截断用。</p>
<ul>
<li><p>头部数据用来声明序列化协议、序列化版本，用于高低版本向后兼容</p>
</li>
<li><p>对象数据主要包括类名、签名、属性名、属性类型及属性值，当然还有开头结尾等数据，除了属性值属于真正的对象值，其他都是为了反序列化用的元数据</p>
</li>
<li><p>存在对象引用、继承的情况下，就是递归遍历“写对象”逻辑</p>
</li>
</ul>
<h4 id="2-、JSON"><a href="#2-、JSON" class="headerlink" title="2)、JSON"></a>2)、JSON</h4><p>一种文本型序列化框架。无论是前台 Web 用 Ajax 调用、用磁盘存储文本类型的数据，还是基于 HTTP 协议的 RPC 框架通信，都会选择 JSON 格式。</p>
<p>但用 JSON 进行序列化有这样<u><strong>两个问题</strong></u>，你需要格外注意：</p>
<ul>
<li><p>JSON 进行序列化的额外空间开销比较大，对于大数据量服务这意味着需要<u><strong>巨大的内存和磁盘开销</strong></u>；</p>
</li>
<li><p>JSON 没有类型，但像 Java 这种<u><strong>强类型语言</strong></u>，需要通过反射统一解决，所以性能不会太好。</p>
</li>
</ul>
<p>所以如果 RPC 框架选用 JSON 序列化，服务提供者与服务调用者之间传输的数据量要相对较小，否则将严重影响性能。</p>
<h4 id="3-、Hessian"><a href="#3-、Hessian" class="headerlink" title="3)、Hessian"></a>3)、Hessian</h4><p>Hessian 是动态类型、二进制、紧凑的，并且可跨语言移植的一种序列化框架。Hessian 协议要比 JDK、JSON 更加紧凑，性能上要比 JDK、JSON 序列化高效很多，而且生成的字节数也更小。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">Student student = <span class="keyword">new</span> Student();</span><br><span class="line">student.setNo(<span class="number">101</span>);</span><br><span class="line">student.setName(<span class="string">"HESSIAN"</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//把student对象转化为byte数组</span></span><br><span class="line">ByteArrayOutputStream bos = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">Hessian2Output output = <span class="keyword">new</span> Hessian2Output(bos);</span><br><span class="line">output.writeObject(student);</span><br><span class="line">output.flushBuffer();</span><br><span class="line"><span class="keyword">byte</span>[] data = bos.toByteArray();</span><br><span class="line">bos.close();</span><br><span class="line"></span><br><span class="line"><span class="comment">//把刚才序列化出来的byte数组转化为student对象</span></span><br><span class="line">ByteArrayInputStream bis = <span class="keyword">new</span> ByteArrayInputStream(data);</span><br><span class="line">Hessian2Input input = <span class="keyword">new</span> Hessian2Input(bis);</span><br><span class="line">Student deStudent = (Student) input.readObject();</span><br><span class="line">input.close();</span><br><span class="line"></span><br><span class="line">System.out.println(deStudent);</span><br></pre></td></tr></table></figure>

<p>相对于 JDK、JSON，由于 Hessian 更加高效，生成的字节数更小，有非常好的兼容性和稳定性，所以 Hessian 更加适合作为 RPC 框架远程通信的序列化协议。</p>
<p>但 Hessian 本身也有问题，官方版本对 Java 里面一些常见对象的类型不支持，比如：</p>
<ul>
<li>Linked 系列，LinkedHashMap、LinkedHashSet 等，但是可以通过扩展 CollectionDeserializer 类修复；</li>
<li>Locale 类，可以通过扩展 ContextSerializerFactory 类修复；</li>
<li>Byte/Short 反序列化的时候变成 Integer。以上这些情况，你在实践时需要格外注意。</li>
</ul>
<h4 id="4-、Protobuf"><a href="#4-、Protobuf" class="headerlink" title="4)、Protobuf"></a>4)、Protobuf</h4><p>Protobuf 是 Google 公司内部的混合语言数据标准，是一种轻便、高效的结构化数据存储格式，可以用于结构化数据序列化，支持 Java、Python、C++、Go 等语言。Protobuf 使用的时候需要定义 IDL（Interface description language），然后使用不同语言的 IDL 编译器，生成序列化工具类，它的优点是：</p>
<ul>
<li>序列化后体积相比 JSON、Hessian 小很多；</li>
<li>IDL 能清晰地描述语义，所以足以帮助并保证应用程序之间的类型不会丢失，无需类似 XML 解析器；</li>
<li>序列化反序列化速度很快，不需要通过反射获取类型；</li>
<li>消息格式升级和兼容性不错，可以做到向后兼容</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * // IDl 文件格式</span></span><br><span class="line"><span class="comment"> * synax = "proto3";</span></span><br><span class="line"><span class="comment"> * option java_package = "com.test";</span></span><br><span class="line"><span class="comment"> * option java_outer_classname = "StudentProtobuf";</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * message StudentMsg &#123;</span></span><br><span class="line"><span class="comment"> * //序号</span></span><br><span class="line"><span class="comment"> * int32 no = 1;</span></span><br><span class="line"><span class="comment"> * //姓名</span></span><br><span class="line"><span class="comment"> * string name = 2;</span></span><br><span class="line"><span class="comment"> * &#125;</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"> </span><br><span class="line">StudentProtobuf.StudentMsg.Builder builder = StudentProtobuf.StudentMsg.newBuilder();</span><br><span class="line">builder.setNo(<span class="number">103</span>);</span><br><span class="line">builder.setName(<span class="string">"protobuf"</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//把student对象转化为byte数组</span></span><br><span class="line">StudentProtobuf.StudentMsg msg = builder.build();</span><br><span class="line"><span class="keyword">byte</span>[] data = msg.toByteArray();</span><br><span class="line"></span><br><span class="line"><span class="comment">//把刚才序列化出来的byte数组转化为student对象</span></span><br><span class="line">StudentProtobuf.StudentMsg deStudent = StudentProtobuf.StudentMsg.parseFrom(data);</span><br><span class="line"></span><br><span class="line">System.out.println(deStudent);</span><br></pre></td></tr></table></figure>

<p>Protobuf 非常高效，但是对于具有反射和动态能力的语言来说，这样用起来很费劲，这一点就不如 Hessian，比如用 Java 的话，这个预编译过程不是必须的，可以考虑使用 Protostuff。</p>
<p>Protostuff 不需要依赖 IDL 文件，可以直接对 Java 领域对象进行反 / 序列化操作，在效率上跟 Protobuf 差不多，生成的二进制格式和 Protobuf 是完全相同的，可以说是一个 Java 版本的 Protobuf 序列化框架。但在使用过程中，我遇到过一些不支持的情况，也同步给你：</p>
<ul>
<li>不支持 null；</li>
<li>ProtoStuff 不支持单纯的 Map、List 集合对象，需要包在对象里面。</li>
</ul>
<h3 id="3-3、RPC框架中如何选择序列化"><a href="#3-3、RPC框架中如何选择序列化" class="headerlink" title="3.3、RPC框架中如何选择序列化"></a>3.3、RPC框架中如何选择序列化</h3><p>我刚刚简单地介绍了几种最常见的序列化协议，其实远不止这几种，还有 Message pack、kryo 等。那么面对这么多的序列化协议，在 RPC 框架中我们该如何选择呢？</p>
<ul>
<li><p>性能和效率</p>
</li>
<li><p>空间开销</p>
</li>
<li><p>序列化协议的通用性和兼容性（版本升级后的兼容性是否很好，是否支持更多的对象类型，是否是跨平台、跨语言的）</p>
</li>
<li><p>安全性（序列化存在安全漏洞，那么线上的服务就很可能被入侵）</p>
</li>
<li><p>易于调试</p>
</li>
</ul>
<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20200225151241.png" alt></p>
<p>我们首选的还是 Hessian 与 Protobuf，因为他们在性能、时间开销、空间开销、通用性、兼容性和安全性上，都满足了我们的要求。其中 Hessian 在使用上更加方便，在对象的兼容性上更好；Protobuf 则更加高效，通用性上更有优势。</p>
<h3 id="3-4、RPC框架在使用时要注意哪些问题？"><a href="#3-4、RPC框架在使用时要注意哪些问题？" class="headerlink" title="3.4、RPC框架在使用时要注意哪些问题？"></a>3.4、RPC框架在使用时要注意哪些问题？</h3><p>对象构造得过于复杂：属性很多，并且存在多层的嵌套</p>
<p>对象过于庞大：我经常遇到业务过来咨询，为啥他们的 RPC 请求经常超时，排查后发现他们的入参对象非常得大</p>
<p>用序列化框架不支持的类作为入参类：比如 Hessian 框架，他天然是不支持 LinkHashMap、LinkedHashSet 等，而且大多数情况下最好不要使用第三方集合类，Guava 中的集合类，很多开源的序列化框架都是优先支持编程语言原生的对象。因此如果入参是集合类，应尽量选用原生的、最为常用的集合类，如 HashMap、ArrayList</p>
<p>对象有复杂的继承关系：大多数序列化框架在序列化对象时都会将对象的属性一一进行序列化，当有继承关系时，会不停地寻找父类，遍历属性</p>
<h3 id="3-5、总结"><a href="#3-5、总结" class="headerlink" title="3.5、总结"></a>3.5、总结</h3><p>在使用 RPC 框架的过程中，我们构造入参、返回值对象，主要记住以下几点：</p>
<ol>
<li>对象要尽量简单，没有太多的依赖关系，属性不要太多，尽量高内聚；</li>
<li>入参对象与返回值对象体积不要太大，更不要传太大的集合；</li>
<li>尽量使用简单的、常用的、开发语言原生的对象，尤其是集合类；</li>
<li>对象不要有复杂的继承关系，最好不要有父子类的情况。</li>
</ol>
<br>

<br>




          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://carlo-z.com/java/jvm/arthas-docs/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Focus-1">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Focus-1">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/java/jvm/arthas-docs/" itemprop="url">arthas手册</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-01-13T00:00:00+08:00">
                2020-01-13
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/java/" itemprop="url" rel="index">
                    <span itemprop="name">java</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/java/jvm/" itemprop="url" rel="index">
                    <span itemprop="name">jvm</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/java/jvm/arthas/" itemprop="url" rel="index">
                    <span itemprop="name">arthas</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <hr>
<br>

<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20200113141230.png" alt></p>
<blockquote>
<p>官方文档：<a href="https://alibaba.github.io/arthas/" target="_blank" rel="noopener">https://alibaba.github.io/arthas/</a></p>
</blockquote>
<h1 id="下载安装"><a href="#下载安装" class="headerlink" title="下载安装"></a>下载安装</h1><p><a href="https://alibaba.github.io/arthas/manual-install.html" target="_blank" rel="noopener">https://alibaba.github.io/arthas/manual-install.html</a></p>
<p>下载</p>
<p><a href="https://maven.aliyun.com/repository/public/com/taobao/arthas/arthas-packaging/3.x.x/arthas-packaging-3.x.x-bin.zip" target="_blank" rel="noopener">https://maven.aliyun.com/repository/public/com/taobao/arthas/arthas-packaging/3.x.x/arthas-packaging-3.x.x-bin.zip</a></p>
<p>解压</p>
<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20200113141904.png" alt></p>
<h1 id="启动"><a href="#启动" class="headerlink" title="启动"></a>启动</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -jar arthas-boot.jar</span><br></pre></td></tr></table></figure>

<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20200113151900.png" alt></p>
<h1 id="查看dashboard"><a href="#查看dashboard" class="headerlink" title="查看dashboard"></a>查看dashboard</h1><blockquote>
<p> [arthas@14628]$ dashboard</p>
</blockquote>
<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20200113152011.png" alt></p>
<h1 id="查看线程"><a href="#查看线程" class="headerlink" title="查看线程"></a>查看线程</h1><blockquote>
<p> [arthas@14628]$ thread</p>
<p>// 拿到最忙的3个线程</p>
<p> [arthas@14628]$ thread -n 3</p>
</blockquote>
<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20200113152223.png" alt></p>
<h1 id="dump内存数据"><a href="#dump内存数据" class="headerlink" title="dump内存数据"></a>dump内存数据</h1><blockquote>
<p> [arthas@14628]$ heapdump d:/data/dump.hprof</p>
</blockquote>
<h3 id="jhat分析dump文件"><a href="#jhat分析dump文件" class="headerlink" title="jhat分析dump文件"></a>jhat分析dump文件</h3><blockquote>
<p>jhat d:/data/dump.hprof</p>
</blockquote>
<p>生成一个web，通过浏览器访问</p>
<h3 id="MAT分析dump文件"><a href="#MAT分析dump文件" class="headerlink" title="MAT分析dump文件"></a>MAT分析dump文件</h3>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://carlo-z.com/message-queue/rocketmq/rocketmq-how-to-submit-pr/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Focus-1">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Focus-1">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/message-queue/rocketmq/rocketmq-how-to-submit-pr/" itemprop="url">如何向rocketmq提交pr</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-01-13T00:00:00+08:00">
                2020-01-13
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/github/" itemprop="url" rel="index">
                    <span itemprop="name">github</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <hr>
<br>

<h1 id="1、fork仓库到自己账号下"><a href="#1、fork仓库到自己账号下" class="headerlink" title="1、fork仓库到自己账号下"></a>1、fork仓库到自己账号下</h1><p>官方仓库：<a href="https://github.com/apache/rocketmq" target="_blank" rel="noopener">https://github.com/apache/rocketmq</a></p>
<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20200113224109.png" alt></p>
<h1 id="2、clone代码到本地"><a href="#2、clone代码到本地" class="headerlink" title="2、clone代码到本地"></a>2、clone代码到本地</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">cd</span> /d/github</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 测试是否可以连接</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ssh -T git@github.com</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">cd</span> ~/.ssh</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ssh-keygen -t rsa</span></span><br></pre></td></tr></table></figure>

<p>将公钥添加到 github</p>
<p>github -&gt; Settings -&gt; SSH and GPG keys -&gt; New SSH key</p>
<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20200113225754.png" alt></p>
<p>再测试一下</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> ssh -T git@github.com</span></span><br><span class="line">Hi carlo-z! You've successfully authenticated, but GitHub does not provide shell access.</span><br></pre></td></tr></table></figure>

<p>clone 代码</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> git <span class="built_in">clone</span> git@github.com:carlo-z/rocketmq.git</span></span><br></pre></td></tr></table></figure>

<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20200113231711.png" alt></p>
<p>查看仓库状态，提示现在是 master 分支</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">cd</span> rocketmq/</span></span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> git status</span></span><br><span class="line">On branch master</span><br><span class="line">Your branch is up to date with 'origin/master'</span><br></pre></td></tr></table></figure>

<p>用<code>git remote -v</code>命令，可以看到此时只与自己的远程仓库建立了连接</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> git remote -v</span></span><br><span class="line">origin  git@github.com:carlo-z/rocketmq.git (fetch)</span><br><span class="line">origin  git@github.com:carlo-z/rocketmq.git (push)</span><br></pre></td></tr></table></figure>

<h1 id="3、与官方仓库建立连接"><a href="#3、与官方仓库建立连接" class="headerlink" title="3、与官方仓库建立连接"></a>3、与官方仓库建立连接</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> git remote add upstream https://github.com/apache/rocketmq.git</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> git remote -v</span></span><br><span class="line">origin  git@github.com:carlo-z/rocketmq.git (fetch)</span><br><span class="line">origin  git@github.com:carlo-z/rocketmq.git (push)</span><br><span class="line">upstream        https://github.com/apache/rocketmq.git (fetch)</span><br><span class="line">upstream        https://github.com/apache/rocketmq.git (push)</span><br></pre></td></tr></table></figure>

<p>再用<code>git remote -v</code>可以看到 已经与官方仓库建立了连接</p>
<h1 id="4、创建新分支用于修改"><a href="#4、创建新分支用于修改" class="headerlink" title="4、创建新分支用于修改"></a>4、创建新分支用于修改</h1><p>接着上面的运行命令：<code>git checkout -b rocketmq-read</code>，这个命令的意思是创建一个叫 rocketmq-read 的分支，运行这个命令后bash将自动切换到新的分支下</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> git checkout -b rocketmq-read</span></span><br><span class="line">Switched to a new branch 'rocketmq-read'</span><br></pre></td></tr></table></figure>

<h3 id="修改代码"><a href="#修改代码" class="headerlink" title="修改代码"></a>修改代码</h3><h3 id="提交"><a href="#提交" class="headerlink" title="提交"></a>提交</h3><h1 id="5、提交pr"><a href="#5、提交pr" class="headerlink" title="5、提交pr"></a>5、提交pr</h1><p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20200113233008.png" alt></p>
<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20200113233121.png" alt></p>
<p>然后点<code>Create pull request</code></p>
<p>写好名字，写好说明，提交，就OK啦。</p>
<h1 id="6、后期同步代码"><a href="#6、后期同步代码" class="headerlink" title="6、后期同步代码"></a>6、后期同步代码</h1><p>所以每次提交pr前，都要先从做代码同步。过程如下：</p>
<p>先fetch</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> git fetch upstream</span></span><br></pre></td></tr></table></figure>

<p>再 rebase</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> git rebase upstream/master</span></span><br></pre></td></tr></table></figure>

<p>再 push master</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> git push origin master</span></span><br></pre></td></tr></table></figure>

<p>push完后，远程仓库便可看到你的branch版本和master分支一致了，否则这个位置会显示与master相差了多少次commit。</p>
<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20200113233631.png" alt></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://carlo-z.com/devops/istio/service-mesh-init/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Focus-1">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Focus-1">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/devops/istio/service-mesh-init/" itemprop="url">Service Mesh 初体验</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-01-02T00:00:00+08:00">
                2020-01-02
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/service-mesh/" itemprop="url" rel="index">
                    <span itemprop="name">service-mesh</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <br>

<blockquote>
<p>来源：<a href="https://developer.aliyun.com/article/723524" target="_blank" rel="noopener">https://developer.aliyun.com/article/723524</a></p>
</blockquote>
<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>计算机软件技术发展到现在，软件架构的演进无不朝着让开发者能够更加轻松快捷地构建大型复杂应用的方向发展。容器技术最初是为了解决运行环境的不一致问题而产生的，随着不断地发展，围绕容器技术衍生出来越来越多的新方向。</p>
<p>最近几年，云计算领域不断地出现很多新的软件架构模式，其中有一些很热门的概念名词如：云原生、函数计算、Serverless、ServiceMesh等等，而本文将初窥一下ServiceMesh的面纱。下面结合自己的理解尽量以通俗的话进行叙述。</p>
<h1 id="背景和定义"><a href="#背景和定义" class="headerlink" title="背景和定义"></a>背景和定义</h1><h2 id="微服务及服务治理"><a href="#微服务及服务治理" class="headerlink" title="微服务及服务治理"></a>微服务及服务治理</h2><p>在微服务之前的软件开发中，往往通过一个应用的方式将所有的模块都包括进去，并一起编译、打包、部署、运维。这种方式存在很多问题，由于单个应用包含的东西太多，其中某个模块出现问题或者需要更新那么整个应用就需要重新部署。这种方式给开发和运维带来了很大的麻烦。随着应用的逐渐复杂，单个应用涉及的东西就会越来越多，慢慢地大家发现了其中很多的缺点，开始对服务进行划分，将一个大的应用按照不同的维度进行划分从而产生很多个小的应用，各应用之间会形成一个调用关系，每个小的应用由不同的开发负责，大家各自部署和运维，这样微服务就出现了。</p>
<p>由于微服务中各应用部署在不同的机器上，服务之间需要进行通信和协调，相比单个应用来说会麻烦很多。在同一个应用内不同方法之间的调用由于在相同的内存中，在代码编译打包时已经进行了链接，因此调用是可寻址且快速的。微服务下不同服务之间的调用涉及到不同进程或者机器之间的通信，一般需要通过第三方中间件的方式作为中介和协调，由于种种这些，面向微服务出现了很多中间件包括服务治理的框架。通过服务治理工具可以管理其接入的所有应用，使得服务之间的通信和协调更加简单高效。</p>
<h2 id="容器及容器编排"><a href="#容器及容器编排" class="headerlink" title="容器及容器编排"></a>容器及容器编排</h2><p>最初容器技术是为了解决应用运行环境不一致的问题而出现的，避免在本地环境或者测试环境能够跑通，等发到生产环境却出现问题。通过容器将程序及其依赖一起打包到镜像中去，将程序的镜像在任何安装并运行了容器软件的机器上启动若干的容器，每个容器就是应用运行时的实例，这些实例一般拥有完全相同的运行环境和参数。使得不管在任何机器上应用都可以表现出一样的效果。这给开发、测试、运维带来了极大的便利，不再需要为不同机器上构建相同的运行环境而头大。且镜像可以Push到镜像仓库，这使得应用可以进行很方便的迁移和部署。Docker就是一个应用广泛的容器技术。目前越来越多的应用以微服务的方式并通过容器进行部署，给了软件开发极大的活力。</p>
<p>与微服务和服务治理的关系类似，越来越多的应用通过容器进行部署，使得集群上的容器数量急剧增加，通过人工的管理和运维这些容器已经变得很艰难且低效，为了解决诸多容器及容器之间的关系出现了很多编排工具，容器编排工具能够管理容器的整个生命周期。如Docker官方出的docker-compose和docker swarm，这两个工具能实现批量容器的启动和编排，但功能较为简单，不足以支撑大型的容器集群。Google基于内部大量的容器管理经验，开源出了Kubernetes项目，Kubernetes（K8S）是针对Google集群上每周亿级别的容器而设计的，具有很强大的容器编排能力和丰富的功能。K8S通过定义了很多资源，这些资源以声明式的方式进行创建，可以通过JSON或者YAML文件表示一个资源，K8S支持多种容器，但主流的是Docker容器，K8S提供了容器接入的相关标准，只要容器实现了该标准就可以被K8S所编排。由于K8S的功能较多，不在此一一叙述，有兴趣可以参考官方文档或者ATA上搜索相关文章。</p>
<p>当某个公司的应用已经完全微服务化后，选择以容器的方式部署应用，此时可以在集群上部署K8S，通过K8S提供的能力进行应用容器的管理，运维可以也可以面向K8S进行工作。由于K8S是目前使用最广泛的容器编排工具，因此成为了容器编排的一个标准了，目前集团内部也有自己的容器和容器编排工具。</p>
<p>面向以K8S为代表的容器管理方式衍生出了一些新的技术。</p>
<h2 id="云原生"><a href="#云原生" class="headerlink" title="云原生"></a>云原生</h2><p>最近两年云原生被炒的很火，可以在各处看到很多大佬对云原生的高谈阔论，下面直接抛出CNCF对云原生的定义：</p>
<blockquote>
<p>云原生技术有利于各组织在公有云、私有云和混合云等新型动态环境中，构建和运行可弹性扩展的应用。云原生的代表技术包括容器、服务网格、微服务、不可变基础设施和声明式API。<br>这些技术能够构建容错性好、易于管理和便于观察的松耦合系统。结合可靠的自动化手段，云原生技术使工程师能够轻松地对系统作出频繁和可预测的重大变更。</p>
</blockquote>
<p>在我看来，通过微服务的方式开发应用，以容器进行部署，使用K8S等容器编排工具进行容器集群的管理，使得开发运维都面向K8S，这就是云原生。云原生可以方便的构建应用，并对应用进行完整的监控，以及在应用针对不同流量时能进行快速的扩容和缩容。如下图：</p>
<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/feb43679e45874c02f6e6c22e8bf4441.png" alt="image.png"></p>
<p>云原生主要包括四个部分:</p>
<ul>
<li>微服务</li>
<li>容器</li>
<li>持续集成和交付</li>
<li>DevOps</li>
</ul>
<p>PS：总是觉得云原生这个叫法太抽象了，很难让人通过名字想到这是个啥东西。</p>
<h2 id="ServiceMesh的定义"><a href="#ServiceMesh的定义" class="headerlink" title="ServiceMesh的定义"></a>ServiceMesh的定义</h2><p>前面讲了微服务、容器、容器编排、云原生等，其实就是为了得出什么是ServiceMesh，自己总结了一下：<strong>SeviceMesh是云原生下的微服务治理方案</strong>。</p>
<p>当我们通过微服务的方式将应用以容器的形式部署在K8S上后，服务之间调用和治理其实有新的方案，可以不需要依赖传统的微服务治理框架。ServiceMesh通过对每个应用在其Pod中启动一个Sidecar（边车）实现对应用的透明代理，所有出入应用的流量都先经过该应用的Sidecar，服务之间的调用转变成了Sidecar之间的调用，服务的治理转变成了对Sidecar的治理。在ServiceMesh中Sidecar是透明的，开发无感知的，之前一直觉得奇怪，总觉得一个应用要让别人发现它从而调用它，总得引入一些库然后进行主动的服务注册，不然啥都不做，别人咋知道这个应用的存在，为什么在ServiceMesh中就可以省去这些，做到对开发者完全地透明呢？这个的实现依赖于容器编排工具，通过K8S进行应用的持续集成和交付时，在启动应用Pod后，其实已经通过Yaml文件的形式向K8S注册了自己的服务以及声明了服务之间的关系，ServiceMesh通过和K8S进行通信获取集群上所有的服务信息，通过K8S这个中间者实现了对开发者的透明。如下图所示，是ServiceMesh的一个基本结构，包括数据平面和控制平面。</p>
<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/7c01430ea43e3669a874822631b15048.png" alt="image.png"></p>
<p>这种方式存在很多好处，我们可以发现在这种模式下应用的语言其实不会对整个服务治理过程有什么影响，对于ServiceMesh来说，它只关心Pod或者说是Pod中的容器实例，并不需要在乎容器中应用的实现语言是啥，Sidecar和其负责的容器在同一个Pod中。这样ServiceMesh就可以实现跨语言，这也是目前很多传统的服务治理框架的一大缺点，而且采用传统的服务治理，需要对应用引入大量的依赖，这样就会造成依赖之间的各种冲突，集团通过Pandora对应用的各种依赖进行隔离。再者传统的服务治理门槛较高，需要开发者对整个架构有一定的了解，且发现问题排查较为麻烦。这也造成了开发和运维之间的界限不清，在ServiceMesh中开发只需要交付代码，运维可以基于K8S去维护整个容器集群。</p>
<h1 id="发展现状"><a href="#发展现状" class="headerlink" title="发展现状"></a>发展现状</h1><p>通过目前查阅的资料来看，ServiceMesh一词最早出现在2016年，最近两年被炒的很火，蚂蚁金服已经有了自己的一套完整的ServiceMesh服务框架–SofaMesh，集团很多团队也在进行相应的跟进。</p>
<p>从历史发展的路线来看，程序的开发方式经历了很多的变化，但总的方向是变得越来越简单了，现在我们在集团内进行开发，可以很简单的构建一个支撑较大QPS的服务，这得益于集团的整个技术体系的完整和丰富以及强大的技术积淀。</p>
<p>我们下面来看看应用开发到底经历了啥？</p>
<h2 id="发展历史"><a href="#发展历史" class="headerlink" title="发展历史"></a>发展历史</h2><h3 id="主机直接阶段"><a href="#主机直接阶段" class="headerlink" title="主机直接阶段"></a>主机直接阶段</h3><p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/0dbc3158dffdae8d73a5e8efc031c75c.png" alt="image.png"></p>
<p>如上图，这一阶段应该是最古老的阶段，两台机器通过网线直接连接，一个应用包含了你能想到的所有的功能，包括两台机器的连接管理，这时还没有网络的概念，毕竟只能和通过网线直接连接在一起的机器进行通信。</p>
<h3 id="网络层的出现"><a href="#网络层的出现" class="headerlink" title="网络层的出现"></a>网络层的出现</h3><p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/b5831ce53a0abc03f438ef4a8085b28b.png" alt="image.png"></p>
<p>如上图，随着技术的发展，网络层出现了，机器可以和通过网络连接的其他所有机器进行通信，不再限制于必须要网线直连两台机器。</p>
<h3 id="集成到应用程序内部的流量控制"><a href="#集成到应用程序内部的流量控制" class="headerlink" title="集成到应用程序内部的流量控制"></a>集成到应用程序内部的流量控制</h3><p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/2ef0e49eaff46aa8847014ce1a33d0fe.png" alt="image.png"></p>
<p>如上图，由于每个应用所在环境和机器配置不一样，接受流量的能力也不相同，当A应用发送的流量大于了B应用的接受能力时，那么无法接收的数据包必定会被丢弃，这时就需要对流量进行控制，最开始流量的控制需要应用自己去实现，网络层只负责接收应用下发的数据包并进行传输。</p>
<h3 id="流量控制转移到网络层"><a href="#流量控制转移到网络层" class="headerlink" title="流量控制转移到网络层"></a>流量控制转移到网络层</h3><p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/ead7fcc503e4e6c2e10d4160c5be0858.png" alt="image.png"></p>
<p>如上图，慢慢地大家发应用中的网络流量控制是可以转移到网络层的，所以网络层中的流量控制出现了，我想大概就是指TCP的流量控制吧，这样还能保证可靠的网络通信。</p>
<h3 id="应用程序的中集成服务发现和断路器"><a href="#应用程序的中集成服务发现和断路器" class="headerlink" title="应用程序的中集成服务发现和断路器"></a>应用程序的中集成服务发现和断路器</h3><p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/c68b6f2f5093077d196c8c9b83e034ff.png" alt="image.png"></p>
<p>如上图，开发者通过在自己的代码模块中实现服务发现和断路器。</p>
<h3 id="专门用于服务发现和断路器的软件包-库"><a href="#专门用于服务发现和断路器的软件包-库" class="headerlink" title="专门用于服务发现和断路器的软件包/库"></a>专门用于服务发现和断路器的软件包/库</h3><p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/11222886203b348637235ce5abf95325.png" alt="image.png"></p>
<p>如上图，开发者通过引用第三方依赖去实现服务发现和断路器。</p>
<h3 id="出现了专门用于服务发现和断路器的开源软件"><a href="#出现了专门用于服务发现和断路器的开源软件" class="headerlink" title="出现了专门用于服务发现和断路器的开源软件"></a>出现了专门用于服务发现和断路器的开源软件</h3><p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/bc9d938db0b4949eb127838956f9bc8d.png" alt="image.png"></p>
<p>如上图，基于各种中间件去实现服务发现和断路器。</p>
<h3 id="ServiceMesh出现"><a href="#ServiceMesh出现" class="headerlink" title="ServiceMesh出现"></a>ServiceMesh出现</h3><p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/647e656d33fef1410d8f816e1d349c67.png" alt="image.png"></p>
<p>最终到了现在，ServiceMesh大法诞生，进一步解放了生产力，提高了软件整个生命周期的效率。</p>
<h2 id="ServiceMesh市场竞争"><a href="#ServiceMesh市场竞争" class="headerlink" title="ServiceMesh市场竞争"></a>ServiceMesh市场竞争</h2><blockquote>
<p>虽然直到2017年底，ServiceMesh才开始较大规模被世人了解，这场微服务市场之争也才显现，但是其实ServiceMesh这股微服务的新势力，早在 2016年初就开始萌芽：</p>
<p>2016年1月，离开Twitter的基础设施工程师William Morgan和Oliver Gould，在github上发布了Linkerd 0.0.7版本，业界第一个ServiceMesh项目就此诞生。Linkerd基于Twitter的Finagle开源项目，大量重用了Finagle的类库，但是实现了通用性，成为了业界第一个ServiceMesh项目。而Envoy是第二个ServiceMesh项目，两者的开发时间差不多，在2017年都相继成为CNCF项目。2017年5月24日，Istio 0.1 release版本发布，Google和IBM高调宣讲，社区反响热烈，很多公司在这时就纷纷站队表示支持Istio。Linkerd的风光瞬间被盖过，从意气风发的少年一夜之间变成过气网红。当然，从产品成熟度上来说，linkerd作为业界仅有的两个生产级ServiceMesh实现之一，暂时还可以在Istio成熟前继续保持市场。但是，随着Istio的稳步推进和日益成熟，外加第二代ServiceMesh的天然优势，Istio取代第一代的Linkerd只是个时间问题。自从在2016年决定委身于Istio之后，Envoy就开始了一条波澜不惊的平稳发展之路，和Linkerd的跌宕起伏完全不同。在功能方面，由于定位在数据平面，因此Envoy无需考虑太多，很多工作在Istio的控制平面完成就好，Envoy从此专心于将数据平面做好，完善各种细节。在市场方面，Envoy和Linkerd性质不同，不存在生存和发展的战略选择，也没有正面对抗生死大敌的巨大压力。</p>
<p>从Google和IBM联手决定推出Istio开始，Istio就注定永远处于风头浪尖，无论成败，Istio面世之后，赞誉不断，尤其是ServiceMesh技术的爱好者，可以说是为之一振：以新一代ServiceMesh之名横空出世的Istio，对比Linkerd，优势明显。同时产品路线图上有一大堆令人眼花缭乱的功能。假以时日，如果Istio能顺利地完成开发，稳定可靠，那么这会是一个非常美好、值得憧憬的大事件，</p>
</blockquote>
<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/634554bf1f3647071057357a4d577cc9.png" alt="image.png"></p>
<h1 id="Istio介绍"><a href="#Istio介绍" class="headerlink" title="Istio介绍"></a>Istio介绍</h1><p>Istio是目前最热的ServiceMesh开源项目，Istio主要分为两个部分：数据平面和控制平面。Istio实现了云原生下的微服务治理，能实现服务发现，流量控制，监控安全等。Istio通过在一个Pod里启动一个应用和Sidecar方式实现透明代理。Istio是一个拓展性较高的框架，其不仅可以支持K8S，还可以支持其他如Mesos等资源调度器。如下图所示，为Istio的整体架构：</p>
<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/801a66c5ed3e49f6eac068a20bc22ebe.png" alt="image.png"></p>
<ul>
<li>逻辑上分为数据平面（上图中的上半部分）和控制平面（上图中的下半部分）。</li>
<li>数据平面由一组以 Sidecar 方式部署的智能代理（Envoy）组成。这些代理可以调节和控制微服务及 Mixer 之间所有的网络通信。</li>
<li>控制平面负责管理和配置代理来路由流量。此外控制平面配置 Mixer 以实施策略和收集遥测数据。</li>
<li>Pilot是整个架构中的抽象层，将对接K8S等资源调度器的步骤进行抽象并以适配器的形式展现，并和用户以及Sidecar交互。</li>
<li>Galley负责资源配置为验证。</li>
<li>Citadel用于生成身份，及密钥和证书管理</li>
<li>核心功能包括流量控制、安全控制、可观测性、多平台支持、可定制化。</li>
</ul>
<h2 id="Mixer"><a href="#Mixer" class="headerlink" title="Mixer"></a>Mixer</h2><p>Mixer同样是一个可拓展的模块，其负责遥感数据的采集以及集成了一些后端服务（BAAS），Sidecar会不断向Mixer报告自己的流量情况，Mixer对流量情况进行汇总，以可视化的形式展现，此外Sidecar可以调用Mixer提供的一些后端服务能力，例如鉴权、登录、日志等等，Mixer通过适配器的方式对接各种后端服务。</p>
<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/403cc8c2367ca7efa446d002ffc3f34f.png" alt="image.png"></p>
<h4 id="In-process-Adapter形式"><a href="#In-process-Adapter形式" class="headerlink" title="In-process Adapter形式"></a>In-process Adapter形式</h4><p>之前版本的Isito采用这种将后端服务适配器集成在Mixer内部的形式，这种方式会有一个问题，就是某个后端服务适配器出现问题即会影响整个Mixer模块，但由于适配器和Mixer集成在一起，在同一个进程内，方法的调用会很快。</p>
<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/d0e35169905977c5aaac8572d2e78f0f.png" alt="image.png"></p>
<h4 id="Out-of-process-Adapter形式"><a href="#Out-of-process-Adapter形式" class="headerlink" title="Out-of-process Adapter形式"></a>Out-of-process Adapter形式</h4><p>目前版本的Istio将Adapter移到Mixer外部，这样可以实现Mixer与Adapter的解耦，当Adapter出现问题并不会影响Mixer，但这种方式同样也存在问题，即Adapter在Mixer外，是两个不同的进程，二者之间的调用是通过RPC的方式，这种方式比同进程内部的方法调用会慢很多，因此性能会受到影响。</p>
<h2 id="Pilot"><a href="#Pilot" class="headerlink" title="Pilot"></a>Pilot</h2><p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/3c0ea5bcdd7d095c8fb9534bdb222731.png" alt="image.png"></p>
<ul>
<li>Envoy API负责和Envoy的通讯, 主要是发送服务发现信息和流量控制规则给Envoy。</li>
<li>Abstract Model 是 Pilot 定义的服务的抽象模型, 以从特定平台细节中解耦, 为跨平台提供基础。</li>
<li>Platform Adapter则是这个抽象模型的实现版本, 用于对接外部的不同平台如k8s/mesos等。</li>
<li>Rules API提供接口给外部调用以管理 Pilot, 包括命令行工具Istioctl以及未来可能出现的第三方管理界面。</li>
</ul>
<h2 id="Galley"><a href="#Galley" class="headerlink" title="Galley"></a>Galley</h2><p>Galley 原来仅负责进行配置验证, 1.1 后升级为整个控制面的配置管理中心, 除了继续提供配置验证功能外, Galley还负责配置的管理和分发, Galley 使用 网格配置协议(Mesh Configuration Protocol) 和其他组件进行配置的交互.</p>
<p>Istio 创造了50多个CRD, 其复杂度可见一斑, 所以有人说面向k8s编程近似于面向yaml编程.早期的Galley 仅仅负责对配置进行运行时验证, Istio 控制面各个组件各自去list/watch 各自关注的配置。越来越多且复杂的配置给Istio用户带来了诸多不便, 主要体现在:</p>
<ul>
<li>配置的缺乏统一管理, 组件各自订阅, 缺乏统一回滚机制, 配置问题难以定位。</li>
<li>配置可复用度低, 比如在1.1之前, 每个Mixer adpater 就需要定义个新的CRD。</li>
<li>配置的隔离, ACL 控制, 一致性, 抽象程度, 序列化等等问题都还不太令人满意</li>
</ul>
<p>随着Istio功能的演进, 可预见的Istio CRD数量还会继续增加, 社区计划将Galley 强化为Istio配置控制层, Galley 除了继续提供配置验证功能外, 还将提供配置管理流水线, 包括输入, 转换, 分发, 以及适合Istio控制面的配置分发协议(MCP)。</p>
<h2 id="Citadel"><a href="#Citadel" class="headerlink" title="Citadel"></a>Citadel</h2><p>将服务拆分为微服务之后，在带来各种好处的同时，在安全方面也带来了比单体时代更多的需求，毕竟不同功能模块之间的调用方式从原来单体架构中的方法调用变成了微服务之间的远程调用：</p>
<ul>
<li>加密：为了不泄露信息，为了抵御中间人攻击，需要对服务间通讯进行加密。</li>
<li>访问控制：不是每个服务都容许被任意访问，因此需要提供灵活的访问控制，如双向 TLS 和细粒度的访问策略。</li>
<li>审计：如果需要审核系统中哪些用户做了什么，则需要提供审计功能。</li>
</ul>
<p><strong>Citadel 是 Istio 中负责安全性的组件，但是 Citadel 需要和其他多个组件配合才能完成工作：</strong></p>
<ul>
<li>Citadel：用于密钥管理和证书管理，下发到Envoy等负责通讯转发的组件。</li>
<li>Envoy：使用从Citadel下发而来的密钥和证书，实现服务间通讯的安全，注意在应用和Envoy之间是走Localhost，通常不用加密。</li>
<li>Pilot：将授权策略和安全命名信息分发给Envoy。</li>
<li>Mixer：负责管理授权，完成审计等。</li>
</ul>
<p><strong>Istio支持的安全类功能有：</strong></p>
<ul>
<li>流量加密：加密服务间的通讯流量。</li>
<li>身份认证：通过内置身份和凭证管理可以提供强大的服务间和最终用户身份验证，包括传输身份认证和来源身份认证，支持双向TLS。</li>
<li>授权和鉴权：提供基于角色的访问控制（RBAC），提供命名空间级别，服务级别和方法级别的访问控制。</li>
</ul>
<p><strong>作者信息：</strong>彭家浩，花名毅忻，阿里巴巴淘系技术部开发工程师，热爱云计算。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://carlo-z.com/devops/sonar/sonarqube-server-setup/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Focus-1">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Focus-1">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/devops/sonar/sonarqube-server-setup/" itemprop="url">sonarqube-8.3 安装</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-12-25T00:00:00+08:00">
                2019-12-25
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/devops/" itemprop="url" rel="index">
                    <span itemprop="name">devops</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <br>



<p>版本要求</p>
<p><a href="https://docs.sonarqube.org/latest/requirements/requirements/" target="_blank" rel="noopener">https://docs.sonarqube.org/latest/requirements/requirements/</a></p>
<h1 id="安装PostgreSQL"><a href="#安装PostgreSQL" class="headerlink" title="安装PostgreSQL"></a>安装PostgreSQL</h1><p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20200512153042.png" alt></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">docker pull postgres</span><br><span class="line">docker run --name postgres -e POSTGRES_USER=sonar -e POSTGRES_PASSWORD=sonar -p 5432:5432 -d postgres</span><br><span class="line">firewall-cmd --permanent --add-port=5432/tcp</span><br><span class="line">firewall-cmd --reload</span><br><span class="line">firewall-cmd --list-all</span><br><span class="line">docker exec -it postgres /bin/bash</span><br></pre></td></tr></table></figure>

<p>修改host</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/hosts</span><br><span class="line">10.1.171.41  dev.mypostgres.com</span><br><span class="line"></span><br><span class="line">C:\Windows\System32\drivers\etc\</span><br><span class="line">hosts</span><br><span class="line">10.1.171.41  dev.mypostgres.com</span><br></pre></td></tr></table></figure>

<p>通过Navicat for Postgres连接</p>
<blockquote>
<p>dev.mypostgres.com</p>
<p>5432</p>
<p>sonar/sonar</p>
</blockquote>
<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20200512171820.png" alt></p>
<br>

<h1 id="安装jdk11"><a href="#安装jdk11" class="headerlink" title="安装jdk11"></a>安装jdk11</h1><p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20200512152854.png" alt></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> vi /etc/profile</span></span><br><span class="line">export JAVA_HOME=/data/components/jdk-11.0.7</span><br><span class="line">export PATH=$JAVA_HOME/bin:$PATH</span><br><span class="line">export CLASSPATH=.:$JAVA_HOME/lib/dt.jar:$JAVA_HOME/lib/tools.jar</span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">source</span> /etc/profile</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> java -version</span></span><br><span class="line">java version "11.0.7" 2020-04-14 LTS</span><br><span class="line">Java(TM) SE Runtime Environment 18.9 (build 11.0.7+8-LTS)</span><br><span class="line">Java HotSpot(TM) 64-Bit Server VM 18.9 (build 11.0.7+8-LTS, mixed mode)</span><br></pre></td></tr></table></figure>

<br>

<h1 id="SonarQube安装配置"><a href="#SonarQube安装配置" class="headerlink" title="SonarQube安装配置"></a>SonarQube安装配置</h1><h3 id="使用zip安装"><a href="#使用zip安装" class="headerlink" title="使用zip安装"></a>使用zip安装</h3><p>下载zip文件（<a href="http://www.sonarqube.org/downloads/）" target="_blank" rel="noopener">http://www.sonarqube.org/downloads/）</a></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">unzip sonarqube-8.3.1.34397.zip</span><br><span class="line">ln -s /data/sonarqube-8.3.1.34397 /data/sonarqube</span><br><span class="line">cd /data/sonarqube</span><br></pre></td></tr></table></figure>

<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20200515152245.png" alt></p>
<br>

<h3 id="设置DB"><a href="#设置DB" class="headerlink" title="设置DB"></a>设置DB</h3><p>在pg中建立数据库</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">create database sonar;</span><br><span class="line">create user sonar;</span><br><span class="line">atler user sonar with password 'sonar';</span><br><span class="line">alter role sonar createdb;alter role sonar superuser;alter role sonar createrole;</span><br><span class="line">alter database sonar owner to sonar</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">vi /data/sonarqube/conf/sonar.properties</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> DATABASE</span></span><br><span class="line">sonar.jdbc.username=sonar</span><br><span class="line">sonar.jdbc.password=sonar</span><br><span class="line">sonar.jdbc.url=jdbc:postgresql://dev.mypostgres.com:5432/sonar</span><br><span class="line"></span><br><span class="line">sonar.jdbc.maxActive=60</span><br><span class="line">sonar.jdbc.maxIdle=5</span><br><span class="line">sonar.jdbc.minIdle=2</span><br><span class="line">sonar.jdbc.maxWait=5000</span><br><span class="line">sonar.jdbc.minEvictableIdleTimeMillis=600000</span><br><span class="line">sonar.jdbc.timeBetweenEvictionRunsMillis=30000</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> sonar.sorceEncoding=UTF-8</span></span><br></pre></td></tr></table></figure>

<br>

<h3 id="添加JDBC驱动程序"><a href="#添加JDBC驱动程序" class="headerlink" title="添加JDBC驱动程序"></a>添加JDBC驱动程序</h3><p>已经提供了支持的数据库（Oracle除外）的驱动程序。不要更换提供的驱动程序；他们是唯一受支持的。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">/data/sonarqube/lib/jdbc</span><br><span class="line">(base) [root@dev-10-1-171-41 jdbc]# ll</span><br><span class="line">total 12</span><br><span class="line">drwxr-xr-x 2 root root 4096 May  7 13:41 h2</span><br><span class="line">drwxr-xr-x 2 root root 4096 May  7 13:41 mssql</span><br><span class="line">drwxr-xr-x 2 root root 4096 May  7 13:41 postgresql</span><br></pre></td></tr></table></figure>

<p>oracle 数据库需要单独添加驱动，其他数据库已经默认提供</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">/data/sonarqube/extensions/jdbc-driver</span><br><span class="line">(base) [root@dev-10-1-171-41 jdbc-driver]# ll</span><br><span class="line">total 4</span><br><span class="line">drwxr-xr-x 2 root root 4096 May  7 13:22 oracle</span><br></pre></td></tr></table></figure>

<br>

<h3 id="配置Elasticsearch存储路径"><a href="#配置Elasticsearch存储路径" class="headerlink" title="配置Elasticsearch存储路径"></a>配置Elasticsearch存储路径</h3><p>默认情况下，Elasticsearch数据存储在<em>$ SONARQUBE-HOME / data中</em>，但不建议将其用于生产实例。相反，您应该将此数据存储在其他位置，最好是在具有快速I / O的专用卷中。除了保持可接受的性能外，这样做还可以简化SonarQube的升级。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">vi /data/sonarqube/conf/sonar.properties</span><br><span class="line"><span class="meta">#</span><span class="bash">sonar.path.data=/var/sonarqube/data</span></span><br><span class="line"><span class="meta">#</span><span class="bash">sonar.path.temp=/var/sonarqube/temp</span></span><br></pre></td></tr></table></figure>

<br>

<h3 id="特别配置jdk路径"><a href="#特别配置jdk路径" class="headerlink" title="特别配置jdk路径"></a>特别配置jdk路径</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">vi /data/sonarqube/conf/wrapper.conf</span><br><span class="line">wrapper.java.command=/data/components/jdk-11.0.7/bin/java</span><br></pre></td></tr></table></figure>

<br>

<h3 id="linux系统参数优化"><a href="#linux系统参数优化" class="headerlink" title="linux系统参数优化"></a>linux系统参数优化</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/sysctl.d/99-sonarqube.conf（或/etc/sysctl.conf文件）</span><br><span class="line">vm.max_map_count=262144</span><br><span class="line">fs.file-max=65536</span><br><span class="line"></span><br><span class="line">sysctl -w vm.max_map_count=262144</span><br><span class="line">sysctl -w fs.file-max=65536</span><br><span class="line">ulimit -n 65536</span><br><span class="line"></span><br><span class="line">sysctl vm.max_map_count </span><br><span class="line">sysctl fs.file-max </span><br><span class="line">ulimit -n</span><br></pre></td></tr></table></figure>

<br>

<h3 id="启动Web服务器"><a href="#启动Web服务器" class="headerlink" title="启动Web服务器"></a>启动Web服务器</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">vi /data/sonarqube/conf/sonar.properties</span><br><span class="line">sonar.web.host=0.0.0.0</span><br><span class="line">sonar.web.port=9011</span><br><span class="line">sonar.web.context=</span><br><span class="line"></span><br><span class="line">firewall-cmd --permanent --add-port=9011/tcp</span><br><span class="line">firewall-cmd --reload</span><br><span class="line">firewall-cmd --list-all</span><br></pre></td></tr></table></figure>

<p>sonar不能使用root启动</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">useradd sonar</span><br><span class="line">passwd sonar</span><br><span class="line">chown -R sonar:sonar /data/sonarqube/</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">su - sonar</span><br><span class="line">/data/sonarqube/bin/linux-x86-64/sonar.sh start</span><br><span class="line">/data/sonarqube/bin/linux-x86-64/sonar.sh restart</span><br><span class="line"></span><br><span class="line">jps -l</span><br></pre></td></tr></table></figure>

<p>设置域名</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/hosts</span><br><span class="line">10.1.171.41  dev.mysonar.com</span><br><span class="line">echo '10.1.171.41  dev.mysonar.com' &gt;&gt; /etc/hosts</span><br><span class="line"></span><br><span class="line">C:\Windows\System32\drivers\etc\</span><br><span class="line">hosts</span><br><span class="line">10.1.171.41  dev.mysonar.com</span><br></pre></td></tr></table></figure>

<p>访问：</p>
<p><a href="http://dev.mysonar.com:9011/" target="_blank" rel="noopener">http://dev.mysonar.com:9011/</a></p>
<p>默认账号：admin/admin</p>
<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20200514142721.png" alt></p>
<br>

<h3 id="安装中文插件"><a href="#安装中文插件" class="headerlink" title="安装中文插件"></a>安装中文插件</h3><p>install -&gt; restart</p>
<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20200514150054.png" alt></p>
<br>

<h3 id="使用systemd管理启动"><a href="#使用systemd管理启动" class="headerlink" title="使用systemd管理启动"></a>使用systemd管理启动</h3><br>

<h1 id="SonarScanner安装配置"><a href="#SonarScanner安装配置" class="headerlink" title="SonarScanner安装配置"></a>SonarScanner安装配置</h1><blockquote>
<p>文档：<a href="https://docs.sonarqube.org/latest/analysis/scan/sonarscanner/" target="_blank" rel="noopener">https://docs.sonarqube.org/latest/analysis/scan/sonarscanner/</a></p>
</blockquote>
<h3 id="下载zip包安装"><a href="#下载zip包安装" class="headerlink" title="下载zip包安装"></a>下载zip包安装</h3><p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20200514150509.png" alt></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> unzip sonar-scanner-cli-4.3.0.2102-linux.zip</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ln -s /data/downloads/sonar-scanner-4.3.0.2102-linux /data/sonar-scanner</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ln -s /data/sonar-scanner/bin/sonar-scanner /usr/bin/sonar-scanner</span></span><br></pre></td></tr></table></figure>

<br>

<h3 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> vi /data/sonar-scanner/conf/sonar-scanner.properties</span></span><br><span class="line">sonar.host.url=http://dev.mysonar.com:9011</span><br><span class="line">sonar.sourceEncoding=UTF-8</span><br></pre></td></tr></table></figure>

<br>

<h3 id="扫描maven工程示例"><a href="#扫描maven工程示例" class="headerlink" title="扫描maven工程示例"></a>扫描maven工程示例</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">cd</span> /data/components/leancloud-proxy</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> vi sonar-project.properties</span></span><br><span class="line">sonar.projectKey=leancloud-proxy</span><br><span class="line">sonar.projectName=leancloud-proxy</span><br><span class="line">sonar.projectVersion=1.0</span><br><span class="line">sonar.sources=./</span><br><span class="line">sonar.language=java</span><br><span class="line">sonar.sources=src</span><br><span class="line">sonar.java.binaries=target</span><br><span class="line">sonar.sourceEncoding=UTF-8</span><br><span class="line">sonar.dynamicAnalysis=false</span><br><span class="line">sonar.scm.disabled=true</span><br><span class="line">sonar.scm.provider=svn</span><br><span class="line">sonar.host.url=http://dev.mysonar.com:9011</span><br></pre></td></tr></table></figure>

<p>执行扫描</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> sonar-scanner</span></span><br></pre></td></tr></table></figure>

<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20200514175808.png" alt></p>
<p><a href="http://dev.mysonar.com:9011/projects" target="_blank" rel="noopener">http://dev.mysonar.com:9011/projects</a></p>
<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20200514191037.png" alt></p>
<br>

<h3 id="扫描php工程示例"><a href="#扫描php工程示例" class="headerlink" title="扫描php工程示例"></a>扫描php工程示例</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">cd</span> /data/public_html</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> vi sonar-project.properties</span></span><br><span class="line">sonar.projectKey=php-trunk</span><br><span class="line">sonar.projectName=php-trunk</span><br><span class="line">sonar.projectVersion=1.0</span><br><span class="line">sonar.sources=./</span><br><span class="line">sonar.language=php</span><br><span class="line">sonar.sourceEncoding=UTF-8</span><br><span class="line">sonar.dynamicAnalysis=false</span><br><span class="line">sonar.scm.disabled=true</span><br><span class="line">sonar.scm.provider=svn</span><br><span class="line">sonar.host.url=http://dev.mysonar.com:9011</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> sonar-scanner</span></span><br></pre></td></tr></table></figure>

<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20200514191525.png" alt></p>
<p><a href="http://dev.mysonar.com:9011/projects" target="_blank" rel="noopener">http://dev.mysonar.com:9011/projects</a></p>
<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20200514190949.png" alt></p>
<br>

<h1 id="jenkins-SonarScanner"><a href="#jenkins-SonarScanner" class="headerlink" title="jenkins + SonarScanner"></a>jenkins + SonarScanner</h1><h3 id="安装SonarQube-Scanner插件"><a href="#安装SonarQube-Scanner插件" class="headerlink" title="安装SonarQube Scanner插件"></a>安装SonarQube Scanner插件</h3><p>Jenkins → 系统管理 → 管理插件 → 可选插件 → 🔍SonarQueue Scanner</p>
<p>安装以后重启</p>
<br>

<h3 id="配置SonarQube"><a href="#配置SonarQube" class="headerlink" title="配置SonarQube"></a>配置SonarQube</h3><p>首先，在SonarQube中生成一个Token（PS：用token代替输入用户名和密码）</p>
<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20200514192610.png" alt></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bb6ad69138f3607af1082565551846a5b23eb310</span><br></pre></td></tr></table></figure>

<p>然后，在Jenkins中配置连接sonarqube服务器的地址，这里用到的token就是刚才在sonarqube中创建的那个token</p>
<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20200514193841.png" alt></p>
<p>系统设置</p>
<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20200514193817.png" alt></p>
<p>最后，配置全局工具配置</p>
<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20200514194221.png" alt></p>
<h3 id="创建任务"><a href="#创建任务" class="headerlink" title="创建任务"></a>创建任务</h3><p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20200514194328.png" alt></p>
<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20200514200516.png" alt></p>
<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20200514200539.png" alt></p>
<p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20200514200634.png" alt></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">sonar.projectKey=php-trunk</span><br><span class="line">sonar.projectName=php-trunk</span><br><span class="line">sonar.projectVersion=1.0</span><br><span class="line">sonar.sources=$WORKSPACE</span><br><span class="line">sonar.language=php</span><br><span class="line">sonar.sourceEncoding=UTF-8</span><br><span class="line">sonar.dynamicAnalysis=false</span><br><span class="line">sonar.scm.disabled=true</span><br><span class="line">sonar.scm.provider=svn</span><br><span class="line">sonar.host.url=http://dev.mysonar.com:9011</span><br></pre></td></tr></table></figure>

<h3 id="开始构建任务"><a href="#开始构建任务" class="headerlink" title="开始构建任务"></a>开始构建任务</h3><p><img src="https://imagehome.oss-cn-beijing.aliyuncs.com/20200514200830.png" alt></p>
<br>

<br>

<br>

<br>

<br>

<br>


          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://carlo-z.com/message-queue/rocketmq/linux-rocketmq-setup/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Focus-1">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Focus-1">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/message-queue/rocketmq/linux-rocketmq-setup/" itemprop="url">centos7 下 rocketmq 单机版安装</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-12-01T00:00:00+08:00">
                2019-12-01
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/rocketmq/" itemprop="url" rel="index">
                    <span itemprop="name">rocketmq</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <hr>
<br>

<blockquote>
<p>文档：<a href="http://rocketmq.apache.org/docs/quick-start/" target="_blank" rel="noopener">http://rocketmq.apache.org/docs/quick-start/</a></p>
</blockquote>
<h1 id="先决条件"><a href="#先决条件" class="headerlink" title="先决条件"></a>先决条件</h1><p>假定已安装以下软件：</p>
<ol>
<li>建议使用64位操作系统，建议使用Linux / Unix / Mac；</li>
<li>64位JDK 1.8+;</li>
<li>Maven 3.2.x;</li>
<li>Git;</li>
<li>适用于Broker服务器的4g +可用磁盘</li>
</ol>
<h1 id="下载安装"><a href="#下载安装" class="headerlink" title="下载安装"></a>下载安装</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7cz ~]# cd /data/download/</span><br><span class="line">[root@centos7cz download]# wget http://mirror.bit.edu.cn/apache/rocketmq/4.6.0/rocketmq-all-4.6.0-bin-release.zip</span><br><span class="line">[root@centos7cz download]# mkdir -p /data/tools/</span><br><span class="line">[root@centos7cz download]# unzip rocketmq-all-4.6.0-bin-release.zip -d /data/tools</span><br><span class="line">[root@centos7cz download]# tar -zxf rocketmq-all-4.6.0.tar.gz  -C /data/tools</span><br><span class="line">[root@centos7cz download]# cd /data/tools/</span><br><span class="line">[root@centos7cz tools]# mv rocketmq-all-4.6.0-bin-release/ rocketmq-all-4.6.0</span><br><span class="line">[root@centos7cz tools]# cd rocketmq-all-4.6.0/</span><br><span class="line">[root@centos7cz rocketmq-all-4.6.0]# ll</span><br><span class="line">total 40</span><br><span class="line">drwxr-xr-x. 2 root root    83 Nov 20 11:04 benchmark</span><br><span class="line">drwxr-xr-x. 3 root root  4096 Aug 19 15:31 bin</span><br><span class="line">drwxr-xr-x. 6 root root   211 Aug  6 16:23 conf</span><br><span class="line">drwxr-xr-x. 2 root root  4096 Nov 20 11:04 lib</span><br><span class="line">-rw-r--r--. 1 root root 17336 Aug  6 16:23 LICENSE</span><br><span class="line">-rw-r--r--. 1 root root  1338 Aug  6 16:23 NOTICE</span><br><span class="line">-rw-r--r--. 1 root root  4225 Nov  1 16:54 README.md</span><br><span class="line">[root@centos7cz rocketmq-all-4.6.0]#</span><br></pre></td></tr></table></figure>

<h1 id="启动和关闭"><a href="#启动和关闭" class="headerlink" title="启动和关闭"></a>启动和关闭</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 安装nohup</span></span><br><span class="line">[root@centos7cz ~]# yum install coreutils -y</span><br><span class="line"></span><br><span class="line">[root@centos7cz ~]# mkdir -p /data/tools/rocketmq-all-4.6.0/logs/</span><br></pre></td></tr></table></figure>

<h3 id="NameSrv"><a href="#NameSrv" class="headerlink" title="NameSrv"></a>NameSrv</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7cz ~]# cd /data/tools/rocketmq-all-4.6.0</span><br><span class="line"></span><br><span class="line">[root@centos7cz rocketmq-all-4.6.0]# nohup sh /data/tools/rocketmq-all-4.6.0/bin/mqnamesrv &gt; /data/tools/rocketmq-all-4.6.0/logs/namesrv.log 2&gt;&amp;1 &amp;</span><br><span class="line"></span><br><span class="line">[root@centos7cz rocketmq-all-4.6.0]# tail -f /data/tools/rocketmq-all-4.6.0/logs/namesrv.log</span><br><span class="line"></span><br><span class="line">[root@centos7cz rocketmq-all-4.6.0]# /data/tools/rocketmq-all-4.6.0/bin/mqshutdown namesrv</span><br></pre></td></tr></table></figure>

<h3 id="Broker"><a href="#Broker" class="headerlink" title="Broker"></a>Broker</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7cz ~]# cd /data/tools/rocketmq-all-4.6.0</span><br><span class="line"></span><br><span class="line">[root@centos7cz rocketmq-all-4.6.0]# nohup sh /data/tools/rocketmq-all-4.6.0/bin/mqbroker &gt; /data/tools/rocketmq-all-4.6.0/logs/broker.log 2&gt;&amp;1 &amp;</span><br><span class="line"></span><br><span class="line">[root@centos7cz rocketmq-all-4.6.0]# tail -f /data/tools/rocketmq-all-4.6.0/logs/broker.log</span><br><span class="line"></span><br><span class="line">[root@centos7cz rocketmq-all-4.6.0]# /data/tools/rocketmq-all-4.6.0/bin/mqshutdown broker</span><br></pre></td></tr></table></figure>

<h1 id="收发消息"><a href="#收发消息" class="headerlink" title="收发消息"></a>收发消息</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7cz ~]# cd /data/tools/rocketmq-all-4.6.0</span><br><span class="line"></span><br><span class="line">[root@centos7cz rocketmq-all-4.6.0]# export NAMESRV_ADDR=localhost:9876</span><br><span class="line"></span><br><span class="line">[root@centos7cz rocketmq-all-4.6.0]# sh bin/tools.sh org.apache.rocketmq.example.quickstart.Producer</span><br><span class="line"></span><br><span class="line">[root@centos7cz rocketmq-all-4.6.0]# sh bin/tools.sh org.apache.rocketmq.example.quickstart.Consumer</span><br></pre></td></tr></table></figure>


          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/2/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><span class="page-number current">3</span><a class="page-number" href="/page/4/">4</a><span class="space">&hellip;</span><a class="page-number" href="/page/24/">24</a><a class="extend next" rel="next" href="/page/4/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">Focus-1</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">236</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">59</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">100</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          

          
          

          
          
            <div class="links-of-blogroll motion-element links-of-blogroll-block">
              <div class="links-of-blogroll-title">
                <i class="fa  fa-fw fa-link"></i>
                Links
              </div>
              <ul class="links-of-blogroll-list">
                
                  <li class="links-of-blogroll-item">
                    <a href="https://gitee.com/carloz" title="repository - https://gitee.com/carloz" target="_blank">repository - https://gitee.com/carloz</a>
                  </li>
                
              </ul>
            </div>
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2015 &mdash; <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Focus-1</span>

  
</div>








  <div class="footer-custom">Hosted by <a target="_blank" href="https://gitee.com/carloz">Gitee Repo</a></div>


        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  
  

  
  
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
          processEscapes: true,
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
      });
    </script>

    <script type="text/x-mathjax-config">
      MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
        }
      });
    </script>
    <script type="text/javascript" src="//cdn.bootcss.com/mathjax/2.7.1/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
  


  

  

</body>
</html>
